<?php/*- simpan pesan history max 100 pesan untuk setiap lawan bicara- bisa kirim walau lawan bicara sudah off - pesan yg belum dibaca ketika kita offline akan ditampilkan saat memulai chat - hanya mengambil data pesan yang terbaru (terkirim !=1)- setalah sukses terkirim update terkirim = 1*/include ('../../config.php');$usr1 = $_GET['usr1'];//$usr2 = $_GET['usr2'];//$newest = $_GET['new']; //1 -> hanya yang terbaru terkirim!=1//$lastid = $_GET['lastid'];//cek usr1 masih online$Kondisi = " where uid='".$usr1."' and online=1 					and TIMESTAMPDIFF(MINUTE,lastaktif,now()) < ".$USER_TIME_OUT;$qry = mysql_query("select * from admin $Kondisi ");if( mysql_num_rows($qry)>0){//ambil pesan user yg online$sqry = 'select aa.Id, aa.tgl, aa.cto, aa.cfrom, aa.isi, bb.online, bb.lastaktif from chatx aa			left join admin bb			on (aa.cfrom = bb.uid ) 			where 				( (aa.cto="'.$usr1.'" and aa.terkirim2 != 1 and TIMESTAMPDIFF(MINUTE,bb.lastaktif,now())< '.$USER_TIME_OUT.' ) or 				(aa.cfrom="'.$usr1.'" and aa.terkirim1 != 1 ) )  				 				order by aa.tgl';	//echo $sqry.'<br>';				$ListDATA='';$qry = mysql_query($sqry);while ($row=mysql_fetch_array($qry)){		$ufr = $row['cfrom'];	$uto = $row['cto'];	$msg = $row['isi'];		$msgID = $row['Id'];	//$lastid = $row['id'];	//$date = strtotime($isi['tgl']);	$date= date(" d/m/Y H:i ", strtotime($row['tgl']));		//$date=strtotime($row['tgl']);    //$final_date=date("F j, Y, g:i a", $date);     		if($ListDATA != ''){		$ListDATA .='<||>';		}	$ListDATA .=$ufr.'<||>'.$uto.'<||>'.$date.'<||>'.$msg.'<||>'.$msgID;		}echo $ListDATA;}else{	echo 'err<||>Anda Sudah Logout. Silahkan Login Kembali!!';}?>