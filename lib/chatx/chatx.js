idpesanterkirim= new Array(); //id pesan yg sukses terkirim usr1idpesanditerima= new Array(); //id pesan yg sukses diterima usr1daftaruseraktif = new Array();delay_cek_notify	= 5000;//delay_cek_pesan		= 3000;delay_cek_user 		= 3000;Array.prototype.findIndex = function(value){var ctr = -1;for (var i=0; i < this.length; i++) {// use === to check for Matches. ie., identical (===), ;	if (this[i] == value) {		return i;	}}return ctr;};/* jadi error recursion???Object.prototype.clone2 = function() {  var newObj = (this instanceof Array) ? [] : {};  for (i in this) {    if (i == 'clone2') continue;    if (this[i] && typeof this[i] == "object") {      newObj[i] = this[i].clone2();    } else newObj[i] = this[i]  } return newObj;};*/function clone(obj){    if(obj == null || typeof(obj) != 'object')        return obj;    var temp = new obj.constructor(); // changed (twice)    for(var key in obj)        temp[key] = clone(obj[key]);    return temp;}function hapusElement(id){	var olddiv = document.getElementById(id) ;	var parent = olddiv.parentNode;  	//document.getElementById(this.idElList).removeChild(olddiv);	parent.removeChild(olddiv);				}cek_user_obj = function(){	this.uri = '';	this.idElList='list_usr';	this.daftarOL = new Array();	this.daftarOff = new Array();	this.tambahuser = function(id,nm,opd){	//tambah user di list		document.getElementById(this.idElList).innerHTML+=			'<div id="list_usr_'+id+'" class="itemonline_style"> '+				'<table><tr valign="top">'+				'	<td> <img src="images/administrator/images/smile.png" /> </td>'+				'	<td >'+						 				'		<a href="javascript:chat_select_user(\''+id+'\')" '+							' style="font-size:12"><b>'+id+'</b></a><br>'+														nm+'<br>'+opd+					'</td></tr></table></div>	'						;					}			this.setinfouseroff = function(userid,info){		if(document.getElementById('chat_listpesan-'+userid)){			var tabsheet= document.getElementById('chat_listpesan-'+userid);			tabsheet.innerHTML += '<div id="info-'+userid+'" style="color:#AAAAAA;padding:4">'+info+'<div>';			scrolldown('chat_listpesan-'+userid);		}	}	this.hapususer = function(){//hapus user di list		for(i=0;i<this.daftarOff.length;i++){			var id= this.daftarOff[i];			if ( document.getElementById('list_usr_'+id) != null ){								hapusElement('list_usr_'+id);								//  jika ada tabsheet -> set info telah off 				if(document.getElementById('chat_listpesan-'+id)){					this.setinfouseroff(id, id+' Offline');				}			}		}			}		this.OnSuccess = function() { //get response		//alert('tes');		var str = trim(this.GetResponseText());//alert('-'+str+'-');		if (str != ''){			//set inisial daftar off ----------------------			//this.daftarOff = this.daftarOL.clone2(); //alert('ini Off: '+this.daftarOff);						this.daftarOff = clone(this.daftarOL);			this.daftarOL  = new Array();			//proses daftar baru ----------------------------			arr = str.split('<||>' );//alert (arr.length);			var i=0;			while (i< arr.length){				var id = arr[i];//alert(id);				var nm = arr[i+1];//alert(nm);				var opd= arr[i+2];//alert(opd);				this.daftarOL.push(id);								//cari yg off				var idx = this.daftarOff.findIndex(id);//alert('idx='+idx);				if(idx>=0){//alert('hapus idx'+idx);					this.daftarOff.splice( idx, 1);				}								//tambhkan ke list jika belum ada				if ( document.getElementById('list_usr_'+id) == null ){//	alert('tambahkan');					this.tambahuser(id,nm,opd);										}				if (document.getElementById('info-'+id)){hapusElement('info-'+id);}				i+=3;			}			//alert('OL: '+this.daftarOL);alert('OFF: '+this.daftarOff);			//hapus user yg ada di daftar off -------------------			this.hapususer();		}			cek_pesan();	}	this.GetData = function() {//alert(this.uri);		this.InitializeRequest('GET', this.uri);        this.Commit(null);	}}cek_user_obj.prototype =  new ajax();cekuserobj = new cek_user_obj();kirim_pesan_obj = function(){	this.uri='';		this.OnSuccess = function() {		//alert(this.GetResponseText());				var str = trim(this.GetResponseText());		if (str == ''){		//sukses				document.getElementById('chat_pesan').value='';			//cek_pesan();		}else{			//alert(str);			var usr1 = document.getElementById('chat_ufr').value;			var arr = str.split('<||>' );				//alert(arr[0]+' '+usr1);			if (arr[0]== usr1  ){				tampil_err('Anda Sudah Logout. Silahkan Login Kembali!!');				//alert('anda off ' );				cekuserobj.setinfouseroff( arr[2], 'Anda Offline' );			}else{				cekuserobj.setinfouseroff( arr[0], arr[0]+' Offline' );				//cek_pesan();			}		}			document.getElementById('chat_btsend').disabled= false;		document.getElementById('chat_pesan').disabled=false;		document.getElementById('chat_pesan').focus();				this.userOnSuccess();		}	this.userOnSuccess = function(){			}	this.GetData = function() {		//alert('uri '+this.uri);		this.InitializeRequest('GET', this.uri);        this.Commit(null);	}	}kirim_pesan_obj.prototype = new ajax();kirimpesanobj = new kirim_pesan_obj();pesan_diterima_obj = function(){/*	pesan dari usr2 sukses diterima -> idt	pesan dari usr1 sukses terkirim -> idk*/	this.uri='';		this.OnSuccess = function() {		if (trim(this.GetResponseText()) !='' ){alert('err diterima '+this.GetResponseText())};		setTimeout( 'cek_user_online()' , delay_cek_user);		/*document.getElementById('chat_btsend').disabled= false;		document.getElementById('chat_pesan').disabled=false;		document.getElementById('chat_pesan').focus();*/	}		this.GetData = function() {		//alert('uri '+this.uri);		this.InitializeRequest('GET', this.uri);        this.Commit(null);	}	}pesan_diterima_obj.prototype = new ajax();pesanditerimaobj = new pesan_diterima_obj();/*pesan_terkirim_obj = function(){//pesan dari usr1 sukses dikirim	this.uri='';		this.OnSuccess = function() {		//alert('sukses terkirim '+this.GetResponseText());			}	this.GetData = function() {		//alert('uri '+this.uri);		this.InitializeRequest('GET', this.uri);        this.Commit(null);	}	}pesan_terkirim_obj.prototype = new ajax();pesanterkirimobj = new pesan_terkirim_obj();*/cek_pesan_obj = function(){	this.uri = '';	this.tampilpesan = function(uto,ufr,tgl,msg,msgid, tabaktif){						var usr1= document.getElementById('chat_ufr').value;		if(ufr == usr1){//jika dari user1			var tabid=uto; //tabid by name			var nmid= ufr;		}else{			var tabid=ufr;			var nmid= "<span style='color:blue'>"+ufr+"</span>";			msg = "<span style='color:blue'>"+msg+"</span>";		}				//cek box/tab		if (document.getElementById("chat_listpesan-"+tabid)==null){			//jika tab+ box belum ada			//alert('tambah tab '+tabid);				chat_tabuser_add(tabid);			}						if (tabid ==tabaktif  ){					//tambahkan pesan ke tabsheet					var objDiv = document.getElementById("chat_listpesan-"+tabid);							objDiv.innerHTML+= "<div id='"+msgid+"' style='padding:4'>"+				"<span style='color:#AAAAAA'>"+tgl+"</span><br>"+				"<b>"+nmid+": </b>&nbsp;"+msg+"&nbsp;&nbsp;</div>";									//scroll to down			scrolldown("chat_listpesan-"+tabid);												//masukan ke daftar pesan terkirim			if(ufr == usr1){//jika dari user1				idpesanterkirim.push(msgid);			}else{				idpesanditerima.push(msgid);			}					}else{			//chat_alert(true);			//tandai ada pesan baru						tabefek(tabid, 3);			//alert(parent.style.backgroundColor);		}		//chat_alert(true);			}	this.OnSuccess = function() {		//alert('pesan '+this.GetResponseText());		var errmsg = '';//String();		idpesanditerima = new Array(); 		idpesanterkirim = new Array();			if (trim(this.GetResponseText()) != ''){			/*			if (document.getElementById('chat_lastid')!= null){				document.getElementById('chat_lastid').id= '';			}*/						//split						var str = trim(this.GetResponseText()); //alert('str='+str);			var arr = str.split('<||>' );				if(arr.length>0){								if (arr[0] != 'err'){										//get tab aktif					var tabaktif = document.getElementById('chat_uto').value; //alert('tabaktif='+tabaktif);							//jika tidak ada tab yg aktif set tabaktif					if (tabaktif==''){//alert('from '+arr[0]);						chat_tabuser_add(arr[0]);						var tabidx = tabuser_findbyname('tabid-'+arr[0]);//alert('aktifkan tab '+tabidx);						//chat_tabuser_open(tabidx, arr[0]);						chat_tabuser_open(arr[0]);								}							tabaktif = document.getElementById('chat_uto').value; //alert('tabaktif='+tabaktif);								var i=0;					while(i<arr.length){						var ufr=arr[i];						var uto=arr[i+1];						var tgl=arr[i+2];						var msg=arr[i+3];							var msgid=arr[i+4];									this.tampilpesan(uto,ufr,tgl,msg,msgid, tabaktif);						i+=5;					}								}else{					//pesan error					//alert('err '+arr[1]);					errmsg= arr[1];//alert('errmsg = '+errmsg);				}			}					}else{			chat_alert(false);		}				if (errmsg ==''){								if (idpesanditerima.length + idpesanterkirim.length >0  ){//alert('pesan terkirim');				//setTimeout('sukses_diterima()',2000);				sukses_diterima();						}else{//alert('cek user online');				setTimeout( 'cek_user_online()' , delay_cek_user);			}		}else{			//proses cek usr & pesan berhenti ganti cek usr1 online			cek_user1_online();		}		//tampil err		tampil_err(errmsg);							this.userOnSuccess();	}	this.userOnSuccess = function(){			}	this.GetData = function() {		//alert('uri '+this.uri);		this.InitializeRequest('GET', this.uri);        this.Commit(null);	}	}cek_pesan_obj.prototype = new ajax();cekpesanobj = new cek_pesan_obj();cek_ada_pesan_obj = function(){	this.uri='';	this.OnSuccess = function(){		var str = trim(this.GetResponseText());	//alert('str=-'+ str+'-');				chat_alert( str!='' );		setTimeout('cekadapesanobj.GetData()', delay_cek_notify);			}	this.GetData = function(){		//alert('gedata');		//if(!document.getElementById('chat_btsend')){ //alert('bukan di chat page');			//alert(this.uri);			this.InitializeRequest('GET', this.uri);        	this.Commit(null);			//}			}	}cek_ada_pesan_obj.prototype = new ajax();cekadapesanobj = new cek_ada_pesan_obj();cek_usr1_online_obj = function(){	this.uri='';	this.OnSuccess = function(){		var str = trim(this.GetResponseText());			if(str != ''){//online			//alert('resdp '+ str);			document.getElementById('chat_errmsg').innerHTML ='';				setTimeout('cek_user_online()', delay_cek_user);		}else{			setTimeout('cek_user1_online()', delay_cek_user);			}					}	this.GetData = function(){		//alert('gedata '+this.uri);		//if(!document.getElementById('chat_btsend')){ //alert('bukan di chat page');			//alert(this.uri);			this.InitializeRequest('GET', this.uri);        	this.Commit(null);			//}			}	}cek_usr1_online_obj.prototype = new ajax();cekusr1onlineobj = new cek_usr1_online_obj();function sukses_diterima(){	//set status terkirim utk id di idpesanditerima	var idt = idpesanditerima.toString();// alert(ids);	var idk = idpesanterkirim.toString();// alert(ids);	pesanditerimaobj.uri = 'lib/chatx/pesan_diterima.php?idt='+idt+'&idk='+idk;	pesanditerimaobj.GetData();}function kirim_pesan(){	uto= document.getElementById('chat_uto').value;	ufr= document.getElementById('chat_ufr').value;	if (uto != ''){				document.getElementById('chat_btsend').disabled= true;		document.getElementById('chat_pesan').disabled=true;		//document.getElementById('chat_pesan').focus();				msg = document.getElementById('chat_pesan').value; 			kirimpesanobj.uri = 'lib/chatx/kirim.php?uto='+uto+'&ufr='+ufr+'&msg='+msg;//alert(detail.uri);		setTimeout('kirimpesanobj.GetData()',1000);	}else{		alert('Pilih dahulu user yang akan dikirim pesan!');	}	//alert();}function cek_user_online(){	//get user ini	ufr= document.getElementById('chat_ufr').value;	//cek user yg online	cekuserobj.uri='lib/chatx/cek_user_ol.php?usr1='+ufr;		cekuserobj.GetData();	}/*function cek_pesan(){	//alert('tes');	usr1 = document.getElementById('chat_ufr').value;	usr2 = document.getElementById('chat_uto').value;		if (document.getElementById('chat_lastid') != null){		lastid = document.getElementById('chat_lastid').value;		}else{		lastid='';	}		//alert(usr1+' '+usr2+' '+lastid);	cekpesanobj.uri = 'lib/chatx/cek_pesan.php?usr1='+usr1+'&usr2='+usr2+'&lastid='+lastid;//alert(detail.uri);	cekpesanobj.GetData();	}*/function cek_pesan(){	//alert('tes');	usr1 = document.getElementById('chat_ufr').value;	//usr2 = document.getElementById('chat_uto').value;		if (document.getElementById('chat_lastid') != null){		lastid = document.getElementById('chat_lastid').value;		}else{		lastid='';	}		//alert(usr1+' '+usr2+' '+lastid);	cekpesanobj.uri = 'lib/chatx/cek_pesan.php?usr1='+usr1+'&lastid='+lastid;//alert(detail.uri);	cekpesanobj.GetData();	}function chat_tabuser_add(userid){	if( document.getElementById('tabid-'+userid) == null ){//alert('tab add');		//tambahkan ke tab user aktif				var jmlEl = daftaruseraktif.length;//parseInt( document.getElementById('chat_tablist_cnt').value)+1;		var tabid = jmlEl;		var objEl = document.getElementById('chat_tablist_useropen');		//objEl.innerHTML+=		//		'<div class="tab_unselect" style=""   >'+		//		'<a class="chat_tab" id="tabid-'+userid+'" name="tabid-'+jmlEl+'" '+		//			' href="javascript:chat_tabuser_open('+(jmlEl)+',\''+userid+'\')" style=""><b>'+userid+'</b></a></div>';		objEl.innerHTML+=			'<div class="tab_unselect" style="" id="tabid-'+userid+'" name="tabid-'+jmlEl+'" '+			' 	 >'+			'<a class="chat_tab"  '+				' href="javascript:chat_tabuser_open(\''+userid+'\')" style=""><b>'+userid+'</b></a>'+			'<a class="bttabclose" href="javascript:chat_tabuser_close(\''+userid+'\')" ></a>'+				'</div>';		document.getElementById('chat_tablist_cnt').value = jmlEl;		tabefek(userid,2);				//alert('width '+document.getElementById('tabid-'+userid).width);		//alert(jmlEl);			//tambahkan tabsheet		boxID = 'chat_listpesan'+'-'+userid;			lastID = 'chat_lastIDMsg-'+userid;		//if (document.getElementById(boxID) == null){		//alert('add objek');				objDiv = document.getElementById('chat_box');		objDiv.innerHTML+= '<div class="chat_window" id='+boxID+' >'+							'<input type="hidden" id='+lastID+' value="">'+						'</div>';			daftaruseraktif.push(''+userid); //alert('daftar '+daftaruseraktif);	//}	}	}function tabefek(tabid, efek){		if (document.getElementById('tabid-'+tabid)){				var tabparent = document.getElementById('tabid-'+tabid);//document.getElementById('tabid-'+tabid).parentNode;	switch(efek){		case 1: {						tabparent.setAttribute("class", "tab_select"); //aktif										var oldtabid = document.getElementById('chat_uto').value; 					if (oldtabid != ''){												//alert('old '+oldtabid);						tabefek(oldtabid,2);						}										break;									}		case 2: {					tabparent.setAttribute("class", "tab_unselect");	//non aktif					break;				}		case 3: {					tabparent.setAttribute("class", "tab_adapesan"); //ada pesan					break;				}	}	}}//function chat_tabuser_close(tabid, userid ){function chat_tabuser_close( userid ){	//alert(tabid+' '+userid)	;	//hapus daftar	var tabid= tab_findidx(''+userid);//alert('hapus id'+tabid);	daftaruseraktif.splice( tabid, 1);// alert('daftar baru'+daftaruseraktif);		//hapus element	var tabaktif = document.getElementById('chat_uto').value;// alert('tabaktif = '+tabaktif);	var tabcnt= document.getElementById('chat_tablist_cnt').value;		//alert('hapus '+userid);	hapusElement('tabid-'+userid);	hapusElement('chat_listpesan-'+userid);		//aktifkan tab baru jika perlu		if (userid==tabaktif ){		//alert('tabid hapus ='+tabid);		/*if (tabid-1 > 0){			newtabaktif= tabid-1;					}else{			if (tabid+1 < daftaruseraktif.length){				newtabaktif= tabid+1;			}		}*/		var newtabaktif = -1;		if(tabid < daftaruseraktif.length){			var newtabaktif = tabid;		}else{						var newtabaktif = tabid-1;			}				if(newtabaktif >= 0){			//alert('new tabaktif ='+newtabaktif);			var newuser= daftaruseraktif[newtabaktif]; //alert('tampil '+newtabaktif+' '+newuser);			chat_tabuser_open(newuser);				}else{			document.getElementById('chat_uto').value='';		}										}		}function tab_findidx(tabid){	var hsl=-1;	for(i=0;i<daftaruseraktif.length;i++){		if(daftaruseraktif[i] == tabid){			return i;			}			}	return hsl;}//function chat_tabuser_open(tabid, userid ){function chat_tabuser_open(userid ){	//alert(document.getElementById('chat_uto').value);	if (document.getElementById('chat_uto').value != userid){					tabefek(userid, 1);			//show tabsheet		tabidx= tab_findidx(userid);		height_= 358;			objDiv = document.getElementById('chat_box');		objDiv.scrollTop = (tabidx) * height_;		//alert('open '+userid);		//scroll to down 		objDiv = document.getElementById("chat_listpesan-"+userid);		scrollHeight_ =  objDiv.scrollHeight; //alert(' f'+scrollHeight_ );		if ( objDiv.scrollTop != scrollHeight_ ){					objDiv.scrollTop = objDiv.scrollHeight;		}			//set aktif user		document.getElementById('chat_uto').value = userid;			document.getElementById('chat_pesan').focus();		//cek_pesan();		//timerobj.start();	}}function tabuser_findbyname(tabname){	//alert('tab find '+tabname);	str = document.getElementById(tabname).getAttribute("name"); //alert('name '+str);	arr = str.split('-');//alert(arr[1]);	return arr[1];}function chat_select_user(userid){	//klik di list user online	//if( document.getElementById('tabid-'+userid) == null ){	chat_tabuser_add(userid);	//	}else{		//tabid = tabuser_findbyname('tabid-'+userid);		//chat_tabuser_open(tabid,userid);//	}	//tabid = tabuser_findbyname('tabid-'+userid);	chat_tabuser_open(userid);				//chat_with( userid);			}function pesan_onenter(evt){	var charCode = (evt.which) ? evt.which : evt.keyCode	if (charCode == 13){		kirim_pesan();	}}function tab_scroll_right(){	var objDiv= document.getElementById('tab_kontainer');		var oldleft =  objDiv.scrollLeft;	objDiv.scrollLeft += 30; //alert(objDiv.scrollLeft);	if (objDiv.scrollLeft == oldleft ){//habis		//alert('habis');	}}function tab_scroll_left(){	var objDiv= document.getElementById('tab_kontainer');		var oldleft =  objDiv.scrollLeft;	objDiv.scrollLeft -= 30;// alert(objDiv.scrollLeft);	if (objDiv.scrollLeft == oldleft ){//habis		//alert('habis');	}}TitleScrollObj = function(){	this.repeat=1 ;//enter 0 to not repeat scrolling after 1 run, othersise, enter 1	this.play= true;	this.title= document.title;	this.pesan = 'Ada pesan baru. ';	this.leng=this.pesan.length;	this.start=1;	this.delay = 500;	this.move = function() {				var titl=this.pesan.substring(this.start, this.leng) + this.pesan.substring(0, this.start);		//console.info(titl+' ' +this.start);		this.start++;		if (this.start>this.leng+1) {			this.start=0;			document.title=this.title;//'::ATISISBADA (Aplikasi Teknologi Informasi Siklus Barang Daerah)';			if (this.play) setTimeout("titleScroll.move()", this.delay*5);			//if (this.repeat==0)   return;		}else if (this.start==this.leng+1) {			if (this.play) setTimeout("titleScroll.move()", this.delay*3);					}else{			document.title=titl;			if (this.play) setTimeout("titleScroll.move()", this.delay);		}			}	this.stop = function(){		document.title=this.title;		this.play = false;	}	/*this.start = function(){		//alert('start');		this.play=true;		this.move();	}*/}titleScroll = new TitleScrollObj();chat_alert_stat=0;/*chat_page_focus = 0;$(window).blur(function(){  chat_page_focus = 0;});$(window).focus(function(){  chat_page_focus = 1;});*/function chat_alert(alerton){		//alert('alert='+alerton);	//var title = '::ATISISBADA (Aplikasi Teknologi Informasi Siklus Barang Daerah)';		if (document.getElementById('chat_alert')){				if (alerton ){			if (chat_alert_stat == 0){				chat_alert_stat = 1;				titleScroll.play=true;				titleScroll.move();								document.getElementById('chat_alert').style.background = 					'url("images/administrator/images/message_24.png") no-repeat scroll 0 0 transparent';						//document.getElementById('chat_alert').innerHTML = 				//	"<img src='images/administrator/images/message_24_anim.gif' width='24' height='24' />";			}		}else{			chat_alert_stat = 0;			titleScroll.stop();			document.getElementById('chat_alert').innerHTML ='';			document.getElementById('chat_alert').style.background = 			'url("images/administrator/images/message_24_off.png") no-repeat scroll 0 0 transparent';			}			}	}function cek_notify(uid){//alert('cek notify'+uid);	//*	if (document.getElementById('chat_alert')){		cekadapesanobj.uri = 'lib/chatx/chat_alert.php?uid='+uid ;		setTimeout('cekadapesanobj.GetData()', delay_cek_notify);//cekadapesanobj.GetData();	}//*/	}function tampil_err(errmsg){//alert('tampil '+errmsg)	if(document.getElementById('chat_errmsg')){		document.getElementById('chat_errmsg').innerHTML = 			'<a href="index.php">'+errmsg+'</a>';		}}function cek_user1_online(){	if(document.getElementById('chat_ufr')){		cekusr1onlineobj.uri='lib/chatx/cek_usr1_online.php?uid='+document.getElementById('chat_ufr').value;		cekusr1onlineobj.GetData();		}	}function scrolldown(elID){	if (document.getElementById(elID)){					var objDiv = document.getElementById(elID);		scrollHeight_ =  objDiv.scrollHeight; //alert(' f'+scrollHeight_ );		if ( objDiv.scrollTop != scrollHeight_ ){objDiv.scrollTop = objDiv.scrollHeight;}	}}