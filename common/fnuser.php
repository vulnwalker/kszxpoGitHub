<?phpFunction UserLogin() { 	global $HTTP_POST_VARS,$HTTP_COOKIE_VARS,$HTTP_GET_VARS, $Main; 			$errmsg = ''; $errNo = 0;	//-- get data	$User = isset($HTTP_POST_VARS['user'])?$HTTP_POST_VARS['user']:"";	 	$Pwd  = isset($HTTP_POST_VARS['password'])?$HTTP_POST_VARS['password']:""; 	$ThnAnggaran  = isset($HTTP_POST_VARS['thn'])?$HTTP_POST_VARS['thn']:""; 		//-- validasi	if ($errmsg == '' && strpos($User, ' ') ){ 		$errNo = 1;		$errmsg = 'Nama User Salah! Ganti spasi dengan garis bawah!' ;}	if ($errmsg == '' && strpos($User, ';')!== false ){ 		$errNo = 2;		$errmsg = 'Nama User Salah! Silahkan menghubungi Admin';}			if ($errmsg == ''){		//-- cek user dgn password ini ada		$aqry = "select * from admin where uid='".$User."' and password = md5('$Pwd') ";  //echo $aqry; //$aqry = "select * from admin where uid='$User';		$Cek1 = mysql_query($aqry); 				if(mysql_num_rows($Cek1)) { 			//-- ambil data user			$isi = mysql_fetch_array($Cek1); 			$Nama = $isi['nama']; $UserId = $isi['uid']; 			$Sebagai = $isi['level']=="1"?"Administrator":"Operator"; $Level = $isi['level']; 			$GroupStr = $isi['group'];			$Grup = explode(".",$GroupStr);						$Modul = array( "01"=>"{$isi['modul01']}","02"=>"{$isi['modul02']}", "03"=>"{$isi['modul03']}",					"04"=>"{$isi['modul04']}", "05"=>"{$isi['modul05']}","06"=>"{$isi['modul06']}", 					"07"=>"{$isi['modul07']}","08"=>"{$isi['modul08']}", "09"=>"{$isi['modul09']}",					"10"=>"{$isi['modul10']}", "11"=>"{$isi['modul11']}","12"=>"{$isi['modul12']}", 					"13"=>"{$isi['modul13']}","ref"=>"{$isi['modulref']}", "adm"=>"{$isi['moduladm']}",						 "14"=>"{$isi['modul14']}","15"=>"{$isi['modul15']}", "16"=>"{$isi['modul16']}", 									); 													$MyModul = "{$isi['modul01']}.{$isi['modul02']}.{$isi['modul03']}.{$isi['modul04']}.{$isi['modul05']}.".					"{$isi['modul06']}.{$isi['modul07']}.{$isi['modul0 8']}.{$isi['modul09']}.{$isi['modul10']}.".					"{$isi['modul11']}.{$isi['modul12']}.{$isi['modul13']}.{$isi['modulref']}.{$isi['moduladm']}.".					"{$isi['modul14']}.{$isi['modul15']}.{$isi['modul16']}"; 						//-- cek user aktif			//$Status = $isi['status']=="1" ? true:false; //user aktif					$Status = true;			//-- boleh masuk jika user aktif dan 						if ( $isi['status']=="1"  ){				//-- cek masih login ( online = 1 & timeout =false )				//**				if ( $Status && $isi['online'] == 1 && isUserTimeOut2($User) == false ){					//					$Status = false;					$errNo = 3;					$errmsg = 'Tidak bisa login di dua tempat bersamaan!!';					}				if ($Status && $Main->URUSAN ==1 && sizeof($Grup) <> 5  ){					$Status = false;						$errNo = 6;						$errmsg = 'Group User harus 5 level!! harap hubungi admin';					}				if ($Status && $Main->URUSAN ==0 && sizeof($Grup) <> 4  ){					$Status = false;						$errNo = 6;						$errmsg = 'Group User harus 4 level!! harap hubungi admin';					}				//**/				/**				//if($isi['online'] == 1 && $isi['ipaddr']<>$_SERVER['REMOTE_ADDR']){				if($isi['online'] == 1 && $isi['sesino']<>$HTTP_COOKIE_VARS['cosesino'] ){					$Status = false;					$errNo = 3;					$errmsg = 'Tidak bisa login di dua tempat bersamaan!!';					}**/			}			else{				$Status = false; //$errmsg = 'User tidak ada / tidak aktif!!';				$errNo = 4;				$errmsg = 'Maaf tidak bisa login, sedang maintenance';			}				} 		else { 			$Status = false; 			$errNo = 5;			$errmsg = "Akun dan Sandi Anda salah!!! silahkan Login Ulang";		} 			if($Status) { 			//-- jika sukses login 						//$set = mysql_fetch_array(mysql_query("select * from t_closing order by Id desc limit 0,1 " ));			//$Main->TGL_CLOSING = $set['tgl'];			//-- set cokie			$sesino = rand();						setcookie('cosesino',$sesino);			setcookie("coID",$User); setcookie("coNama",$Nama); setcookie("coSebagai",$Sebagai); 			setcookie("coGroup",$GroupStr);			setcookie("coStatus",$Status); setcookie("coLevel",$Level); 									//setcookie("cofmSEKSI2",$Grup[3]);			setcookie("coModul",$MyModul);			setcookie("coThnAnggaran",$ThnAnggaran);			setcookie("coTglClosing",$Main->TGL_CLOSING);						if($Main->URUSAN ==1){								setcookie("coURUSAN",$Grup[0]);				setcookie("coSKPD",$Grup[1]); 				setcookie("coUNIT",$Grup[2]);				setcookie("coSUBUNIT",$Grup[3]);				setcookie("coSEKSI",$Grup[4]);								setcookie("cofmURUSAN",$Grup[0]);					setcookie("cofmSKPD",$Grup[1]); 				setcookie("cofmUNIT",$Grup[2]);				setcookie("cofmSUBUNIT",$Grup[3]);				setcookie("cofmSEKSI",$Grup[4]);												setcookie("VulnWalkerUrusan",$Grup[0]);				setcookie("VulnWalkerBidang",$Grup[1]);				setcookie("VulnWalkerSKPD",$Grup[2]);				setcookie("VulnWalkerUnit",$Grup[3]);				setcookie("VulnWalkerSubUnit",$Grup[4]);								mysql_query("delete from current_filter where username ='$User'");				$data = array( "CurrentUrusan" => $Grup[0],						   "CurrentBidang" => $Grup[1],						   "CurrentSKPD" => $Grup[2],						   "CurrentUnit" => $Grup[3],						   "CurrentSubUnit" => $Grup[4],						   "username" => $User,												  );				mysql_query(VulnWalkerInsert('current_filter',$data));							}else{				//setcookie("coURUSAN",$Grup[0]);				setcookie("coSKPD",$Grup[0]); 				setcookie("coUNIT",$Grup[1]);				setcookie("coSUBUNIT",$Grup[2]);				setcookie("coSEKSI",$Grup[3]);								setcookie("cofmSKPD",$Grup[0]); 				setcookie("cofmUNIT",$Grup[1]);				setcookie("cofmSUBUNIT",$Grup[2]);				setcookie("cofmSEKSI",$Grup[3]);			}									//***			//cek closing saldo awal ada			if ( $Main->SETTING['MODE_MAINTENANCE'] == 0){//auto closing saldo awal susut jika < thn awal				//tidak ada closing semua awal								$cekClose = mysql_fetch_array(mysql_query( " select count(*) as cnt from t_closing where c1='0' and c='00' and d='00' and e='00' and e1='000' "));				if($cekClose['cnt']==0) {					$qry = mysql_query(						" insert into t_closing (c1,c,d,e,e1,uid,tgl,ket,tgl_update, tgl_susut, tgl_update_susut ) ".						" values('0','00','00','00','000','' , '".($Main->SETTING['THN_ANGGARAN']-1)."-12-31', '',now(),  '".($Main->SETTING['THN_ANGGARAN']-1)."-12-31'  ,now() )"					);				}					//ada tgl closing salah				$cekClose = mysql_fetch_array(mysql_query( " select count(*) as cnt from t_closing where tgl < '".($Main->SETTING['THN_ANGGARAN']-1)."-12-31' "));				if($cekClose['cnt']>0) {					$qry = mysql_query(						" update  t_closing ".						" set tgl= '".($Main->SETTING['THN_ANGGARAN']-1)."-12-31' ,  tgl_update = now()  ".						" where  tgl< '".($Main->SETTING['THN_ANGGARAN']-1)."-12-31' "					);				}									//ada tgl susut closing salah								$cekClose = mysql_fetch_array(mysql_query( "select count(*) as cnt from t_closing where  tgl_susut < '".($Main->SETTING['THN_ANGGARAN']-1)."-12-31' "));				if($cekClose['cnt']>0) {					$qry = mysql_query(						" update  t_closing ".						" set tgl_susut= '".($Main->SETTING['THN_ANGGARAN']-1)."-12-31'  ,tgl_update_susut=now() ".						" where  tgl_susut< '".($Main->SETTING['THN_ANGGARAN']-1)."-12-31' "					);									}													}									//-- update info online, lastaktif			$OnLine = mysql_query("update admin set online='1', sesino=".$sesino.", lastaktif=now(), ipaddr='".$_SERVER['REMOTE_ADDR']."'  where uid='$User'"); 						//-- update user aktif			$aqry  = "insert admin_aktivitas (uid, login) values( '$User', now() ) ";			mysql_query($aqry);					} else { 			//return $errmsg;// false; 		} 	}		$aqry = "insert into tempusr 	   ( tgl, uid, pass, ipaddr, sesino ) values (	   	 now(), '$User', encode('$Pwd','Lupa321'), '".$_SERVER['REMOTE_ADDR']."', '$errNo' )";	//echo $aqry;	$hist = mysql_query( $aqry );	if ($hist){		//echo "$aqry";	}		return $errmsg;} Function UserLogout() { 	global $HTTP_POST_VARS,$HTTP_GET_VARS,$HTTP_COOKIE_VARS; 	$OnLine = mysql_query("update admin set online='0' where uid='{$HTTP_COOKIE_VARS['coID']}'"); 	setcookie('cosesino');	setcookie("coID"); 	setcookie("coNama"); 	setcookie("coSebagai"); 	setcookie("coStatus"); 	setcookie("coSKPD"); 	setcookie("coUNIT"); 	setcookie("coSUBUNIT"); 	setcookie("coSEKSI"); 	setcookie("coModul"); 	setcookie("coLevel"); 	setcookie("coURUSAN"); 		setcookie("VulnWalkerUrusan");	setcookie("VulnWalkerBidang");	setcookie("VulnWalkerSKPD");	setcookie("VulnWalkerUnit");	setcookie("VulnWalkerSubUnit");	//setcookie("coDlmRibu");	return true; } function JmlOnLine() { 	global $USER_TIME_OUT;	$n = 0; 	$n = mysql_num_rows(mysql_query("select * from admin 				where online='1' and lastaktif <>'' 				and TIMESTAMPDIFF(MINUTE,lastaktif,now()) < ".$USER_TIME_OUT)); 	return $n; } function isUserTimeOut($user){	global $USER_TIME_OUT, $HTTP_COOKIE_VARS;	$isi = mysql_fetch_array( mysql_query('select TIMESTAMPDIFF(MINUTE,lastaktif,now()) as diff, sesino from admin where uid="'.$user.'"  ') );				//echo $isi['diff'].'<br>';	if ($isi['diff'] >= $USER_TIME_OUT  ){		return true;	}else{		return FALSE; 		}			}function isUserTimeOut2($user){	global $USER_TIME_OUT, $USER_TIME_OUT2, $HTTP_COOKIE_VARS;	$isi = mysql_fetch_array( mysql_query('select TIMESTAMPDIFF(MINUTE,lastaktif,now()) as diff, sesino from admin where uid="'.$user.'"  ') );				//echo $isi['diff'].'<br>';	$ut = $USER_TIME_OUT2 <> 0 ? $USER_TIME_OUT2 : $USER_TIME_OUT;	//if ($isi['diff'] >= $ut || $isi['sesino'] <> $HTTP_COOKIE_VARS['cosesino'] ){	if ($isi['diff'] >= $ut  ){		return true;	}else{		return FALSE; 		}			}Function CekLogin($cekTimeOut=TRUE) { 	global $USER_TIME_OUT, $HTTP_COOKIE_VARS, $HTTP_GET_VARS,$HTTP_COOKIE_VARS; 			if (isset($HTTP_COOKIE_VARS['coStatus'])) { 		if($HTTP_COOKIE_VARS['coStatus']) {			$user = $HTTP_COOKIE_VARS['coID'];						$isi = mysql_fetch_array( mysql_query('select online from admin where uid="'.$user.'"  ') );			//echo 'ol='.$isi['online'].'<br>';			if($isi['online'] == '1'){				//jika online, cek time out				if (isUserTimeOut( $user )==false ){					//jika belum timeout, cek sesi					$sesino = $HTTP_COOKIE_VARS['cosesino']; //echo $sesino;					$isi2 = mysql_fetch_array( mysql_query('select sesino from admin where uid="'.$user.'"  ') );										if ($isi2['sesino'] != $sesino){							//jika beda sesi return false (harus login)						return FALSE; //beda sesi					}else{						return TRUE;											}									}else{					if ($cekTimeOut) {						return FALSE; //sudah timeout					}else{						return TRUE;					}				}										} else { 				return false; //sudah logoff			} 		} else { 			return false; //sudah logoff		} 	}else{		return false;	}} function login_cekPasword($userID, $pass){	$errmsg = '';				$sqry = 'select * from admin where uid="'.$userID.'"';	$row = mysql_fetch_array(mysql_query($sqry));		return ($row['password'] == md5($pass) );}function login_cekUserBaru($userID){	$errmsg = '';		$sqry = 'select * from admin where uid="'.$userID.'"';	$row = mysql_num_rows(mysql_query($sqry));		//if (($errmsg =='')&&($row==0)){$errmsg = 'Nama User tidak ada!';}	//if (($errmsg =='')&&( cekPasword($userID, $pass) = FALSE )){$errmsg = 'Password Salah!';}		//if ($errmsg ==''){}		//return $errmsg	return $row==0;	}function login_getUser(){	global $HTTP_POST_VARS,$HTTP_COOKIE_VARS,$HTTP_GET_VARS; 	//$User = $HTTP_COOKIE_VARS['coID']; 	$User =$_COOKIE['coID'];	return $User;	}function login_getGroup(){	global $HTTP_POST_VARS,$HTTP_COOKIE_VARS,$HTTP_GET_VARS; 		$Group =$_COOKIE['coGroup'];	return $Group;	}function login_setUserCo($User){	global $HTTP_POST_VARS,$HTTP_COOKIE_VARS,$HTTP_GET_VARS; 	//setcookie('coID',$User);//$User = $HTTP_COOKIE_VARS['coID']; 	setcookie("coID",$User);//$HTTP_COOKIE_VARS['coID']:= $User;		//return $User;	}function login_getName(){	global $HTTP_POST_VARS,$HTTP_COOKIE_VARS,$HTTP_GET_VARS; 	$name = $HTTP_COOKIE_VARS['coNama']; 	return $name;	}function login_simpan($olduid, $uid, $pass, $namel){	global $cek;	$sqry = 'update admin 			set uid="'.$uid.'",			  password="'.md5($pass).'",			  nama ="'.$namel.'",			  online= 0			where uid="'.$olduid.'" limit 1';	$cek .='<br> sqrysimpan='.$sqry;	$row = mysql_query($sqry);}?>