-- MySQL dump 10.13  Distrib 5.5.44, for debian-linux-gnu (x86_64)
--
-- Host: localhost    Database: db_atisisbada_2017
-- ------------------------------------------------------
-- Server version	5.5.44-0+deb7u1
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `db_atisisbada_2017`.`bi_bef_ins` BEFORE INSERT ON `db_atisisbada_2017`.`buku_induk`
  FOR EACH ROW begin
/*************************
20161028 rusyad - program kegiatan , bk,ck,dk
20161031 rusyad - set utk mutasi/reklas, jns_hibah
*****************/

declare tgl_ba_, tgl_spk_ date;
declare no_ba_, no_spk_ varchar(200);
declare c_old_, d_old_ ,e_old_ char(2);
declare e1_old_ char(3);
declare asal_usul_awal_ char(1);
declare tgl_sensus_ date;
declare tahun_sensus_, bk_, ck_, dk_, bk_p_, ck_p_, dk_p_, p_, q_  int;
declare jns_hibah_, nmprogram_, nmkegiatan_ varchar(255);
declare thn_login_ integer;


#set new.idall=concat(new.a1,new.a,new.b,new.c,new.d,new.e,new.e1,new.f,new.g,new.h,new.i,new.j,new.thn_perolehan,new.noreg);
#set new.idall2=concat(new.a1,new.a,new.b,new.c,new.d, substr(new.thn_perolehan,3,2), new.e,new.e1,new.f,new.g,new.h,new.i,new.j,new.noreg);
set new.idall=concat(new.a1,new.a,new.b,new.c1,new.c,new.d,new.e,new.e1,new.f,new.g,new.h,new.i,new.j,new.thn_perolehan,new.noreg);
set new.idall2=concat(new.a1,new.a,new.b,new.c1,new.c,new.d, substr(new.thn_perolehan,3,2), new.e,new.e1,new.f,new.g,new.h,new.i,new.j,new.noreg);

set new.tgl_create = now();
set new.uid_create = new.uid;

/***
# mutasi balai sementara ditutup
if( new.asal_usul=4 or new.asal_usul=5) and new.id_lama is not null then
  select c,d,e,e1
    into c_old_, d_old_ ,e_old_, e1_old_
    from buku_induk where id = new.id_lama;
   #20160417 detek mutasi balai
  if new.asal_usul = 4  and new.c = c_old_ and new.d = d_old_ then
     update penghapusan set mutasi=3 where id_bukuinduk = new.id_lama;
     set new.asal_usul = 7;
  end if; #if asal_usul mutasi balai
end if; #if asal_usul mutasi/reklas
**/

#isi nm program dan kegiatan
if new.p <>'' or new.p is not null then
   select nama into nmprogram_ from ref_program where bk=new.bk_p and ck=new.ck_p and dk=new.dk_p and p=new.p and q= 0;
   set new.nmprogram = nmprogram_;   
   select nama into nmkegiatan_ from ref_program where bk=new.bk_p and ck=new.ck_p and dk=new.dk_p and p=new.p and q= new.q;
   set new.nmkegiatan = nmkegiatan_;
end if;

# set untuk barang mutasi/reklas
#if new.idawal is not null or new.idawal<> '' then
  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
  
if new.id_lama is not null and new.id_lama <> '' and year(new.tgl_buku) >= thn_login_ then
   select asal_usul, no_ba, tgl_ba, no_spk, tgl_spk,   
     tgl_sensus, tahun_sensus, bk, ck, dk, bk_p, ck_p, dk_p, p, q, nmprogram, nmkegiatan, jns_hibah
     into asal_usul_awal_ , no_ba_, tgl_ba_, no_spk_, tgl_spk_,     
     tgl_sensus_, tahun_sensus_, bk_, ck_, dk_, bk_p_, ck_p_, dk_p_, p_, q_, nmprogram_, nmkegiatan_, jns_hibah_
     from buku_induk where id = new.id_lama;
   set new.asal_usul_awal = asal_usul_awal_;   
   if  new.no_ba is null or new.no_ba='' then
     set new.no_ba = no_ba_;
     set new.tgl_ba = tgl_ba_;   
   end if;
   set new.no_spk = no_spk_;
   set new.tgl_spk = tgl_spk_;     

   set new.tgl_sensus = tgl_sensus_;
   set new.tahun_sensus= tahun_sensus_;
   set new.bk = bk_;
   set new.ck = ck_;
   set new.dk = dk_;
   set new.bk_p = bk_p_;
   set new.ck_p = ck_p_;
   set new.dk_p = dk_p_;
   set new.p = p_;
   set new.q = q_;
   set new.nmprogram = nmprogram_;
   set new.nmkegiatan = nmkegiatan_;

   set new.jns_hibah = jns_hibah_;
   
end if;



end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `db_atisisbada_2017`.`bi_aft_ins` AFTER INSERT ON `db_atisisbada_2017`.`buku_induk`
  FOR EACH ROW /**************************************
# 20160927  
- insert kondisi awal ke t_kondisi
- tgl create t_history_aset
20180225 rusyad kompatible urudan buku_induk_del
**************************************/
begin
declare refid_, jns_, idbi_awal_ int;
declare cek_ text;
declare hrg_perolehan_, nilai_susut_ decimal(18,2);
declare tgl_periode_ date;


if new.id_lama is NULL or new.id_lama = '' then


  # insert t_history_aset --------------------------------------------------------------------
  set jns_ = 1;
  set refid_ = new.id;
  insert into t_history_aset
    (tgl,idbi,uid,tgl_update,staset,staset_baru,div_staset,idbi_awal,jns,refid, tgl_create, uid_create)
    values
    (new.tgl_buku, new.id, new.uid, now(), 0, new.staset, new.staset, new.id, jns_, refid_, now(), new.uid );

  # insert perubahan kondisi -----------------------------------------------------------------  
  insert into t_kondisi
     (tgl,idbi,idbi_awal,kond_awal,kond_akhir,dif_kondisi,ket,tgl_update,uid, tgl_create, uid_create)
     values
     (new.tgl_buku, new.id, new.id, 0, new.kondisi, new.kondisi, '', now(), new.uid, now(), new.uid) ;

  #jurnal penatausahaan baru -----------------------------------------------------------------
  call sp_jurnal_bi(new.id);    


end if;

/***
#simpan ke buku_induk_thn    ------------------------------------------------------------------------------------
  set idbi_awal_ = 0;  
  set hrg_perolehan_ = 0;      
  if new.id_lama is NULL or new.id_lama = '' then
    set hrg_perolehan_ = new.jml_harga;    
    set nilai_susut_ =0 ;    
    set idbi_awal_ = new.id;
  else 
    select get_nilai_rehab(new.id, new.idawal, new.tgl_buku )  into  hrg_perolehan_ ;                  
    set hrg_perolehan_ = hrg_perolehan_ + new.jml_harga;
    select sf_getAkumSusut(new.id, new.tgl_buku) into nilai_susut_;        
    if nilai_susut_ is null or nilai_susut_='' then  
       set nilai_susut_ = 0;  
    end if ;
    set idbi_awal_ = new.idawal;
  end if;

  set tgl_periode_ = concat(year(new.tgl_buku), '-12-31' );

  insert into buku_induk_thn
     (tgl_periode, idbi, idawal, jml_harga, nilai_susut, kondisi, status_barang, ref_idpemegang, ref_idpenanggung, ref_idruang, tahun_sensus, ref_idpemegang2,
      staset, idall, a1, a, b, c, d, e, e1, f, g, h, i, j, noreg, thn_perolehan, jml_barang, satuan, harga, asal_usul,tgl_update, gambar, dokumen, dokumen_ket,
      dokumen_file, nilai_appraisal, tgl_buku, uid, id_lama, tgl_sensus, jml_barang_tmp, jml_gambar, idall2, status_penguasaan, verifikasi, harga_beli, harga_atribusi,
      ref_idatribusi, masa_manfaat, nilai_sisa, thn_susut_aw, thn_susut_ak, bln_susut_aw, bln_susut_ak, ref_idstatussurvey, stusul, stmigrasi, ka, kb, kc, kd, ke, kf,
      no_ba, tgl_ba, thn_akun, penggunaan, no_spk, tgl_spk, jns_ekstra, jns_lain, masa_manfaat_tot, tgl_create, uid_create, asal_usul_awal, stop_susut, jns_hibah,
      no_barang, kampung, rt, rw)
   values 
     (tgl_periode_, new.id, idbi_awal_, hrg_perolehan_, nilai_susut_, new.kondisi, new.status_barang, new.ref_idpemegang, new.ref_idpenanggung, new.ref_idruang, new.tahun_sensus, new.ref_idpemegang2,
      new.staset, new.idall, new.a1, new.a, new.b, new.c, new.d, new.e, new.e1, new.f, new.g, new.h, new.i, new.j, new.noreg, new.thn_perolehan, new.jml_barang, new.satuan, new.harga, new.asal_usul, new.tgl_update, new.gambar, new.dokumen, new.dokumen_ket,
      new.dokumen_file, new.nilai_appraisal, new.tgl_buku, new.uid, new.id_lama, new.tgl_sensus, new.jml_barang_tmp, new.jml_gambar, new.idall2, new.status_penguasaan, new.verifikasi, new.harga_beli, new.harga_atribusi,
      new.ref_idatribusi, new.masa_manfaat, new.nilai_sisa, new.thn_susut_aw, new.thn_susut_ak, new.bln_susut_aw, new.bln_susut_ak, new.ref_idstatussurvey, new.stusul, new.stmigrasi, new.ka, new.kb, new.kc, new.kd, new.ke, new.kf,
      new.no_ba, new.tgl_ba, new.thn_akun, new.penggunaan, new.no_spk, new.tgl_spk, new.jns_ekstra, new.jns_lain, new.masa_manfaat_tot, new.tgl_create, new.uid_create, new.asal_usul_awal, new.stop_susut, new.jns_hibah,
      new.no_barang, new.kampung, new.rt, new.rw);       
**/

#history 

insert into buku_induk_del 
( tgl, jns_hist, idbi,idall,a1,a,b,c1,c,d,e,e1,f,g,h,i,j,noreg,thn_perolehan,
jml_barang,satuan,harga,jml_harga,asal_usul,kondisi,status_barang,
tgl_update,tahun,gambar,dokumen,dokumen_ket,dokumen_file,nilai_appraisal,
tgl_buku,uid,id_lama,tgl_sensus,jml_barang_tmp,idawal,jml_gambar,idall2,
ref_idpemegang,ref_idpenanggung,ref_idruang,tahun_sensus,ref_idpemegang2,
status_penguasaan,staset,verifikasi,harga_beli,harga_atribusi,ref_idatribusi,
masa_manfaat,nilai_sisa,thn_susut_aw,thn_susut_ak,bln_susut_aw,bln_susut_ak,
ref_idstatussurvey,stusul,stmigrasi,ka,kb,kc,kd,ke,kf,no_ba,tgl_ba,thn_akun,
penggunaan,no_spk,tgl_spk,jns_ekstra,jns_lain,masa_manfaat_tot,tgl_create,uid_create,
asal_usul_awal,stop_susut,jns_hibah,no_barang,kampung,rt,rw )
values 
( now(), 0, new.id, new.idall, new.a1, new.a, new.b, new.c1, new.c, new.d, new.e, new.e1, new.f, new.g, new.h, new.i, new.j, new.noreg, new.thn_perolehan,
 new.jml_barang, new.satuan, new.harga, new.jml_harga, new.asal_usul, new.kondisi, new.status_barang, 
 new.tgl_update, new.tahun, new.gambar, new.dokumen, new.dokumen_ket,  new.dokumen_file, new.nilai_appraisal, 
 new.tgl_buku, new.uid, new.id_lama, new.tgl_sensus, new.jml_barang_tmp, new.idawal, new.jml_gambar, new.idall2, 
 new.ref_idpemegang, new.ref_idpenanggung, new.ref_idruang, new.tahun_sensus, new.ref_idpemegang2, 
 new.status_penguasaan, new.staset, new.verifikasi, new.harga_beli, new.harga_atribusi, new.ref_idatribusi, 
 new.masa_manfaat, new.nilai_sisa, new.thn_susut_aw, new.thn_susut_ak, new.bln_susut_aw, new.bln_susut_ak,
 new.ref_idstatussurvey, new.stusul, new.stmigrasi,    new.ka, new.kb, new.kc, new.kd, new.ke, new.kf, new.no_ba, new.tgl_ba, new.thn_akun,
 new.penggunaan, new.no_spk, new.tgl_spk, new.jns_ekstra, new.jns_lain, new.masa_manfaat_tot, new.tgl_create, new.uid_create, 
 new.asal_usul_awal, new.stop_susut, new.jns_hibah, new.no_barang, new.kampung, new.rt, new.rw );

/***
# insert backup -----------------------------------------------------------------------------------------------
insert into db_sislog_tmp_v2.temp1 ( tgl, idbi, a1, a, b, c, d, e,e1, f, g, h, i, j,
  noreg, thn_perolehan, jml_barang, satuan, harga, jml_harga, asal_usul,
  kondisi, status_barang, tgl_update, tahun, gambar,
  dokumen, dokumen_ket, dokumen_file, nilai_appraisal,
  tgl_buku, uid, id_lama, tgl_sensus, jml_barang_tmp, idawal, st,
  ref_idpemegang,ref_idpenanggung,ref_idruang,tahun_sensus,ref_idpemegang2)
values
( now(),
  new.id, new.a1, new.a, new.b, new.c, new.d, new.e,new.e1, new.f, new.g, new.h, new.i, new.j,
  new.noreg, new.thn_perolehan, new.jml_barang, new.satuan, new.harga, new.jml_harga, new.asal_usul,
  new.kondisi, new.status_barang, new.tgl_update, new.tahun, new.gambar,
  new.dokumen, new.dokumen_ket, new.dokumen_file, new.nilai_appraisal,
  new.tgl_buku, new.uid, new.id_lama, new.tgl_sensus, new.jml_barang_tmp, new.idawal, 2,
  new.ref_idpemegang, new.ref_idpenanggung, new.ref_idruang, new.tahun_sensus, new.ref_idpemegang2);  
***/
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `bi_bef_upd` BEFORE UPDATE ON `buku_induk`
  FOR EACH ROW begin

declare nmprogram_, nmkegiatan_ varchar(255);





if new.c1 <> old.c1 or new.c<>old.c or new.d<>old.d or new.e<>old.e or new.e1<>old.e1 
  or  new.f <> old.f or new.g<>old.g or new.h<>old.h or new.i<>old.i or new.j<>old.j  then
  set new.idall=concat(new.a1,new.a,new.b,new.c1,new.c,new.d,new.e,new.e1,new.f,new.g,new.h,new.i,new.j,new.thn_perolehan,new.noreg);
  set new.idall2=concat(new.a1,new.a,new.b,new.c1,new.c,new.d, substr(new.thn_perolehan,3,2), new.e,new.e1,new.f,new.g,new.h,new.i,new.j,new.noreg);
end if ;


if new.p <>'' or new.p is not null then
   select nama into nmprogram_ from ref_program where bk=new.bk_p and ck=new.ck_p and dk=new.dk_p and p=new.p and q= 0;
   set new.nmprogram = nmprogram_;   
   select nama into nmkegiatan_ from ref_program where bk=new.bk_p and ck=new.ck_p and dk=new.dk_p and p=new.p and q= new.q;
   set new.nmkegiatan = nmkegiatan_;
end if;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `db_atisisbada_2017`.`bi_aft_upd` AFTER UPDATE ON `db_atisisbada_2017`.`buku_induk`
  FOR EACH ROW begin
/***
20180225 rusyad kompatible urudan buku_induk_del
***/
declare a_ int;
declare cek_ text;
declare tgl_periode_ date;

#select sf_isi_bi_thn_harga(old.id, old.tgl_buku, -1*old.jml_harga  ) into cek_;
#select sf_isi_bi_thn_harga(new.id, new.tgl_buku, new.jml_harga  ) into cek_;
# sudah di php
#select sf_isi_bi_thn_kondisi(old.id, old.tgl_buku, -1*old.kondisi  ) into cek_;
#select sf_isi_bi_thn_kondisi(new.id, new.tgl_buku, new.kondisi  ) into cek_;

# edit buk_induk tahun untuk awal harga, kondisi, staset ---------------------------
/***
if (new.status_barang=1 and old.status_barang = new.status_barang) then
   set tgl_periode_ = concat(year(old.tgl_buku), '-12-31' );
   update buku_induk_thn
     set 
     #tgl_periode =tgl_periode_, 
     jml_harga= jml_harga+(new.jml_harga-old.jml_harga) 
     #kondisi=kondisi+(new.kondisi-old.kondisi), 
     #staset=staset+ (new.staset- old.staset)
   where   
     idbi = old.id and tgl_periode=tgl_periode_;     
end if;
***/



# backup delete ---------------------------------------------------------------
if old.f<>new.f or old.g<>new.g or old.tgl_buku<>new.tgl_buku or old.jml_harga<>new.jml_harga 
or old.harga_atribusi<>new.harga_atribusi or old.harga_beli<>new.harga_beli
or old.thn_perolehan<>new.thn_perolehan 
then
insert into buku_induk_del 
( tgl, jns_hist, idbi,idall,a1,a,b,c1,c,d,e,e1,f,g,h,i,j,noreg,thn_perolehan,
jml_barang,satuan,harga,jml_harga,asal_usul,kondisi,status_barang,
tgl_update,tahun,gambar,dokumen,dokumen_ket,dokumen_file,nilai_appraisal,
tgl_buku,uid,id_lama,tgl_sensus,jml_barang_tmp,idawal,jml_gambar,idall2,
ref_idpemegang,ref_idpenanggung,ref_idruang,tahun_sensus,ref_idpemegang2,
status_penguasaan,staset,verifikasi,harga_beli,harga_atribusi,ref_idatribusi,
masa_manfaat,nilai_sisa,thn_susut_aw,thn_susut_ak,bln_susut_aw,bln_susut_ak,
ref_idstatussurvey,stusul,stmigrasi,ka,kb,kc,kd,ke,kf,no_ba,tgl_ba,thn_akun,
penggunaan,no_spk,tgl_spk,jns_ekstra,jns_lain,masa_manfaat_tot,tgl_create,uid_create,
asal_usul_awal,stop_susut,jns_hibah,no_barang,kampung,rt,rw )
values 
( now(), 1, new.id, new.idall, new.a1, new.a, new.b, new.c1, new.c, new.d, new.e, new.e1, new.f, new.g, new.h, new.i, new.j, new.noreg, new.thn_perolehan,
 new.jml_barang, new.satuan, new.harga, new.jml_harga, new.asal_usul, new.kondisi, new.status_barang, 
 new.tgl_update, new.tahun, new.gambar, new.dokumen, new.dokumen_ket,  new.dokumen_file, new.nilai_appraisal, 
 new.tgl_buku, new.uid, new.id_lama, new.tgl_sensus, new.jml_barang_tmp, new.idawal, new.jml_gambar, new.idall2, 
 new.ref_idpemegang, new.ref_idpenanggung, new.ref_idruang, new.tahun_sensus, new.ref_idpemegang2, 
 new.status_penguasaan, new.staset, new.verifikasi, new.harga_beli, new.harga_atribusi, new.ref_idatribusi, 
 new.masa_manfaat, new.nilai_sisa, new.thn_susut_aw, new.thn_susut_ak, new.bln_susut_aw, new.bln_susut_ak,
 new.ref_idstatussurvey, new.stusul, new.stmigrasi,    new.ka, new.kb, new.kc, new.kd, new.ke, new.kf, new.no_ba, new.tgl_ba, new.thn_akun,
 new.penggunaan, new.no_spk, new.tgl_spk, new.jns_ekstra, new.jns_lain, new.masa_manfaat_tot, new.tgl_create, new.uid_create, 
 new.asal_usul_awal, new.stop_susut, new.jns_hibah, new.no_barang, new.kampung, new.rt, new.rw  );
end if;

/**
insert into db_sislog_tmp_v2.temp1 ( tgl, idbi, a1, a, b, c, d, e,e1, f, g, h, i, j,
  noreg, thn_perolehan, jml_barang, satuan, harga, jml_harga, asal_usul,
  kondisi, status_barang, tgl_update, tahun, gambar,
  dokumen, dokumen_ket, dokumen_file, nilai_appraisal,
  tgl_buku, uid, id_lama, tgl_sensus, jml_barang_tmp, idawal, st,
  ref_idpemegang,ref_idpenanggung,ref_idruang,tahun_sensus,ref_idpemegang2)
values
( now(),
  new.id, new.a1, new.a, new.b, new.c, new.d, new.e,new.e1, new.f, new.g, new.h, new.i, new.j,
  new.noreg, new.thn_perolehan, new.jml_barang, new.satuan, new.harga, new.jml_harga, new.asal_usul,
  new.kondisi, new.status_barang, new.tgl_update, new.tahun, new.gambar,
  new.dokumen, new.dokumen_ket, new.dokumen_file, new.nilai_appraisal,
  new.tgl_buku, new.uid, new.id_lama, new.tgl_sensus, new.jml_barang_tmp, new.idawal, 1,
  new.ref_idpemegang, new.ref_idpenanggung, new.ref_idruang, new.tahun_sensus, new.ref_idpemegang2
  );
**/
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `db_atisisbada_2017`.`bi_aft_del` AFTER DELETE ON `db_atisisbada_2017`.`buku_induk`
  FOR EACH ROW /*******************
20160926 rusyad - tambah backup dataa buku_induk yg dihapus
20160929 rusyad - delete t_kondisi
20161108 rusyad - delete kib g
20180225 rusyad kompatible urudan buku_induk_del
**************/
begin
declare cek_ text;

delete from buku_induk_thn where idbi = old.id;


# penyuutan ----------------------------------------------
delete from t_jurnal_penyusutan where idbi = old.id;
delete from penyusutan where idbi = old.id;

#jurnal -------------------------------------------------
#update jurnal set stbatal=1 where jns=1 and ref_id=old.id; #batalkan
  delete from t_transaksi where idbi= old.id;



# history aset ------------------------------------------
delete from t_asetlainlain where idbi = old.id;
delete from t_kapitalisasi where idbi = old.id;

delete from t_history_aset where idbi = old.id;

delete from t_kondisi where idbi = old.id;
delete from t_koreksi where idbi = old.id;

# delete kib ---------------------------------------------
if old.f = '01' then
  delete from kib_a where idbi = old.id;
elseif old.f = '02' then
  delete from kib_b where idbi = old.id;
elseif old.f = '03' then
  delete from kib_c where idbi = old.id;
elseif old.f = '04' then
  delete from kib_d where idbi = old.id;
elseif old.f = '05' then
  delete from kib_e where idbi = old.id;
elseif old.f = '06' then
  delete from kib_f where idbi = old.id;    
elseif old.f = '07' then
  delete from kib_g where idbi = old.id;
end if;

# delete pengecekan
delete from t_cek_bi where idbi = old.id;

# bck delete ------------------------------------------------
insert into buku_induk_del 
( tgl, jns_hist, idbi,idall,a1,a,b,c1,c,d,e,e1,f,g,h,i,j,noreg,thn_perolehan,
jml_barang,satuan,harga,jml_harga,asal_usul,kondisi,status_barang,
tgl_update,tahun,gambar,dokumen,dokumen_ket,dokumen_file,nilai_appraisal,
tgl_buku,uid,id_lama,tgl_sensus,jml_barang_tmp,idawal,jml_gambar,idall2,
ref_idpemegang,ref_idpenanggung,ref_idruang,tahun_sensus,ref_idpemegang2,
status_penguasaan,staset,verifikasi,harga_beli,harga_atribusi,ref_idatribusi,
masa_manfaat,nilai_sisa,thn_susut_aw,thn_susut_ak,bln_susut_aw,bln_susut_ak,
ref_idstatussurvey,stusul,stmigrasi,ka,kb,kc,kd,ke,kf,no_ba,tgl_ba,thn_akun,
penggunaan,no_spk,tgl_spk,jns_ekstra,jns_lain,masa_manfaat_tot,tgl_create,uid_create,
asal_usul_awal,stop_susut,jns_hibah,no_barang,kampung,rt,rw )
values 
( now(), 2, old.id, old.idall, old.a1, old.a, old.b, old.c1, old.c, old.d, old.e, old.e1, old.f, old.g, old.h, old.i, old.j, old.noreg, old.thn_perolehan,
 old.jml_barang, old.satuan, old.harga, old.jml_harga, old.asal_usul, old.kondisi, old.status_barang, 
 old.tgl_update, old.tahun, old.gambar, old.dokumen, old.dokumen_ket,  old.dokumen_file, old.nilai_appraisal, 
 old.tgl_buku, old.uid, old.id_lama, old.tgl_sensus, old.jml_barang_tmp, old.idawal, old.jml_gambar, old.idall2, 
 old.ref_idpemegang, old.ref_idpenanggung, old.ref_idruang, old.tahun_sensus, old.ref_idpemegang2, 
 old.status_penguasaan, old.staset, old.verifikasi, old.harga_beli, old.harga_atribusi, old.ref_idatribusi, 
 old.masa_manfaat, old.nilai_sisa, old.thn_susut_aw, old.thn_susut_ak, old.bln_susut_aw, old.bln_susut_ak,
 old.ref_idstatussurvey, old.stusul, old.stmigrasi,    old.ka, old.kb, old.kc, old.kd, old.ke, old.kf, old.no_ba, old.tgl_ba, old.thn_akun,
 old.penggunaan, old.no_spk, old.tgl_spk, old.jns_ekstra, old.jns_lain, old.masa_manfaat_tot, old.tgl_create, old.uid_create, 
 old.asal_usul_awal, old.stop_susut, old.jns_hibah, old.no_barang, old.kampung, old.rt, old.rw );

/***
# bck -------------------------------------------------------
insert into db_sislog_tmp_v2.temp1 ( tgl, idbi, a1, a, b, c, d, e,e1, f, g, h, i, j,
  noreg, thn_perolehan, jml_barang, satuan, harga, jml_harga, asal_usul,
  kondisi, status_barang, tgl_update, tahun, gambar,
  dokumen, dokumen_ket, dokumen_file, nilai_appraisal,
  tgl_buku, uid, id_lama, tgl_sensus, jml_barang_tmp, idawal,
  ref_idpemegang,ref_idpenanggung,ref_idruang,tahun_sensus,ref_idpemegang2)
values
( now(),
  old.id, old.a1, old.a, old.b, old.c, old.d, old.e,old.e1, old.f, old.g, old.h, old.i, old.j,
  old.noreg, old.thn_perolehan, old.jml_barang, old.satuan, old.harga, old.jml_harga, old.asal_usul,
  old.kondisi, old.status_barang, old.tgl_update, old.tahun, old.gambar,
  old.dokumen, old.dokumen_ket, old.dokumen_file, old.nilai_appraisal,
  old.tgl_buku, old.uid, old.id_lama, old.tgl_sensus, old.jml_barang_tmp, old.idawal,
  old.ref_idpemegang, old.ref_idpenanggung, old.ref_idruang, old.tahun_sensus, old.ref_idpemegang2);
***/
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `dkb_aft_del` AFTER DELETE ON `dkb`
  FOR EACH ROW begin
update rkb set stat = 0 where id = old.idrkb;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `dkpb_aft_del` AFTER DELETE ON `dkpb`
  FOR EACH ROW begin
update rkpb set stat = 2 where id = old.idrkpb; 

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `gambar_bef_ins` BEFORE INSERT ON `gambar`
  FOR EACH ROW begin

set new.tgl_create = now();
set new.uid_create = new.uid;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `gambar_aft_ins` AFTER INSERT ON `gambar` FOR EACH ROW begin
  update buku_induk set jml_gambar=coalesce(jml_gambar,0)+1 where id= new.idbi;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `gambar_aft_del` AFTER DELETE ON `gambar`
  FOR EACH ROW begin
  update buku_induk set jml_gambar=jml_gambar-1 where id= old.idbi and jml_gambar>0;

 insert gambar_hist
  (tgl,jns, idbi,nmfile,nmfile_asli,ket,stat,uid,tgl_update,tgl_create,uid_create)
 values
  ( now(),2,old.idbi, old.nmfile, old.nmfile_asli, old.ket, old.stat, old.uid, old.tgl_update, old.tgl_create, old.uid_create);

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `gantirugi_bef_ins` BEFORE INSERT ON `gantirugi`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `gantirugi_aft_ins` AFTER INSERT ON `gantirugi`
  FOR EACH ROW begin
declare tgl_periode_ date;
declare staset_,difstaset_ tinyint(3);

   


set staset_= new.staset;
set difstaset_=6 - staset_;
if new.no_sk <> '' and new.no_sk is not null then 
     update buku_induk set status_barang = 5 , staset=6 where id = new.id_bukuinduk;
     call sp_jurnal_gantirugi(new.id);
     insert into t_history_aset (tgl,tgl_create,uid_create,jns,refid,staset,staset_baru,div_staset,idbi,idbi_awal)
       values(new.tgl_gantirugi,new.tgl_create,new.uid_create,5,new.id,new.staset,6,difstaset_,new.id_bukuinduk,new.idbi_awal);

     
     set tgl_periode_ = concat(year(new.tgl_gantirugi), '-12-31');
     

  else 
     update buku_induk set stusul=4 where id = new.id_bukuinduk;
end if;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `gantirugi_aft_upd` AFTER UPDATE ON `gantirugi`
  FOR EACH ROW begin
declare i int;
declare tgl_periode_ date;
declare staset_,difstaset_ tinyint(3);

set staset_ = new.staset;
set difstaset_ = 6 - staset_;


   if new.no_sk <> '' and new.no_sk is not null then 
     
     
     call sp_jurnal_gantirugi(new.id);
     insert into t_history_aset (tgl,tgl_create,uid_create,jns,refid,staset,staset_baru,div_staset,idbi,idbi_awal)
         values(new.tgl_gantirugi,new.tgl_create,new.uid_create,5,new.id,new.staset,6,difstaset_,new.id_bukuinduk,new.idbi_awal);

     
     set tgl_periode_ = concat(year(new.tgl_gantirugi), '-12-31');
     

   end if;

  if new.no_sk <> old.no_sk and (new.no_sk is null or new.no_sk='')  then 

      update buku_induk set status_barang =1,staset = old.staset,stusul=0 where id = old.id_bukuinduk;
      delete from t_transaksi where jns_trans2=18 and refid= old.id;
      delete from  t_history_aset where refid = old.id and jns=5 and idbi=old.id_bukuinduk ;

      

      
     set tgl_periode_ = concat(year(old.tgl_gantirugi), '-12-31');
     
     
   end if;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `gantirugi_aft_del` AFTER DELETE ON `gantirugi`
  FOR EACH ROW begin
declare tgl_periode_ date;




if old.no_sk <> '' and old.no_sk is not null then 
    update buku_induk set status_barang = 1, staset = old.staset where id = old.id_bukuinduk;
    
    
    

    
    set tgl_periode_ = concat(year(old.tgl_gantirugi), '-12-31');  
    

  else 
    update buku_induk set stusul = 0 where id = old.id_bukuinduk;
  end if;


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `gantirugi_bayar_bef_ins` BEFORE INSERT ON `gantirugi_bayar`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.bayar = new.harga;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `gantirugi_bayar_aft_ins` AFTER INSERT ON `gantirugi_bayar`
  FOR EACH ROW begin
call sp_jurnal_gantirugi_bayar(new.Id);
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `gantirugi_bayar_aft_upd` AFTER UPDATE ON `gantirugi_bayar`
  FOR EACH ROW begin
call sp_jurnal_gantirugi_bayar(old.Id);
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `gantirugi_bayar_aft_del` AFTER DELETE ON `gantirugi_bayar`
  FOR EACH ROW begin
    delete from t_transaksi where jns_trans2=33 and refid= old.id and idbi= old.id_bukuinduk;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kiba_aft_ins` AFTER INSERT ON `kib_a`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp2
( tgl, idkib,
  a1, a, b, c, d, e, e1,f, g, h, i, j, noreg,
  luas, alamat, alamat_a, alamat_b,alamat_c, alamat_kel,
  alamat_kec, koordinat_gps, koord_bidang, status_hak,
  bersertifikat, sertifikat_tgl, sertifikat_no, penggunaan,
  ket, tahun, kota, idbi, st)
values (
 now(), new.id,
  new.a1, new.a, new.b, new.c, new.d, new.e,new.e1, new.f, new.g, new.h, new.i, new.j, new.noreg,
  new.luas, new.alamat, new.alamat_a, new.alamat_b, new.alamat_c, new.alamat_kel,
  new.alamat_kec, new.koordinat_gps, new.koord_bidang, new.status_hak,
  new.bersertifikat, new.sertifikat_tgl, new.sertifikat_no, new.penggunaan,
  new.ket, new.tahun, new.kota, new.idbi, 2
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kiba_aft_upd` AFTER UPDATE ON `kib_a`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp2
( tgl, idkib,
  a1, a, b, c, d, e,e1, f, g, h, i, j, noreg,
  luas, alamat, alamat_a, alamat_b, alamat_c, alamat_kel,
  alamat_kec, koordinat_gps, koord_bidang, status_hak,
  bersertifikat, sertifikat_tgl, sertifikat_no, penggunaan,
  ket, tahun, kota, idbi, st)
values (
 now(), old.id,
  old.a1, old.a, old.b, old.c, old.d, old.e,old.e1, old.f, old.g, old.h, old.i, old.j, old.noreg,
  old.luas, old.alamat, old.alamat_a, old.alamat_b,old.alamat_c, old.alamat_kel,
  old.alamat_kec, old.koordinat_gps, old.koord_bidang, old.status_hak,
  old.bersertifikat, old.sertifikat_tgl, old.sertifikat_no, old.penggunaan,
  old.ket, old.tahun, old.kota, old.idbi, 1
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kiba_aft_del` AFTER DELETE ON `kib_a`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp2
( tgl, idkib,
  a1, a, b, c, d, e,e1, f, g, h, i, j, noreg,
  luas, alamat, alamat_a, alamat_b,alamat_c, alamat_kel,
  alamat_kec, koordinat_gps, koord_bidang, status_hak,
  bersertifikat, sertifikat_tgl, sertifikat_no, penggunaan,
  ket, tahun, kota, idbi)
values (
 now(), old.id,
  old.a1, old.a, old.b, old.c, old.d, old.e, old.e1, old.f, old.g, old.h, old.i, old.j, old.noreg,
  old.luas, old.alamat, old.alamat_a, old.alamat_b,old.alamat_c, old.alamat_kel,
  old.alamat_kec, old.koordinat_gps, old.koord_bidang, old.status_hak,
  old.bersertifikat, old.sertifikat_tgl, old.sertifikat_no, old.penggunaan,
  old.ket, old.tahun, old.kota, old.idbi
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibb_aft_ins` AFTER INSERT ON `kib_b`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp3
( tgl, idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg,
  merk, ukuran, bahan, no_pabrik, no_rangka, no_mesin, no_polisi, no_bpkb,
  ket, tahun, idbi, st
) values (
  now(), new.id, new.a1, new.a, new.b, new.c, new.d, new.e, new.e1,
  new.f, new.g, new.h, new.i, new.j, new.noreg,
  new.merk, new.ukuran, new.bahan, new.no_pabrik, new.no_rangka, new.no_mesin, new.no_polisi, new.no_bpkb,
  new.ket, new.tahun, new.idbi, 2
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibb_aft_upd` AFTER UPDATE ON `kib_b`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp3
( tgl, idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg,
  merk, ukuran, bahan, no_pabrik, no_rangka, no_mesin, no_polisi, no_bpkb,
  ket, tahun, idbi, st
) values (
  now(), old.id, old.a1, old.a, old.b, old.c, old.d, old.e,old.e1,
  old.f, old.g, old.h, old.i, old.j, old.noreg,
  old.merk, old.ukuran, old.bahan, old.no_pabrik, old.no_rangka, old.no_mesin, old.no_polisi, old.no_bpkb,
  old.ket, old.tahun, old.idbi, 1
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibb_aft_del` AFTER DELETE ON `kib_b`
  FOR EACH ROW begin 
declare i int;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibc_aft_ins` AFTER INSERT ON `kib_c`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp4
( tgl,
  idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg,
  kondisi, kondisi_bangunan, konstruksi_tingkat, konstruksi_beton,
  luas_lantai, alamat, alamat_a, alamat_b,alamat_c, alamat_kel, alamat_kec, koordinat_gps, koord_bidang,
  dokumen_tgl, dokumen_no, luas, status_tanah, kode_tanah, ket,
  tahun, idbi, kode_loktanah, st,kota
) values (
  now(), new.id, new.a1, new.a, new.b, new.c, new.d, new.e,new.e1,
  new.f, new.g, new.h, new.i, new.j, new.noreg,
  new.kondisi, new.kondisi_bangunan, new.konstruksi_tingkat, new.konstruksi_beton,
  new.luas_lantai, new.alamat, new.alamat_a, new.alamat_b,new.alamat_c, new.alamat_kel, new.alamat_kec, new.koordinat_gps, new.koord_bidang,
  new.dokumen_tgl, new.dokumen_no, new.luas, new.status_tanah, new.kode_tanah, new.ket,
  new.tahun, new.idbi, new.kode_loktanah, 2,new.kota
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibc_aft_upd` AFTER UPDATE ON `kib_c`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp4
( tgl,
  idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg,
  kondisi, kondisi_bangunan, konstruksi_tingkat, konstruksi_beton,
  luas_lantai, alamat, alamat_a, alamat_b,alamat_c, alamat_kel, alamat_kec, koordinat_gps, koord_bidang,
  dokumen_tgl, dokumen_no, luas, status_tanah, kode_tanah, ket,
  tahun, idbi, kode_loktanah, st,kota
) values (
  now(), old.id, old.a1, old.a, old.b, old.c, old.d, old.e,old.e1,
  old.f, old.g, old.h, old.i, old.j, old.noreg,
  old.kondisi, old.kondisi_bangunan, old.konstruksi_tingkat, old.konstruksi_beton,
  old.luas_lantai, old.alamat, old.alamat_a, old.alamat_b, old.alamat_c, old.alamat_kel, old.alamat_kec, old.koordinat_gps, old.koord_bidang,
  old.dokumen_tgl, old.dokumen_no, old.luas, old.status_tanah, old.kode_tanah, old.ket,
  old.tahun, old.idbi, old.kode_loktanah, 1,old.kota
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibc_aft_del` AFTER DELETE ON `kib_c`
  FOR EACH ROW begin
declare i int;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibd_aft_ins` AFTER INSERT ON `kib_d`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp5 (
 tgl, idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg,
  konstruksi, panjang, lebar, luas, alamat, alamat_a, alamat_b, alamat_c, alamat_kel, alamat_kec,
  koordinat_gps, koord_bidang, dokumen_tgl, dokumen_no, status_tanah, kode_tanah,
  kondisi, ket, tahun, idbi, st,kota
) values (
  now(), new.id, new.a1, new.a, new.b, new.c, new.d, new.e,new.e1,
  new.f, new.g, new.h, new.i, new.j, new.noreg,
  new.konstruksi, new.panjang, new.lebar, new.luas, new.alamat, new.alamat_a, new.alamat_b,new.alamat_c, new.alamat_kel, new.alamat_kec,
  new.koordinat_gps, new.koord_bidang, new.dokumen_tgl, new.dokumen_no, new.status_tanah, new.kode_tanah,
  new.kondisi, new.ket, new.tahun, new.idbi, 2,new.kota
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibd_aft_upd` AFTER UPDATE ON `kib_d`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp5 (
 tgl, idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg,
  konstruksi, panjang, lebar, luas, alamat, alamat_a, alamat_b,alamat_c, alamat_kel, alamat_kec,
  koordinat_gps, koord_bidang, dokumen_tgl, dokumen_no, status_tanah, kode_tanah,
  kondisi, ket, tahun, idbi, st,kota
) values (
  now(), old.id, old.a1, old.a, old.b, old.c, old.d, old.e, old.e1,
  old.f, old.g, old.h, old.i, old.j, old.noreg,
  old.konstruksi, old.panjang, old.lebar, old.luas, old.alamat, old.alamat_a, old.alamat_b,old.alamat_c, old.alamat_kel, old.alamat_kec,
  old.koordinat_gps, old.koord_bidang, old.dokumen_tgl, old.dokumen_no, old.status_tanah, old.kode_tanah,
  old.kondisi, old.ket, old.tahun, old.idbi, 2,old.kota
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibd_aft_del` AFTER DELETE ON `kib_d`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp5 (
 tgl, idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg,
  konstruksi, panjang, lebar, luas, alamat, alamat_a, alamat_b,alamat_c, alamat_kel, alamat_kec,
  koordinat_gps, koord_bidang, dokumen_tgl, dokumen_no, status_tanah, kode_tanah,
  kondisi, ket, tahun, idbi,kota
) values (
  now(), old.id, old.a1, old.a, old.b, old.c, old.d, old.e,old.e1,
  old.f, old.g, old.h, old.i, old.j, old.noreg,
  old.konstruksi, old.panjang, old.lebar, old.luas, old.alamat, old.alamat_a, old.alamat_b, old.alamat_c, old.alamat_kel, old.alamat_kec,
  old.koordinat_gps, old.koord_bidang, old.dokumen_tgl, old.dokumen_no, old.status_tanah, old.kode_tanah,
  old.kondisi, old.ket, old.tahun, old.idbi, old.kota
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibe_aft_ins` AFTER INSERT ON `kib_e`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp6
( tgl, idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg,
  buku_judul, buku_spesifikasi, seni_asal_daerah, seni_pencipta, seni_bahan,
  hewan_jenis, hewan_ukuran, ket, tahun, idbi, st
) values (
 now(), new.id, new.a1, new.a, new.b, new.c, new.d, new.e, new.e1,
  new.f, new.g, new.h, new.i, new.j, new.noreg,
  new.buku_judul, new.buku_spesifikasi, new.seni_asal_daerah, new.seni_pencipta, new.seni_bahan,
  new.hewan_jenis, new.hewan_ukuran, new.ket, new.tahun, new.idbi, 2
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibe_aft_upd` AFTER UPDATE ON `kib_e`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp6
( tgl, idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg,
  buku_judul, buku_spesifikasi, seni_asal_daerah, seni_pencipta, seni_bahan,
  hewan_jenis, hewan_ukuran, ket, tahun, idbi, st
) values (
 now(), old.id, old.a1, old.a, old.b, old.c, old.d, old.e,old.e1,
  old.f, old.g, old.h, old.i, old.j, old.noreg,
  old.buku_judul, old.buku_spesifikasi, old.seni_asal_daerah, old.seni_pencipta, old.seni_bahan,
  old.hewan_jenis, old.hewan_ukuran, old.ket, old.tahun, old.idbi, 1
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibe_aft_del` AFTER DELETE ON `kib_e`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp6
( tgl, idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg,
  buku_judul, buku_spesifikasi, seni_asal_daerah, seni_pencipta, seni_bahan,
  hewan_jenis, hewan_ukuran, ket, tahun, idbi
) values (
 now(), old.id, old.a1, old.a, old.b, old.c, old.d, old.e,old.e1,
  old.f, old.g, old.h, old.i, old.j, old.noreg,
  old.buku_judul, old.buku_spesifikasi, old.seni_asal_daerah, old.seni_pencipta, old.seni_bahan,
  old.hewan_jenis, old.hewan_ukuran, old.ket, old.tahun, old.idbi
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibf_aft_ins` AFTER INSERT ON `kib_f`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp7
(  tgl, idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j,
  noreg, bangunan, konstruksi_tingkat, konstruksi_beton, luas,
  alamat, alamat_a, alamat_b,alamat_c, alamat_kel, alamat_kec,
  koordinat_gps, koord_bidang, dokumen_tgl, dokumen_no,
  tmt, status_tanah, kode_tanah, ket, tahun, idbi, st,kota
) values (
  now(), new.id, new.a1, new.a, new.b, new.c, new.d, new.e,new.e1,
  new.f, new.g, new.h, new.i, new.j,
  new.noreg, new.bangunan, new.konstruksi_tingkat, new.konstruksi_beton, new.luas,
  new.alamat, new.alamat_a, new.alamat_b,new.alamat_c, new.alamat_kel, new.alamat_kec,
  new.koordinat_gps, new.koord_bidang, new.dokumen_tgl, new.dokumen_no,
  new.tmt, new.status_tanah, new.kode_tanah, new.ket, new.tahun, new.idbi, 2,new.kota
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibf_aft_upd` AFTER UPDATE ON `kib_f`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp7
(  tgl, idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j,
  noreg, bangunan, konstruksi_tingkat, konstruksi_beton, luas,
  alamat, alamat_a, alamat_b,alamat_c, alamat_kel, alamat_kec,
  koordinat_gps, koord_bidang, dokumen_tgl, dokumen_no,
  tmt, status_tanah, kode_tanah, ket, tahun, idbi, st,kota
) values (
  now(), old.id, old.a1, old.a, old.b, old.c, old.d, old.e,old.e1,
  old.f, old.g, old.h, old.i, old.j,
  old.noreg, old.bangunan, old.konstruksi_tingkat, old.konstruksi_beton, old.luas,
  old.alamat, old.alamat_a, old.alamat_b,old.alamat_c, old.alamat_kel, old.alamat_kec,
  old.koordinat_gps, old.koord_bidang, old.dokumen_tgl, old.dokumen_no,
  old.tmt, old.status_tanah, old.kode_tanah, old.ket, old.tahun, old.idbi, 1,old.kota
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `kibf_aft_del` AFTER DELETE ON `kib_f`
  FOR EACH ROW insert into db_sislog_tmp_v2.temp7
(  tgl, idkib, a1, a, b, c, d, e,e1,
  f, g, h, i, j,
  noreg, bangunan, konstruksi_tingkat, konstruksi_beton, luas,
  alamat, alamat_a, alamat_b,alamat_c, alamat_kel, alamat_kec,
  koordinat_gps, koord_bidang, dokumen_tgl, dokumen_no,
  tmt, status_tanah, kode_tanah, ket, tahun, idbi,kota
) values (
  now(), old.id, old.a1, old.a, old.b, old.c, old.d, old.e,old.e1,
  old.f, old.g, old.h, old.i, old.j,
  old.noreg, old.bangunan, old.konstruksi_tingkat, old.konstruksi_beton, old.luas,
  old.alamat, old.alamat_a, old.alamat_b,old.alamat_c, old.alamat_kel, old.alamat_kec,
  old.koordinat_gps, old.koord_bidang, old.dokumen_tgl, old.dokumen_no,
  old.tmt, old.status_tanah, old.kode_tanah, old.ket, old.tahun, old.idbi,old.kota
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemanfaatan_bef_ins` BEFORE INSERT ON `pemanfaatan`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemanfaatan_aft_ins` AFTER INSERT ON `pemanfaatan`
  FOR EACH ROW begin
declare difstaset_ char(3);
declare refid_ ,jns_,isi_staset int;
declare tgl_periode_ date;

  
 call sp_jurnal_pemanfaatan(new.id);
SET sql_mode = 'NO_UNSIGNED_SUBTRACTION';
set jns_ = 6;
set difstaset_ = 7 - new.staset;
set refid_ = new.id;
if new.bentuk_pemanfaatan != 2 then
   set isi_staset = 7;
else
   set isi_staset = new.staset;
end if;
if new.bentuk_pemanfaatan != 2 then
  insert into t_history_aset
    (tgl,idbi,uid,tgl_update,staset,staset_baru,div_staset,idbi_awal,jns,refid, tgl_create, uid_create)
    values
    (new.tgl_pemanfaatan, new.id_bukuinduk, new.uid, now(), new.staset, 7, difstaset_ , new.idbi_awal, jns_, refid_, new.tgl_create, new.uid );
end if;
update buku_induk set status_barang = 2,staset=isi_staset where id = new.id_bukuinduk;


  set tgl_periode_ = concat(year(new.tgl_pemanfaatan), '-12-31');
  

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemanfaatan_aft_upd` AFTER UPDATE ON `pemanfaatan`
  FOR EACH ROW begin
declare tgl_periode_ date ;
declare jns_,stasetbaru_,difstaset_ tinyint (3);
set jns_ = 6;


  if old.tgl_pemanfaatan<>new.tgl_pemanfaatan or new.bentuk_pemanfaatan != 2 then
    update t_history_aset set tgl=new.tgl_pemanfaatan where jns=jns_ and refid=new.id;
    
    
  end if;
  


call sp_jurnal_pemanfaatan(new.id);
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemanfaatan_aft_del` AFTER DELETE ON `pemanfaatan`
  FOR EACH ROW begin
declare i_ int;
declare tgl_periode_ date;

  
  delete from t_transaksi where jns_trans2=19 and refid= old.id;
  delete from t_history_aset where jns=6 and refid= old.id;
  

update buku_induk set status_barang = 1,staset=old.staset where id = old.id_bukuinduk;


  set tgl_periode_ = concat(year(old.tgl_pemanfaatan), '-12-31');  
  

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemeliharaan_bef_ins` BEFORE INSERT ON `pemeliharaan`
  FOR EACH ROW begin
declare staset_, idlama_, idawal_ int;
declare jml_harga_ decimal(18,2);
declare f_,g_,h_,i_ char(2);
declare j_ char(3);
declare f1_,f2_ char(1);
  set new.tgl_create = now();
  set new.uid_create = new.uid;

select jml_harga,f1,f2,f,g,h,i,j,staset, idawal into jml_harga_,f1_,f2_,f_,g_,h_,i_,j_,staset_, idawal_ from buku_induk where id = new.id_bukuinduk ;

set new.idbi_awal = idawal_;
set new.staset = staset_;

  if new.tgl_perolehan is null then
    set new.tgl_perolehan = new.tgl_pemeliharaan;
  end if;

 

  
  
    
    
    

  

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemeliharaan_aft_ins` AFTER INSERT ON `pemeliharaan`
  FOR EACH ROW begin

declare i int;
declare cek_ text;
  
call sp_jurnal_pemeliharaan(new.id);


























end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemeliharaan_bef_upd` BEFORE UPDATE ON `pemeliharaan`
  FOR EACH ROW begin

declare staset_, idlama_, idawal_ int;
declare jml_harga_ decimal(18,2);
declare f_,g_,h_,i_ char(2);
declare f1_,f2_ char(1);
declare j_ char(3);



  if new.tgl_perolehan is null then
    set new.tgl_perolehan = new.tgl_pemeliharaan;
  end if;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemeliharaan_aft_upd` AFTER UPDATE ON `pemeliharaan`
  FOR EACH ROW begin
declare i_ int;
declare cek_ text;

if old.tgl_pemeliharaan <> new.tgl_pemeliharaan or old.cara_perolehan <> new.cara_perolehan or old.tambah_aset<> new.tambah_aset or old.biaya_pemeliharaan<>new.biaya_pemeliharaan 
or old.staset <> new.staset or old.id_bukuinduk <> new.id_bukuinduk then
  
   
  call sp_jurnal_pemeliharaan(new.id);



end if;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemeliharaan_aft_del` AFTER DELETE ON `pemeliharaan`
  FOR EACH ROW begin

  declare i_ int;  
  declare cek_ text;
  
  delete from t_transaksi where jns_trans2=9 and refid= old.id;
  



   

 
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemindahtanganan_bef_ins` BEFORE INSERT ON `pemindahtanganan`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemindahtanganan_aft_ins` AFTER INSERT ON `pemindahtanganan`
  FOR EACH ROW begin
declare difstaset_,stasetbaru_ tinyint(3);
declare refid_, jns_ int;
declare tgl_periode_ date;

SET sql_mode = 'NO_UNSIGNED_SUBTRACTION';
set jns_ = 4;
set refid_ = new.id;
  if new.bentuk_pemindahtanganan = 1 then 
     set difstaset_ = 5-new.staset;
     set stasetbaru_ = 5;
  elseif new.bentuk_pemindahtanganan = 2 then  
     set difstaset_ = 11-new.staset;
     set stasetbaru_ = 11;
  elseif new.bentuk_pemindahtanganan = 3 then    
     set difstaset_ = 12-new.staset;
     set stasetbaru_ = 12;
  else   
     set difstaset_ = 13-new.staset;
     set stasetbaru_ = 13;
  end if;  

  
  set tgl_periode_ = concat(year(new.tgl_pemindahtanganan), '-12-31');  
  update buku_induk_thn set status_barang=4, staset=stasetbaru_  where idbi = new.id_bukuinduk and tgl_periode = tgl_periode_;  

  insert into t_history_aset
    (tgl,idbi,uid,tgl_update,staset,staset_baru,div_staset,idbi_awal,jns,refid, tgl_create, uid_create)
    values
    (new.tgl_pemindahtanganan, new.id_bukuinduk, new.uid, now(), new.staset, stasetbaru_, difstaset_ , new.idbi_awal, jns_, refid_, now(), new.uid );

call sp_jurnal_pemindahtangan(new.id);

update buku_induk set status_barang = 4,staset=stasetbaru_ where id = new.id_bukuinduk;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemindahtanganan_aft_upd` AFTER UPDATE ON `pemindahtanganan`
  FOR EACH ROW begin
declare difstaset_,stasetbaru_ tinyint(3);
declare refid_, jns_ int;
declare tgl_periode_ date;

 

SET sql_mode = 'NO_UNSIGNED_SUBTRACTION';
set jns_ = 4;
set refid_ = new.id;
if old.tgl_pemindahtanganan<>new.tgl_pemindahtanganan then
  update t_history_aset set tgl=new.tgl_pemindahtanganan
  where jns=jns_ and refid=new.id;

  

  

  
  
  

  
  set tgl_periode_ = concat(year(new.tgl_pemindahtanganan), '-12-31');
  

end if;
call sp_jurnal_pemindahtangan(new.id);
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemindahtanganan_aft_del` AFTER DELETE ON `pemindahtanganan`
  FOR EACH ROW begin
declare i_ int;
declare tgl_periode_ date ;


delete from t_history_aset where jns=4 and refid= old.id;
delete from t_transaksi where idbi = old.id_bukuinduk and refid= old.id;
delete from t_jurnal_aset where idbi = old.id_bukuinduk and refid= old.id;

update buku_induk set status_barang = 1,staset=old.staset where id = old.id_bukuinduk;



  set tgl_periode_ = concat(year(old.tgl_pemindahtanganan), '-12-31');  
  

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemusnahan_aft_upd` AFTER UPDATE ON `pemusnahan`
  FOR EACH ROW begin
update pemusnahan_det set sttemp='0',tgl_update=now() where refid_pemusnahan=old.id;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemusnahan_aft_del` AFTER DELETE ON `pemusnahan`
  FOR EACH ROW begin
delete from pemusnahan_panitia where refid_pemusnahan=old.id;
delete from pemusnahan_det where refid_pemusnahan=old.id;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemusnahan_det_aft_ins` AFTER INSERT ON `pemusnahan_det`
  FOR EACH ROW begin
declare difstaset_ tinyint(3);
declare refid_, jns_ int;
set jns_ = 7;
set difstaset_ = 14-new.staset;

insert into t_history_aset
    (tgl,idbi,tgl_update,staset,staset_baru,div_staset,idbi_awal,jns,refid, tgl_create, uid_create)
    values
    (new.tgl_buku, new.id_bukuinduk, now(), new.staset, 14, difstaset_ , new.idbi_awal, jns_, new.id, new.tgl_create, new.uid_create );

call sp_jurnal_pemusnahan(new.id);
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pemusnahan_det_aft_del` AFTER DELETE ON `pemusnahan_det`
  FOR EACH ROW begin
declare i_ int;

delete from t_history_aset where jns=7 and refid= old.id;
delete from t_transaksi where jns_trans2=39 and idbi = old.id_bukuinduk and refid= old.id;
delete from t_jurnal_aset where jns_trans2=39 and idbi = old.id_bukuinduk and refid= old.id;

update buku_induk set staset=old.staset,status_barang=1 where id = old.id_bukuinduk;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pengamanan_bef_ins` BEFORE INSERT ON `pengamanan`
  FOR EACH ROW begin
declare staset_, idlama_, idawal_ int;

select  staset, idawal into  staset_, idawal_ from buku_induk where id = new.id_bukuinduk;
set new.tgl_create = now();
set new.uid_create = new.uid;
set new.idbi_awal = idawal_;
set new.staset = staset_;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pengamanan_aft_ins` AFTER INSERT ON `pengamanan`
  FOR EACH ROW begin
declare i int;
declare cek_ text;
  
  call sp_jurnal_pengaman(new.id);


   


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pengamanan_aft_upd` AFTER UPDATE ON `pengamanan`
  FOR EACH ROW begin
declare i_ int;
declare cek_ text;
  
  
  call sp_jurnal_pengaman(new.id);


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `pengamanan_aft_del` AFTER DELETE ON `pengamanan`
  FOR EACH ROW begin
  declare i_ int;  
declare cek_ text;
  
  delete from t_transaksi where jns_trans2=10 and refid= old.id;
  




end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penghapusan_bef_ins` BEFORE INSERT ON `penghapusan`
  FOR EACH ROW begin

set new.tgl_create = now();
set new.uid_create = new.uid;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `hapus_aft_ins` AFTER INSERT ON `penghapusan`
  FOR EACH ROW begin
declare tgl_periode_ date;

  set tgl_periode_ = concat(year(new.tgl_penghapusan), '-12-31');  
  
 
  
  
  
  if new.mutasi=0 or new.mutasi=4 or new.mutasi=5 then
    call sp_jurnal_penghapusan(new.id);
  end if;

  if new.mutasi = 1 then
    call sp_jurnal_mutasi(new.id);
  end if;

  if new.mutasi = 2 then
    call sp_jurnal_reklass(new.id);
  end if;  

  

insert into db_sislog_tmp_v2.temp8 (
  tgl, idhps, id_bukuinduk, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg, thn_perolehan,
  tgl_penghapusan, uraian, gambar, ket, tahun, mutasi, sudahmutasi,
  kondisi_akhir, apraisal, nosk, tglsk, tgl_update, uid, st
) values (
  now(), new.id, new.id_bukuinduk, new.a1, new.a, new.b, new.c, new.d, new.e,new.e1,
  new.f, new.g, new.h, new.i, new.j, new.noreg, new.thn_perolehan,
  new.tgl_penghapusan, new.uraian, new.gambar, new.ket, new.tahun, new.mutasi, new.sudahmutasi,
  new.kondisi_akhir, new.apraisal, new.nosk, new.tglsk, new.tgl_update, new.uid, 2
);

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `hapus_aft_upd` AFTER UPDATE ON `penghapusan`
  FOR EACH ROW begin


if old.tgl_penghapusan <> new.tgl_penghapusan or old.mutasi <> new.mutasi or old.sudahmutasi <> new.sudahmutasi or old.idbi_awal <> new.idbi_awal or old.staset<> new.staset  then
  
  
  
  
  
   
  
  
  
 
  
  
  
  
  
  

  
  if new.mutasi=0 or new.mutasi=4 or new.mutasi=5 then
    call sp_jurnal_penghapusan(new.id);
  elseif new.mutasi=1  then
    call sp_jurnal_mutasi(new.id);
  elseif new.mutasi=2  then
    call sp_jurnal_reklass(new.id);  
  end if;  

end if;

insert into db_sislog_tmp_v2.temp8 (
  tgl, idhps, id_bukuinduk, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg, thn_perolehan,
  tgl_penghapusan, uraian, gambar, ket, tahun, mutasi, sudahmutasi,
  kondisi_akhir, apraisal, nosk, tglsk, tgl_update, uid, st
) values (
  now(), old.id, old.id_bukuinduk, old.a1, old.a, old.b, old.c, old.d, old.e,old.e1,
  old.f, old.g, old.h, old.i, old.j, old.noreg, old.thn_perolehan,
  old.tgl_penghapusan, old.uraian, old.gambar, old.ket, old.tahun, old.mutasi, old.sudahmutasi,
  old.kondisi_akhir, old.apraisal, old.nosk, old.tglsk, old.tgl_update, old.uid, 1
);

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `hapus_aft_del` AFTER DELETE ON `penghapusan`
  FOR EACH ROW begin
declare tgl_periode_ date;
  set tgl_periode_ = concat(year(old.tgl_penghapusan), '-12-31');
  update buku_induk_thn set status_barang=1 where idbi = old.id_bukuinduk and tgl_periode = tgl_periode_;

  
  if old.mutasi=0 then 
    delete from t_transaksi where jns_trans2=14 and refid= old.id;
  end if;

  if old.mutasi = 1  then
    delete from t_transaksi where jns_trans2=15 and refid= old.id;
  end if;

  if old.mutasi = 2  then
    delete from t_transaksi where jns_trans2=16 and refid= old.id;
  end if;

  if old.mutasi = 4  then
    delete from t_transaksi where jns_trans2=37 and refid= old.id;
  end if;
  if old.mutasi = 5  then
    delete from t_transaksi where jns_trans2=38 and refid= old.id;
  end if;

update buku_induk set status_barang = old.status_barang,staset = old.staset  where id = old.id_bukuinduk;


insert into db_sislog_tmp_v2.temp8 (
  tgl, idhps, id_bukuinduk, a1, a, b, c, d, e,e1,
  f, g, h, i, j, noreg, thn_perolehan,
  tgl_penghapusan, uraian, gambar, ket, tahun, mutasi, sudahmutasi,
  kondisi_akhir, apraisal, nosk, tglsk, tgl_update, uid
) values (
  now(), old.id, old.id_bukuinduk, old.a1, old.a, old.b, old.c, old.d, old.e,
  old.e1,old.f, old.g, old.h, old.i, old.j, old.noreg, old.thn_perolehan,
  old.tgl_penghapusan, old.uraian, old.gambar, old.ket, old.tahun, old.mutasi, old.sudahmutasi,
  old.kondisi_akhir, old.apraisal, old.nosk, old.tglsk, old.tgl_update, old.uid
);
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penghapusan_sebagian_bef_ins` BEFORE INSERT ON `penghapusan_sebagian`
  FOR EACH ROW begin
declare staset_ int;

set new.tgl_create = now();
set new.uid_create = new.uid;
select staset into staset_ from buku_induk where id = new.id_bukuinduk;
set new.staset = staset_;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penghapusan_sebagian_aft_ins` AFTER INSERT ON `penghapusan_sebagian`
  FOR EACH ROW begin
declare cek_ text;
call sp_jurnal_hapussebagian(new.id);



end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penghapusan_sebagian_aft_upd` AFTER UPDATE ON `penghapusan_sebagian`
  FOR EACH ROW begin
declare cek_ text ;

call sp_jurnal_hapussebagian(new.id);





end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penghapusan_sebagian_aft_del` AFTER DELETE ON `penghapusan_sebagian`
  FOR EACH ROW begin
  declare i_ int;  
  declare cek_ text;
  
  delete from t_transaksi where jns_trans2=11 and refid= old.id;
  






end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penilaian_bef_ins` BEFORE INSERT ON `penilaian`
  FOR EACH ROW begin

set new.tgl_create = now();
set new.uid_create = new.uid;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penilaian_aft_ins` AFTER INSERT ON `penilaian`
  FOR EACH ROW begin
declare i int;
declare cek_ text;
  
  call sp_jurnal_penilaian(new.id);  


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penilaian_aft_upd` AFTER UPDATE ON `penilaian`
  FOR EACH ROW begin
declare i_ int;
  
  
  call sp_jurnal_penilaian(new.id);


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penilaian_aft_del` AFTER DELETE ON `penilaian`
  FOR EACH ROW begin
  declare i_ int;  
  declare cek_ text;
  
  delete from t_transaksi where jns_trans2=13 and refid= old.id;
  

 

 
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penyusutan_bef_ins` BEFORE INSERT ON `penyusutan`
  FOR EACH ROW begin
 set new.tgl_create= now();
  set new.uid_create= new.uid;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penyusutan_aft_ins` AFTER INSERT ON `penyusutan`
  FOR EACH ROW begin
declare i int;
  

call sp_jurnal_susut(new.Id);

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `penyusutan_aft_del` AFTER DELETE ON `penyusutan`
  FOR EACH ROW begin
  declare i_ int;
  
if old.jns_trans2 = 30 then
  delete from t_transaksi where jns_trans2=30 and refid= old.Id;  
end if;
  


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_barang_aft_ins` AFTER INSERT ON `ref_barang`
  FOR EACH ROW begin

insert into ref_barang_hist
(tgl_hist, jns, f1,f2,f,g,h,i,j,j1,nm_barang,ka,kb,kc,kd,ke,kf,masa_manfaat,residu,l1,l2,l3,l4,l5,l6,m1,m2,m3,m4,m5,m6,n1,n2,n3,n4,n5,n6,tgl_update,tgl_create,mapping,kodeawal,o1,o2,o3,o4,o5,o6,k11,l11,m11,n11,o11,k12,l12,m12,k13,o12,l13,n13,m13,o13,n12)
values
(now(), 0,new.f1, new.f2, new.f, new.g, new.h, new.i, new.j, new.j1, new.nm_barang,
 new.ka, new.kb, new.kc, new.kd, new.ke, new.kf, new.masa_manfaat, new.residu,
 new.l1, new.l2, new.l3, new.l4, new.l5, new.l6,
 new.m1, new.m2, new.m3, new.m4, new.m5, new.m6,
 new.n1, new.n2, new.n3, new.n4, new.n5, new.n6,
 new.tgl_update, new.tgl_create, new.mapping, new.kodeawal,
 new.o1, new.o2, new.o3, new.o4, new.o5, new.o6,
 new.k11, new.l11, new.m11, new.n11, new.o11, new.k12, new.l12, new.m12, new.k13, new.o12,
 new.l13, new.n13, new.m13, new.o13, new.n12);


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_barang_aft_upd` AFTER UPDATE ON `ref_barang`
  FOR EACH ROW begin
declare i int;

insert into ref_barang_hist
(tgl_hist, jns,f1,f2,f,g,h,i,j,j1,nm_barang,ka,kb,kc,kd,ke,kf,masa_manfaat,residu,l1,l2,l3,l4,l5,l6,m1,m2,m3,m4,m5,m6,n1,n2,n3,n4,n5,n6,tgl_update,tgl_create,mapping,kodeawal,o1,o2,o3,o4,o5,o6,k11,l11,m11,n11,o11,k12,l12,m12,k13,o12,l13,n13,m13,o13,n12)
values
(now(), 1,new.f1, new.f2, new.f, new.g, new.h, new.i, new.j, new.j1, new.nm_barang,
 new.ka, new.kb, new.kc, new.kd, new.ke, new.kf, new.masa_manfaat, new.residu,
 new.l1, new.l2, new.l3, new.l4, new.l5, new.l6,
 new.m1, new.m2, new.m3, new.m4, new.m5, new.m6,
 new.n1, new.n2, new.n3, new.n4, new.n5, new.n6,
 new.tgl_update, new.tgl_create, new.mapping, new.kodeawal,
 new.o1, new.o2, new.o3, new.o4, new.o5, new.o6,
 new.k11, new.l11, new.m11, new.n11, new.o11, new.k12, new.l12, new.m12, new.k13, new.o12,
 new.l13, new.n13, new.m13, new.o13, new.n12);

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_barang_aft_del` AFTER DELETE ON `ref_barang`
  FOR EACH ROW begin

insert into ref_barang_hist
(tgl_hist, jns,f1,f2,f,g,h,i,j,j1,nm_barang,ka,kb,kc,kd,ke,kf,masa_manfaat,residu,l1,l2,l3,l4,l5,l6,m1,m2,m3,m4,m5,m6,n1,n2,n3,n4,n5,n6,tgl_update,tgl_create,mapping,kodeawal,o1,o2,o3,o4,o5,o6,k11,l11,m11,n11,o11,k12,l12,m12,k13,o12,l13,n13,m13,o13,n12)
values
(now(), 2,old.f1, old.f2, old.f, old.g, old.h, old.i, old.j, old.j1, old.nm_barang,
 old.ka, old.kb, old.kc, old.kd, old.ke, old.kf, old.masa_manfaat, old.residu,
 old.l1, old.l2, old.l3, old.l4, old.l5, old.l6,
 old.m1, old.m2, old.m3, old.m4, old.m5, old.m6,
 old.n1, old.n2, old.n3, old.n4, old.n5, old.n6,
 old.tgl_update, old.tgl_create, old.mapping, old.kodeawal,
 old.o1, old.o2, old.o3, old.o4, old.o5, old.o6,
 old.k11, old.l11, old.m11, old.n11, old.o11, old.k12, old.l12, old.m12, old.k13, old.o12,
 old.l13, old.n13, old.m13, old.o13, old.n12);



end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_rincian_template_bef_ins` BEFORE INSERT ON `ref_rincian_template`
  FOR EACH ROW begin
   SET new.tgl_create = NOW();
   SET new.tgl_update = NOW();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_rincian_template_bef_upd` BEFORE UPDATE ON `ref_rincian_template`
  FOR EACH ROW begin
   SET new.tgl_update = NOW();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_ruang_bef_ins` BEFORE INSERT ON `ref_ruang`
  FOR EACH ROW begin

  set new.id = cast(concat('1',new.c1,new.c,new.d,new.e,new.e1,new.p,new.q) as UNSIGNED  integer);


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_ruang_bef_updt` BEFORE UPDATE ON `ref_ruang`
  FOR EACH ROW begin

  set new.id = cast(concat('1',new.c1, new.c,new.d,new.e,new.e1,new.p,new.q) as UNSIGNED  integer);


  update buku_induk set ref_idruang = new.id where ref_idruang = old.id;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_ruas_jalan_bef_ins` BEFORE INSERT ON `ref_ruas_jalan`
  FOR EACH ROW begin
  declare i_ int;
  set new.id = cast(concat('1',new.c,new.d,new.e,new.e1,new.jns,new.no_urut) as UNSIGNED  integer);

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_ruas_jalan_bef_upd` BEFORE UPDATE ON `ref_ruas_jalan`
  FOR EACH ROW begin
declare i int;
  set new.id = cast(concat('1',new.c,new.d,new.e,new.e1,new.jns,new.no_urut) as UNSIGNED  integer);


  update kib_d set ref_ruas_jalan = new.id where ref_ruas_jalan = old.id;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_tambah_manfaat_bef_ins` BEFORE INSERT ON `ref_tambah_manfaat`
  FOR EACH ROW begin

  set new.tgl_create = now();  

  
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_tambah_manfaat_bef_upd` BEFORE UPDATE ON `ref_tambah_manfaat`
  FOR EACH ROW begin
   set new.tgl_update = now();

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_tambah_manfaat_bef_del` BEFORE DELETE ON `ref_tambah_manfaat`
  FOR EACH ROW begin
  declare cnt_ int;  
  declare kd_barang_  varchar(60);  
  declare err_ varchar(200);  
  
  
  set cnt_ = 0;
 
  
    set kd_barang_ = old.f;       
  
  if old.g <>'00' then
    set kd_barang_ = concat(kd_barang_,'.',old.g);       
  end if;
  if old.h <>'00' then
    set kd_barang_ = concat(kd_barang_,'.',old.h);       
  end if;  
  if old.i <>'00' then
    set kd_barang_ = concat(kd_barang_,'.',old.i);       
  end if;  
  if old.j <>'000' then
    set kd_barang_ = concat(kd_barang_,'.',old.j);       
  end if;
  
  select count(*) into cnt_ from penyusutan where masa_manfaat_rehab > 0 and concat( f,'.',g,'.',h,'.',i,'.',j)  like concat(kd_barang_,'%') ; 
  
  if cnt_ > 0 then
    set err_ = concat('Kode Barang : ', kd_barang_, ' tidak bisa dihapus, karena sudah ada di penyusutan!');
    SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT =  err_;

  end if;  
  
  
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_template_bef_ins` BEFORE INSERT ON `ref_template`
  FOR EACH ROW begin
   SET new.tgl_create = NOW();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_template_bef_del` BEFORE DELETE ON `ref_template`
  FOR EACH ROW begin
     DELETE FROM ref_rincian_template WHERE refid_template=old.id;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_templatebarang_bef_ins` BEFORE INSERT ON `ref_templatebarang`
  FOR EACH ROW begin

SET new.tgl_create=NOW();
SET new.tgl_update=NOW();
SET new.uid_create=new.uid;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_templatebarang_bef_upd` BEFORE UPDATE ON `ref_templatebarang`
  FOR EACH ROW begin
SET new.tgl_update=NOW();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_templatebarang_bef_del` BEFORE DELETE ON `ref_templatebarang`
  FOR EACH ROW begin
   DELETE FROM ref_templatebarang_det WHERE refid_templatebarang = old.Id;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_templatebarang_det_bef_ins` BEFORE INSERT ON `ref_templatebarang_det`
  FOR EACH ROW begin
  SET new.tgl_create=NOW();
  SET new.tgl_update=NOW();
  SET new.uid_create=new.uid;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_template_barang_det_bef_upd` BEFORE UPDATE ON `ref_templatebarang_det`
  FOR EACH ROW begin
  SET new.tgl_update=NOW();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_urusan_aft_ins` AFTER INSERT ON `ref_urusan`
  FOR EACH ROW begin
  declare cnt_ int;
  declare urusan_ int;  

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `ref_urusan_aft_del` AFTER DELETE ON `ref_urusan`
  FOR EACH ROW begin
  declare cnt_ int;

  

  
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `sensus_bef_ins` BEFORE INSERT ON `sensus`
  FOR EACH ROW begin
declare idbi_awal int;

select idawal into idbi_awal from buku_induk where id = new.idbi;
set new.idbi_awal = idbi_awal;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `sensus_bef_del` BEFORE DELETE ON `sensus`
  FOR EACH ROW begin

declare tgl_sensus_ date;

if(sesi is null or sesi = '') and (error is null or error ='') then
update buku_induk
set kondisi = old.kondisi_awal,
ref_idruang = old.ref_idruang_lama,
ref_idpemegang2 = old.ref_idpemegang2_lama,
ref_idpemegang = old.ref_idpemegang_lama,
ref_idpenanggung = old.ref_idpenanggung_lama,
tahun_sensus = old.tahun_sensus_lama,
tgl_sensus = old.tgl_lama,
status_penguasaan = null
where id=old.idbi;

end if;



end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `setting_inventaris_history` AFTER UPDATE ON `setting_inventaris`
  FOR EACH ROW insert into setting_inventaris_history (tgl_buku,data_barang,thn_buku1,thn_buku2,staset,metode,thn_sensus,uid,tgl_update,uid_create,tgl_create)
value (old.tgl_buku,old.data_barang,old.thn_buku1,old.thn_buku2,old.staset,old.metode,old.thn_sensus,old.uid,old.tgl_update,old.uid,now()) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_asetlainlain_bef_ins` BEFORE INSERT ON `t_asetlainlain`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_atribusi_bef_ins` BEFORE INSERT ON `t_atribusi`
  FOR EACH ROW begin

DECLARE jns_trans_,bk_,ck_,dk_,p_,q_,pekerjaan_ text ;

  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();

if new.refid_terima IS NOT NULL THEN
  SELECT jns_trans,bk,ck,dk,p,q,pekerjaan INTO jns_trans_,bk_,ck_,dk_,p_,q_,pekerjaan_ FROM t_penerimaan_barang WHERE Id=new.refid_terima;

  SET new.jns_trans = jns_trans_;
  SET new.bk = bk_;
  SET new.ck = ck_;
  SET new.dk = dk_;
  SET new.p = p_;
  SET new.q = q_;
  SET new.pekerjaan = pekerjaan_;
  SET new.status_barang = '1';

end if;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_atribusi_bef_upd` BEFORE UPDATE ON `t_atribusi`
  FOR EACH ROW begin
  DECLARE jns_trans_, bk_, ck_, dk_, p_, q_, pekerjaan_, nama_penyedia_ text;
  set new.tgl_update = now();
  if new.refid_terima != '' || new.refid_terima != null then
     SELECT jns_trans, bk, ck, dk, p , q, pekerjaan INTO jns_trans_, bk_, ck_, dk_, p_, q_, pekerjaan_ FROM t_penerimaan_barang WHERE Id=new.refid_terima;
     set new.jns_trans = jns_trans_;
     set new.bk = bk_;
     set new.ck = ck_;
     set new.dk = dk_;
     set new.p = p_;
     set new.q = q_;
     set new.pekerjaan = pekerjaan_;
  end if;


  SELECT nama_penyedia INTO nama_penyedia_ FROM ref_penyedia WHERE id=new.refid_penyedia;
  SET new.nama_refid_penyedia = nama_penyedia_;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_atribusi_bef_del` BEFORE DELETE ON `t_atribusi`
  FOR EACH ROW begin
    DELETE FROM t_atribusi_dokumen WHERE refid_atribusi=old.Id;
    DELETE FROM t_atribusi_rincian WHERE refid_atribusi=old.Id;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_atribusi_dokumen_bef_ins` BEFORE INSERT ON `t_atribusi_dokumen`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_atribusi_dokumen_bef_upd` BEFORE UPDATE ON `t_atribusi_dokumen`
  FOR EACH ROW begin
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_atribusi_rincian_bef_ins` BEFORE INSERT ON `t_atribusi_rincian`
  FOR EACH ROW begin
  declare refid_terima_, tahun_ text;
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();

  SELECT refid_terima, tahun INTO refid_terima_, tahun_ FROM t_atribusi WHERE Id=new.refid_atribusi;
  set new.refid_terima=refid_terima_;
  set new.tahun=tahun_;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_atribusi_rincian_bef_upd` BEFORE UPDATE ON `t_atribusi_rincian`
  FOR EACH ROW begin
  declare tgl_buku_ date;
  declare jns_trans_, c1_,c_,d_,e_,e1_,refid_terima_,tahun_ text;
  set new.tgl_update = now();

  SELECT refid_terima, tahun INTO refid_terima_,tahun_ FROM t_atribusi WHERE Id=new.refid_atribusi;
  set new.refid_terima=refid_terima_;
  set new.tahun =tahun_;

  IF new.sttemp=0 THEN
     SELECT tanggal_dok INTO tgl_buku_ FROM t_atribusi_dokumen WHERE Id=new.refid_dokumen_atribusi_fix;
     DELETE FROM t_penerimaan_rek_biaya WHERE jns='1' AND jns2='2' AND refid=new.refid_terima AND refid_rek=new.Id;
     SELECT jns_trans, c1,c,d,e,e1 INTO jns_trans_,c1_,c_,d_,e_,e1_ FROM t_penerimaan_barang WHERE Id=new.refid_terima;
     INSERT INTO t_penerimaan_rek_biaya (c1,c,d,e,e1, jns,jns2,jns_trans,k,l,m,n,o,jumlah,refid,refid_rek,uid, sttemp,tahun,tgl_buku) VALUES (c1_,c_,d_,e_,e1_, "1", "2",jns_trans_, new.k, new.l, new.m, new.n, new.o, new.jumlah, new.refid_terima, new.Id, new.uid, "0", new.tahun, tgl_buku_);
  END IF;


  INSERT INTO t_atribusi_rincian_hist (k,l,m,n,o,uraian,jumlah,satuan,harga_satuan,jml_harga,keterangan,refid_atribusi,refid_terima,tahun,uid,tgl_create,tgl_update,status,sttemp,refid_dokumen_atribusi,refid_dokumen_atribusi_fix,jns_aksi,refid_atribusi_rincian,tgl_aksi) values (old.k,old.l,old.m,old.n,old.o,old.uraian,old.jumlah,old.satuan,old.harga_satuan,old.jml_harga,old.keterangan,old.refid_atribusi,old.refid_terima,old.tahun,old.uid,old.tgl_create,old.tgl_update,old.status,old.sttemp,old.refid_dokumen_atribusi,old.refid_dokumen_atribusi_fix,1,old.Id,NOW());
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_atribusi_rincian_bef_del` BEFORE DELETE ON `t_atribusi_rincian`
  FOR EACH ROW begin
   IF old.sttemp=0 THEN
     DELETE FROM t_penerimaan_rek_biaya WHERE jns='1' AND jns2='2' AND refid=old.refid_terima AND refid_rek=old.Id;
  END IF;

  INSERT INTO t_atribusi_rincian_hist (k,l,m,n,o,uraian,jumlah,satuan,harga_satuan,jml_harga,keterangan,refid_atribusi,refid_terima,tahun,uid,tgl_create,tgl_update,status,sttemp,refid_dokumen_atribusi,refid_dokumen_atribusi_fix,jns_aksi,refid_atribusi_rincian,tgl_aksi) values (old.k,old.l,old.m,old.n,old.o,old.uraian,old.jumlah,old.satuan,old.harga_satuan,old.jml_harga,old.keterangan,old.refid_atribusi,old.refid_terima,old.tahun,old.uid,old.tgl_create,old.tgl_update,old.status,old.sttemp,old.refid_dokumen_atribusi,old.refid_dokumen_atribusi_fix,2,old.Id,NOW());
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_birm_aft_insert` AFTER INSERT ON `t_birm_pekerjaan`
  FOR EACH ROW update t_birm set tgl_create=now() where pid=new.ref_idbirm */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_bku_bef_ins` BEFORE INSERT ON `t_bku`
  FOR EACH ROW begin
   DECLARE bk_,ck_,dk_, p_, q_, k_, l_, m_, n_, o_ text;
   DECLARE jumlah_ DECIMAL(18.2);
   set new.tgl_create=NOW();
   set new.tgl_update=NOW();
   set new.uid_create=new.uid;

   IF new.jns = "1" THEN
      SELECT bk, ck, dk, p, q, k, l, m, n, o, jumlah INTO bk_,ck_,dk_, p_, q_, k_, l_, m_, n_, o_, jumlah_ FROM t_spp_rekening WHERE refid_spp=new.refid AND Id=new.refid_det AND sttemp='0';
      
      SET new.k=k_;
      SET new.l=l_;
      SET new.m=m_;
      SET new.n=n_;
      SET new.o=o_;
      SET new.jumlah=jumlah_;
   END IF;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_bku_bef_upd` BEFORE UPDATE ON `t_bku`
  FOR EACH ROW begin
   set new.tgl_update=NOW();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_closing_aft_ins` AFTER INSERT ON `t_closing`
  FOR EACH ROW begin
   insert t_closing_hist ( tgl_hist, jns, c1,c,d,e,e1,tgl,ket,uid,tgl_update, tgl_susut, tgl_update_susut)
   values
   ( now(), 0, new.c1,new.c,new.d,new.e,new.e1,new.tgl,new.ket,new.uid,new.tgl_update, new.tgl_susut, new.tgl_update_susut);

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_closing_aft_upd` AFTER UPDATE ON `t_closing`
  FOR EACH ROW begin
   insert t_closing_hist ( tgl_hist, jns, c1,c,d,e,e1,tgl,ket,uid,tgl_update, tgl_susut, tgl_update_susut)
   values
   ( now(), 1, new.c1,new.c,new.d,new.e,new.e1,new.tgl,new.ket,new.uid,new.tgl_update, new.tgl_susut, new.tgl_update_susut);
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_closing_aft_del` AFTER DELETE ON `t_closing`
  FOR EACH ROW begin
   insert t_closing_hist ( tgl_hist, jns, c1,c,d,e,e1,tgl,ket,uid,tgl_update,tgl_susut, tgl_update_susut)
   values
   ( now(), 2, old.c1,old.c,old.d,old.e,old.e1,old.tgl,old.ket,old.uid,old.tgl_update, old.tgl_susut, old.tgl_update_susut);
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_distribusi_bef_ins` BEFORE INSERT ON `t_distribusi`
  FOR EACH ROW begin
  DECLARE refid_jns_ int;

  SELECT Id INTO refid_jns_ FROM ref_jenis_pemeliharaan WHERE jenis=new.jns_pemeliharaan LIMIT 0,1;

  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();
  set new.refid_jns_pemeliharaan = refid_jns_;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_distribusi_bef_upd` BEFORE UPDATE ON `t_distribusi`
  FOR EACH ROW begin
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_history_aset_bef_ins` BEFORE INSERT ON `t_history_aset`
  FOR EACH ROW begin
     
  
  
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_history_aset_aft_ins` AFTER INSERT ON `t_history_aset`
  FOR EACH ROW begin

 declare cek_ text; 

 if new.staset <> 0 then 
   
       
    if ((new.staset=3 or new.staset=8 or new.staset=10) and new.staset_baru=9) or
      (new.staset=9 and (new.staset_baru=3 or new.staset_baru=8 or new.staset=10)) or
      ((new.staset=3 or new.staset=8 or new.staset=9) and new.staset_baru=10) or
      (new.staset=10 and (new.staset_baru=3 or new.staset_baru=8 or new.staset=9))
    then 
       call sp_jurnal_staset(new.id);              

       
    end if;    
    
  end if;  

  


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_history_aset_aft_upd` AFTER UPDATE ON `t_history_aset`
  FOR EACH ROW begin

declare cek_ text;



  if new.staset <> 0 then 
    call sp_jurnal_staset(new.id);
  end if;
   
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_history_aset_aft_del` AFTER DELETE ON `t_history_aset`
  FOR EACH ROW begin
  declare cek_ text;
  if old.staset <> 0 then 
     if old.staset = 9 or old.staset_baru = 9 then
        delete from t_transaksi where jns_trans2= 21 and refid = old.id;
     elseif old.staset = 10 or old.staset_baru = 10 then
        delete from t_transaksi where jns_trans2= 22 and refid = old.id;
     end if;     
     
  end if;

  

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_jurnal_aset _bef_ins` BEFORE INSERT ON `t_jurnal_aset`
  FOR EACH ROW begin

if new.status_barang is null then
  set new.status_barang = 0;
end if;

set new.tgl_update = now();
set new.tgl_create = now();


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_jurnal_aset_aft_ins` AFTER INSERT ON `t_jurnal_aset`
  FOR EACH ROW begin

declare id_ integer;
declare tgl_periode_ date;
declare cek_ text;
declare cnt_ integer;
declare thn_anggaran_ integer;







end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_jurnal_aset_bef_upd` BEFORE UPDATE ON `t_jurnal_aset`
  FOR EACH ROW begin
  declare cek_ text;

  if old.stposting = new.stposting then
    
    select sf_jurnal_set_stpost( old.c1,old.c,old.d,old.e,old.e1,
      old.kint,old.ka,old.kb,
      old.f1,old.f2,old.f,old.g,old.h,old.i,old.j,
      old.jns_trans,old.jns_trans2,old.jns_trans3,
      old.tgl_buku, old.uid, 0 ) into cek_; 

    set new.stposting=0;    
    set new.tgl_update = now();
    
  end if;
    
  
  

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_jurnal_aset_aft_del` AFTER DELETE ON `t_jurnal_aset`
  FOR EACH ROW 
begin
declare id_ integer;
declare tgl_periode_ date;
declare cek_ text;


select sf_jurnal_set_stpost( old.c1,old.c,old.d,old.e,old.e1,
  old.kint,old.ka,old.kb,
  old.f1,old.f2,old.f,old.g,old.h,old.i,old.j,
   old.jns_trans,old.jns_trans2,old.jns_trans3,
  old.tgl_buku, old.uid, 0 ) into cek_; 



end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_jurnal_aset_rekap_bef_ins` BEFORE INSERT ON `t_jurnal_aset_rekap`
  FOR EACH ROW begin

  set new.id2 =  concat(new.c1,new.c,new.d,new.e,new.e1, new.kint,new.ka,new.kb,
  new.f1,new.f2,new.f,new.g,new.h,new.i,new.j, new.jns_trans,new.jns_trans2,new.jns_trans3, new.mode);

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_jurnal_aset_rekap_bef_upd` BEFORE UPDATE ON `t_jurnal_aset_rekap`
  FOR EACH ROW begin

  set new.id2 =  concat(new.c1,new.c,new.d,new.e,new.e1, new.kint,new.ka,new.kb,
  new.f1,new.f2,new.f,new.g,new.h,new.i,new.j, new.jns_trans,new.jns_trans2,new.jns_trans3, new.mode);

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER  `t_kapitalisasi_bef_ins` BEFORE INSERT ON  `t_kapitalisasi`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_kondisi_bef_ins` BEFORE INSERT ON `t_kondisi`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_kondisi_aft_ins` AFTER INSERT ON `t_kondisi`
  FOR EACH ROW begin
  declare idperiode_ integer;  
  declare tgl_periode_ date;  
declare cek_ text;

  
  call sp_jurnal_kondisi(new.id);  

  
     select sf_isi_bi_thn_kondisi(new.idbi, new.tgl, new.dif_kondisi  ) into cek_;      
  

  
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_kondisi_aft_upd` AFTER UPDATE ON `t_kondisi`
  FOR EACH ROW begin

  declare tgl_periode_ date;  
  declare cek_ text;  

  
  

  
  call sp_jurnal_kondisi(new.id);
  
  
  if old.kond_awal <> 0 and old.kond_awal is not null then  
    select sf_isi_bi_thn_kondisi(old.idbi, old.tgl, -1*old.dif_kondisi  ) into cek_;   
    select sf_isi_bi_thn_kondisi(new.idbi, new.tgl, new.dif_kondisi  ) into cek_;   
  end if;  

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_kondisi_aft_del` AFTER DELETE ON `t_kondisi`
  FOR EACH ROW begin
declare tgl_periode_ date;
declare cek_ text;
declare cnt_ int;



delete from t_transaksi where jns_trans2 = 34 and refid=old.id;

select count(*) into cnt_ from buku_induk where id =  old.idbi;

if cnt_ >0 and old.kond_awal>0 and old.kond_awal is not null  then
  update buku_induk set kondisi = old.kond_awal where id = old.idbi;
end if;




end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_koreksi_bef_ins` BEFORE INSERT ON `t_koreksi`
  FOR EACH ROW begin
set new.tgl_create = now();
set new.uid_create = new.uid;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_koreksi_aft_ins` AFTER INSERT ON `t_koreksi`
  FOR EACH ROW begin
declare cek_ text;
  call sp_jurnal_koreksi(new.id);  
   
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_koreksi_aft_upd` AFTER UPDATE ON `t_koreksi`
  FOR EACH ROW begin
declare i_ int;
declare cek_ text;
  

  
  

call sp_jurnal_koreksi(new.id);
 

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_koreksi_aft_del` AFTER DELETE ON `t_koreksi`
  FOR EACH ROW begin
  declare i_ int;  
  declare cek_ text;  

  
  delete from t_transaksi where jns_trans2=12 and refid= old.id;
  

  
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_koreksi_penyusutan_aft_del` AFTER DELETE ON `t_koreksi_penyusutan`
  FOR EACH ROW begin

delete from penyusutan where id_koreksi_tambah=old.Id;
update penyusutan set id_koreksi=0 where id_koreksi=old.Id;
delete from t_transaksi where refid=old.Id and jns_trans2=31;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_nomor_spd_bef_ins` BEFORE INSERT ON `t_nomor_spd`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_nomor_spd_bef_upd` BEFORE UPDATE ON `t_nomor_spd`
  FOR EACH ROW begin
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_nomor_spd_bef_del` BEFORE DELETE ON `t_nomor_spd`
  FOR EACH ROW begin
  DELETE FROM t_nomor_spd_det WHERE refid_nomor_spd=old.Id;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_nomor_spd_det_bef_ins` BEFORE INSERT ON `t_nomor_spd_det`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_nomor_spd_det_bef_upd` BEFORE UPDATE ON `t_nomor_spd_det`
  FOR EACH ROW begin
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_bef_ins` BEFORE INSERT ON `t_penerimaan_barang`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_bef_upd` BEFORE UPDATE ON `t_penerimaan_barang`
  FOR EACH ROW begin
  DECLARE nama_penyedia_, nama_penerima_ text;

  set new.tgl_update = now();
  IF new.status_validasi = '' THEN
     set new.status_validasi = '0';
  END IF;

  SELECT nama_penyedia INTO nama_penyedia_ FROM ref_penyedia WHERE id=new.refid_penyedia;
  SET new.nama_refid_penyedia = nama_penyedia_;

  SELECT nama INTO nama_penerima_ FROM ref_tandatangan WHERE Id=new.refid_penerima;
  SET new.nama_refid_penerima=nama_penerima_;

  IF new.status_validasi = "0" OR new.status_validasi = "" OR new.status_validasi = null THEN
     UPDATE t_penerimaan_barang_det SET dat_hargabeli1=0, dat_hargabeli2=0, dat_atribusi1=0, dat_atribusi2=0 WHERE refid_terima=new.Id;
  END IF;


  IF new.refid_t_birm != 0 OR new.refid_t_birm != null then
     
     UPDATE t_birm SET ref_idterima=new.Id WHERE pid=new.refid_t_birm;
     UPDATE t_birm SET ref_idterima=NULL WHERE pid=old.refid_t_birm;

  END IF;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_aft_upd` AFTER UPDATE ON `t_penerimaan_barang`
  FOR EACH ROW begin

UPDATE t_atribusi SET bk=new.bk, ck=new.ck, dk=new.dk, p=new.p, q=new.q, pekerjaan=new.pekerjaan WHERE refid_terima=new.Id;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_bef_del` BEFORE DELETE ON `t_penerimaan_barang`
  FOR EACH ROW begin
  IF old.refid_t_birm != 0 OR old.refid_t_birm != null then
     
     UPDATE t_birm SET ref_idterima=NULL WHERE pid=old.refid_t_birm;

  END IF;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_det_bef_ins` BEFORE INSERT ON `t_penerimaan_barang_det`
  FOR EACH ROW begin
  DECLARE c1_,c_,d_,e_,e1_ text;
  DECLARE bk_,ck_,dk_,p_,q_ text;
  DECLARE k_,l_,m_,n_,o_ text;
  DECLARE f1_,f2_,f_,g_,h_,i_,j_,j1_ text;

  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();
  if new.kuantitas < 1 then
     set new.kuantitas = 1;
  end if;
  set new.jml_terima=new.jml * new.kuantitas;
  IF new.refid_dpa != 0 THEN
     SELECT bk,ck,dk,p,q,k,l,m,n,o,f1,f2,f,g,h,i,j,j1 INTO bk_,ck_,dk_,p_,q_,k_,l_,m_,n_,o_,f1_,f2_,f_,g_,h_,i_,j_,j1_ FROM tabel_dpa WHERE id=new.refid_dpa;
     SET new.bk=bk_;
     SET new.ck=ck_;
     SET new.dk=dk_;
     SET new.p=p_;
     SET new.q=q_;
     SET new.k=k_;
     SET new.l=l_;
     SET new.m=m_;
     SET new.n=n_;
     SET new.o=o_;
     IF new.status2_dpa != 1 THEN
       SET new.f1=f1_;
       SET new.f2=f2_;
       SET new.f=f_;
       SET new.g=g_;
       SET new.h=h_;
       SET new.i=i_;
       SET new.j=j_;
       SET new.j1=j1_;
     END IF;

     SELECT c1,c,d,e,e1 INTO c1_,c_,d_,e_,e1_ FROM t_penerimaan_barang WHERE Id=new.refid_terima;
     SET new.c1=c1_;
     SET new.c=c_;
     SET new.d=d_;
     SET new.e=e_;
     SET new.e1=e1_;
     SET new.status_dpa=1;
  END IF;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_det_aft_ins` AFTER INSERT ON `t_penerimaan_barang_det`
  FOR EACH ROW begin
 DECLARE k_,l_,m_,n_,o_ text;

 IF new.refid_dpa != 0 OR new.refid_dpa = '' OR new.refid_dpa = NULL THEN
   SELECT k,l,m,n,o INTO k_,l_,m_,n_,o_ FROM tabel_dpa WHERE id=new.refid_dpa;
   
 END IF;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_det_bef_upd` BEFORE UPDATE ON `t_penerimaan_barang_det`
  FOR EACH ROW begin
  set new.tgl_update = now();
  if new.kuantitas < 1 then
     set new.kuantitas = 1;
  end if;
  set new.jml_terima=new.jml * new.kuantitas;
  
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_det_bef_del` BEFORE DELETE ON `t_penerimaan_barang_det`
  FOR EACH ROW begin
DELETE FROM t_distribusi WHERE refid_terima=old.refid_terima AND refid_penerimaan_det=old.Id;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_det_v2_bef_ins` BEFORE INSERT ON `t_penerimaan_barang_det_v2`
  FOR EACH ROW begin
  DECLARE c1_, c_, d_, e_, e1_, tahun_ text;
  DECLARE f1_, f2_, f_, g_, h_, i_, j_, j1_ text;
  DECLARE k_, l_, m_, n_, o_ text;
  DECLARE bk_, ck_, dk_, p_, q_ text;
  DECLARE rincian_perhitungan_, satuan_, jenis_anggaran_, sumber_dana_,satuan1_, satuan2_, jns_transaksi_  text;
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();

  if new.refid_terima != '' OR new.refid_terima != NULL then
     SELECT c1, c, d, e, e1, tahun, jns_trans INTO c1_, c_, d_, e_, e1_, tahun_,jns_transaksi_ FROM t_penerimaan_barang_v2 WHERE Id=new.refid_terima;
     SET new.c1=c1_;
     SET new.c=c_;
     SET new.d=d_;
     SET new.e=e_;
     SET new.e1=e1_;
  end if;


  if new.refid_dpa != 0 then
     SELECT f1,f2,f,g,h,i,j,j1,k,l,m,n,o,rincian_perhitungan, satuan_total, satuan1, satuan2, bk, ck, dk, p, q,  jenis_anggaran, sumber_dana INTO f1_,f2_,f_,g_,h_,i_,j_,j1_,k_,l_,m_,n_,o_,rincian_perhitungan_,satuan_,satuan1_, satuan2_, bk_, ck_, dk_, p_, q_,  jenis_anggaran_, sumber_dana_  FROM tabel_dpa WHERE id=new.refid_dpa;

     SET new.f1=f1_;
     SET new.f2=f2_;
     SET new.f=f_;
     SET new.g=g_;
     SET new.h=h_;
     SET new.i=i_;
     SET new.j=j_;
     SET new.j1=j1_;
     SET new.k=k_;
     SET new.l=l_;
     SET new.m=m_;
     SET new.n=n_;
     SET new.o=o_;
     IF new.stat_ket_barang != 1 THEN
        SET new.ket_barang=rincian_perhitungan_;
     END IF;

     IF jns_transaksi_ = 1 THEN
        SET new.satuan=satuan_;
     END IF;
     IF jns_transaksi_ = 2 THEN
        SET new.satuan=satuan1_;
        SET new.ket_kuantitas=satuan2_;
     END IF;

     SET new.bk=bk_;
     SET new.ck=ck_;
     SET new.dk=dk_;
     SET new.p=p_;
     SET new.q=q_;
     SET new.sumber_dana=sumber_dana_;
     SET new.jenis_anggaran=jenis_anggaran_;
  end if;


  if new.kuantitas < 1 then
     set new.kuantitas = 1;
  end if;
  set new.jml_terima=new.jml * new.kuantitas;
  set new.harga_total= new.jml * new.harga_satuan;
  set new.tahun=tahun_;


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_det_v2_bef_upd` BEFORE UPDATE ON `t_penerimaan_barang_det_v2`
  FOR EACH ROW begin
  set new.tgl_update = now();
  if new.kuantitas < 1 then
     set new.kuantitas = 1;
  end if;
  set new.jml_terima=new.jml * new.kuantitas;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_v2_bef_ins` BEFORE INSERT ON `t_penerimaan_barang_v2`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_v2_bef_upd` BEFORE UPDATE ON `t_penerimaan_barang_v2`
  FOR EACH ROW begin
  DECLARE nama_penyedia_, nama_penerima_, nomor_kontrak_, tgl_kontrak_ text;

  set new.tgl_update = now();
  IF new.status_validasi = '' THEN
     set new.status_validasi = '0';
  END IF;

  SELECT nama_penyedia INTO nama_penyedia_ FROM ref_penyedia WHERE id=new.refid_penyedia;
  SET new.nama_refid_penyedia = nama_penyedia_;

  SELECT nama INTO nama_penerima_ FROM ref_tandatangan WHERE Id=new.refid_penerima;
  SET new.nama_refid_penerima=nama_penerima_;

  IF new.status_validasi = "0" OR new.status_validasi = "" OR new.status_validasi = null THEN
     UPDATE t_penerimaan_barang_det SET dat_hargabeli1=0, dat_hargabeli2=0, dat_atribusi1=0, dat_atribusi2=0 WHERE refid_terima=new.Id;
  END IF;

  IF new.refid_nomor_kontrak != "0" OR new.refid_nomor_kontrak = "" THEN
     SELECT nomor_dok, tgl_dok INTO nomor_kontrak_, tgl_kontrak_ FROM ref_nomor_dokumen WHERE Id=new.refid_nomor_kontrak;
     set new.nomor_kontrak=nomor_kontrak_;
     set new.tgl_kontrak=tgl_kontrak_;
  END IF;


  IF new.refid_t_birm != 0 OR new.refid_t_birm != null then
     
     UPDATE t_birm SET ref_idterima=new.Id WHERE pid=new.refid_t_birm;
     UPDATE t_birm SET ref_idterima=NULL WHERE pid=old.refid_t_birm;

  END IF;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_barang_v2_bef_del` BEFORE DELETE ON `t_penerimaan_barang_v2`
  FOR EACH ROW begin
  IF old.refid_t_birm != 0 OR old.refid_t_birm != null then
     
     UPDATE t_birm SET ref_idterima=NULL WHERE pid=old.refid_t_birm;

  END IF;
  DELETE FROM t_penerimaan_barang_det_v2 WHERE refid_terima=old.Id;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_rek_biaya_bef_ins` BEFORE INSERT ON `t_penerimaan_rek_biaya`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_rek_biaya_bef_upd` BEFORE UPDATE ON `t_penerimaan_rek_biaya`
  FOR EACH ROW begin
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_rekening_bef_ins` BEFORE INSERT ON `t_penerimaan_rekening`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.tgl_update = now();

  IF new.status_dpa = 1 THEN
     set new.jumlah_dpa=new.jumlah;
  END IF;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_rekening_bef_upd` BEFORE UPDATE ON `t_penerimaan_rekening`
  FOR EACH ROW begin
  declare tgl_buku_ date;
  declare jns_trans_, c1_,c_,d_,e_,e1_ text;
  set new.tgl_update = now();

  IF new.sttemp=0 THEN
     SELECT tgl_buku, jns_trans, c1,c,d,e,e1 INTO tgl_buku_, jns_trans_, c1_,c_,d_,e_,e1_ FROM t_penerimaan_barang WHERE Id=new.refid_terima;
     IF jns_trans_ != "3" THEN
        DELETE FROM t_penerimaan_rek_biaya WHERE jns='1' AND jns2='1' AND refid=new.refid_terima AND refid_rek=new.Id;
        INSERT INTO t_penerimaan_rek_biaya (c1,c,d,e,e1,jns,jns2,jns_trans,k,l,m,n,o,jumlah,refid,refid_rek,uid, sttemp,tahun, tgl_buku) VALUES (c1_,c_,d_,e_,e1_, "1", "1",jns_trans_, new.k, new.l, new.m, new.n, new.o, new.jumlah, new.refid_terima, new.Id, new.uid, "0", new.tahun, tgl_buku_);
     END IF;
  END IF;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_rekening_bef_del` BEFORE DELETE ON `t_penerimaan_rekening`
  FOR EACH ROW begin
   DELETE FROM t_penerimaan_rekening_det WHERE refid_terima=old.refid_terima AND refid_rek=old.Id;
   IF old.sttemp=0 THEN
     DELETE FROM t_penerimaan_rek_biaya WHERE jns='1' AND jns2='1' AND refid=old.refid_terima AND refid_rek=old.Id;
  END IF;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_rekening_det_bef_ins` BEFORE INSERT ON `t_penerimaan_rekening_det`
  FOR EACH ROW begin
  DECLARE f1_,f2_,f_,g_,h_,i_,j_,j1_, jns_trans_ text;
  DECLARE jml_, kuantitas_, harga_satuan_, harga_total_,jml_kuantitas_ float;

  set new.tgl_create = now();
  set new.tgl_update = now();

  IF new.refid_dpa != 0 THEN
     SELECT f1,f2,f,g,h,i,j,j1, jumlah1, jumlah2, jumlah INTO f1_,f2_,f_,g_,h_,i_,j_,j1_,jml_,kuantitas_,harga_satuan_ FROM tabel_dpa WHERE id=new.refid_dpa;
     SET new.f2=f2_;
     SET new.f=f_;
     SET new.g=g_;
     SET new.h=h_;
     SET new.i=i_;
     SET new.j=j_;
     SET new.j1=j1_;
     SET new.jml=jml_;
     SET new.harga_satuan=harga_satuan_;
    

     SELECT jns_trans INTO jns_trans_ FROM t_penerimaan_barang WHERE Id=new.refid_terima;

     IF jns_trans_ = 2 THEN
        SET jml_kuantitas_ =kuantitas_;
        SET harga_total_= (jml_ * kuantitas_) * harga_satuan_;
     ELSE
         SET harga_total_= jml_ * harga_satuan_;
         SET jml_kuantitas_ = 1;
     END IF;

     SET new.harga_total=harga_total_;
     SET new.kuantitas=jml_kuantitas_;


  END IF;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_rekening_det_bef_upd` BEFORE UPDATE ON `t_penerimaan_rekening_det`
  FOR EACH ROW begin
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_retensi_bef_ins` BEFORE INSERT ON `t_penerimaan_retensi`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_retensi_bef_upd` BEFORE UPDATE ON `t_penerimaan_retensi`
  FOR EACH ROW begin
  DECLARE nama_penyedia_, nama_penerima_ text;

  set new.tgl_update = now();
  IF new.status_validasi = '' THEN
     set new.status_validasi = '0';
  END IF;

  SELECT nama_penyedia INTO nama_penyedia_ FROM ref_penyedia WHERE id=new.refid_penyedia;
  SET new.nama_refid_penyedia = nama_penyedia_;

  SELECT nama INTO nama_penerima_ FROM ref_tandatangan WHERE Id=new.refid_penerima;
  SET new.nama_refid_penerima=nama_penerima_;

  IF new.status_validasi = "0" OR new.status_validasi = "" OR new.status_validasi = null THEN
     UPDATE t_penerimaan_barang_det SET dat_hargabeli1=0, dat_hargabeli2=0, dat_atribusi1=0, dat_atribusi2=0 WHERE refid_terima=new.Id;
  END IF;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_retensi_bef_del` BEFORE DELETE ON `t_penerimaan_retensi`
  FOR EACH ROW begin
   DELETE FROM t_penerimaan_retensi_det WHERE refid_retensi=old.Id;
   DELETE FROM t_penerimaan_retensi_rekening WHERE refid_retensi=old.Id;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_retensi_det_bef_ins` BEFORE INSERT ON `t_penerimaan_retensi_det`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_retensi_det_bef_upd` BEFORE UPDATE ON `t_penerimaan_retensi_det`
  FOR EACH ROW begin
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_retensi_rekening_bef_ins` BEFORE INSERT ON `t_penerimaan_retensi_rekening`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_retensi_rekening_bef_upd` BEFORE UPDATE ON `t_penerimaan_retensi_rekening`
  FOR EACH ROW begin
  declare tgl_buku_ date;
  declare c1_,c_,d_,e_,e1_ text;
  set new.tgl_update = now();
  IF new.sttemp=0 THEN
     SELECT tgl_buku, c1,c,d,e,e1 INTO tgl_buku_, c1_,c_,d_,e_,e1_ FROM t_penerimaan_retensi WHERE Id=new.refid_retensi;
     DELETE FROM t_penerimaan_rek_biaya WHERE jns='2' AND jns2='3' AND refid=new.refid_retensi AND refid_rek=new.Id;
     INSERT INTO t_penerimaan_rek_biaya (c1,c,d,e,e1,jns,jns2,jns_trans, k,l,m,n,o,jumlah,refid,refid_rek,uid, sttemp,tahun,tgl_buku) VALUES (c1_,c_,d_,e_,e1_, "2", "3", "4", new.k, new.l, new.m, new.n, new.o, new.jumlah, new.refid_retensi, new.Id, new.uid, "0", new.tahun, tgl_buku_);
  END IF;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_penerimaan_retensi_rekening_bef_del` BEFORE DELETE ON `t_penerimaan_retensi_rekening`
  FOR EACH ROW begin
     DELETE FROM t_penerimaan_rek_biaya WHERE jns='2' AND jns2='3' AND refid=old.refid_retensi AND refid_rek=old.Id;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_pengeluaran_kas_bef_ins` BEFORE INSERT ON `t_pengeluaran_kas`
  FOR EACH ROW begin
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_pengeluaran_kas_bef_upd` BEFORE UPDATE ON `t_pengeluaran_kas`
  FOR EACH ROW begin
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_pengeluaran_kas_aft_upd` AFTER UPDATE ON `t_pengeluaran_kas`
  FOR EACH ROW begin
   UPDATE t_pengeluaran_kas_rek SET tgl_update=NOW() WHERE refid=new.Id AND sttemp='0';
   UPDATE t_pengeluaran_kas_pot SET tgl_update=NOW() WHERE refid=new.Id AND sttemp='0';
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_pengeluaran_kas_bef_del` BEFORE DELETE ON `t_pengeluaran_kas`
  FOR EACH ROW begin
  DELETE FROM t_pengeluaran_kas_pot WHERE refid=old.Id;
  DELETE FROM t_pengeluaran_kas_rek WHERE refid=old.Id;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_pengeluaran_kas_pot_bef_ins` BEFORE INSERT ON `t_pengeluaran_kas_pot`
  FOR EACH ROW begin
  declare tahun_, k_,l_,m_,n_,o_ text;
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();

  SELECT tahun INTO tahun_ FROM t_pengeluaran_kas WHERE Id=new.refid;
  set new.tahun = tahun_;

  SELECT k, l, m, n, o INTO k_, l_, m_, n_, o_ FROM ref_potongan_spm WHERE Id=new.refid_potongan_spm;
  set new.k=k_;
  set new.l=l_;
  set new.m=m_;
  set new.n=n_;
  set new.o=o_;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_pengeluaran_kas_pot_bef_upd` BEFORE UPDATE ON `t_pengeluaran_kas_pot`
  FOR EACH ROW begin
  DECLARE hit_, nomor_bku_, IdBku_ int;
  DECLARE c1_, c_, d_, tahun_ text;
  DECLARE tgl_ date;

  set new.tgl_update = now();
  
  IF new.sttemp=0 THEN
      SELECT count(*), Id INTO hit_, IdBku_ FROM t_bku WHERE refid=new.refid AND refid_det=new.Id AND jns='3';
         SELECT c1, c, d, tahun, tanggal INTO c1_, c_, d_, tahun_, tgl_ FROM t_pengeluaran_kas WHERE Id=new.refid;
      IF hit_ < 1 THEN
         SELECT sf_getnomor_bku(c1_, c_, d_, tahun_) INTO nomor_bku_;
         INSERT INTO t_bku(nomor_bku, refid, refid_det, jns, tanggal, c1, c, d, k, l, m, n, o, jumlah, tahun, uid) values (nomor_bku_, new.refid, new.Id, "3", tgl_, c1_, c_, d_, new.k, new.l, new.m, new.n, new.o, new.jumlah, tahun_, new.uid);
      ELSE
         UPDATE t_bku SET tanggal=tgl_ WHERE Id=IdBku_;
      END IF;
  END IF;
  
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_pengeluaran_kas_pot_bef_del` BEFORE DELETE ON `t_pengeluaran_kas_pot`
  FOR EACH ROW begin
    DELETE FROM t_bku WHERE refid=old.refid AND refid_det=old.Id AND jns='3';
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_pengeluaran_kas_rek_bef_ins` BEFORE INSERT ON `t_pengeluaran_kas_rek`
  FOR EACH ROW begin
  declare tahun_ text;
  set new.tgl_create = now();
  set new.uid_create = new.uid;
  set new.tgl_update = now();

  SELECT tahun INTO tahun_ FROM t_pengeluaran_kas WHERE Id=new.refid;
  set new.tahun = tahun_;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_pengeluaran_kas_rek_bef_upd` BEFORE UPDATE ON `t_pengeluaran_kas_rek`
  FOR EACH ROW begin
  DECLARE hit_, nomor_bku_, IdBku_ int;
  DECLARE c1_, c_, d_, tahun_ text;
  DECLARE tgl_ date;
  set new.tgl_update = now();
  
  IF new.sttemp=0 THEN
      SELECT count(*), Id INTO hit_, IdBku_ FROM t_bku WHERE refid=new.refid AND refid_det=new.Id AND jns='2';
      SELECT c1, c, d, tahun, tanggal INTO c1_, c_, d_, tahun_, tgl_ FROM t_pengeluaran_kas WHERE Id=new.refid;

      IF hit_ < 1 THEN
         SELECT sf_getnomor_bku(c1_, c_, d_, tahun_) INTO nomor_bku_;
         INSERT INTO t_bku(nomor_bku, refid, refid_det, jns, tanggal, c1, c, d, k, l, m, n, o, jumlah, tahun, uid) values (nomor_bku_, new.refid, new.Id, "2",tgl_, c1_, c_, d_, new.k, new.l, new.m, new.n, new.o, new.jumlah, tahun_, new.uid);
      ELSE
         UPDATE t_bku SET tanggal=tgl_ WHERE Id=IdBku_;
      END IF;
  END IF;
  
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_pengeluaran_kas_rek_bef_del` BEFORE DELETE ON `t_pengeluaran_kas_rek`
  FOR EACH ROW begin
    DELETE FROM t_bku WHERE refid=old.refid AND refid_det=old.Id AND jns='2';
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_spp_bef_ins` BEFORE INSERT ON `t_spp`
  FOR EACH ROW begin
  DECLARE refid_terima_,bk_,ck_,dk_,p_,q_, refid_penyedia_ int;
  DECLARE no_dok_kontrak_, nama_refid_penyedia_, pekerjaan_ text;
  DECLARE tgl_dok_kontrak_ date;

  SET refid_terima_ = new.refid_terima;

  IF refid_terima_ != "" THEN
    SELECT bk, ck, dk, p, q, pekerjaan, nomor_kontrak, tgl_kontrak, refid_penyedia, nama_refid_penyedia INTO bk_, ck_, dk_, p_, q_, pekerjaan_, no_dok_kontrak_, tgl_dok_kontrak_, refid_penyedia_, nama_refid_penyedia_ FROM t_penerimaan_barang WHERE Id=refid_terima_ ;

    SET new.bk = bk_;
    SET new.ck = ck_;
    SET new.dk = dk_;
    SET new.p = p_;
    SET new.q = q_;
    SET new.pekerjaan = pekerjaan_;
    SET new.no_dok_kontrak = no_dok_kontrak_;
    SET new.tgl_dok_kontrak = tgl_dok_kontrak_;
    SET new.refid_penyedia = refid_penyedia_;
    SET new.penyedia_barang = nama_refid_penyedia_;

  END IF;

  set new.tgl_create = now();
  set new.uid_create = new.uid_spp;
  set new.tgl_update = now();

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_spp_bef_upd` BEFORE UPDATE ON `t_spp`
  FOR EACH ROW begin
  DECLARE refid_terima_,bk_,ck_,dk_,p_,q_, refid_penyedia_ int;
  DECLARE no_dok_kontrak_, nama_refid_penyedia_, pekerjaan_, nomor_spd_  text;
  DECLARE tgl_dok_kontrak_, tgl_spd_ date;

  SET refid_terima_ = new.refid_terima;

  IF refid_terima_ != 0 THEN
    SELECT bk, ck, dk, p, q,pekerjaan, nomor_kontrak, tgl_kontrak, refid_penyedia, nama_refid_penyedia INTO bk_, ck_, dk_, p_, q_,pekerjaan_, no_dok_kontrak_, tgl_dok_kontrak_, refid_penyedia_, nama_refid_penyedia_ FROM t_penerimaan_barang WHERE Id=refid_terima_ ;

    SET new.bk = bk_;
    SET new.ck = ck_;
    SET new.dk = dk_;
    SET new.p = p_;
    SET new.q = q_;
    SET new.pekerjaan = pekerjaan_;
    SET new.no_dok_kontrak = no_dok_kontrak_;
    SET new.tgl_dok_kontrak = tgl_dok_kontrak_;
    SET new.refid_penyedia = refid_penyedia_;
    SET new.penyedia_barang = nama_refid_penyedia_;

  END IF;

  IF new.refid_nomor_spd != '' THEN
    SELECT nomor_spd,tanggal_spd INTO nomor_spd_, tgl_spd_ FROM t_nomor_spd WHERE Id=new.refid_nomor_spd;
    SET new.no_spd=nomor_spd_;
    SET new.tgl_spd=tgl_spd_;
  END IF;

  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_spp_aft_upd` AFTER UPDATE ON `t_spp`
  FOR EACH ROW begin
  DECLARE refid_det_tukBKU_ text;

  IF new.jns_spp = '2' AND new.status='4' THEN
     DELETE FROM t_bku WHERE refid=new.Id AND jns="1";
     SELECT Id INTO refid_det_tukBKU_ FROM t_spp_rekening WHERE refid_spp=new.Id AND sttemp=0;
     INSERT INTO t_bku (nomor_bku, refid, refid_det, jns, tanggal, c1, c, d, tahun, uid)values(new.nomor_bku, new.Id, refid_det_tukBKU_, "1", new.tgl_sp2d, new.c1, new.c, new.d, new.tahun, new.uid_sp2d);
  END IF;
  

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_spp_bef_del` BEFORE DELETE ON `t_spp`
  FOR EACH ROW begin
   DELETE FROM t_spp_kelengkapan_dok WHERE refid_spp = old.Id;
   DELETE FROM t_spp_potongan WHERE refid_spp = old.Id;
   DELETE FROM t_spp_rekening WHERE refid_spp = old.Id;
   DELETE FROM t_bku WHERE refid=old.Id AND old="1";
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_spp_kelengkapan_dok_bef_ins` BEFORE INSERT ON `t_spp_kelengkapan_dok`
  FOR EACH ROW begin
  DECLARE syarat_ text;

  IF new.refid_kelengkapan_dok != '' THEN

     SELECT syarat INTO syarat_ FROM ref_kelengkapan_dokumen WHERE Id=new.refid_kelengkapan_dok;
     SET new.syarat_dok = syarat_;

  END IF;

  set new.tgl_create = now();
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_spp_kelengkapan_dok_bef_upd` BEFORE UPDATE ON `t_spp_kelengkapan_dok`
  FOR EACH ROW begin
  DECLARE syarat_ text;

  IF new.refid_kelengkapan_dok != '' THEN

     SELECT syarat INTO syarat_ FROM ref_kelengkapan_dokumen WHERE Id=new.refid_kelengkapan_dok;
     SET new.syarat_dok = syarat_;

  END IF;

  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_spp_potongan_bef_ins` BEFORE INSERT ON `t_spp_potongan`
  FOR EACH ROW begin

  DECLARE k_,l_,m_,n_,o_ text;
  set new.tgl_create = now();
  set new.tgl_update = now();
  set new.uid_create = new.uid;

  SELECT k,l,m,n,o INTO k_,l_,m_,n_,o_ FROM ref_potongan_spm WHERE Id=new.refid_potongan_spm;
  SET new.k=k_;
  SET new.l=l_;
  SET new.m=m_;
  SET new.n=n_;
  SET new.o=o_;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_spp_potongan_bef_upd` BEFORE UPDATE ON `t_spp_potongan`
  FOR EACH ROW begin
  DECLARE k_,l_,m_,n_,o_ text;
  set new.tgl_update = now();

SELECT k,l,m,n,o INTO k_,l_,m_,n_,o_ FROM ref_potongan_spm WHERE Id=new.refid_potongan_spm;
SET new.k=k_;
SET new.l=l_;
SET new.m=m_;
SET new.n=n_;
SET new.o=o_;

end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_spp_rekening_bef_ins` BEFORE INSERT ON `t_spp_rekening`
  FOR EACH ROW begin
  declare c1_,c_,d_, tahun_ text;
  set new.tgl_create = now();
  set new.tgl_update = now();
  set new.uid_create = new.uid;

  SELECT c1, c, d, tahun INTO c1_, c_, d_, tahun_ FROM t_spp WHERE Id=new.refid_spp;
  set new.c1 = c1_;
  set new.c = c_;
  set new.d = d_;
  set new.tahun = tahun_;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_spp_rekening_bef_upd` BEFORE UPDATE ON `t_spp_rekening`
  FOR EACH ROW begin
  set new.tgl_update = now();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_transaksi_bef_ins` BEFORE INSERT ON `t_transaksi`
  FOR EACH ROW 
begin

  
  set new.uid_create = new.uid;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_transaksi_aft_del` AFTER DELETE ON `t_transaksi`
  FOR EACH ROW begin


  delete from t_jurnal_aset where jns_trans2=old.jns_trans2 and refid=old.refid ;




end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_tree_bef_ins` BEFORE INSERT ON `t_tree`
  FOR EACH ROW begin
  declare maxurut_ int;
  declare parent_level_ int;  
  declare maxurut_digit_ int;
  declare newurut_digit_ int;
  declare kdparent_lama_ varchar(255);    
  declare kdparent_baru_ varchar(255);   
  declare parent_kdparent_ varchar(255);   
  declare parent_urut_ int;

  if new.kdparent is null then    
    set new.kdparent = '';
  end if;

  
  select max(urut) into maxurut_ from t_tree where kdparent = new.kdparent;
  if maxurut_ is  null then
     set maxurut_ = 0;
  end if;
  
  select char_length(cast(maxurut_ as CHAR(50) )) into maxurut_digit_;   


  
  select level, kdparent, urut into parent_level_, parent_kdparent_, parent_urut_ from t_tree where kode =  new.kdparent;
  if parent_level_ is  null then
     set parent_level_ = 0;
  end if;


  
  set new.level = parent_level_ + 1;
  set new.urut= maxurut_+1;    

  
  select char_length(cast(new.urut as CHAR(50) )) into newurut_digit_;   

  set new.kode = concat(new.kdparent, LPAD(new.urut,newurut_digit_,'0'),'.');    
  set new.dig = newurut_digit_;


  


end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `t_tree_aft_ins` AFTER INSERT ON `t_tree`
  FOR EACH ROW begin
 declare i_ int;
 
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `temp_data_bef_ins` BEFORE INSERT ON `temp_data`
  FOR EACH ROW begin
  SET new.tgl_create=NOW();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `temp_data_bef_del` BEFORE DELETE ON `temp_data`
  FOR EACH ROW begin
   DELETE FROM temp_data_det WHERE refid_temp_data=old.Id;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `temp_data_det_bef_ins` BEFORE INSERT ON `temp_data_det`
  FOR EACH ROW begin
  SET new.tgl_create=NOW();
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = latin1 */ ;
/*!50003 SET character_set_results = latin1 */ ;
/*!50003 SET collation_connection  = latin1_swedish_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `tempusr_aft_ins` AFTER INSERT ON `tempusr`
  FOR EACH ROW insert into db_sislog_tmp_v2.tempusr
(tgl, uid, pass, ipaddr, sesino)
values(
 new.tgl, new.uid, new.pass, new.ipaddr, new.sesino
) */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Dumping routines for database 'db_atisisbada_2017'
--
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `get_bi_rincian`(`idbi_` int(11) , tgl_ date, with_susut_ int(3) ) RETURNS text CHARSET latin1 COLLATE latin1_general_ci
BEGIN

  declare tmp_  decimal(18,5);  
  declare tmp_susut_, tot_  decimal(18,5);   
  declare idawal_ int(11);  
declare rinci_ text; 
      
  set tot_ = 0;    
  set rinci_ = '';
    
  set tmp_ = 0;
  select idawal, jml_harga into idawal_, tmp_  from buku_induk where id= idbi_  ;  
  set tot_ = tot_ + tmp_;  
  if tmp_ > 0 and tmp_<>'' and tmp_ is not null then
      set rinci_ = concat(rinci_,'perolehan awal,',tmp_,';');       
  end if; 
  
  set tmp_ = 0;
  select ifnull(sum(biaya_pemeliharaan),0) into tmp_ from pemeliharaan  where idbi_awal=idawal_ and tambah_aset=1 and tgl_pemeliharaan<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;  
  if tmp_ > 0 and tmp_<>'' and tmp_ is not null then
      set rinci_ = concat(rinci_,'pemeliharaan,',tmp_,';');       
  end if;   

  set tmp_ = 0;
  select ifnull(sum(biaya_pengamanan),0) into tmp_ from pengamanan  where idbi_awal=idawal_ and tambah_aset=1 and tgl_pengamanan<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;
  if tmp_ > 0 and tmp_<>'' and tmp_ is not null then
      set rinci_ = concat(rinci_,'pengamanan,',tmp_,';');       
  end if;   

  set tmp_ = 0;
  select ifnull(sum(harga_hapus),0) into tmp_ from penghapusan_sebagian  where idbi_awal=idawal_ and tgl_penghapusan<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ - tmp_;    
  if tmp_ > 0 and tmp_<>'' and tmp_ is not null then
      set rinci_ = concat(rinci_,'penghapusan_sebagian,',tmp_,';');       
  end if;

  set tmp_ = 0;
  select ifnull(sum(harga_baru - harga),0) into tmp_ from t_koreksi  where idbi_awal=idawal_ and tgl<=tgl_ and idbi<=idbi_ ;     
  set tot_ = tot_ + tmp_;    
  if tmp_ > 0 and tmp_<>'' and tmp_ is not null then
      set rinci_ = concat(rinci_,'t_koreksi,',tmp_,';');       
  end if;
  
  set tmp_ = 0;     
  select ifnull(sum(nilai_barang - nilai_barang_asal),0) into tmp_ from penilaian  where idbi_awal=idawal_ and tgl_penilaian<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;
  if tmp_ > 0 and tmp_<>'' and tmp_ is not null then
      set rinci_ = concat(rinci_,'penilaian,',tmp_,';');       
  end if;  

  set tmp_susut_ = 0;
  if with_susut_=1 then    
     
     select sf_getAkumSusut(idbi_,tgl_) into tmp_susut_;     
     if tmp_susut_ > 0 and tmp_susut_<>'' and tmp_susut_ is not null then
          set rinci_ = concat(rinci_,'penyusutan,',tmp_susut_,';');       
      end if; 
  end if;  
  set tot_ = tot_ - tmp_susut_;  

  RETURN rinci_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `get_nilai_buku`(`idbi_` int(11) , tgl_ date, with_susut_ int(3) ) RETURNS decimal(18,5)
BEGIN

  declare tmp_  decimal(18,5);  
  declare tmp_susut_, tot_  decimal(18,5);   
  declare idawal_ int(11);
      
  set tot_ = 0;  
    
  set tmp_ = 0;
  select idawal, jml_harga into idawal_, tmp_  from buku_induk where id= idbi_  ;  
  set tot_ = tot_ + tmp_;
  
  set tmp_ = 0;
  select ifnull(sum(biaya_pemeliharaan),0) into tmp_ from pemeliharaan  where idbi_awal=idawal_ and tambah_aset=1 and tgl_pemeliharaan<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;  

  set tmp_ = 0;
  select ifnull(sum(biaya_pengamanan),0) into tmp_ from pengamanan  where idbi_awal=idawal_ and tambah_aset=1 and tgl_pengamanan<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;

  set tmp_ = 0;
  select ifnull(sum(harga_hapus),0) into tmp_ from penghapusan_sebagian  where idbi_awal=idawal_ and tgl_penghapusan<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ - tmp_;  

  set tmp_ = 0;
  select ifnull(sum(harga_baru - harga),0) into tmp_ from t_koreksi  where idbi_awal=idawal_ and tgl<=tgl_ and idbi<=idbi_ ;     
  set tot_ = tot_ + tmp_;    

  
  set tmp_ = 0;     
  select ifnull(sum(nilai_barang - nilai_barang_asal),0) into tmp_ from penilaian  where idbi_awal=idawal_ and tgl_penilaian<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;

  set tmp_susut_ = 0;
  if with_susut_=1 then    
     
     select sf_getAkumSusut(idbi_,tgl_) into tmp_susut_;
  end if;  
  set tot_ = tot_ - tmp_susut_;  

  RETURN tot_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `get_nilai_buku_20160727`(`idbi_` int(11) , tgl_ date, with_susut_ int(3) ) RETURNS decimal(18,2)
BEGIN
  declare tmp_, tot_ decimal(18,2);    
  declare idawal_ int(11);
      
  set tot_ = 0;  
    
  
  select idawal, jml_harga into idawal_, tmp_  from buku_induk where id= idbi_  ;  
  set tot_ = tot_ + tmp_;

  
  select ifnull(sum(biaya_pemeliharaan),0) into tmp_ from pemeliharaan  where idbi_awal=idawal_ and tambah_aset=1 and tgl_pemeliharaan<=tgl_;     
  set tot_ = tot_ + tmp_;  

  
  select ifnull(sum(biaya_pengamanan),0) into tmp_ from pengamanan  where idbi_awal=idawal_ and tambah_aset=1 and tgl_pengamanan<=tgl_;     
  set tot_ = tot_ + tmp_;

  
  select ifnull(sum(harga_hapus),0) into tmp_ from penghapusan_sebagian  where idbi_awal=idawal_ and tgl_penghapusan<=tgl_;     
  set tot_ = tot_ + tmp_;  

  
  select ifnull(sum(harga_baru - harga),0) into tmp_ from t_koreksi  where idbi_awal=idawal_ and tgl<=tgl_;     
  set tot_ = tot_ + tmp_;    

  
  select ifnull(sum(nilai_barang - nilai_barang_asal),0) into tmp_ from penilaian  where idbi_awal=idawal_ and tgl_penilaian<=tgl_;     
  set tot_ = tot_ + tmp_;

  if with_susut_=1 then    
     select ifnull(sum(harga),0) into tot_ from penyusutan Where idbi=idbi_ and tgl<=tgl_;
  end if;  
  set tot_ = tot_ + tmp_;  

  RETURN tot_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `get_nilai_perolehan`(`idbi_` int(11) , tgl_perolehan_ date ) RETURNS decimal(18,5)
BEGIN

  declare tmp_  decimal(18,5);  
  declare tmp_susut_, tot_  decimal(18,5);   
  declare idawal_ int(11);
      
  set tot_ = 0;  
    
  set tmp_ = 0;
  select idawal, jml_harga into idawal_, tmp_  from buku_induk where id= idbi_  ;  
  set tot_ = tot_ + tmp_;
  
  set tmp_ = 0;
  select ifnull(sum(biaya_pemeliharaan),0) into tmp_ from pemeliharaan  where idbi_awal=idawal_ and tambah_aset=1 and tgl_perolehan<=tgl_perolehan_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;  

  set tmp_ = 0;
  select ifnull(sum(biaya_pengamanan),0) into tmp_ from pengamanan  where idbi_awal=idawal_ and tambah_aset=1 and tgl_perolehan<=tgl_perolehan_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;

  set tmp_ = 0;
  select ifnull(sum(harga_hapus),0) into tmp_ from penghapusan_sebagian  where idbi_awal=idawal_ and tgl_perolehan<=tgl_perolehan_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ - tmp_;  

  set tmp_ = 0;
  select ifnull(sum(harga_baru - harga),0) into tmp_ from t_koreksi  where idbi_awal=idawal_ and tgl_perolehan<=tgl_perolehan_ and idbi<=idbi_ ;     
  set tot_ = tot_ + tmp_;    

  
  set tmp_ = 0;     
  select ifnull(sum(nilai_barang - nilai_barang_asal),0) into tmp_ from penilaian  where idbi_awal=idawal_ and tgl_perolehan<=tgl_perolehan_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;

  
  RETURN tot_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `get_nilai_rehab`(`idbi_` int(11) , idawal_ int, tgl_ date ) RETURNS decimal(18,2)
BEGIN

  declare tmp_, tot_ decimal(18,2);    
  
      
  set tot_ = 0;  
    
  
  
  
  
  set tmp_ = 0;
  select ifnull(sum(biaya_pemeliharaan),0) into tmp_ from pemeliharaan  where idbi_awal=idawal_ and tambah_aset=1 and tgl_pemeliharaan<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;  

  set tmp_ = 0;
  select ifnull(sum(biaya_pengamanan),0) into tmp_ from pengamanan  where idbi_awal=idawal_ and tambah_aset=1 and tgl_pengamanan<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;

  set tmp_ = 0;
  select ifnull(sum(harga_hapus),0) into tmp_ from penghapusan_sebagian  where idbi_awal=idawal_ and tgl_penghapusan<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ - tmp_;  

  set tmp_ = 0;
  select ifnull(sum(harga_baru - harga),0) into tmp_ from t_koreksi  where idbi_awal=idawal_ and tgl<=tgl_ and idbi<=idbi_ ;     
  set tot_ = tot_ + tmp_;    

  
  set tmp_ = 0;     
  select ifnull(sum(nilai_barang - nilai_barang_asal),0) into tmp_ from penilaian  where idbi_awal=idawal_ and tgl_penilaian<=tgl_ and id_bukuinduk<=idbi_ ;     
  set tot_ = tot_ + tmp_;

  
  
     
  
  
  set tot_ = tot_ - tmp_;  

  RETURN tot_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `get_staset`(`idbi_` int(11), tgl_ date, f_ char(2)) RETURNS int(11)
BEGIN
  declare staset_ int(11);  
   
  select staset into staset_ from 
  (  
  select '1-1-1' as tgl, idbi_ as idbi , if(f_='07',8, 3 ) as staset, 0 as harga  
  union all 
  select tgl, idbi, staset_baru as staset, 0 as harga from t_asetlainlain 
  union all 
  select tgl, idbi, staset_baru as staset, 0 as harga from t_kapitalisasi 
  ) aa
  where aa.idbi = idbi_ and aa.tgl <= tgl_ 
  order by tgl desc limit 0,1;
          
  
  RETURN staset_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_cek_idbi`(`idbi_` int(11)) RETURNS longtext CHARSET latin1 COLLATE latin1_general_ci
BEGIN
/*****
  return cek : idbi, idawal, jns_err, err
  20170417 rusyad  
  20170721 rusyad cek 28    
  20171110 rusyad cek kint,ka,kb  
  20180212 rusyad kompatible pindah saldo  30
  20180215 err no 25 sementara ditutup  
  20180224 rusad :
    - errno 31 cek nilai perolehan dan nilai jurnal     
    - update pesan error
***/
  declare jns_err_ int;  
  declare idawal_, id_lama_, cnt_, staset_, div_staset_, dif_kondisi_, kondisi_, status_barang_ int;    
  declare f_ char(2);  
  declare kint_,ka_,kb_ char(2);  
  declare err_ text;  
  declare akum_susut_, akum_susut_j_, jml_harga_, harga_atribusi_, harga_beli_ decimal(18,2);  
  declare tgl_buku_, thn_perolehan_ date;
  declare asal_usul_awal_, asal_usul_ char(1);  
  declare maxtgl_susut_ date;  
  declare refid_terima_ int;  
  declare harga_temp_ decimal(18,2);  
  declare tgl_buku_lama_ date;  
  declare thn_anggaran_ int;  
  declare nilai_perolehan_, nilai_jurnal_ decimal(18,5);

  set jns_err_ = 0;  
  set idawal_ = 0;  
  set cnt_ = 0;
  set err_ = '';      

  #set kondisi_ = 0;  
  #set status_barang_ = 0;  
  #set dif_kondisi_ = 0;
  select nilai into thn_anggaran_ from setting where Id = 'THN_ANGGARAN';  
  #select tgl_buku into tgl_buku_ from buku_induk where id = idbi_; 
   
  select count(id) into cnt_ from  buku_induk where id = idbi_; 
  if cnt_ = 0 or cnt_='' or cnt_ is null then    
     set jns_err_ = 1;  
     set err_ = concat(err_,'1. id barang tidak ada, ');
  else
  #1 cek id awal
  select idawal, f , staset, status_barang, kondisi ,jml_harga, harga_atribusi, harga_beli , tgl_buku, thn_perolehan, asal_usul_awal, asal_usul, 
  id_lama, refid_terima
  into idawal_, f_, staset_, status_barang_ , kondisi_ ,jml_harga_, harga_atribusi_, harga_beli_, tgl_buku_, thn_perolehan_ , asal_usul_awal_, asal_usul_,  
  id_lama_, refid_terima_
  from buku_induk where id = idbi_; 
  if idawal_ = 0 or idawal_='' or idawal_ is null then
    
    #insert into t_cek (idbi, idbi_awal, jns_err, ket ) values (idbi_, idawal_, jns_err_, ' id awal tidak ada ');    
    set err_ = concat(err_,'2. id awal tidak ada, ');
  end if;  

  #2 cek kib    
  if status_barang_ <> 3 then
    if f_ = '01' then
      select count(*) into cnt_ from kib_a where idbi = idbi_;        
    elseif f_ = '02' then  
      select count(*) into cnt_ from kib_b where idbi = idbi_;        
    elseif f_ = '03' then   
      select count(*) into cnt_ from kib_c where idbi = idbi_;        
    elseif f_ = '04' then   
      select count(*) into cnt_ from kib_d where idbi = idbi_;        
    elseif f_ = '05' then   
      select count(*) into cnt_ from kib_e where idbi = idbi_;        
    elseif f_ = '06' then   
      select count(*) into cnt_ from kib_f where idbi = idbi_;        
    elseif f_ = '07' then
      select count(*) into cnt_ from kib_g where idbi = idbi_;          
    end if;
    if cnt_ = 0 or cnt_ is null then          
      #insert into t_cek (idbi, idbi_awal, jns_err, ket ) values (idbi_, idawal_, jns_err_, ' data kib tidak ada ');    
      set err_ = concat(err_,'3. data kib tidak ada, ');
    end if;  
  end if;  

  #30 cek idawal , pindah saldo harusnya 1
  select count(*) into cnt_ from buku_induk where year(tgl_buku) < thn_anggaran_ and idawal = idawal_ and status_barang <> 3;  
  #select count(*) into cnt_ from buku_induk where year(tgl_buku) < thn_anggaran_ and idawal = idawal_ ;
  if cnt_ > 1 then  
    set err_ = concat(err_,'30. untuk perode sebelumnya: idawal = ',idawal_, " tidak boleh dipakai lebih dari satu, "); 
  end if; 

    
  if idawal_ is not null or idawal_ > 0 then    
    #3cek staset
    if staset_ not in (3,5,6,7,8,9,10,11,12,13,14) then
      #insert into t_cek (idbi, idbi_awal, jns_err, ket ) values (idbi_, idawal_, jns_err_, ' status aset salah '); 
      set err_ = concat(err_,'4. status aset salah, '); 
    end if;   
        
    /** sementara dituutp
    #4 cek history aset 
    select sum(div_staset) into div_staset_ from t_history_aset where idbi_awal = idawal_;    
    if staset_ <> div_staset_ or div_staset_ is null or div_staset_ = '' then   
       #insert into t_cek (idbi, idbi_awal, jns_err, ket ) values (idbi_, idawal_, jns_err_, ' status aset dan history tidak sinkron ');       
       set err_ = concat(err_,'5. history status aset tidak sesuai, '); 
    end if;        
    **/    

    #6 cek status_barang penghapusan         
    if status_barang_ = 3  then  
       select count(*) into cnt_ from buku_induk where  idawal=idawal_ and id>idbi_ and year(tgl_buku)<thn_anggaran_ ;#and status_barang<>3; #idbi ini harusnya tidak di pindah saldo       
       if cnt_ = 0 then
         select count(*) into cnt_ from penghapusan where id_bukuinduk = idbi_;       
         if cnt_ <> 1 then                         
          set err_ = concat(err_,'6. data penghapusan tidak ada, '); 
         end if;         
       end if;
    end if;    
     

    #5 cek jurnal  bukan penghapusan    
    if status_barang_ <> 3 then      
       #cari saldo jml barang (cnt) untuk setiap kode rekap, jika lebih dari 1 kode rekap utk saldo akhir=1 maka error
       select count(*) into cnt_ from     
       (select kint,ka,kb, sum(jml_barang_d - jml_barang_k ) as cnt from t_jurnal_aset where idbi = idbi_ and jns_trans<>10 group by kint,ka,kb) aa
       where aa.cnt = 1;        
    
       
      if  cnt_ <> 1   then     
        #jika lebih dari 1 kode rekap utk saldo akhir=1 maka error          
        set err_ = concat(err_,'7. jurnal tampil lebih dari 1 kode rekap, '); 
      else    
          
        select kint,ka,kb,cnt,tot  into kint_,ka_,kb_, cnt_,nilai_jurnal_ from     
          (select kint,ka,kb, sum(jml_barang_d - jml_barang_k ) as cnt, sum(debet-kredit) as tot from t_jurnal_aset where idbi = idbi_ and jns_trans<>10 group by kint,ka,kb) aa
        where aa.cnt = 1;    
        # cek posisi kode rekap sesuai dengan status aset             
        if kint_ is null or kint_ = '' then    
          set err_ = concat(err_, '8. jurnal tidak sesuai, ');
        elseif staset_ = 3 and status_barang_=1 and concat(kint_,'.',ka_,'.',kb_) <> concat('01.01.' , f_ ) then
          set err_ = concat(err_, '9. kode rekap jurnal tidak sesuai status aset 3, ');     
        elseif staset_ = 8 and status_barang_=1 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.04' then   #atb   
          set err_ = concat(err_, '10. kode rekap jurnal tidak sesuai status aset 8, ');   
        elseif staset_ = 5 and status_barang_=4 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.01' then # pemindahtanganan penjualan        
          set err_ = concat(err_, '11. kode rekap jurnal tidak sesuai status aset 4, ');              
        elseif staset_ = 6 and status_barang_=5 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.02' then #tgr      
          set err_ = concat(err_, '12. kode rekap jurnal tidak sesuai status aset 5, ');
        elseif staset_ = 7 and status_barang_=2 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.03' then #kemitraan         
          set err_ = concat(err_, '13. kode rekap jurnal tidak sesuai status aset 7, ');
        elseif staset_ = 9 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.05'  then  #aset lainlain      
          set err_ = concat(err_, '14. kode rekap jurnal tidak sesuai status aset 9, ');
        elseif staset_ = 10 and concat(kint_,'.',ka_,'.',kb_) <> '02.00.00' then    #ekstra
          set err_ = concat(err_, '15. kode rekap jurnal tidak sesuai status aset 10, ');        
        elseif (staset_ = 11 or staset_ = 12 or staset_ = 13 ) and concat(kint_,'.',ka_,'.',kb_)<> '01.02.06' then    #pindahtangan tukar menukar
          set err_ = concat(err_, '16. kode rekap jurnal tidak sesuai status aset 11, ');                   
        elseif staset_ = 14 and concat(kint_,'.',ka_,'.',kb_)<> '01.02.07' then    #pemusnahan
          set err_ = concat(err_, '17. kode rekap jurnal tidak sesuai status aset 14, '); 
        
        else
          # jika sesuai cek nilai perolehan dan nilai jurnal        
          set nilai_perolehan_ = get_nilai_buku(idbi_,concat(thn_anggaran_,'-12-31'),0) ; 
          if nilai_jurnal_ <> nilai_perolehan_ then          
             set err_ = concat(err_, '31. Nilai Perolehan s/d ', concat(thn_anggaran_,'-12-31'),' : ',nilai_perolehan_,' tidak sama dengan Nilai Jurnal: ',nilai_jurnal_,', '); 
          end if;        
        end if;
    
      end if;# end jika ada jurnal    

    end if;
    
    /** sementara dituutp 
    #cek kondisi dif_kondisi
    select sum(dif_kondisi) into dif_kondisi_ from t_kondisi where idbi_awal = idawal_;        
    if dif_kondisi_ <> kondisi_ or dif_kondisi_ ='' or dif_kondisi_ is null then        
       set err_ = concat(err_, '18. kondisi dan history kondisi tidak sesuai, ');    
    end if;    
    **/    

    #cek penyusutan       
    select count(*), max(tgl) into cnt_ , maxtgl_susut_ from penyusutan where idbi = idbi_;    
    if (cnt_>0) and status_barang_=1  and (staset_=3 or staset_=8)   then   
       select sf_getAkumSusut(idbi_, maxtgl_susut_ ) into akum_susut_;       
       SELECT    sum(kredit- debet) into akum_susut_j_  from t_jurnal_aset where idbi = idbi_ and jns_trans=10 and concat(kint,'.',ka,'.',kb) = concat('01.01.' , f_ )  ;       
       if akum_susut_ > 0 and staset_=3 and akum_susut_ <> akum_susut_j_ then 
          set err_ = concat(err_, '19. Akum. Penyusutan s/d ',maxtgl_susut_,': ',akum_susut_,' tidak sama dengan Nilai Jurnal: ',akum_susut_j_,', ');          
       end if;       

       SELECT    sum(kredit- debet) into akum_susut_j_  from t_jurnal_aset where idbi = idbi_ and jns_trans=10 and concat(kint,'.',ka,'.',kb) = '01.02.04' ;       
       if akum_susut_ > 0 and staset_=8 and akum_susut_ <> akum_susut_j_ then 
          set err_ = concat(err_, '20. Akum. Penyusutan s/d ',maxtgl_susut_,': ',akum_susut_,' tidak sama dengan Nilai Jurnal: ',akum_susut_j_,', ');          
       end if;
    end if;    

    # cek t_transaksi perolehan       
    if idbi_ = idawal_ and year(tgl_buku_)>=thn_anggaran_ then
       select count(*) into cnt_ from t_transaksi where jns_trans2 in (1,2,3,4,5,6,7) and refid = idbi_;        
       if cnt_ = 0 or cnt_='' or cnt_ is null then         
          set err_ = concat(err_, '21. t_transaksi perolehan tidak ditemukan, ');           
       end if;
    end if;    

    # cek harga
    if harga_beli_+harga_atribusi_ <> jml_harga_ then        
       set err_ = concat(err_, '22. harga beli, atribusi dan perolehan tidak sesuai,');        
    end if;

    #cek tgl buku  
    if tgl_buku_ = '0000-00-00' or tgl_buku_ is null or tgl_buku_ = '' then    
       set err_ = concat(err_, '23. Tanggal Buku belum diisi, ');   
    end if;    

    #cek thn perolehan
    if thn_perolehan_ is null or thn_perolehan_ = '' then    
       set err_ = concat(err_, '24. Tahun Perolehan belum diisi, ');   
    end if;    

    /** sementara di tutup
    #cek asal usul awal
    # if asal_usul_awal_ <> asal_usul_ and asal_usul_ not in (4,5) then 
    if asal_usul_awal_ <> asal_usul_ and ( id_lama_ is null or id_lama_ =0 or id_lama_ ='') then    
       set err_ = concat(err_, '25. Cara perolehan awal tidak sesuai, ');   
    end if;  
    **/  

    # jika mutasi/reklas    
    /**
    if id_lama_ is not null and id_lama_ <>0 and id_lama_ <>'' then    
       select count(*) into cnt_ from penghapusan where id_bukuinduk = id_lama_;       
       if cnt_<>1 then               
           set err_ = concat(err_, '26. Penghapusan karena reklas/mutasi terhadap ID Barang sebelumnya tidak sesuai, '); 
       end if;
    end if;      
    **/
    if id_lama_ is not null and id_lama_ <>0 and id_lama_ <>'' then  
       select tgl_buku into tgl_buku_lama_ from buku_induk where id =  id_lama_;       
       if year(tgl_buku_lama_) >= thn_anggaran_ then   # hanya cek utk mutasi / reklas di thn anggaran
         select count(*) into cnt_ from penghapusan where id_bukuinduk = id_lama_;       
         if cnt_<>1 then               
           set err_ = concat(err_, '26. Penghapusan karena reklas/mutasi terhadap ID Barang sebelumnya tidak sesuai, '); 
         end if;           
       end if;
    end if;    

    #cek penerimaan    
    if refid_terima_ is not null and refid_terima_ <>0 and refid_terima_ <>'' then        
       select count(*) into cnt_ from t_penerimaan_barang where id= refid_terima_;       
       if cnt_<>1 then               
           set err_ = concat(err_, '27. ID Penerimaan tidak sesuai, '); 
       end if;
    end if;    

    # cek t_jurnal perolehan       
    if idbi_ = idawal_ and year(tgl_buku_) >= thn_anggaran_ then
       select sum(debet-kredit) into harga_temp_ from t_jurnal_aset where jns_trans2 in (1,2,3,4,5,6,7) and refid = idbi_;        
       if harga_temp_ <> jml_harga_ then         
          set err_ = concat(err_, '28. t_jurnal_aset dengan harga perolehan tidak sesuai, ');           
       end if;
    end if;
        
   # cek kint,ka,kb di jurnal tidak boleh null (bisa terjadi karena kesalahan staset, misal seharusnya tidak ada pemeliharaan utk barang pemusnahan   
   select count(*) into cnt_ from t_jurnal_aset where idbi = idbi_ and ( kint is null or ka is null or kb is null);   
   if cnt_ > 0 then    
      set err_ = concat(err_, '29. kode kint,ka,kb di t_jurnal_aset  tidak sesuai, ');  
   end if;
  
     

  end if;# end jika ada idawal

  end if;#end jika id bi ada  

  delete from t_cek_bi where idbi = idbi_;
  if err_ <> '' then   
     set err_ = concat(' error no ', err_);
     insert into t_cek_bi (idbi, idbi_awal, jns_err, ket, tgl_update ) values (idbi_, idawal_, 0, err_, now());    
  end if;  

   
    

  RETURN err_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_cek_idbi_20171110`(`idbi_` int(11)) RETURNS longtext CHARSET latin1 COLLATE latin1_general_ci
BEGIN

  declare jns_err_ int;  
  declare idawal_, id_lama_, cnt_, staset_, div_staset_, dif_kondisi_, kondisi_, status_barang_ int;    
  declare f_ char(2);  
  declare kint_,ka_,kb_ char(2);  
  declare err_ text;  
  declare akum_susut_, akum_susut_j_, jml_harga_, harga_atribusi_, harga_beli_ decimal(18,2);  
  declare tgl_buku_, thn_perolehan_ date;
  declare asal_usul_awal_, asal_usul_ char(1);  
  declare maxtgl_susut_ date;  
  declare refid_terima_ int;  
  declare harga_temp_ decimal(18,2);

  set jns_err_ = 0;  
  set idawal_ = 0;  
  set cnt_ = 0;
  set err_ = '';      

  
  
  

  select count(id) into cnt_ from  buku_induk where id = idbi_; 
  if cnt_ = 0 or cnt_='' or cnt_ is null then    
     set jns_err_ = 1;  
     set err_ = concat(err_,'1. id barang tidak ada, ');
  else
  
  select idawal, f , staset, status_barang, kondisi ,jml_harga, harga_atribusi, harga_beli , tgl_buku, thn_perolehan, asal_usul_awal, asal_usul, 
  id_lama, refid_terima
  into idawal_, f_, staset_, status_barang_ , kondisi_ ,jml_harga_, harga_atribusi_, harga_beli_, tgl_buku_, thn_perolehan_ , asal_usul_awal_, asal_usul_,  
  id_lama_, refid_terima_
  from buku_induk where id = idbi_; 
  if idawal_ = 0 or idawal_='' or idawal_ is null then
    
    
    set err_ = concat(err_,'2. id awal tidak ada, ');
  end if;  

  
  if f_ = '01' then
    select count(*) into cnt_ from kib_a where idbi = idbi_;        
  elseif f_ = '02' then  
    select count(*) into cnt_ from kib_b where idbi = idbi_;        
  elseif f_ = '03' then   
    select count(*) into cnt_ from kib_c where idbi = idbi_;        
  elseif f_ = '04' then   
    select count(*) into cnt_ from kib_d where idbi = idbi_;        
  elseif f_ = '05' then   
    select count(*) into cnt_ from kib_e where idbi = idbi_;        
  elseif f_ = '06' then   
    select count(*) into cnt_ from kib_f where idbi = idbi_;        
  elseif f_ = '07' then
    select count(*) into cnt_ from kib_g where idbi = idbi_;          
  end if;
  if cnt_ = 0 or cnt_ is null then          
    
    set err_ = concat(err_,'3. data kib tidak ada, ');
  end if;
    
  if idawal_ is not null or idawal_ > 0 then    
    
    if staset_ not in (3,5,6,7,8,9,10,11,12,13,14) then
      
      set err_ = concat(err_,'4. status aset salah, '); 
    end if;   

    
    select sum(div_staset) into div_staset_ from t_history_aset where idbi_awal = idawal_;    
    if staset_ <> div_staset_ or div_staset_ is null or div_staset_ = '' then   
       
       set err_ = concat(err_,'5. history status aset tidak sesuai, '); 
    end if;        
    
    
    if status_barang_ = 3 then     
       select count(*) into cnt_ from penghapusan where id_bukuinduk = idbi_;       
       if cnt_ <> 1 then                         
          set err_ = concat(err_,'6. data penghapusan tidak ada, '); 
       end if;
    end if;     

    
    if status_barang_ <> 3 then      
       
       select count(*) into cnt_ from     
       (select kint,ka,kb, sum(jml_barang_d - jml_barang_k ) as cnt from t_jurnal_aset where idbi = idbi_ group by kint,ka,kb) aa
       where aa.cnt = 1;        
    
       
      if  cnt_ <> 1   then     
        
        set err_ = concat(err_,'7. jurnal tidak sesuai, '); 
      else    
          
        select kint,ka,kb,cnt  into kint_,ka_,kb_, cnt_ from     
          (select kint,ka,kb, sum(jml_barang_d - jml_barang_k ) as cnt from t_jurnal_aset where idbi = idbi_ group by kint,ka,kb) aa
        where aa.cnt = 1;                 
        if kint_ is null or kint_ = '' then    
          set err_ = concat(err_, '8. jurnal tidak sesuai, ');
        elseif staset_ = 3 and status_barang_=1 and concat(kint_,'.',ka_,'.',kb_) <> concat('01.01.' , f_ ) then
          set err_ = concat(err_, '9. jurnal tidak sesuai, ');     
        elseif staset_ = 8 and status_barang_=1 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.04' then   
          set err_ = concat(err_, '10. jurnal tidak sesuai, ');   
        elseif staset_ = 5 and status_barang_=4 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.01' then 
          set err_ = concat(err_, '11. jurnal tidak sesuai, ');              
        elseif staset_ = 6 and status_barang_=5 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.02' then 
          set err_ = concat(err_, '12. jurnal tidak sesuai, ');
        elseif staset_ = 7 and status_barang_=2 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.03' then 
          set err_ = concat(err_, '13. jurnal tidak sesuai, ');
        elseif staset_ = 9 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.05'  then  
          set err_ = concat(err_, '14. jurnal tidak sesuai, ');
        elseif staset_ = 10 and concat(kint_,'.',ka_,'.',kb_) <> '02.00.00' then    
          set err_ = concat(err_, '15. jurnal tidak sesuai, ');        
        elseif (staset_ = 11 or staset_ = 12 or staset_ = 13 ) and concat(kint_,'.',ka_,'.',kb_)<> '01.02.06' then    
          set err_ = concat(err_, '16. jurnal tidak sesuai, ');                   
        elseif staset_ = 14 and concat(kint_,'.',ka_,'.',kb_)<> '01.02.07' then    
          set err_ = concat(err_, '17. jurnal tidak sesuai, ');        
        end if;
    
      end if;

    end if;
     
    
    select sum(dif_kondisi) into dif_kondisi_ from t_kondisi where idbi_awal = idawal_;        
    if dif_kondisi_ <> kondisi_ or dif_kondisi_ ='' or dif_kondisi_ is null then        
       set err_ = concat(err_, '18. kondisi dan history kondisi tidak sesuai, ');    
    end if;    

    
    select count(*), max(tgl) into cnt_ , maxtgl_susut_ from penyusutan where idbi = idbi_;    
    if (cnt_>0) and status_barang_=1  and (staset_=3 or staset_=8)   then   
       select sf_getAkumSusut(idbi_, maxtgl_susut_ ) into akum_susut_;       
       SELECT    sum(kredit- debet) into akum_susut_j_  from t_jurnal_aset where idbi = idbi_ and jns_trans=10 and concat(kint,'.',ka,'.',kb) = concat('01.01.' , f_ )  ;       
       if akum_susut_ > 0 and staset_=3 and akum_susut_ <> akum_susut_j_ then 
          set err_ = concat(err_, '19. jurnal penyusutan tidak sesuai, ');          
       end if;       

       SELECT    sum(kredit- debet) into akum_susut_j_  from t_jurnal_aset where idbi = idbi_ and jns_trans=10 and concat(kint,'.',ka,'.',kb) = '01.02.04' ;       
       if akum_susut_ > 0 and staset_=8 and akum_susut_ <> akum_susut_j_ then 
          set err_ = concat(err_, '20. jurnal penyusutan tidak sesuai, ');          
       end if;
    end if;    

    
    if idbi_ = idawal_ then
       select count(*) into cnt_ from t_transaksi where jns_trans2 in (1,2,3,4,5,6,7) and refid = idbi_;        
       if cnt_ = 0 or cnt_='' or cnt_ is null then         
          set err_ = concat(err_, '21. t_transaksi perolehan tidak sesuai, ');           
       end if;
    end if;    

    
    if harga_beli_+harga_atribusi_ <> jml_harga_ then        
       set err_ = concat(err_, '22. harga beli, atribusi dan perolehan tidak sesuai,');        
    end if;

    
    if tgl_buku_ = '0000-00-00' or tgl_buku_ is null or tgl_buku_ = '' then    
       set err_ = concat(err_, '23. Tanggal Buku belum diisi, ');   
    end if;    

    
    if thn_perolehan_ is null or thn_perolehan_ = '' then    
       set err_ = concat(err_, '24. Tahun Perolehan belum diisi, ');   
    end if;

    
    
    if asal_usul_awal_ <> asal_usul_ and ( id_lama_ is null or id_lama_ =0 or id_lama_ ='') then    
       set err_ = concat(err_, '25. Cara perolehan awal tidak sesuai, ');   
    end if;    

    
    if id_lama_ is not null and id_lama_ <>0 and id_lama_ <>'' then    
       select count(*) into cnt_ from penghapusan where id_bukuinduk = id_lama_;       
       if cnt_<>1 then               
           set err_ = concat(err_, '26. Penghapusan karena reklas/mutasi terhadap ID Barang sebelumnya tidak sesuai, '); 
       end if;
    end if;    

    
    if refid_terima_ is not null and refid_terima_ <>0 and refid_terima_ <>'' then        
       select count(*) into cnt_ from t_penerimaan_barang where id= refid_terima_;       
       if cnt_<>1 then               
           set err_ = concat(err_, '27. ID Penerimaan tidak sesuai, '); 
       end if;
    end if;    

    
    if idbi_ = idawal_ then
       select sum(debet-kredit) into harga_temp_ from t_jurnal_aset where jns_trans2 in (1,2,3,4,5,6,7) and refid = idbi_;        
       if harga_temp_ <> jml_harga_ then         
          set err_ = concat(err_, '28. t_jurnal_aset dengan harga perolehan tidak sesuai, ');           
       end if;
    end if;
    
  
     

  end if;

  end if;

  delete from t_cek_bi where idbi = idbi_;
  if err_ <> '' then   
     set err_ = concat(' error no ', err_);
     insert into t_cek_bi (idbi, idbi_awal, jns_err, ket, tgl_update ) values (idbi_, idawal_, 0, err_, now());    
  end if;  

   
    

  RETURN err_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_cek_idbi_20180212`(`idbi_` int(11)) RETURNS longtext CHARSET latin1 COLLATE latin1_general_ci
BEGIN

  declare jns_err_ int;  
  declare idawal_, id_lama_, cnt_, staset_, div_staset_, dif_kondisi_, kondisi_, status_barang_ int;    
  declare f_ char(2);  
  declare kint_,ka_,kb_ char(2);  
  declare err_ text;  
  declare akum_susut_, akum_susut_j_, jml_harga_, harga_atribusi_, harga_beli_ decimal(18,2);  
  declare tgl_buku_, thn_perolehan_ date;
  declare asal_usul_awal_, asal_usul_ char(1);  
  declare maxtgl_susut_ date;  
  declare refid_terima_ int;  
  declare harga_temp_ decimal(18,2);

  set jns_err_ = 0;  
  set idawal_ = 0;  
  set cnt_ = 0;
  set err_ = '';      

  
  
  

  select count(id) into cnt_ from  buku_induk where id = idbi_; 
  if cnt_ = 0 or cnt_='' or cnt_ is null then    
     set jns_err_ = 1;  
     set err_ = concat(err_,'1. id barang tidak ada, ');
  else
  
  select idawal, f , staset, status_barang, kondisi ,jml_harga, harga_atribusi, harga_beli , tgl_buku, thn_perolehan, asal_usul_awal, asal_usul, 
  id_lama, refid_terima
  into idawal_, f_, staset_, status_barang_ , kondisi_ ,jml_harga_, harga_atribusi_, harga_beli_, tgl_buku_, thn_perolehan_ , asal_usul_awal_, asal_usul_,  
  id_lama_, refid_terima_
  from buku_induk where id = idbi_; 
  if idawal_ = 0 or idawal_='' or idawal_ is null then
    
    
    set err_ = concat(err_,'2. id awal tidak ada, ');
  end if;  

  
  if f_ = '01' then
    select count(*) into cnt_ from kib_a where idbi = idbi_;        
  elseif f_ = '02' then  
    select count(*) into cnt_ from kib_b where idbi = idbi_;        
  elseif f_ = '03' then   
    select count(*) into cnt_ from kib_c where idbi = idbi_;        
  elseif f_ = '04' then   
    select count(*) into cnt_ from kib_d where idbi = idbi_;        
  elseif f_ = '05' then   
    select count(*) into cnt_ from kib_e where idbi = idbi_;        
  elseif f_ = '06' then   
    select count(*) into cnt_ from kib_f where idbi = idbi_;        
  elseif f_ = '07' then
    select count(*) into cnt_ from kib_g where idbi = idbi_;          
  end if;
  if cnt_ = 0 or cnt_ is null then          
    
    set err_ = concat(err_,'3. data kib tidak ada, ');
  end if;
    
  if idawal_ is not null or idawal_ > 0 then    
    
    if staset_ not in (3,5,6,7,8,9,10,11,12,13,14) then
      
      set err_ = concat(err_,'4. status aset salah, '); 
    end if;   

    
    select sum(div_staset) into div_staset_ from t_history_aset where idbi_awal = idawal_;    
    if staset_ <> div_staset_ or div_staset_ is null or div_staset_ = '' then   
       
       set err_ = concat(err_,'5. history status aset tidak sesuai, '); 
    end if;        
    
    
    if status_barang_ = 3 then     
       select count(*) into cnt_ from penghapusan where id_bukuinduk = idbi_;       
       if cnt_ <> 1 then                         
          set err_ = concat(err_,'6. data penghapusan tidak ada, '); 
       end if;
    end if;     

    
    if status_barang_ <> 3 then      
       
       select count(*) into cnt_ from     
       (select kint,ka,kb, sum(jml_barang_d - jml_barang_k ) as cnt from t_jurnal_aset where idbi = idbi_ group by kint,ka,kb) aa
       where aa.cnt = 1;        
    
       
      if  cnt_ <> 1   then     
        
        set err_ = concat(err_,'7. jurnal tidak sesuai, '); 
      else    
          
        select kint,ka,kb,cnt  into kint_,ka_,kb_, cnt_ from     
          (select kint,ka,kb, sum(jml_barang_d - jml_barang_k ) as cnt from t_jurnal_aset where idbi = idbi_ group by kint,ka,kb) aa
        where aa.cnt = 1;                 
        if kint_ is null or kint_ = '' then    
          set err_ = concat(err_, '8. jurnal tidak sesuai, ');
        elseif staset_ = 3 and status_barang_=1 and concat(kint_,'.',ka_,'.',kb_) <> concat('01.01.' , f_ ) then
          set err_ = concat(err_, '9. jurnal tidak sesuai, ');     
        elseif staset_ = 8 and status_barang_=1 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.04' then   
          set err_ = concat(err_, '10. jurnal tidak sesuai, ');   
        elseif staset_ = 5 and status_barang_=4 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.01' then 
          set err_ = concat(err_, '11. jurnal tidak sesuai, ');              
        elseif staset_ = 6 and status_barang_=5 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.02' then 
          set err_ = concat(err_, '12. jurnal tidak sesuai, ');
        elseif staset_ = 7 and status_barang_=2 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.03' then 
          set err_ = concat(err_, '13. jurnal tidak sesuai, ');
        elseif staset_ = 9 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.05'  then  
          set err_ = concat(err_, '14. jurnal tidak sesuai, ');
        elseif staset_ = 10 and concat(kint_,'.',ka_,'.',kb_) <> '02.00.00' then    
          set err_ = concat(err_, '15. jurnal tidak sesuai, ');        
        elseif (staset_ = 11 or staset_ = 12 or staset_ = 13 ) and concat(kint_,'.',ka_,'.',kb_)<> '01.02.06' then    
          set err_ = concat(err_, '16. jurnal tidak sesuai, ');                   
        elseif staset_ = 14 and concat(kint_,'.',ka_,'.',kb_)<> '01.02.07' then    
          set err_ = concat(err_, '17. jurnal tidak sesuai, ');        
        end if;
    
      end if;

    end if;
     
    
    select sum(dif_kondisi) into dif_kondisi_ from t_kondisi where idbi_awal = idawal_;        
    if dif_kondisi_ <> kondisi_ or dif_kondisi_ ='' or dif_kondisi_ is null then        
       set err_ = concat(err_, '18. kondisi dan history kondisi tidak sesuai, ');    
    end if;    

    
    select count(*), max(tgl) into cnt_ , maxtgl_susut_ from penyusutan where idbi = idbi_;    
    if (cnt_>0) and status_barang_=1  and (staset_=3 or staset_=8)   then   
       select sf_getAkumSusut(idbi_, maxtgl_susut_ ) into akum_susut_;       
       SELECT    sum(kredit- debet) into akum_susut_j_  from t_jurnal_aset where idbi = idbi_ and jns_trans=10 and concat(kint,'.',ka,'.',kb) = concat('01.01.' , f_ )  ;       
       if akum_susut_ > 0 and staset_=3 and akum_susut_ <> akum_susut_j_ then 
          set err_ = concat(err_, '19. jurnal penyusutan tidak sesuai, ');          
       end if;       

       SELECT    sum(kredit- debet) into akum_susut_j_  from t_jurnal_aset where idbi = idbi_ and jns_trans=10 and concat(kint,'.',ka,'.',kb) = '01.02.04' ;       
       if akum_susut_ > 0 and staset_=8 and akum_susut_ <> akum_susut_j_ then 
          set err_ = concat(err_, '20. jurnal penyusutan tidak sesuai, ');          
       end if;
    end if;    

    
    if idbi_ = idawal_ then
       select count(*) into cnt_ from t_transaksi where jns_trans2 in (1,2,3,4,5,6,7) and refid = idbi_;        
       if cnt_ = 0 or cnt_='' or cnt_ is null then         
          set err_ = concat(err_, '21. t_transaksi perolehan tidak sesuai, ');           
       end if;
    end if;    

    
    if harga_beli_+harga_atribusi_ <> jml_harga_ then        
       set err_ = concat(err_, '22. harga beli, atribusi dan perolehan tidak sesuai,');        
    end if;

    
    if tgl_buku_ = '0000-00-00' or tgl_buku_ is null or tgl_buku_ = '' then    
       set err_ = concat(err_, '23. Tanggal Buku belum diisi, ');   
    end if;    

    
    if thn_perolehan_ is null or thn_perolehan_ = '' then    
       set err_ = concat(err_, '24. Tahun Perolehan belum diisi, ');   
    end if;

    
    
    if asal_usul_awal_ <> asal_usul_ and ( id_lama_ is null or id_lama_ =0 or id_lama_ ='') then    
       set err_ = concat(err_, '25. Cara perolehan awal tidak sesuai, ');   
    end if;    

    
    if id_lama_ is not null and id_lama_ <>0 and id_lama_ <>'' then    
       select count(*) into cnt_ from penghapusan where id_bukuinduk = id_lama_;       
       if cnt_<>1 then               
           set err_ = concat(err_, '26. Penghapusan karena reklas/mutasi terhadap ID Barang sebelumnya tidak sesuai, '); 
       end if;
    end if;    

    
    if refid_terima_ is not null and refid_terima_ <>0 and refid_terima_ <>'' then        
       select count(*) into cnt_ from t_penerimaan_barang where id= refid_terima_;       
       if cnt_<>1 then               
           set err_ = concat(err_, '27. ID Penerimaan tidak sesuai, '); 
       end if;
    end if;    

    
    if idbi_ = idawal_ then
       select sum(debet-kredit) into harga_temp_ from t_jurnal_aset where jns_trans2 in (1,2,3,4,5,6,7) and refid = idbi_;        
       if harga_temp_ <> jml_harga_ then         
          set err_ = concat(err_, '28. t_jurnal_aset dengan harga perolehan tidak sesuai, ');           
       end if;
    end if;
        
   
   select count(*) into cnt_ from t_jurnal_aset where idbi = idbi_ and ( kint is null or ka is null or kb is null);   
   if cnt_ > 0 then    
      set err_ = concat(err_, '29. kode kint,ka,kb di t_jurnal_aset  tidak sesuai, ');  
   end if;
  
     

  end if;

  end if;

  delete from t_cek_bi where idbi = idbi_;
  if err_ <> '' then   
     set err_ = concat(' error no ', err_);
     insert into t_cek_bi (idbi, idbi_awal, jns_err, ket, tgl_update ) values (idbi_, idawal_, 0, err_, now());    
  end if;  

   
    

  RETURN err_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_cek_idbi_20180215`(`idbi_` int(11)) RETURNS longtext CHARSET latin1 COLLATE latin1_general_ci
BEGIN

  declare jns_err_ int;  
  declare idawal_, id_lama_, cnt_, staset_, div_staset_, dif_kondisi_, kondisi_, status_barang_ int;    
  declare f_ char(2);  
  declare kint_,ka_,kb_ char(2);  
  declare err_ text;  
  declare akum_susut_, akum_susut_j_, jml_harga_, harga_atribusi_, harga_beli_ decimal(18,2);  
  declare tgl_buku_, thn_perolehan_ date;
  declare asal_usul_awal_, asal_usul_ char(1);  
  declare maxtgl_susut_ date;  
  declare refid_terima_ int;  
  declare harga_temp_ decimal(18,2);  
  declare tgl_buku_lama_ date;  
  declare thn_anggaran_ int;

  set jns_err_ = 0;  
  set idawal_ = 0;  
  set cnt_ = 0;
  set err_ = '';      

  
  
  
  select nilai into thn_anggaran_ from setting where Id = 'THN_ANGGARAN';  
  
   
  select count(id) into cnt_ from  buku_induk where id = idbi_; 
  if cnt_ = 0 or cnt_='' or cnt_ is null then    
     set jns_err_ = 1;  
     set err_ = concat(err_,'1. id barang tidak ada, ');
  else
  
  select idawal, f , staset, status_barang, kondisi ,jml_harga, harga_atribusi, harga_beli , tgl_buku, thn_perolehan, asal_usul_awal, asal_usul, 
  id_lama, refid_terima
  into idawal_, f_, staset_, status_barang_ , kondisi_ ,jml_harga_, harga_atribusi_, harga_beli_, tgl_buku_, thn_perolehan_ , asal_usul_awal_, asal_usul_,  
  id_lama_, refid_terima_
  from buku_induk where id = idbi_; 
  if idawal_ = 0 or idawal_='' or idawal_ is null then
    
    
    set err_ = concat(err_,'2. id awal tidak ada, ');
  end if;  

  
  if status_barang_ <> 3 then
    if f_ = '01' then
      select count(*) into cnt_ from kib_a where idbi = idbi_;        
    elseif f_ = '02' then  
      select count(*) into cnt_ from kib_b where idbi = idbi_;        
    elseif f_ = '03' then   
      select count(*) into cnt_ from kib_c where idbi = idbi_;        
    elseif f_ = '04' then   
      select count(*) into cnt_ from kib_d where idbi = idbi_;        
    elseif f_ = '05' then   
      select count(*) into cnt_ from kib_e where idbi = idbi_;        
    elseif f_ = '06' then   
      select count(*) into cnt_ from kib_f where idbi = idbi_;        
    elseif f_ = '07' then
      select count(*) into cnt_ from kib_g where idbi = idbi_;          
    end if;
    if cnt_ = 0 or cnt_ is null then          
      
      set err_ = concat(err_,'3. data kib tidak ada, ');
    end if;  
  end if;  

  
  select count(*) into cnt_ from buku_induk where year(tgl_buku) < thn_anggaran_ and idawal = idawal_ and status_barang <> 3;  
  
  if cnt_ > 1 then  
    set err_ = concat(err_,'30. untuk perode sebelumnya: idawal = ',idawal_, " tidak boleh dipakai lebih dari satu, "); 
  end if; 

    
  if idawal_ is not null or idawal_ > 0 then    
    
    if staset_ not in (3,5,6,7,8,9,10,11,12,13,14) then
      
      set err_ = concat(err_,'4. status aset salah, '); 
    end if;   
        
        

    
    if status_barang_ = 3  then  
       select count(*) into cnt_ from buku_induk where  idawal=idawal_ and id>idbi_ and year(tgl_buku)<thn_anggaran_ ;
       if cnt_ = 0 then
         select count(*) into cnt_ from penghapusan where id_bukuinduk = idbi_;       
         if cnt_ <> 1 then                         
          set err_ = concat(err_,'6. data penghapusan tidak ada, '); 
         end if;         
       end if;
    end if;    
     

    
    if status_barang_ <> 3 then      
       
       select count(*) into cnt_ from     
       (select kint,ka,kb, sum(jml_barang_d - jml_barang_k ) as cnt from t_jurnal_aset where idbi = idbi_ group by kint,ka,kb) aa
       where aa.cnt = 1;        
    
       
      if  cnt_ <> 1   then     
        
        set err_ = concat(err_,'7. jurnal tidak sesuai, '); 
      else    
          
        select kint,ka,kb,cnt  into kint_,ka_,kb_, cnt_ from     
          (select kint,ka,kb, sum(jml_barang_d - jml_barang_k ) as cnt from t_jurnal_aset where idbi = idbi_ group by kint,ka,kb) aa
        where aa.cnt = 1;                 
        if kint_ is null or kint_ = '' then    
          set err_ = concat(err_, '8. jurnal tidak sesuai, ');
        elseif staset_ = 3 and status_barang_=1 and concat(kint_,'.',ka_,'.',kb_) <> concat('01.01.' , f_ ) then
          set err_ = concat(err_, '9. jurnal tidak sesuai, ');     
        elseif staset_ = 8 and status_barang_=1 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.04' then   
          set err_ = concat(err_, '10. jurnal tidak sesuai, ');   
        elseif staset_ = 5 and status_barang_=4 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.01' then 
          set err_ = concat(err_, '11. jurnal tidak sesuai, ');              
        elseif staset_ = 6 and status_barang_=5 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.02' then 
          set err_ = concat(err_, '12. jurnal tidak sesuai, ');
        elseif staset_ = 7 and status_barang_=2 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.03' then 
          set err_ = concat(err_, '13. jurnal tidak sesuai, ');
        elseif staset_ = 9 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.05'  then  
          set err_ = concat(err_, '14. jurnal tidak sesuai, ');
        elseif staset_ = 10 and concat(kint_,'.',ka_,'.',kb_) <> '02.00.00' then    
          set err_ = concat(err_, '15. jurnal tidak sesuai, ');        
        elseif (staset_ = 11 or staset_ = 12 or staset_ = 13 ) and concat(kint_,'.',ka_,'.',kb_)<> '01.02.06' then    
          set err_ = concat(err_, '16. jurnal tidak sesuai, ');                   
        elseif staset_ = 14 and concat(kint_,'.',ka_,'.',kb_)<> '01.02.07' then    
          set err_ = concat(err_, '17. jurnal tidak sesuai, ');        
        end if;
    
      end if;

    end if;
    
        

    
    select count(*), max(tgl) into cnt_ , maxtgl_susut_ from penyusutan where idbi = idbi_;    
    if (cnt_>0) and status_barang_=1  and (staset_=3 or staset_=8)   then   
       select sf_getAkumSusut(idbi_, maxtgl_susut_ ) into akum_susut_;       
       SELECT    sum(kredit- debet) into akum_susut_j_  from t_jurnal_aset where idbi = idbi_ and jns_trans=10 and concat(kint,'.',ka,'.',kb) = concat('01.01.' , f_ )  ;       
       if akum_susut_ > 0 and staset_=3 and akum_susut_ <> akum_susut_j_ then 
          set err_ = concat(err_, '19. jurnal penyusutan tidak sesuai, ');          
       end if;       

       SELECT    sum(kredit- debet) into akum_susut_j_  from t_jurnal_aset where idbi = idbi_ and jns_trans=10 and concat(kint,'.',ka,'.',kb) = '01.02.04' ;       
       if akum_susut_ > 0 and staset_=8 and akum_susut_ <> akum_susut_j_ then 
          set err_ = concat(err_, '20. jurnal penyusutan tidak sesuai, ');          
       end if;
    end if;    

    
    if idbi_ = idawal_ and year(tgl_buku_)>=thn_anggaran_ then
       select count(*) into cnt_ from t_transaksi where jns_trans2 in (1,2,3,4,5,6,7) and refid = idbi_;        
       if cnt_ = 0 or cnt_='' or cnt_ is null then         
          set err_ = concat(err_, '21. t_transaksi perolehan tidak sesuai, ');           
       end if;
    end if;    

    
    if harga_beli_+harga_atribusi_ <> jml_harga_ then        
       set err_ = concat(err_, '22. harga beli, atribusi dan perolehan tidak sesuai,');        
    end if;

    
    if tgl_buku_ = '0000-00-00' or tgl_buku_ is null or tgl_buku_ = '' then    
       set err_ = concat(err_, '23. Tanggal Buku belum diisi, ');   
    end if;    

    
    if thn_perolehan_ is null or thn_perolehan_ = '' then    
       set err_ = concat(err_, '24. Tahun Perolehan belum diisi, ');   
    end if;
        

    
    
    if asal_usul_awal_ <> asal_usul_ and ( id_lama_ is null or id_lama_ =0 or id_lama_ ='') then    
       set err_ = concat(err_, '25. Cara perolehan awal tidak sesuai, ');   
    end if;    

    
    
    if id_lama_ is not null and id_lama_ <>0 and id_lama_ <>'' then  
       select tgl_buku into tgl_buku_lama_ from buku_induk where id =  id_lama_;       
       if year(tgl_buku_lama_) >= thn_anggaran_ then   
         select count(*) into cnt_ from penghapusan where id_bukuinduk = id_lama_;       
         if cnt_<>1 then               
           set err_ = concat(err_, '26. Penghapusan karena reklas/mutasi terhadap ID Barang sebelumnya tidak sesuai, '); 
         end if;           
       end if;
    end if;    

    
    if refid_terima_ is not null and refid_terima_ <>0 and refid_terima_ <>'' then        
       select count(*) into cnt_ from t_penerimaan_barang where id= refid_terima_;       
       if cnt_<>1 then               
           set err_ = concat(err_, '27. ID Penerimaan tidak sesuai, '); 
       end if;
    end if;    

    
    if idbi_ = idawal_ and year(tgl_buku_) >= thn_anggaran_ then
       select sum(debet-kredit) into harga_temp_ from t_jurnal_aset where jns_trans2 in (1,2,3,4,5,6,7) and refid = idbi_;        
       if harga_temp_ <> jml_harga_ then         
          set err_ = concat(err_, '28. t_jurnal_aset dengan harga perolehan tidak sesuai, ');           
       end if;
    end if;
        
   
   select count(*) into cnt_ from t_jurnal_aset where idbi = idbi_ and ( kint is null or ka is null or kb is null);   
   if cnt_ > 0 then    
      set err_ = concat(err_, '29. kode kint,ka,kb di t_jurnal_aset  tidak sesuai, ');  
   end if;
  
     

  end if;

  end if;

  delete from t_cek_bi where idbi = idbi_;
  if err_ <> '' then   
     set err_ = concat(' error no ', err_);
     insert into t_cek_bi (idbi, idbi_awal, jns_err, ket, tgl_update ) values (idbi_, idawal_, 0, err_, now());    
  end if;  

   
    

  RETURN err_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_cek_idbi_20180217`(`idbi_` int(11)) RETURNS longtext CHARSET latin1 COLLATE latin1_general_ci
BEGIN

  declare jns_err_ int;  
  declare idawal_, id_lama_, cnt_, staset_, div_staset_, dif_kondisi_, kondisi_, status_barang_ int;    
  declare f_ char(2);  
  declare kint_,ka_,kb_ char(2);  
  declare err_ text;  
  declare akum_susut_, akum_susut_j_, jml_harga_, harga_atribusi_, harga_beli_ decimal(18,2);  
  declare tgl_buku_, thn_perolehan_ date;
  declare asal_usul_awal_, asal_usul_ char(1);  
  declare maxtgl_susut_ date;  
  declare refid_terima_ int;  
  declare harga_temp_ decimal(18,2);  
  declare tgl_buku_lama_ date;  
  declare thn_anggaran_ int;

  set jns_err_ = 0;  
  set idawal_ = 0;  
  set cnt_ = 0;
  set err_ = '';      

  
  
  
  select nilai into thn_anggaran_ from setting where Id = 'THN_ANGGARAN';  
  
   
  select count(id) into cnt_ from  buku_induk where id = idbi_; 
  if cnt_ = 0 or cnt_='' or cnt_ is null then    
     set jns_err_ = 1;  
     set err_ = concat(err_,'1. id barang tidak ada, ');
  else
  
  select idawal, f , staset, status_barang, kondisi ,jml_harga, harga_atribusi, harga_beli , tgl_buku, thn_perolehan, asal_usul_awal, asal_usul, 
  id_lama, refid_terima
  into idawal_, f_, staset_, status_barang_ , kondisi_ ,jml_harga_, harga_atribusi_, harga_beli_, tgl_buku_, thn_perolehan_ , asal_usul_awal_, asal_usul_,  
  id_lama_, refid_terima_
  from buku_induk where id = idbi_; 
  if idawal_ = 0 or idawal_='' or idawal_ is null then
    
    
    set err_ = concat(err_,'2. id awal tidak ada, ');
  end if;  

  
  if status_barang_ <> 3 then
    if f_ = '01' then
      select count(*) into cnt_ from kib_a where idbi = idbi_;        
    elseif f_ = '02' then  
      select count(*) into cnt_ from kib_b where idbi = idbi_;        
    elseif f_ = '03' then   
      select count(*) into cnt_ from kib_c where idbi = idbi_;        
    elseif f_ = '04' then   
      select count(*) into cnt_ from kib_d where idbi = idbi_;        
    elseif f_ = '05' then   
      select count(*) into cnt_ from kib_e where idbi = idbi_;        
    elseif f_ = '06' then   
      select count(*) into cnt_ from kib_f where idbi = idbi_;        
    elseif f_ = '07' then
      select count(*) into cnt_ from kib_g where idbi = idbi_;          
    end if;
    if cnt_ = 0 or cnt_ is null then          
      
      set err_ = concat(err_,'3. data kib tidak ada, ');
    end if;  
  end if;  

  
  select count(*) into cnt_ from buku_induk where year(tgl_buku) < thn_anggaran_ and idawal = idawal_ and status_barang <> 3;  
  
  if cnt_ > 1 then  
    set err_ = concat(err_,'30. untuk perode sebelumnya: idawal = ',idawal_, " tidak boleh dipakai lebih dari satu, "); 
  end if; 

    
  if idawal_ is not null or idawal_ > 0 then    
    
    if staset_ not in (3,5,6,7,8,9,10,11,12,13,14) then
      
      set err_ = concat(err_,'4. status aset salah, '); 
    end if;   
        
        

    
    if status_barang_ = 3  then  
       select count(*) into cnt_ from buku_induk where  idawal=idawal_ and id>idbi_ and year(tgl_buku)<thn_anggaran_ ;
       if cnt_ = 0 then
         select count(*) into cnt_ from penghapusan where id_bukuinduk = idbi_;       
         if cnt_ <> 1 then                         
          set err_ = concat(err_,'6. data penghapusan tidak ada, '); 
         end if;         
       end if;
    end if;    
     

    
    if status_barang_ <> 3 then      
       
       select count(*) into cnt_ from     
       (select kint,ka,kb, sum(jml_barang_d - jml_barang_k ) as cnt from t_jurnal_aset where idbi = idbi_ group by kint,ka,kb) aa
       where aa.cnt = 1;        
    
       
      if  cnt_ <> 1   then     
        
        set err_ = concat(err_,'7. jurnal tidak sesuai, '); 
      else    
          
        select kint,ka,kb,cnt  into kint_,ka_,kb_, cnt_ from     
          (select kint,ka,kb, sum(jml_barang_d - jml_barang_k ) as cnt from t_jurnal_aset where idbi = idbi_ group by kint,ka,kb) aa
        where aa.cnt = 1;                 
        if kint_ is null or kint_ = '' then    
          set err_ = concat(err_, '8. jurnal tidak sesuai, ');
        elseif staset_ = 3 and status_barang_=1 and concat(kint_,'.',ka_,'.',kb_) <> concat('01.01.' , f_ ) then
          set err_ = concat(err_, '9. jurnal tidak sesuai, ');     
        elseif staset_ = 8 and status_barang_=1 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.04' then   
          set err_ = concat(err_, '10. jurnal tidak sesuai, ');   
        elseif staset_ = 5 and status_barang_=4 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.01' then 
          set err_ = concat(err_, '11. jurnal tidak sesuai, ');              
        elseif staset_ = 6 and status_barang_=5 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.02' then 
          set err_ = concat(err_, '12. jurnal tidak sesuai, ');
        elseif staset_ = 7 and status_barang_=2 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.03' then 
          set err_ = concat(err_, '13. jurnal tidak sesuai, ');
        elseif staset_ = 9 and concat(kint_,'.',ka_,'.',kb_) <> '01.02.05'  then  
          set err_ = concat(err_, '14. jurnal tidak sesuai, ');
        elseif staset_ = 10 and concat(kint_,'.',ka_,'.',kb_) <> '02.00.00' then    
          set err_ = concat(err_, '15. jurnal tidak sesuai, ');        
        elseif (staset_ = 11 or staset_ = 12 or staset_ = 13 ) and concat(kint_,'.',ka_,'.',kb_)<> '01.02.06' then    
          set err_ = concat(err_, '16. jurnal tidak sesuai, ');                   
        elseif staset_ = 14 and concat(kint_,'.',ka_,'.',kb_)<> '01.02.07' then    
          set err_ = concat(err_, '17. jurnal tidak sesuai, ');        
        end if;
    
      end if;

    end if;
    
        

    
    select count(*), max(tgl) into cnt_ , maxtgl_susut_ from penyusutan where idbi = idbi_;    
    if (cnt_>0) and status_barang_=1  and (staset_=3 or staset_=8)   then   
       select sf_getAkumSusut(idbi_, maxtgl_susut_ ) into akum_susut_;       
       SELECT    sum(kredit- debet) into akum_susut_j_  from t_jurnal_aset where idbi = idbi_ and jns_trans=10 and concat(kint,'.',ka,'.',kb) = concat('01.01.' , f_ )  ;       
       if akum_susut_ > 0 and staset_=3 and akum_susut_ <> akum_susut_j_ then 
          set err_ = concat(err_, '19. jurnal penyusutan tidak sesuai, ');          
       end if;       

       SELECT    sum(kredit- debet) into akum_susut_j_  from t_jurnal_aset where idbi = idbi_ and jns_trans=10 and concat(kint,'.',ka,'.',kb) = '01.02.04' ;       
       if akum_susut_ > 0 and staset_=8 and akum_susut_ <> akum_susut_j_ then 
          set err_ = concat(err_, '20. jurnal penyusutan tidak sesuai, ');          
       end if;
    end if;    

    
    if idbi_ = idawal_ and year(tgl_buku_)>=thn_anggaran_ then
       select count(*) into cnt_ from t_transaksi where jns_trans2 in (1,2,3,4,5,6,7) and refid = idbi_;        
       if cnt_ = 0 or cnt_='' or cnt_ is null then         
          set err_ = concat(err_, '21. t_transaksi perolehan tidak sesuai, ');           
       end if;
    end if;    

    
    if harga_beli_+harga_atribusi_ <> jml_harga_ then        
       set err_ = concat(err_, '22. harga beli, atribusi dan perolehan tidak sesuai,');        
    end if;

    
    if tgl_buku_ = '0000-00-00' or tgl_buku_ is null or tgl_buku_ = '' then    
       set err_ = concat(err_, '23. Tanggal Buku belum diisi, ');   
    end if;    

    
    if thn_perolehan_ is null or thn_perolehan_ = '' then    
       set err_ = concat(err_, '24. Tahun Perolehan belum diisi, ');   
    end if;    

      

    
    
    if id_lama_ is not null and id_lama_ <>0 and id_lama_ <>'' then  
       select tgl_buku into tgl_buku_lama_ from buku_induk where id =  id_lama_;       
       if year(tgl_buku_lama_) >= thn_anggaran_ then   
         select count(*) into cnt_ from penghapusan where id_bukuinduk = id_lama_;       
         if cnt_<>1 then               
           set err_ = concat(err_, '26. Penghapusan karena reklas/mutasi terhadap ID Barang sebelumnya tidak sesuai, '); 
         end if;           
       end if;
    end if;    

    
    if refid_terima_ is not null and refid_terima_ <>0 and refid_terima_ <>'' then        
       select count(*) into cnt_ from t_penerimaan_barang where id= refid_terima_;       
       if cnt_<>1 then               
           set err_ = concat(err_, '27. ID Penerimaan tidak sesuai, '); 
       end if;
    end if;    

    
    if idbi_ = idawal_ and year(tgl_buku_) >= thn_anggaran_ then
       select sum(debet-kredit) into harga_temp_ from t_jurnal_aset where jns_trans2 in (1,2,3,4,5,6,7) and refid = idbi_;        
       if harga_temp_ <> jml_harga_ then         
          set err_ = concat(err_, '28. t_jurnal_aset dengan harga perolehan tidak sesuai, ');           
       end if;
    end if;
        
   
   select count(*) into cnt_ from t_jurnal_aset where idbi = idbi_ and ( kint is null or ka is null or kb is null);   
   if cnt_ > 0 then    
      set err_ = concat(err_, '29. kode kint,ka,kb di t_jurnal_aset  tidak sesuai, ');  
   end if;
  
     

  end if;

  end if;

  delete from t_cek_bi where idbi = idbi_;
  if err_ <> '' then   
     set err_ = concat(' error no ', err_);
     insert into t_cek_bi (idbi, idbi_awal, jns_err, ket, tgl_update ) values (idbi_, idawal_, 0, err_, now());    
  end if;  

   
    

  RETURN err_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_getAkumSusut`(`idbi_` int(11), tgl_ date) RETURNS decimal(18,5)
BEGIN

  
  declare hrg_susut_  decimal(18,5);  
  set hrg_susut_ = 0;

  select sum(ifnull(harga,0)) into hrg_susut_ from penyusutan where idbi = idbi_ and tgl <= tgl_ and (id_koreksi is null or id_koreksi ='' or id_koreksi=0);
  if hrg_susut_ is null then    
     set hrg_susut_ = 0;
  end if;
  RETURN hrg_susut_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_getnomor_bku`(`c1_` text, `c_` text, `d_` text, `tahun_` text) RETURNS int(11)
BEGIN
  DECLARE nomor_bku_, hit_ int;  

  SELECT nomor_bku, count(Id)  INTO nomor_bku_, hit_ FROM t_bku WHERE c1=c1_ AND c=c_ AND d=d_ AND tahun=tahun_ ORDER BY nomor_bku DESC LIMIT 0,1;    
  IF hit_ = 0 THEN 
      set nomor_bku_ = 0;
  END IF;
  set nomor_bku_= nomor_bku_+1;
  RETURN nomor_bku_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_get_bi_noreg`(`idbi_` int(11)) RETURNS int(11)
BEGIN



  declare noreg_ int;  
  declare c1_ char(1);
  declare c_,d_,e_ char(2);
  declare e1_ char(3);  
  declare f1_,f2_ char(1);
  declare f_,g_,h_,i_ char(2);
  declare j_  char(3);  
  declare thn_perolehan_ char(4);  

  select c1,c,d,e,e1,f1,f2,f,g,h,i,j,thn_perolehan into 
    c1_,c_,d_,e_,e1_,f1_,f2_,f_,g_,h_,i_,j_,thn_perolehan_ from buku_induk where id = idbi_;

  select max(ifnull(noreg_baru,0)) +1 into noreg_ from buku_induk where c1= c1_ and c=c_ and d=d_ and e=e_ and e1=e1_ 
    and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and thn_perolehan=thn_perolehan_ and id<>idbi_ ;  
    
  if noreg_ is null or noreg_ = '' then   
     set noreg_=1;
  end if;
  
  
  RETURN noreg_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_get_susut`( `idbi_` int(11) , thnsusut_ int(11), blnsusut_ int(11), susut_mode int(11) ) RETURNS varchar(255) CHARSET latin1
    DETERMINISTIC
BEGIN
  
 

  declare masa_manfaat_ int(11);  
  declare residu_  decimal(10,2);  
  declare thn_susut_aw_, bln_susut_aw_, thn_susut_ak_, bln_susut_ak_ int(11);  
  declare f_,g_,h_,i_,j_, idbi_awal_ int(11);  
  declare curthn_  int(11);  
  declare tot_, tot_rehab_, hrg_perolehan_, hrg_susut_, nilai_buku_ decimal(18,2);    
  declare tot_manfaat_, masa_rehab_ int(11);  
  declare thn_perolehan_, bln_buku_ int(11);
    
  set hrg_susut_ = 0; 
  set tot_rehab_ = 0; 
  set masa_rehab_ = 0;   
  set residu_ = 0;  
  set hrg_susut_ = 0;
  set tot_rehab_ = 0;
  set masa_manfaat_ = 0;
  set hrg_perolehan_ = 0;
  set nilai_buku_ = 0;



  
  
  select f,g,h,i,j, thn_susut_aw, bln_susut_aw, thn_susut_ak, bln_susut_ak, masa_manfaat, nilai_sisa , idawal, jml_harga, thn_perolehan, MONTH(tgl_buku)
    into f_,g_,h_,i_,j_, thn_susut_aw_, bln_susut_aw_, thn_susut_ak_, bln_susut_ak_, masa_manfaat_, residu_ , idbi_awal_, hrg_perolehan_, thn_perolehan_, bln_buku_  
    from buku_induk where id=idbi_;  
  
  if masa_manfaat_ = 0 or masa_manfaat_ is null then    
    select masa_manfaat, residu into masa_manfaat_, residu_  from ref_barang where     
      f = f_ and g=g_ and h=h_ and i=i_ and j=j_;
  end if; 

  

  if thnsusut_*12 + blnsusut_  > thn_perolehan_ *12 + bln_buku_ then 
  if  masa_manfaat_ > 0 then 
    set curthn_ = thnsusut_ * 12 + blnsusut_;        

    
    
    
    
    select sum(biaya_pemeliharaan), sum(ifnull(masa_manfaat,0)) 
      into tot_, tot_manfaat_  from pemeliharaan 
      where tambah_aset=1 and idbi_awal= idbi_awal_
      and (YEAR(tgl_pemeliharaan)*12) + MONTH(tgl_pemeliharaan) < curthn_;
    set tot_rehab_ = tot_rehab_ + ifnull(tot_,0); 
    set masa_rehab_ = masa_rehab_ + ifnull(tot_manfaat_,0);
    
    select sum(biaya_pengamanan), sum(ifnull(masa_manfaat,0)) 
      into tot_, tot_manfaat_  from pengamanan 
      where tambah_aset=1 and idbi_awal= idbi_awal_
      and (YEAR(tgl_pengamanan)*12) + MONTH(tgl_pengamanan) < curthn_;      
    set tot_rehab_ = tot_rehab_ + ifnull(tot_,0);    
    set masa_rehab_ = masa_rehab_ + ifnull(tot_manfaat_,0);
    
    select sum(harga_hapus), sum(ifnull(masa_manfaat,0)) 
      into tot_, tot_manfaat_ from penghapusan_sebagian 
      where  idbi_awal= idbi_awal_
      and (YEAR(tgl_penghapusan)*12) + MONTH(tgl_penghapusan) < curthn_;      
    set tot_rehab_ = tot_rehab_ + ifnull(tot_,0);    
    set masa_rehab_ = masa_rehab_ + ifnull(tot_manfaat_,0);
    
    select sum(harga_baru - harga), sum(ifnull(masa_manfaat,0)) 
      into tot_, tot_manfaat_ from t_koreksi
      where idbi_awal= idbi_awal_
      and (YEAR(tgl)*12) + MONTH(tgl) <= curthn_;       
    set tot_rehab_ = tot_rehab_ + ifnull(tot_,0);
    set masa_rehab_ = masa_rehab_ + ifnull(tot_manfaat_,0);        
    
    select sum(nilai_barang - nilai_barang_asal), sum(ifnull(masa_manfaat,0)) 
      into tot_, tot_manfaat_ from penilaian
      where idbi_awal= idbi_awal_
      and (YEAR(tgl_penilaian)*12) + MONTH(tgl_penilaian) < curthn_;       
    set tot_rehab_ = tot_rehab_ + ifnull(tot_,0);
    set masa_rehab_ = masa_rehab_ + ifnull(tot_manfaat_,0); 
        
    
    set nilai_buku_ = hrg_perolehan_ + ifnull(tot_rehab_,0);   
    set masa_manfaat_ = masa_manfaat_ + masa_rehab_;    

    
    set hrg_susut_ = ((nilai_buku_ - ( residu_/100* nilai_buku_ ))/masa_manfaat_ )/12; 
  
   
  end if; 
  end if; 


  
  return concat(hrg_susut_,';',tot_rehab_,';',masa_rehab_,';',masa_manfaat_,';',hrg_perolehan_,';',nilai_buku_);
  
  
  
  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_get_tambah_manfaat`(f_ int, g_ int, h_ int, i_ int, j_ int, nilai_rehab_ decimal(18,2), nilai_buku_ decimal(18,2) ) RETURNS int(11)
BEGIN



 declare tambah_manfaat_ integer;    
  declare persen_, cek_persen_ decimal(18,2);   
  declare cnt_ integer; 
  declare SUSUT_MODE_ integer;  
declare cek_ varchar(200); 
    
 
 select nilai into SUSUT_MODE_ from setting where Id= 'SUSUT_MODE';  
  
  
set cnt_ = 0;

  if nilai_buku_ <=0 then   
    set persen_ = 0;    
  else
    set persen_ = nilai_rehab_/nilai_buku_ * 100;      
  end if;  

if persen_ > 100 and SUSUT_MODE_ <> 8 then  
    set persen_ = 100;    
end if;

if SUSUT_MODE_ = 8 then
    select max(persen2), concat(f,'.',g,'.',h,'.',i,'.',j) into cek_persen_, cek_ from ref_tambah_manfaat
    where CAST(f AS UNSIGNED) = 'f_' and CAST(g AS UNSIGNED)='g_' and CAST(h AS UNSIGNED)='h_' and (i='00' or i is null) and (j='00' or j is null);    
    if persen_ > cek_persen_ then    
        select masa_manfaat into tambah_manfaat_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    end if;
end if;

select masa_manfaat, concat(f,'.',g,'.',h,'.',i,'.',j) into tambah_manfaat_ , cek_ from ref_tambah_manfaat
   where  CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and CAST(h AS UNSIGNED)=h_ and CAST(i AS UNSIGNED)=i_ and CAST(j AS UNSIGNED)=j_
   and persen1<persen_  and persen_ <= persen2 ;   

if tambah_manfaat_ is null then
   select max(masa_manfaat), concat(f,'.',g,'.',h,'.',i,'.',j) into tambah_manfaat_ , cek_ from ref_tambah_manfaat
   where  CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and CAST(h AS UNSIGNED)=h_ and CAST(i AS UNSIGNED)=i_ and CAST(j AS UNSIGNED)=j_;  
end if;

if tambah_manfaat_ is null then
   select ifnull(masa_manfaat,0) ,concat(f,'.',g,'.',h,'.',i,'.',j)  into tambah_manfaat_, cek_  from ref_tambah_manfaat
   where  CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and CAST(h AS UNSIGNED)=h_ and CAST(i AS UNSIGNED)=i_ and (j='000' or j is null)
   and persen1<persen_  and persen_ <= persen2 ;    
end if;

if tambah_manfaat_ is null then
   select max(masa_manfaat) ,concat(f,'.',g,'.',h,'.',i,'.',j)  into tambah_manfaat_, cek_  from ref_tambah_manfaat
   where  CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and CAST(h AS UNSIGNED)=h_ and CAST(i AS UNSIGNED)=i_ and (j='000' or j is null);  
end if;

if tambah_manfaat_ is null then
   select ifnull(masa_manfaat,0) ,concat(f,'.',g,'.',h,'.',i,'.',j) into tambah_manfaat_, cek_  from ref_tambah_manfaat
   where  CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and CAST(h AS UNSIGNED)=h_ and (i='00' or i is null) and (j='000' or j is null)
   and persen1<persen_  and persen_ <= persen2 ;    
end if;

if tambah_manfaat_ is null then
   select max(masa_manfaat) ,concat(f,'.',g,'.',h,'.',i,'.',j) into tambah_manfaat_, cek_  from ref_tambah_manfaat
   where  CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and CAST(h AS UNSIGNED)=h_ and (i='00' or i is null) and (j='000' or j is null);   
end if;

if tambah_manfaat_ is null then
   select ifnull(masa_manfaat,0) , concat(f,'.',g,'.',h,'.',i,'.',j) into tambah_manfaat_, cek_  from ref_tambah_manfaat
   where  CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and (h='00' or h is null)  and (i='00' or i is null) and (j='000' or j is null)
   and persen1<persen_  and persen_ <= persen2 ;    
end if;

if tambah_manfaat_ is null then
   select max(masa_manfaat) , concat(f,'.',g,'.',h,'.',i,'.',j) into tambah_manfaat_, cek_  from ref_tambah_manfaat
   where  CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and (h='00' or h is null)  and (i='00' or i is null) and (j='000' or j is null);   
end if;

if tambah_manfaat_ is null then
   select ifnull(masa_manfaat,0) ,concat(f,'.',g,'.',h,'.',i,'.',j) into tambah_manfaat_, cek_  from ref_tambah_manfaat
   where  CAST(f AS UNSIGNED) = f_ and (g='00' or g is null) and (h='00' or h is null)  and (i='00' or i is null) and (j='000' or j is null)
   and persen1<persen_  and persen_ <= persen2 ;    
end if;

if tambah_manfaat_ is null then
   select max(masa_manfaat) ,concat(f,'.',g,'.',h,'.',i,'.',j) into tambah_manfaat_, cek_  from ref_tambah_manfaat
   where  CAST(f AS UNSIGNED) = f_ and (g='00' or g is null) and (h='00' or h is null)  and (i='00' or i is null) and (j='000' or j is null);
end if;

if tambah_manfaat_ is null then
   select ifnull(masa_manfaat,0) ,concat(f,'.',g,'.',h,'.',i,'.',j) into tambah_manfaat_, cek_  from ref_tambah_manfaat
   where  (f='00' or f is null) and (g='00' or g is null) and (h='00' or h is null)  and (i='00' or i is null) and (j='000' or j is null)
   and persen1<persen_  and persen_ <= persen2 ;    
end if;

if tambah_manfaat_ is null then
   select max(masa_manfaat) ,concat(f,'.',g,'.',h,'.',i,'.',j) into tambah_manfaat_, cek_  from ref_tambah_manfaat
   where  (f='00' or f is null) and (g='00' or g is null) and (h='00' or h is null)  and (i='00' or i is null) and (j='000' or j is null);   
end if;

if tambah_manfaat_ is null or nilai_rehab_ = 0 then 
   set tambah_manfaat_ = 0;      
end if;


return tambah_manfaat_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_get_tambah_manfaat_20161013`(f_ int, g_ int, h_ int, i_ int, j_ int, nilai_rehab_ decimal(18,2), nilai_buku_ decimal(18,2) ) RETURNS int(11)
BEGIN

 declare tambah_manfaat_ integer;    
  declare persen_ decimal(18,2);   
  declare cnt_ integer;
  
  
  
     
  set tambah_manfaat_ = 0;    
set cnt_ = 0;

  if nilai_buku_ <=0 then   
    set persen_ = 0;    
  else
    set persen_ = nilai_rehab_/nilai_buku_ * 100;      
  end if;  

if persen_ > 100 then  
    set persen_ = 100;    
  end if;
  
    


select count(*) into cnt_  from ref_tambah_manfaat  where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;
if cnt_>0 then
  select ifnull(masa_manfaat,0) into tambah_manfaat_ from ref_tambah_manfaat  
    where 
    concat(f_,'.',g_,'.',h_,'.',i_,'.',j_)     
    like concat(
    
    concat(
    if(CAST(f AS UNSIGNED)<>0, CAST(f AS UNSIGNED), '') ,
    if(CAST(g AS UNSIGNED)<>0, concat('.',CAST(g AS UNSIGNED)), '') ,
    if(CAST(h AS UNSIGNED)<>0, concat('.',CAST(h AS UNSIGNED)), '') ,
    if(CAST(i AS UNSIGNED)<>0, concat('.',CAST(i AS UNSIGNED)), '') ,
    if(CAST(j AS UNSIGNED)<>0, concat('.',CAST(j AS UNSIGNED)), '') )
    ,'%') 
    
    and persen1<persen_  and persen_ <= persen2 ;
    

  if tambah_manfaat_ =0 then 
     select max(masa_manfaat) into tambah_manfaat_  from ref_tambah_manfaat  where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;   
  end if;
end if;




  RETURN tambah_manfaat_;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_insert_log`(`log_` varchar(255)) RETURNS int(11)
BEGIN
  declare sukses_  tinyint;  

  insert into t_log (log) values(log_);     

  RETURN sukses_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_isi_bi_thn`(`idbi_` int(11), tgl_periode_ date) RETURNS longtext CHARSET latin1
BEGIN



     declare cek_ text;     
     declare kondisi_, staset_, status_barang_, kondisi2_, staset2_, status_barang2_ int;     
     declare hrg_perolehan_, nilai_susut_, hrg_perolehan2_, nilai_susut2_ decimal(18,2);              
     declare tgl_buku_ date;     
     declare idall_ varchar(40);
     declare a1_,a_,b_,c_,d_,e_ char(2);
     declare e1_ char(3);
     declare g_,f_,h_,i_ char(2);
     declare j_ char(3);
     declare noreg_ char(6);
     declare thn_perolehan_ char(4);
     declare jml_barang_ int(9);
     declare satuan_ varchar(15);
     declare harga_, jml_harga_  decimal(18,2);
     declare asal_usul_ char(1);
     declare id_lama_, idawal_ int(11);
     declare stusul_ tinyint(3);
     declare tgl_update_ datetime;
     declare tahun_ char(4);
     declare gambar_, dokumen_, dokumen_ket_, dokumen_file_ text;
     declare nilai_appraisal_ decimal(18,2);
     declare uid_ varchar(20);
     declare tgl_sensus_ datetime;
     declare jml_barang_tmp_, jml_gambar_ int(11);
     declare idall2_ varchar(40);
     declare ref_idpemegang_, ref_idpenanggung_, ref_idpemegang2_ varchar(30);
     declare ref_idruang_ bigint(22);
     declare tahun_sensus_ varchar(4);
     declare status_penguasaan_, verifikasi_ tinyint(3);
     declare harga_beli_, harga_atribusi_ decimal(18,2);     
     declare ref_idatribusi_ int(11);     
     declare masa_manfaat_ tinyint(3);
     declare nilai_sisa_ decimal(18,2);
     declare thn_susut_aw_, thn_susut_ak_, bln_susut_aw_, bln_susut_ak_ int(11);
     declare ref_idstatussurvey_ int(11);
     declare stmigrasi_ tinyint(3);
     declare ka_,kb_,kc_,kd_,ke_,kf_ smallint(3);
     declare no_ba_, no_spk_ varchar(100);
     declare tgl_ba_, tgl_spk_ date;     
     declare thn_akun_ int(11);
     declare penggunaan_ varchar(255);
     declare jns_ekstra_, jns_lain_ tinyint(3);
     declare masa_manfaat_tot_ int(11);
     declare tgl_create_ datetime;
     declare uid_create_ varchar(20);
     declare asal_usul_awal_ char(1);
     declare stop_susut_ tinyint(3);
     declare jns_hibah_, no_barang_, kampung_ varchar(100);
     declare rt_, rw_ varchar(4);          
     declare cnt_ , cnt_status_ int;     
     set cek_ = concat("idbi=",idbi_);

     
     select idall,a1,a,b,c,d,e,e1,f,g,h,i,j,noreg,thn_perolehan,jml_barang,satuan,harga,jml_harga,asal_usul,tgl_buku,id_lama,idawal,stusul,     
            tgl_update,tahun,gambar,dokumen,dokumen_ket,dokumen_file,nilai_appraisal,uid,tgl_sensus,jml_barang_tmp,jml_gambar,idall2,            
            ref_idpemegang,ref_idpenanggung,ref_idruang,tahun_sensus,ref_idpemegang2,status_penguasaan, verifikasi, harga_beli,harga_atribusi,            
            ref_idatribusi,masa_manfaat,nilai_sisa,thn_susut_aw,thn_susut_ak,bln_susut_aw,bln_susut_ak,ref_idstatussurvey,stmigrasi,            
            ka,kb,kc,kd,ke,kf,no_ba,tgl_ba,thn_akun,penggunaan,no_spk,tgl_spk,jns_ekstra,jns_lain,masa_manfaat_tot,tgl_create,uid_create,            
            asal_usul_awal,stop_susut,jns_hibah,no_barang,kampung,rt,rw
     into idall_,a1_,a_,b_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,noreg_,thn_perolehan_,jml_barang_,satuan_,harga_,jml_harga_,asal_usul_,tgl_buku_,id_lama_,idawal_,stusul_,
          tgl_update_,tahun_,gambar_,dokumen_,dokumen_ket_,dokumen_file_,nilai_appraisal_,uid_,tgl_sensus_,jml_barang_tmp_,jml_gambar_,idall2_,
          ref_idpemegang_,ref_idpenanggung_,ref_idruang_,tahun_sensus_,ref_idpemegang2_,status_penguasaan_,verifikasi_,harga_beli_,harga_atribusi_,
          ref_idatribusi_,masa_manfaat_,nilai_sisa_,thn_susut_aw_,thn_susut_ak_,bln_susut_aw_,bln_susut_ak_,ref_idstatussurvey_,stmigrasi_,
          ka_,kb_,kc_,kd_,ke_,kf_,no_ba_,tgl_ba_,thn_akun_,penggunaan_,no_spk_,tgl_spk_,jns_ekstra_,jns_lain_,masa_manfaat_tot_,tgl_create_,uid_create_,
          asal_usul_awal_,stop_susut_,jns_hibah_,no_barang_,kampung_,rt_,rw_ 
     from buku_induk where id = idbi_;     

     
     if tgl_buku_<=tgl_periode_ then     
        
        
                
        select sum(dif_kondisi) into kondisi_ from t_kondisi where tgl <= tgl_periode_ and idbi_awal = idawal_;
        select sum(div_staset) into staset_ from t_history_aset where tgl <= tgl_periode_ and idbi_awal = idawal_;
        
        set status_barang_ = 1;        
        select count(*) into cnt_status_ from pemanfaatan where id_bukuinduk = idbi_ and tgl_pemanfaatan <= tgl_periode_ ;  
        if  cnt_status_ >0 then 
           set status_barang_ = 2;            
        else 
           select count(*) into cnt_status_ from pemindahtanganan where id_bukuinduk = idbi_ and tgl_pemindahtanganan <= tgl_periode_ ;   
           if  cnt_status_ >0 then 
               set status_barang_ = 4;                                       
           else
              select count(*) into cnt_status_ from gantirugi where id_bukuinduk = idbi_ and tgl_gantirugi <= tgl_periode_ ;    
              if  cnt_status_ >0 then 
                 set status_barang_ = 5; 
              end if;     
           end if;    
        end if;
        
        select count(*) into cnt_status_ from penghapusan where id_bukuinduk = idbi_ and tgl_penghapusan <= tgl_periode_ ; 
        if  cnt_status_ >0 then 
           set status_barang_ = 3; 
        end if;        
                
        
        
        select get_nilai_buku(idbi_,tgl_periode_,0) into  hrg_perolehan_;        
        
        
        select  sf_getAkumSusut(idbi_,tgl_periode_) into nilai_susut_;      
                
        
        select count(*) into cnt_ from buku_induk_thn where idbi = idbi_ and tgl_periode = tgl_periode_;        
        if cnt_ > 0 then        
           
           select kondisi, jml_harga, nilai_susut, status_barang, staset into kondisi2_, hrg_perolehan2_, nilai_susut2_, status_barang2_, staset2_           
           from buku_induk_thn where idbi = idbi_ and tgl_periode = tgl_periode_;           
                      
           
           update buku_induk_thn           
               set kondisi = kondisi + (kondisi_ - kondisi2_),           
               jml_harga = jml_harga + (hrg_perolehan_ - hrg_perolehan2_),           
               nilai_susut = nilai_susut + (nilai_susut_ - nilai_susut2_),           
               status_barang = status_barang + (status_barang_ - status_barang2_),           
               staset = staset + (staset_ - staset2_)           
           where idbi = idbi_ and tgl_periode >= tgl_periode_;
        
        else        
            
             insert into buku_induk_thn
                (tgl_periode, idbi, idawal, jml_harga, nilai_susut, kondisi, status_barang, ref_idpemegang, ref_idpenanggung, ref_idruang, tahun_sensus, ref_idpemegang2,
                staset, idall, a1, a, b, c, d, e, e1, f, g, h, i, j, noreg, thn_perolehan, jml_barang, satuan, harga, asal_usul,tgl_update, gambar, dokumen, dokumen_ket,
                dokumen_file, nilai_appraisal, tgl_buku, uid, id_lama, tgl_sensus, jml_barang_tmp, jml_gambar, idall2, status_penguasaan, verifikasi, harga_beli, harga_atribusi,
                ref_idatribusi, masa_manfaat, nilai_sisa, thn_susut_aw, thn_susut_ak, bln_susut_aw, bln_susut_ak, ref_idstatussurvey, stusul, stmigrasi, ka, kb, kc, kd, ke, kf,
                no_ba, tgl_ba, thn_akun, penggunaan, no_spk, tgl_spk, jns_ekstra, jns_lain, masa_manfaat_tot, tgl_create, uid_create, asal_usul_awal, stop_susut, jns_hibah,
                no_barang, kampung, rt, rw)
             values 
                (tgl_periode_, idbi_, idawal_, hrg_perolehan_, nilai_susut_, kondisi_, status_barang_, ref_idpemegang_, ref_idpenanggung_, ref_idruang_, tahun_sensus_, ref_idpemegang2_,
                staset_, idall_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, noreg_, thn_perolehan_, jml_barang_, satuan_, harga_, asal_usul_,tgl_update_, gambar_, dokumen_, dokumen_ket_,
                dokumen_file_, nilai_appraisal_, tgl_buku_, uid_, id_lama_, tgl_sensus_, jml_barang_tmp_, jml_gambar_, idall2_, status_penguasaan_, verifikasi_, harga_beli_, harga_atribusi_,
                ref_idatribusi_, masa_manfaat_, nilai_sisa_, thn_susut_aw_, thn_susut_ak_, bln_susut_aw_, bln_susut_ak_, ref_idstatussurvey_, stusul_, stmigrasi_, ka_, kb_, kc_, kd_, ke_, kf_,
                no_ba_, tgl_ba_, thn_akun_, penggunaan_, no_spk_, tgl_spk_, jns_ekstra_, jns_lain_, masa_manfaat_tot_, tgl_create_, uid_create_, asal_usul_awal_, stop_susut_, jns_hibah_,
                no_barang_, kampung_, rt_, rw_);          
        end if;
     end if;
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_isi_bi_thn_baru`(`idbi_` int(11), tgl_trans_ date, 
  harga_trans_ decimal(18,2), kondisi_trans int, status_barang_trans int,
  staset_trans_ int ) RETURNS longtext CHARSET latin1
BEGIN


     declare cek_ text;     
     
     declare staset_, status_barang_, kondisi2_, staset2_, status_barang2_ int;     
     declare hrg_perolehan_, nilai_susut_, hrg_perolehan2_, nilai_susut2_ decimal(18,2);              
     declare tgl_buku_ date;     
     declare idall_ varchar(40);
     declare a1_,a_,b_,c_,d_,e_ char(2);
     declare e1_ char(3);
     declare g_,f_,h_,i_ char(2);
     declare j_ char(3);
     declare noreg_ char(6);
     declare thn_perolehan_ char(4);
     declare jml_barang_ int(9);
     declare satuan_ varchar(15);
     declare harga_, jml_harga_  decimal(18,2);
     declare asal_usul_ char(1);
     declare id_lama_, idawal_ int(11);
     declare stusul_ tinyint(3);
     declare tgl_update_ datetime;
     declare tahun_ char(4);
     declare gambar_, dokumen_, dokumen_ket_, dokumen_file_ text;
     declare nilai_appraisal_ decimal(18,2);
     declare uid_ varchar(20);
     declare tgl_sensus_ datetime;
     declare jml_barang_tmp_, jml_gambar_ int(11);
     declare idall2_ varchar(40);
     declare ref_idpemegang_, ref_idpenanggung_, ref_idpemegang2_ varchar(30);
     declare ref_idruang_ bigint(22);
     declare tahun_sensus_ varchar(4);
     declare status_penguasaan_, verifikasi_ tinyint(3);
     declare harga_beli_, harga_atribusi_ decimal(18,2);     
     declare ref_idatribusi_ int(11);     
     declare masa_manfaat_ tinyint(3);
     declare nilai_sisa_ decimal(18,2);
     declare thn_susut_aw_, thn_susut_ak_, bln_susut_aw_, bln_susut_ak_ int(11);
     declare ref_idstatussurvey_ int(11);
     declare stmigrasi_ tinyint(3);
     declare ka_,kb_,kc_,kd_,ke_,kf_ smallint(3);
     declare no_ba_, no_spk_ varchar(100);
     declare tgl_ba_, tgl_spk_ date;     
     declare thn_akun_ int(11);
     declare penggunaan_ varchar(255);
     declare jns_ekstra_, jns_lain_ tinyint(3);
     declare masa_manfaat_tot_ int(11);
     declare tgl_create_ datetime;
     declare uid_create_ varchar(20);
     declare asal_usul_awal_ char(1);
     declare stop_susut_ tinyint(3);
     declare jns_hibah_, no_barang_, kampung_ varchar(100);
     declare rt_, rw_ varchar(4);          
     declare cnt_ int;          

     declare tgl_periode_ date;
     set cek_ = concat("idbi=",idbi_);

     
    
     
     
        
        
                
        
        
        
        
        
        
        
        set nilai_susut_= 0;
        select  sf_getAkumSusut(idbi_,tgl_periode_) into nilai_susut_;      
        if   nilai_susut_ is null then 
           set nilai_susut_= 0;
        end if;       
        select concat(year(tgl_trans_) , '-12-31') into tgl_periode_; 
         
            
             insert into buku_induk_thn
                (tgl_periode, idbi, idawal, 
                jml_harga,             nilai_susut, 
                kondisi, 
                status_barang, 
                staset
                )
             values 
                (tgl_periode_, idbi_, idawal_, 
                harga_trans_,            nilai_susut_, 
                kondisi_trans, 
                status_barang_trans, 
                staset_trans_
                );          
      
     
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_isi_bi_thn_harga`(`idbi_` int(11), tgl_trans_ date, harga_trans_ decimal(18,2)) RETURNS longtext CHARSET latin1
BEGIN


     declare cek_ text;     
     declare kondisi_, staset_, status_barang_, kondisi2_, staset2_, status_barang2_ int;     
     declare hrg_perolehan_, nilai_susut_, hrg_perolehan2_, nilai_susut2_ decimal(18,2);              
     declare tgl_buku_ date;     
     declare idall_ varchar(40);
     declare a1_,a_,b_,c_,d_,e_ char(2);
     declare e1_ char(3);
     declare g_,f_,h_,i_ char(2);
     declare j_ char(3);
     declare noreg_ char(6);
     declare thn_perolehan_ char(4);
     declare jml_barang_ int(9);
     declare satuan_ varchar(15);
     declare harga_, jml_harga_  decimal(18,2);
     declare asal_usul_ char(1);
     declare id_lama_, idawal_ int(11);
     declare stusul_ tinyint(3);
     declare tgl_update_ datetime;
     declare tahun_ char(4);
     declare gambar_, dokumen_, dokumen_ket_, dokumen_file_ text;
     declare nilai_appraisal_ decimal(18,2);
     declare uid_ varchar(20);
     declare tgl_sensus_ datetime;
     declare jml_barang_tmp_, jml_gambar_ int(11);
     declare idall2_ varchar(40);
     declare ref_idpemegang_, ref_idpenanggung_, ref_idpemegang2_ varchar(30);
     declare ref_idruang_ bigint(22);
     declare tahun_sensus_ varchar(4);
     declare status_penguasaan_, verifikasi_ tinyint(3);
     declare harga_beli_, harga_atribusi_ decimal(18,2);     
     declare ref_idatribusi_ int(11);     
     declare masa_manfaat_ tinyint(3);
     declare nilai_sisa_ decimal(18,2);
     declare thn_susut_aw_, thn_susut_ak_, bln_susut_aw_, bln_susut_ak_ int(11);
     declare ref_idstatussurvey_ int(11);
     declare stmigrasi_ tinyint(3);
     declare ka_,kb_,kc_,kd_,ke_,kf_ smallint(3);
     declare no_ba_, no_spk_ varchar(100);
     declare tgl_ba_, tgl_spk_ date;     
     declare thn_akun_ int(11);
     declare penggunaan_ varchar(255);
     declare jns_ekstra_, jns_lain_ tinyint(3);
     declare masa_manfaat_tot_ int(11);
     declare tgl_create_ datetime;
     declare uid_create_ varchar(20);
     declare asal_usul_awal_ char(1);
     declare stop_susut_ tinyint(3);
     declare jns_hibah_, no_barang_, kampung_ varchar(100);
     declare rt_, rw_ varchar(4);          
     declare cnt_ int;          

     declare tgl_periode_ date;
     set cek_ = concat("idbi=",idbi_);

     
     select idall,a1,a,b,c,d,e,e1,f,g,h,i,j,noreg,thn_perolehan,jml_barang,satuan,harga,jml_harga,asal_usul,tgl_buku,id_lama,idawal,stusul,     
            tgl_update,tahun,gambar,dokumen,dokumen_ket,dokumen_file,nilai_appraisal,uid,tgl_sensus,jml_barang_tmp,jml_gambar,idall2,            
            ref_idpemegang,ref_idpenanggung,ref_idruang,tahun_sensus,ref_idpemegang2,status_penguasaan, verifikasi, harga_beli,harga_atribusi,            
            ref_idatribusi,masa_manfaat,nilai_sisa,thn_susut_aw,thn_susut_ak,bln_susut_aw,bln_susut_ak,ref_idstatussurvey,stmigrasi,            
            ka,kb,kc,kd,ke,kf,no_ba,tgl_ba,thn_akun,penggunaan,no_spk,tgl_spk,jns_ekstra,jns_lain,masa_manfaat_tot,tgl_create,uid_create,            
            asal_usul_awal,stop_susut,jns_hibah,no_barang,kampung,rt,rw
     into idall_,a1_,a_,b_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,noreg_,thn_perolehan_,jml_barang_,satuan_,harga_,jml_harga_,asal_usul_,tgl_buku_,id_lama_,idawal_,stusul_,
          tgl_update_,tahun_,gambar_,dokumen_,dokumen_ket_,dokumen_file_,nilai_appraisal_,uid_,tgl_sensus_,jml_barang_tmp_,jml_gambar_,idall2_,
          ref_idpemegang_,ref_idpenanggung_,ref_idruang_,tahun_sensus_,ref_idpemegang2_,status_penguasaan_,verifikasi_,harga_beli_,harga_atribusi_,
          ref_idatribusi_,masa_manfaat_,nilai_sisa_,thn_susut_aw_,thn_susut_ak_,bln_susut_aw_,bln_susut_ak_,ref_idstatussurvey_,stmigrasi_,
          ka_,kb_,kc_,kd_,ke_,kf_,no_ba_,tgl_ba_,thn_akun_,penggunaan_,no_spk_,tgl_spk_,jns_ekstra_,jns_lain_,masa_manfaat_tot_,tgl_create_,uid_create_,
          asal_usul_awal_,stop_susut_,jns_hibah_,no_barang_,kampung_,rt_,rw_ 
     from buku_induk where id = idbi_;     

     
     
        
        
                
        
        
        
        
        
        
        
        
                
        select concat(year(tgl_trans_) , '-12-31') into tgl_periode_; 
        
        select count(*) into cnt_ from buku_induk_thn where idbi = idbi_ and tgl_periode = tgl_periode_;        
        if cnt_ > 0 then        
           
           
           
                      
           
           update buku_induk_thn           
               set 
               
               jml_harga = jml_harga + harga_trans_ 
               
               
               
           where idbi = idbi_ and tgl_periode >= tgl_periode_;
        
        else        
            
             insert into buku_induk_thn
                (tgl_periode, idbi, idawal, 
                jml_harga, 
                
                ref_idpemegang, ref_idpenanggung, ref_idruang, tahun_sensus, ref_idpemegang2,
                idall, a1, a, b, c, d, e, e1, f, g, h, i, j, noreg, thn_perolehan, jml_barang, satuan, harga, asal_usul,tgl_update, gambar, dokumen, dokumen_ket,
                dokumen_file, nilai_appraisal, tgl_buku, uid, id_lama, tgl_sensus, jml_barang_tmp, jml_gambar, idall2, status_penguasaan, verifikasi, harga_beli, harga_atribusi,
                ref_idatribusi, masa_manfaat, nilai_sisa, thn_susut_aw, thn_susut_ak, bln_susut_aw, bln_susut_ak, ref_idstatussurvey, stusul, stmigrasi, ka, kb, kc, kd, ke, kf,
                no_ba, tgl_ba, thn_akun, penggunaan, no_spk, tgl_spk, jns_ekstra, jns_lain, masa_manfaat_tot, tgl_create, uid_create, asal_usul_awal, stop_susut, jns_hibah,
                no_barang, kampung, rt, rw)
             values 
                (tgl_periode_, idbi_, idawal_, 
                harga_trans_, 
                
                ref_idpemegang_, ref_idpenanggung_, ref_idruang_, tahun_sensus_, ref_idpemegang2_,
                idall_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, noreg_, thn_perolehan_, jml_barang_, satuan_, harga_, asal_usul_,tgl_update_, gambar_, dokumen_, dokumen_ket_,
                dokumen_file_, nilai_appraisal_, tgl_buku_, uid_, id_lama_, tgl_sensus_, jml_barang_tmp_, jml_gambar_, idall2_, status_penguasaan_, verifikasi_, harga_beli_, harga_atribusi_,
                ref_idatribusi_, masa_manfaat_, nilai_sisa_, thn_susut_aw_, thn_susut_ak_, bln_susut_aw_, bln_susut_ak_, ref_idstatussurvey_, stusul_, stmigrasi_, ka_, kb_, kc_, kd_, ke_, kf_,
                no_ba_, tgl_ba_, thn_akun_, penggunaan_, no_spk_, tgl_spk_, jns_ekstra_, jns_lain_, masa_manfaat_tot_, tgl_create_, uid_create_, asal_usul_awal_, stop_susut_, jns_hibah_,
                no_barang_, kampung_, rt_, rw_);          
        end if;
     
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_isi_bi_thn_kondisi`(`idbi_` int(11), tgl_trans_ date, kondisi_trans_ int) RETURNS longtext CHARSET latin1
BEGIN


     declare cek_ text;     
     
     declare staset_, status_barang_, kondisi2_, staset2_, status_barang2_ int;     
     declare hrg_perolehan_, nilai_susut_, hrg_perolehan2_, nilai_susut2_ decimal(18,2);              
     declare tgl_buku_ date;     
     declare idall_ varchar(40);
     declare a1_,a_,b_,c_,d_,e_ char(2);
     declare e1_ char(3);
     declare g_,f_,h_,i_ char(2);
     declare j_ char(3);
     declare noreg_ char(6);
     declare thn_perolehan_ char(4);
     declare jml_barang_ int(9);
     declare satuan_ varchar(15);
     declare harga_, jml_harga_  decimal(18,2);
     declare asal_usul_ char(1);
     declare id_lama_, idawal_ int(11);
     declare stusul_ tinyint(3);
     declare tgl_update_ datetime;
     declare tahun_ char(4);
     declare gambar_, dokumen_, dokumen_ket_, dokumen_file_ text;
     declare nilai_appraisal_ decimal(18,2);
     declare uid_ varchar(20);
     declare tgl_sensus_ datetime;
     declare jml_barang_tmp_, jml_gambar_ int(11);
     declare idall2_ varchar(40);
     declare ref_idpemegang_, ref_idpenanggung_, ref_idpemegang2_ varchar(30);
     declare ref_idruang_ bigint(22);
     declare tahun_sensus_ varchar(4);
     declare status_penguasaan_, verifikasi_ tinyint(3);
     declare harga_beli_, harga_atribusi_ decimal(18,2);     
     declare ref_idatribusi_ int(11);     
     declare masa_manfaat_ tinyint(3);
     declare nilai_sisa_ decimal(18,2);
     declare thn_susut_aw_, thn_susut_ak_, bln_susut_aw_, bln_susut_ak_ int(11);
     declare ref_idstatussurvey_ int(11);
     declare stmigrasi_ tinyint(3);
     declare ka_,kb_,kc_,kd_,ke_,kf_ smallint(3);
     declare no_ba_, no_spk_ varchar(100);
     declare tgl_ba_, tgl_spk_ date;     
     declare thn_akun_ int(11);
     declare penggunaan_ varchar(255);
     declare jns_ekstra_, jns_lain_ tinyint(3);
     declare masa_manfaat_tot_ int(11);
     declare tgl_create_ datetime;
     declare uid_create_ varchar(20);
     declare asal_usul_awal_ char(1);
     declare stop_susut_ tinyint(3);
     declare jns_hibah_, no_barang_, kampung_ varchar(100);
     declare rt_, rw_ varchar(4);          
     declare cnt_ int;          

     declare tgl_periode_ date;
     set cek_ = concat("idbi=",idbi_);

     
     select idall,a1,a,b,c,d,e,e1,f,g,h,i,j,noreg,thn_perolehan,jml_barang,satuan,harga,jml_harga,asal_usul,tgl_buku,id_lama,idawal,stusul,     
            tgl_update,tahun,gambar,dokumen,dokumen_ket,dokumen_file,nilai_appraisal,uid,tgl_sensus,jml_barang_tmp,jml_gambar,idall2,            
            ref_idpemegang,ref_idpenanggung,ref_idruang,tahun_sensus,ref_idpemegang2,status_penguasaan, verifikasi, harga_beli,harga_atribusi,            
            ref_idatribusi,masa_manfaat,nilai_sisa,thn_susut_aw,thn_susut_ak,bln_susut_aw,bln_susut_ak,ref_idstatussurvey,stmigrasi,            
            ka,kb,kc,kd,ke,kf,no_ba,tgl_ba,thn_akun,penggunaan,no_spk,tgl_spk,jns_ekstra,jns_lain,masa_manfaat_tot,tgl_create,uid_create,            
            asal_usul_awal,stop_susut,jns_hibah,no_barang,kampung,rt,rw
     into idall_,a1_,a_,b_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,noreg_,thn_perolehan_,jml_barang_,satuan_,harga_,jml_harga_,asal_usul_,tgl_buku_,id_lama_,idawal_,stusul_,
          tgl_update_,tahun_,gambar_,dokumen_,dokumen_ket_,dokumen_file_,nilai_appraisal_,uid_,tgl_sensus_,jml_barang_tmp_,jml_gambar_,idall2_,
          ref_idpemegang_,ref_idpenanggung_,ref_idruang_,tahun_sensus_,ref_idpemegang2_,status_penguasaan_,verifikasi_,harga_beli_,harga_atribusi_,
          ref_idatribusi_,masa_manfaat_,nilai_sisa_,thn_susut_aw_,thn_susut_ak_,bln_susut_aw_,bln_susut_ak_,ref_idstatussurvey_,stmigrasi_,
          ka_,kb_,kc_,kd_,ke_,kf_,no_ba_,tgl_ba_,thn_akun_,penggunaan_,no_spk_,tgl_spk_,jns_ekstra_,jns_lain_,masa_manfaat_tot_,tgl_create_,uid_create_,
          asal_usul_awal_,stop_susut_,jns_hibah_,no_barang_,kampung_,rt_,rw_ 
     from buku_induk where id = idbi_;     

     
    if a1_ is not null or a1_ <> '' then             
        select concat(year(tgl_trans_) , '-12-31') into tgl_periode_; 
        
        select count(*) into cnt_ from buku_induk_thn where idbi = idbi_ and tgl_periode = tgl_periode_;        
        if cnt_ > 0 then        
           
           
           update buku_induk_thn           
               set 
               kondisi = kondisi + kondisi_trans_                
           where idbi = idbi_ and tgl_periode >= tgl_periode_;
        
        else        
            
             insert into buku_induk_thn
                (tgl_periode, idbi, idawal, 
                
                kondisi, 
                
                ref_idpemegang, ref_idpenanggung, ref_idruang, tahun_sensus, ref_idpemegang2,
                idall, a1, a, b, c, d, e, e1, f, g, h, i, j, noreg, thn_perolehan, jml_barang, satuan, harga, asal_usul,tgl_update, gambar, dokumen, dokumen_ket,
                dokumen_file, nilai_appraisal, tgl_buku, uid, id_lama, tgl_sensus, jml_barang_tmp, jml_gambar, idall2, status_penguasaan, verifikasi, harga_beli, harga_atribusi,
                ref_idatribusi, masa_manfaat, nilai_sisa, thn_susut_aw, thn_susut_ak, bln_susut_aw, bln_susut_ak, ref_idstatussurvey, stusul, stmigrasi, ka, kb, kc, kd, ke, kf,
                no_ba, tgl_ba, thn_akun, penggunaan, no_spk, tgl_spk, jns_ekstra, jns_lain, masa_manfaat_tot, tgl_create, uid_create, asal_usul_awal, stop_susut, jns_hibah,
                no_barang, kampung, rt, rw)
             values 
                (tgl_periode_, idbi_, idawal_, 
                
                kondisi_trans_, 
                
                ref_idpemegang_, ref_idpenanggung_, ref_idruang_, tahun_sensus_, ref_idpemegang2_,
                idall_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, noreg_, thn_perolehan_, jml_barang_, satuan_, harga_, asal_usul_,tgl_update_, gambar_, dokumen_, dokumen_ket_,
                dokumen_file_, nilai_appraisal_, tgl_buku_, uid_, id_lama_, tgl_sensus_, jml_barang_tmp_, jml_gambar_, idall2_, status_penguasaan_, verifikasi_, harga_beli_, harga_atribusi_,
                ref_idatribusi_, masa_manfaat_, nilai_sisa_, thn_susut_aw_, thn_susut_ak_, bln_susut_aw_, bln_susut_ak_, ref_idstatussurvey_, stusul_, stmigrasi_, ka_, kb_, kc_, kd_, ke_, kf_,
                no_ba_, tgl_ba_, thn_akun_, penggunaan_, no_spk_, tgl_spk_, jns_ekstra_, jns_lain_, masa_manfaat_tot_, tgl_create_, uid_create_, asal_usul_awal_, stop_susut_, jns_hibah_,
                no_barang_, kampung_, rt_, rw_);          
        end if;
     end if;
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_isi_bi_thn_staset`(`idbi_` int(11), tgl_trans_ date, staset_trans_ int) RETURNS longtext CHARSET latin1
BEGIN


     declare cek_ text;     
     
     declare staset_, status_barang_, kondisi2_, staset2_, status_barang2_ int;     
     declare hrg_perolehan_, nilai_susut_, hrg_perolehan2_, nilai_susut2_ decimal(18,2);              
     declare tgl_buku_ date;     
     declare idall_ varchar(40);
     declare a1_,a_,b_,c_,d_,e_ char(2);
     declare e1_ char(3);
     declare g_,f_,h_,i_ char(2);
     declare j_ char(3);
     declare noreg_ char(6);
     declare thn_perolehan_ char(4);
     declare jml_barang_ int(9);
     declare satuan_ varchar(15);
     declare harga_, jml_harga_  decimal(18,2);
     declare asal_usul_ char(1);
     declare id_lama_, idawal_ int(11);
     declare stusul_ tinyint(3);
     declare tgl_update_ datetime;
     declare tahun_ char(4);
     declare gambar_, dokumen_, dokumen_ket_, dokumen_file_ text;
     declare nilai_appraisal_ decimal(18,2);
     declare uid_ varchar(20);
     declare tgl_sensus_ datetime;
     declare jml_barang_tmp_, jml_gambar_ int(11);
     declare idall2_ varchar(40);
     declare ref_idpemegang_, ref_idpenanggung_, ref_idpemegang2_ varchar(30);
     declare ref_idruang_ bigint(22);
     declare tahun_sensus_ varchar(4);
     declare status_penguasaan_, verifikasi_ tinyint(3);
     declare harga_beli_, harga_atribusi_ decimal(18,2);     
     declare ref_idatribusi_ int(11);     
     declare masa_manfaat_ tinyint(3);
     declare nilai_sisa_ decimal(18,2);
     declare thn_susut_aw_, thn_susut_ak_, bln_susut_aw_, bln_susut_ak_ int(11);
     declare ref_idstatussurvey_ int(11);
     declare stmigrasi_ tinyint(3);
     declare ka_,kb_,kc_,kd_,ke_,kf_ smallint(3);
     declare no_ba_, no_spk_ varchar(100);
     declare tgl_ba_, tgl_spk_ date;     
     declare thn_akun_ int(11);
     declare penggunaan_ varchar(255);
     declare jns_ekstra_, jns_lain_ tinyint(3);
     declare masa_manfaat_tot_ int(11);
     declare tgl_create_ datetime;
     declare uid_create_ varchar(20);
     declare asal_usul_awal_ char(1);
     declare stop_susut_ tinyint(3);
     declare jns_hibah_, no_barang_, kampung_ varchar(100);
     declare rt_, rw_ varchar(4);          
     declare cnt_ int;          

     declare tgl_periode_ date;
     set cek_ = concat("idbi=",idbi_);

     
     select idall,a1,a,b,c,d,e,e1,f,g,h,i,j,noreg,thn_perolehan,jml_barang,satuan,harga,jml_harga,asal_usul,tgl_buku,id_lama,idawal,stusul,     
            tgl_update,tahun,gambar,dokumen,dokumen_ket,dokumen_file,nilai_appraisal,uid,tgl_sensus,jml_barang_tmp,jml_gambar,idall2,            
            ref_idpemegang,ref_idpenanggung,ref_idruang,tahun_sensus,ref_idpemegang2,status_penguasaan, verifikasi, harga_beli,harga_atribusi,            
            ref_idatribusi,masa_manfaat,nilai_sisa,thn_susut_aw,thn_susut_ak,bln_susut_aw,bln_susut_ak,ref_idstatussurvey,stmigrasi,            
            ka,kb,kc,kd,ke,kf,no_ba,tgl_ba,thn_akun,penggunaan,no_spk,tgl_spk,jns_ekstra,jns_lain,masa_manfaat_tot,tgl_create,uid_create,            
            asal_usul_awal,stop_susut,jns_hibah,no_barang,kampung,rt,rw
     into idall_,a1_,a_,b_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,noreg_,thn_perolehan_,jml_barang_,satuan_,harga_,jml_harga_,asal_usul_,tgl_buku_,id_lama_,idawal_,stusul_,
          tgl_update_,tahun_,gambar_,dokumen_,dokumen_ket_,dokumen_file_,nilai_appraisal_,uid_,tgl_sensus_,jml_barang_tmp_,jml_gambar_,idall2_,
          ref_idpemegang_,ref_idpenanggung_,ref_idruang_,tahun_sensus_,ref_idpemegang2_,status_penguasaan_,verifikasi_,harga_beli_,harga_atribusi_,
          ref_idatribusi_,masa_manfaat_,nilai_sisa_,thn_susut_aw_,thn_susut_ak_,bln_susut_aw_,bln_susut_ak_,ref_idstatussurvey_,stmigrasi_,
          ka_,kb_,kc_,kd_,ke_,kf_,no_ba_,tgl_ba_,thn_akun_,penggunaan_,no_spk_,tgl_spk_,jns_ekstra_,jns_lain_,masa_manfaat_tot_,tgl_create_,uid_create_,
          asal_usul_awal_,stop_susut_,jns_hibah_,no_barang_,kampung_,rt_,rw_ 
     from buku_induk where id = idbi_;     

      
     if a1_ is not null or a1_ <> '' then           
        select concat(year(tgl_trans_) , '-12-31') into tgl_periode_; 
        
        select count(*) into cnt_ from buku_induk_thn where idbi = idbi_ and tgl_periode = tgl_periode_;        
        if cnt_ > 0 then        
          
           
           update buku_induk_thn           
               set 
                        
               staset = staset + staset_trans_            
           where idbi = idbi_ and tgl_periode >= tgl_periode_;
        
        else        
            
             insert into buku_induk_thn
                (tgl_periode, idbi, idawal, 
                
                
                
                staset,
                ref_idpemegang, ref_idpenanggung, ref_idruang, tahun_sensus, ref_idpemegang2,
                idall, a1, a, b, c, d, e, e1, f, g, h, i, j, noreg, thn_perolehan, jml_barang, satuan, harga, asal_usul,tgl_update, gambar, dokumen, dokumen_ket,
                dokumen_file, nilai_appraisal, tgl_buku, uid, id_lama, tgl_sensus, jml_barang_tmp, jml_gambar, idall2, status_penguasaan, verifikasi, harga_beli, harga_atribusi,
                ref_idatribusi, masa_manfaat, nilai_sisa, thn_susut_aw, thn_susut_ak, bln_susut_aw, bln_susut_ak, ref_idstatussurvey, stusul, stmigrasi, ka, kb, kc, kd, ke, kf,
                no_ba, tgl_ba, thn_akun, penggunaan, no_spk, tgl_spk, jns_ekstra, jns_lain, masa_manfaat_tot, tgl_create, uid_create, asal_usul_awal, stop_susut, jns_hibah,
                no_barang, kampung, rt, rw)
             values 
                (tgl_periode_, idbi_, idawal_, 
                
                
                
                staset_trans_, 
                ref_idpemegang_, ref_idpenanggung_, ref_idruang_, tahun_sensus_, ref_idpemegang2_,
                idall_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, noreg_, thn_perolehan_, jml_barang_, satuan_, harga_, asal_usul_,tgl_update_, gambar_, dokumen_, dokumen_ket_,
                dokumen_file_, nilai_appraisal_, tgl_buku_, uid_, id_lama_, tgl_sensus_, jml_barang_tmp_, jml_gambar_, idall2_, status_penguasaan_, verifikasi_, harga_beli_, harga_atribusi_,
                ref_idatribusi_, masa_manfaat_, nilai_sisa_, thn_susut_aw_, thn_susut_ak_, bln_susut_aw_, bln_susut_ak_, ref_idstatussurvey_, stusul_, stmigrasi_, ka_, kb_, kc_, kd_, ke_, kf_,
                no_ba_, tgl_ba_, thn_akun_, penggunaan_, no_spk_, tgl_spk_, jns_ekstra_, jns_lain_, masa_manfaat_tot_, tgl_create_, uid_create_, asal_usul_awal_, stop_susut_, jns_hibah_,
                no_barang_, kampung_, rt_, rw_);          
        end if;
     end if;
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_bi`(id_ int(11) ) RETURNS longtext CHARSET latin1
BEGIN
  declare cek_ text;
  
  
  return cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_mutasi`(id_ int(11) ) RETURNS longtext CHARSET latin1
BEGIN
  declare cek_ text;
  
  call sp_jurnal_mutasi(id_);
  return cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_rekap`(id_ integer) RETURNS text CHARSET latin1
BEGIN


declare cek_ text;
declare idrekap_ integer;
declare tgl_periode_ date;
declare c_, d_, e_ varchar(2);
declare e1_ varchar(3); 
declare kint_, ka_, kb_ varchar(2);
declare f_, g_, h_, i_ varchar(2);
declare j_ varchar(3);
declare jml_barang_d_, jml_barang_k_ integer;
declare debet_, kredit_ decimal(18,2);
declare tgl_buku_ date;
declare jns_trans_, jns_trans2_ integer;
declare staset_, kondisi_ integer;

set kondisi_ = 0;
set debet_ = 0;
set kredit_ = 0 ;
set jml_barang_d_ = 0;
set jml_barang_k_ = 0;
set staset_=0;

set cek_ = '';
set cek_ = concat(cek_,'; id = ',id_ );

select tgl_buku, c, d, e, e1, kint, ka, kb, f, g, h, i, j, jns_trans, jns_trans2,
jml_barang_d, jml_barang_k , debet, kredit, staset
into 
tgl_buku_, c_, d_, e_, e1_, kint_, ka_, kb_, f_, g_, h_, i_, j_, jns_trans_, jns_trans2_,
jml_barang_d_, jml_barang_k_ , debet_, kredit_, staset_
from t_jurnal_aset where id=id_;






if month(tgl_buku_) <= 6 then
  set tgl_periode_ = concat(year(tgl_buku_),'-06-30');
else
  set tgl_periode_ = concat(year(tgl_buku_),'-12-31');
end if;


select id into idrekap_ from t_jurnal_aset_rekap 
where
tgl_buku = tgl_periode_ and c = c_ and d= d_ and  e=e_ and e1=e1_ and kint=kint_ and ka=ka_ and kb=kb_
and f=f_ and g=g_ and h=h_ and i=i_ and j=j_ and jns_trans=jns_trans_ and jns_trans2 = jns_trans2_ limit 0,1;


if idrekap_ is not null then

   update t_jurnal_aset_rekap
     set debet = debet + debet_, kredit = kredit + kredit_,
     jml_barang_d=jml_barang_d+jml_barang_d_, jml_barang_k=jml_barang_k+jml_barang_k_,     
     staset = staset + staset_, 
     kondisi = kondisi + kondisi_
   where
     tgl_buku >= tgl_periode_
     and c = c_ and d= d_ and  e=e_ and e1=e1_ and kint=kint_ and ka=ka_ and kb=kb_
     and f= f_ and g= g_ and h= h_ and i= i_ and j= j_ and jns_trans=jns_trans_ and jns_trans2 = jns_trans2_;

else

   insert t_jurnal_aset_rekap
      (tgl_buku, c,d,e,e1, kint,ka,kb, f,g,h,i,j, jns_trans, jns_trans2,
      debet, kredit, jml_barang_d, jml_barang_k, staset, kondisi)
   values
      (tgl_periode_, c_, d_, e_, e1_, kint_, ka_, kb_, f_, g_, h_, i_, j_, jns_trans_ , jns_trans2_,
      debet_, kredit_, jml_barang_d_, jml_barang_k_, staset_, kondisi_);
end if;






  RETURN cek_;
end ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_rekap_v2`(
c1_ char(1), c_ varchar(2), d_ varchar(2), e_ varchar(2), e1_ varchar(3), 
kint_ varchar(2), ka_ varchar(2), kb_ varchar(2),
f1_ varchar(1), f2_ varchar(2), f_ varchar(2), g_ varchar(2), h_ varchar(2), i_ varchar(2), j_ varchar(3),
jns_trans_ int, jns_trans2_ int, jns_trans3_ int, 

thn_anggaran_ int, uid_ varchar(20), mode_ int
) RETURNS text CHARSET latin1
BEGIN
  

  declare cek_ text;    
  declare debet_, kredit_, harga_atribusi_ decimal(18,5);  
  declare jml_barang_d_ , jml_barang_k_, cnt_, thn_anggaran_prev_ , stposting_ int;  
  
    
  set cek_ = '';
  set thn_anggaran_prev_ = thn_anggaran_ -1;  
   
  set cnt_ = 0;


  
if mode_=0 or mode_=1 then  
  
  
  
  select ifnull(stposting,0), count(*) into stposting_, cnt_ from t_jurnal_aset_rekap where   
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans <> 10 and
    
    year(tgl_buku) < thn_anggaran_;
  
  if cnt_ > 1 then    
     delete from t_jurnal_aset_rekap where c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
      kint= kint_ and ka=ka_ and kb=kb_ and
      f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans <> 10 and
         year(tgl_buku) < thn_anggaran_ ; 
      set cnt_ = 0;        
  end if;  

  
  
  select      
    sum(ifnull(debet,0)), sum(ifnull(kredit,0)) , sum(ifnull(jml_barang_d,0)), sum(ifnull(jml_barang_k,0)), sum(ifnull(harga_atribusi,0))
    into debet_, kredit_ ,  jml_barang_d_ , jml_barang_k_, harga_atribusi_
    from t_jurnal_aset where 
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans <> 10 and    
    year(tgl_buku) < thn_anggaran_; 
  
  if cnt_ =1 then  
    update t_jurnal_aset_rekap 
      set debet=debet_, kredit=kredit_ , jml_barang_d = jml_barang_d_ , jml_barang_k = jml_barang_k_, harga_atribusi= harga_atribusi_,
      tgl_buku = concat( thn_anggaran_prev_, '-12-31') ,      
      jns_trans= 0 , jns_trans2 = 0, jns_trans3 = 0, mode=1,
      tgl_update = now(), uid =uid_, stposting = 1
    where c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
      kint= kint_ and ka=ka_ and kb=kb_ and
      f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans <> 10 and
      year(tgl_buku) < thn_anggaran_ ; 
  else  
    insert into t_jurnal_aset_rekap    
      (c1,c,d,e,e1, kint, ka, kb, f1,f2,f,g,h,i,j,
      jns_trans, jns_trans2, jns_trans3, mode,
      debet,kredit, jml_barang_d, jml_barang_k, harga_atribusi,
      tgl_buku, uid, stposting, tgl_update )    
    values         
      (c1_,c_,d_,e_,e1_, kint_, ka_, kb_, f1_,f2_,f_,g_,h_,i_,j_,
      0, 0, 0, 1,   
      debet_,kredit_, jml_barang_d_, jml_barang_k_, harga_atribusi_,
      concat( thn_anggaran_-1, '-12-31') , uid_, 1, now() ) ;
  end if;
  update t_jurnal_aset set stposting=1  where   
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans <> 10 and    
    year(tgl_buku) < thn_anggaran_ and stposting<>1;   
end if;
  

if mode_=0 or mode_=2 then 
  
  
  
  select ifnull(stposting,0), count(*) into stposting_, cnt_ from t_jurnal_aset_rekap where   
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans = 10 and
    
    year(tgl_buku) < thn_anggaran_;
  
  if cnt_ > 1 then    
     delete from t_jurnal_aset_rekap where c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
      kint= kint_ and ka=ka_ and kb=kb_ and
      f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans = 10 and
         year(tgl_buku) < thn_anggaran_ ; 
      set cnt_ = 0; 
  end if;
  

  
  select 
    
    sum(ifnull(debet,0)), sum(ifnull(kredit,0)) , sum(ifnull(jml_barang_d,0)), sum(ifnull(jml_barang_k,0)), sum(ifnull(harga_atribusi,0))
    into debet_, kredit_ ,  jml_barang_d_ , jml_barang_k_, harga_atribusi_
    from t_jurnal_aset where 
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans = 10 and    
    year(tgl_buku) < thn_anggaran_; 
  
  if cnt_ =1 then  
    update t_jurnal_aset_rekap 
      set debet=debet_, kredit=kredit_ , jml_barang_d = jml_barang_d_ , jml_barang_k = jml_barang_k_, harga_atribusi=harga_atribusi_,
      tgl_buku = concat( thn_anggaran_prev_, '-12-31') ,      
      jns_trans= 10 , jns_trans2 = 0, jns_trans3 = 0, mode=2,
      tgl_update = now(), uid =uid_, stposting = 1
    where c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
      kint= kint_ and ka=ka_ and kb=kb_ and
      f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans = 10 and
      year(tgl_buku) < thn_anggaran_ ; 
  else  
    insert into t_jurnal_aset_rekap    
      (c1,c,d,e,e1, kint, ka, kb, f1,f2,f,g,h,i,j,
      jns_trans, jns_trans2, jns_trans3, mode,
      debet,kredit, jml_barang_d, jml_barang_k, harga_atribusi,
      tgl_buku, uid, stposting, tgl_update )    
    values         
      (c1_,c_,d_,e_,e1_, kint_, ka_, kb_, f1_,f2_,f_,g_,h_,i_,j_,
      10, 0, 0, 2,    
      debet_,kredit_, jml_barang_d_, jml_barang_k_, harga_atribusi_,
      concat( thn_anggaran_-1, '-12-31') , uid_, 1, now() ) ;
  end if;     
  update t_jurnal_aset set stposting=1  where   
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans = 10 and    
    year(tgl_buku) < thn_anggaran_ and stposting<>1; 
end if;

  
if mode_=0 or mode_=3 then  
  
  
  select ifnull(stposting,0), count(*) into stposting_, cnt_ from t_jurnal_aset_rekap where   
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and 
    jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and
    tgl_buku <= concat(thn_anggaran_,'-06-30') and year(tgl_buku)=thn_anggaran_;  
  
  if cnt_ > 1 then    
     delete from t_jurnal_aset_rekap where c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
      kint= kint_ and ka=ka_ and kb=kb_ and
      f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and      
      jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and
      tgl_buku <= concat(thn_anggaran_,'-06-30') and year(tgl_buku)=thn_anggaran_;   
    set cnt_ = 0;    
  end if;  

  
  select  sum(ifnull(debet,0)), sum(ifnull(kredit,0)) , sum(ifnull(jml_barang_d,0)), sum(ifnull(jml_barang_k,0)), sum(ifnull(harga_atribusi,0))
    into debet_, kredit_ ,  jml_barang_d_ , jml_barang_k_, harga_atribusi_
    from t_jurnal_aset where 
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and 
    jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and
    tgl_buku <= concat(thn_anggaran_,'-06-30') and year(tgl_buku)=thn_anggaran_;  
  
  if cnt_ =1 then  
    update t_jurnal_aset_rekap 
      set debet=debet_, kredit=kredit_ , jml_barang_d = jml_barang_d_ , jml_barang_k = jml_barang_k_, mode=3, harga_atribusi=harga_atribusi_,
      tgl_buku = concat( thn_anggaran_, '-06-30') ,
      tgl_update = now(), uid =uid_, stposting = 1
    where c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
      kint= kint_ and ka=ka_ and kb=kb_ and
      f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and      
      jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and
      tgl_buku <= concat(thn_anggaran_,'-06-30') and year(tgl_buku)=thn_anggaran_; 
  else  
    insert into t_jurnal_aset_rekap    
      (c1,c,d,e,e1, kint, ka, kb, f1,f2,f,g,h,i,j,
      jns_trans, jns_trans2, jns_trans3, mode, 
      debet,kredit, jml_barang_d, jml_barang_k, harga_atribusi,
      tgl_buku, uid, stposting, tgl_update )    
    values         
      (c1_,c_,d_,e_,e1_, kint_, ka_, kb_, f1_,f2_,f_,g_,h_,i_,j_,
      jns_trans_, jns_trans2_, jns_trans3_, 3,    
      debet_,kredit_, jml_barang_d_, jml_barang_k_, harga_atribusi_, 
      concat( thn_anggaran_, '-06-30') , uid_, 1, now() ) ;
  end if;  
  update t_jurnal_aset set stposting=1  where   
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and 
    jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and
    tgl_buku <= concat(thn_anggaran_,'-06-30') and year(tgl_buku)=thn_anggaran_ and stposting<>1;     
end if; 

  
if mode_=0 or mode_=4 then  
  
  
  select ifnull(stposting,0), count(*) into stposting_, cnt_ from t_jurnal_aset_rekap where   
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and 
    jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and
    tgl_buku > concat(thn_anggaran_,'-06-30') and tgl_buku<=concat(thn_anggaran_,'-12-31');    
  
  if cnt_ > 1 then    
     delete from t_jurnal_aset_rekap where c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
      kint= kint_ and ka=ka_ and kb=kb_ and
      f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and      
      jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and
      tgl_buku > concat(thn_anggaran_,'-06-30') and tgl_buku<=concat(thn_anggaran_,'-12-31');     
    set cnt_ = 0;       
  end if;  

  
  select  sum(ifnull(debet,0)), sum(ifnull(kredit,0)) , sum(ifnull(jml_barang_d,0)), sum(ifnull(jml_barang_k,0)), sum(ifnull(harga_atribusi,0))
    into debet_, kredit_ ,  jml_barang_d_ , jml_barang_k_, harga_atribusi_
    from t_jurnal_aset where 
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and 
    jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and
    tgl_buku > concat(thn_anggaran_,'-06-30') and tgl_buku<=concat(thn_anggaran_,'-12-31');     
  
  if cnt_ =1 then  
    update t_jurnal_aset_rekap 
      set debet=debet_, kredit=kredit_ , jml_barang_d = jml_barang_d_ , jml_barang_k = jml_barang_k_, mode=4, harga_atribusi=harga_atribusi_,
      tgl_buku = concat( thn_anggaran_, '-12-31') ,
      tgl_update = now(), uid =uid_, stposting = 1
    where c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
      kint= kint_ and ka=ka_ and kb=kb_ and
      f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and      
      jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and
      tgl_buku > concat(thn_anggaran_,'-06-30') and tgl_buku<=concat(thn_anggaran_,'-12-31');  
  else  
    insert into t_jurnal_aset_rekap    
      (c1,c,d,e,e1, kint, ka, kb, f1,f2,f,g,h,i,j,
      jns_trans, jns_trans2, jns_trans3, mode,
      debet,kredit, jml_barang_d, jml_barang_k, harga_atribusi,
      tgl_buku, uid, stposting, tgl_update )    
    values         
      (c1_,c_,d_,e_,e1_, kint_, ka_, kb_, f1_,f2_,f_,g_,h_,i_,j_,
      jns_trans_, jns_trans2_, jns_trans3_, 4,    
      debet_,kredit_, jml_barang_d_, jml_barang_k_, harga_atribusi_,
      concat( thn_anggaran_, '-12-31') , uid_, 1, now() ) ;
  end if; 
  update t_jurnal_aset set stposting=1  where   
    c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
    kint= kint_ and ka=ka_ and kb=kb_ and
    f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and 
    jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and
    tgl_buku > concat(thn_anggaran_,'-06-30') and tgl_buku<=concat(thn_anggaran_,'-12-31') and stposting<>1;         
end if;   

  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_set_stpost`(
c1_ char(1), c_ varchar(2), d_ varchar(2), e_ varchar(2), e1_ varchar(3), 
kint_ varchar(2), ka_ varchar(2), kb_ varchar(2),
f1_ varchar(1), f2_ varchar(2), f_ varchar(2), g_ varchar(2), h_ varchar(2), i_ varchar(2), j_ varchar(3),
jns_trans_ int, jns_trans2_ int, jns_trans3_ int, 

 tgl_buku_ date, uid_ varchar(20), stposting_ int
) RETURNS text CHARSET latin1
BEGIN

  declare cek_ text;
  declare thn_anggaran_, cnt_ int;  
  
  
    

 
       

  if jns_trans_ is null then   
    set jns_trans_ = 0 ;    
  end if;  
  if jns_trans2_ is null then   
    set jns_trans2_ = 0 ;    
  end if;  
  if jns_trans3_ is null then   
    set jns_trans3_ = 0 ;    
  end if;
  
  select nilai into thn_anggaran_ from setting where Id = 'THN_ANGGARAN';  

  
  if year(tgl_buku_) < thn_anggaran_ and jns_trans_ <> 10 then 
     
                
        update t_jurnal_aset_rekap set stposting = stposting_, debet=0,kredit=0, jml_barang_d=0, jml_barang_k=0        
          where 
          c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
          kint= kint_ and ka=ka_ and kb=kb_ and
          f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans = 0 and mode=1 and
          year(tgl_buku) < thn_anggaran_;
      

  elseif  year(tgl_buku_) < thn_anggaran_ and jns_trans_ = 10 then 
      
      
        update t_jurnal_aset_rekap set stposting = stposting_, debet=0,kredit=0, jml_barang_d=0, jml_barang_k=0        
          where c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
          kint= kint_ and ka=ka_ and kb=kb_ and
          f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and jns_trans = 10 and mode=2 and
          year(tgl_buku) < thn_anggaran_ ;
      
       
  elseif year(tgl_buku_) = thn_anggaran_ and tgl_buku_ <= concat(thn_anggaran_, '-06-30') then  
    
    
      update t_jurnal_aset_rekap set stposting = stposting_, debet=0,kredit=0, jml_barang_d=0, jml_barang_k=0        
        where c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
        kint= kint_ and ka=ka_ and kb=kb_ and
        f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and      
        jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and mode=3 and
        tgl_buku <= concat(thn_anggaran_,'-06-30') and year(tgl_buku)=thn_anggaran_; 
    
     
  elseif year(tgl_buku_) = thn_anggaran_ and tgl_buku_ > concat(thn_anggaran_, '-06-30') then  
    
      
      update t_jurnal_aset_rekap set stposting = stposting_, debet=0,kredit=0, jml_barang_d=0, jml_barang_k=0              
      where  c1 = c1_ and c=c_ and d= d_ and e=e_ and e1=e1_ and
        kint= kint_ and ka=ka_ and kb=kb_ and
        f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j= j_ and 
        jns_trans= jns_trans_ and jns_trans2 = jns_trans2_ and jns_trans3 = jns_trans3_ and mode=4 and
        tgl_buku > concat(thn_anggaran_,'-06-30') and tgl_buku<=concat(thn_anggaran_,'-12-31');
    
     
  end if;
    

  return cek_;
end ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut`(id_ int(11)) RETURNS int(11)
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, refid_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,2);
  
  
  
  declare uid_ varchar(20);  
  
  
  
  
  declare thn_perolehan_ char(4);  

  
  select tgl, idbi, idbi_awal, harga, thn_perolehan, staset, uid
     into tgl_, idbi_,idawal_, harga_susut_, thn_perolehan_, staset_, uid_
     from penyusutan where Id = id_;
  
  
  set jns_trans2_ = 30;         

  
  if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
  elseif staset_ = 9 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '05' ;   
  elseif staset_ = 10 then    
      set rkint_ = '02'; set rka_ = '00'; set rkb_ = '00' ;   
  end if;       
  

  
  select a1, a, b, c, d, e, e1, f, g, h, i, j
     into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
     from buku_induk where id = idbi_;     

 
 insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,jml_barang_d,jml_barang_k,debet,kredit,
       tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,uid, tgl_update)
    value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 30, idbi_, 0, idbi_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
       0, 0, harga_susut_, 0, tgl_penghapusan_, 0, 0, 0, 0, 10, uid_, now());
 
  RETURN Param;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut2`(id_ int(11) ) RETURNS longtext CHARSET latin1
BEGIN
  declare cek_ text;
          call sp_jurnal_susut(id_);
  return cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_gantirugi`(id_ int(11)) RETURNS text CHARSET latin1
BEGIN

  declare cek_ text;
  declare qry varchar(300);
  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_, akum_susut_, hrg_ketetapan_ decimal(18,5);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);
  declare tgl_create_ datetime;  
  declare susut_mode_ int;  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  set jns_trans2_ = 18;     
  
  select staset,tgl_gantirugi,id_bukuinduk,idbi_awal, no_sk, diganti_barang, harga_gantirugi,tgl_create
     into staset_, tgl_, idbi_, idawal_, no_sk_, diganti_barang_, hrg_ketetapan_,tgl_create_ from gantirugi where id = id_; 
    
  
  
if no_sk_<> '' and no_sk_ is not null then 
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    
    
  

  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);  
      
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
  
  if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 9, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;
  if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0,  0, akum_susut_, tgl_, 0, 9, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;
end if;

return cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_gantirugi_20180213`(id_ int(11)) RETURNS text CHARSET latin1
BEGIN

  declare cek_ text;
  declare qry varchar(300);
  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_, akum_susut_, hrg_ketetapan_ decimal(18,5);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);
  declare tgl_create_ datetime;  
  declare susut_mode_ int;  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  set jns_trans2_ = 18;     
  
  select staset,tgl_gantirugi,id_bukuinduk,idbi_awal, no_sk, diganti_barang, harga_gantirugi,tgl_create
     into staset_, tgl_, idbi_, idawal_, no_sk_, diganti_barang_, hrg_ketetapan_,tgl_create_ from gantirugi where id = id_; 
    
  
  
if no_sk_<> '' and no_sk_ is not null then 
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    
    
  

  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);  
      
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
  
  if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 9, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;
  if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0,  0, akum_susut_, tgl_, 0, 9, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;
end if;

return cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_mutasi`(id_ int(11)) RETURNS text CHARSET latin1
BEGIN


  declare cek_ text;
  declare idbi_, idawal_, refid_, idbi_baru_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_, mutasi_,sudahmutasi_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,5);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_, uid_create varchar(20);    
  declare tgl_create_ datetime; 
  declare uid_create_ datetime;
  
  
  
  
  declare thn_perolehan_ char(4);  
  declare susut_mode_ int;    
  declare maxthn_ , thnak_, blnak_ int;  
  declare c1_,f1_,f2_ char(1);


  set cek_ = concat('id=',id_);
  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi,  sudahmutasi, tgl_create, uid_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_,uid_create_ from penghapusan where id = id_;  


  if mutasi_ = 1 then 
    set cek_ = concat(cek_,' dimutasi');    

    select max(tahun*12 + bulan) into maxthn_ from penyusutan where idbi = idbi_  ; 
    select tahun , bulan into thnak_, blnak_  from penyusutan where idbi = idbi_ and tahun*12 + bulan = maxthn_;
    update buku_induk set thn_susut_ak=thnak_, bln_susut_ak=blnak_ where id =idbi_;

    
    
    select sf_getAkumSusut(idbi_, tgl_) into harga_susut_;

    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j
       into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_
       from buku_induk where id = idbi_;  
  


    
    set jns_trans2_= 15;    
    set jns_trans_ = 10;    

    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;               

   
    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      

     
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_ and jns_trans=jns_trans_ ;
    
    
    if harga_susut_ <> 0 then
      insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j,
       jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
      value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_, idawal_,a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_,
       0, 0, harga_susut_, 0, tgl_, 0, 0, 0, 0, jns_trans_, l1_, l2_, l3_, l4_, l5_, l6_, uid_, now(), tgl_create_, uid_create_);
    end if;
    set cek_ = concat(cek_,' jurnal berkurang | ');
    if sudahmutasi_ = 1 then
       
      select id,a1, a, b, c1, c, d, e, e1, f1,f2,f, g, h, i, j
        into idbi_baru_,a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_
        from buku_induk where id_lama = idbi_;          
                  
      
      delete from penyusutan where idbi = idbi_baru_;      
      update buku_induk aa join buku_induk bb on aa.id_lama = bb.id 
        set aa.nilai_sisa=bb.nilai_sisa, aa.thn_susut_aw=bb.thn_susut_aw, 
        aa.thn_susut_ak=bb.thn_susut_ak, aa.masa_manfaat=bb.masa_manfaat, aa.bln_susut_aw=bb.bln_susut_aw, aa.bln_susut_ak=bb.bln_susut_ak , aa.stop_susut=bb.stop_susut        
        where aa.id=idbi_baru_;
            

      
      insert into penyusutan       
         (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c1,c,d,e,e1,f1,f2,f,g,h,i,j,ket,jns_trans2,id_koreksi,tgl_create,uid_create)
      select       
         tgl_,tahun,sem,bulan,idbi_baru_ ,idbi_awal, harga, uid_, now(),thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c1_,c_,d_,e_,e1_,f1_,f2_,f_,g_,h_,i_,j_,ket,jns_trans2_,id_koreksi, tgl_create_, uid_create_
      from penyusutan           
      where idbi = idbi_ and (id_koreksi is null or id_koreksi='' or id_koreksi=0);
       set cek_ = concat(cek_,'  salin penyusutan ke baru |');     
            
      if harga_susut_ <> 0 then
        
        insert into t_jurnal_aset
          (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j,
          jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
        value
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_baru_, idawal_,a1_, a_, b_,c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_,
          0, 0, 0, harga_susut_,  tgl_, 0, 0, 0, 0, jns_trans_,  l1_, l2_, l3_, l4_, l5_, l6_ , uid_, now(), tgl_create_, uid_create_);          
      end if;
      set cek_ = concat(cek_,'  jurnal bertambah |');
    end if; 
        

  end if; 
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_mutasi_20180207`(id_ int(11)) RETURNS text CHARSET latin1
BEGIN


  declare cek_ text;
  declare idbi_, idawal_, refid_, idbi_baru_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_, mutasi_,sudahmutasi_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,2);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_, uid_create varchar(20);    
  declare tgl_create_ datetime; 
  declare uid_create_ datetime;
  
  
  
  
  declare thn_perolehan_ char(4);  
  declare susut_mode_ int;    
  declare maxthn_ , thnak_, blnak_ int;


  set cek_ = concat('id=',id_);
  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi,  sudahmutasi, tgl_create, uid_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_,uid_create_ from penghapusan where id = id_;  


  if mutasi_ = 1 then 
    set cek_ = concat(cek_,' dimutasi');    

    select max(tahun*12 + bulan) into maxthn_ from penyusutan where idbi = idbi_  ; 
    select tahun , bulan into thnak_, blnak_  from penyusutan where idbi = idbi_ and tahun*12 + bulan = maxthn_;
    update buku_induk set thn_susut_ak=thnak_, bln_susut_ak=blnak_ where id =idbi_;

    
    
    select sf_getAkumSusut(idbi_, tgl_) into harga_susut_;

    
    select a1, a, b, c, d, e, e1, f, g, h, i, j
       into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
       from buku_induk where id = idbi_;  
  


    
    set jns_trans2_= 15;    
    set jns_trans_ = 10;    

    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;               

   
    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      

     
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_ and jns_trans=jns_trans_ ;
    
    
    if harga_susut_ <> 0 then
      insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,
       jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
      value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
       0, 0, harga_susut_, 0, tgl_, 0, 0, 0, 0, jns_trans_, l1_, l2_, l3_, l4_, l5_, l6_, uid_, now(), tgl_create_, uid_create_);
    end if;
    set cek_ = concat(cek_,' jurnal berkurang | ');
    if sudahmutasi_ = 1 then
       
      select id,a1, a, b, c, d, e, e1, f, g, h, i, j
        into idbi_baru_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
        from buku_induk where id_lama = idbi_;          
                  
      
      delete from penyusutan where idbi = idbi_baru_;      
      update buku_induk aa join buku_induk bb on aa.id_lama = bb.id 
        set aa.nilai_sisa=bb.nilai_sisa, aa.thn_susut_aw=bb.thn_susut_aw, 
        aa.thn_susut_ak=bb.thn_susut_ak, aa.masa_manfaat=bb.masa_manfaat, aa.bln_susut_aw=bb.bln_susut_aw, aa.bln_susut_ak=bb.bln_susut_ak , aa.stop_susut=bb.stop_susut        
        where aa.id=idbi_baru_;
            

      
      insert into penyusutan       
         (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c,d,e,e1,f,g,h,i,j,ket,jns_trans2,id_koreksi,tgl_create,uid_create)
      select       
         tgl_,tahun,sem,bulan,idbi_baru_ ,idbi_awal, harga, uid_, now(),thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c_,d_,e_,e1_,f_,g_,h_,i_,j_,ket,jns_trans2_,id_koreksi, tgl_create_, uid_create_
      from penyusutan           
      where idbi = idbi_ and (id_koreksi is null or id_koreksi='' or id_koreksi=0);
       set cek_ = concat(cek_,'  salin penyusutan ke baru |');     
            
      if harga_susut_ <> 0 then
        
        insert into t_jurnal_aset
          (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,
          jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
        value
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_baru_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
          0, 0, 0, harga_susut_,  tgl_, 0, 0, 0, 0, jns_trans_,  l1_, l2_, l3_, l4_, l5_, l6_ , uid_, now(), tgl_create_, uid_create_);          
      end if;
      set cek_ = concat(cek_,'  jurnal bertambah |');
    end if; 
        

  end if; 
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_mutasi_20180213`(id_ int(11)) RETURNS text CHARSET latin1
BEGIN


  declare cek_ text;
  declare idbi_, idawal_, refid_, idbi_baru_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_, mutasi_,sudahmutasi_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,5);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_, uid_create varchar(20);    
  declare tgl_create_ datetime; 
  declare uid_create_ datetime;
  
  
  
  
  declare thn_perolehan_ char(4);  
  declare susut_mode_ int;    
  declare maxthn_ , thnak_, blnak_ int;  
  declare c1_,f1_,f2_ char(1);


  set cek_ = concat('id=',id_);
  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi,  sudahmutasi, tgl_create, uid_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_,uid_create_ from penghapusan where id = id_;  


  if mutasi_ = 1 then 
    set cek_ = concat(cek_,' dimutasi');    

    select max(tahun*12 + bulan) into maxthn_ from penyusutan where idbi = idbi_  ; 
    select tahun , bulan into thnak_, blnak_  from penyusutan where idbi = idbi_ and tahun*12 + bulan = maxthn_;
    update buku_induk set thn_susut_ak=thnak_, bln_susut_ak=blnak_ where id =idbi_;

    
    
    select sf_getAkumSusut(idbi_, tgl_) into harga_susut_;

    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j
       into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_
       from buku_induk where id = idbi_;  
  


    
    set jns_trans2_= 15;    
    set jns_trans_ = 10;    

    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;               

   
    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      

     
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_ and jns_trans=jns_trans_ ;
    
    
    if harga_susut_ <> 0 then
      insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j,
       jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
      value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_, idawal_,a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_,
       0, 0, harga_susut_, 0, tgl_, 0, 0, 0, 0, jns_trans_, l1_, l2_, l3_, l4_, l5_, l6_, uid_, now(), tgl_create_, uid_create_);
    end if;
    set cek_ = concat(cek_,' jurnal berkurang | ');
    if sudahmutasi_ = 1 then
       
      select id,a1, a, b, c1, c, d, e, e1, f1,f2,f, g, h, i, j
        into idbi_baru_,a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_
        from buku_induk where id_lama = idbi_;          
                  
      
      delete from penyusutan where idbi = idbi_baru_;      
      update buku_induk aa join buku_induk bb on aa.id_lama = bb.id 
        set aa.nilai_sisa=bb.nilai_sisa, aa.thn_susut_aw=bb.thn_susut_aw, 
        aa.thn_susut_ak=bb.thn_susut_ak, aa.masa_manfaat=bb.masa_manfaat, aa.bln_susut_aw=bb.bln_susut_aw, aa.bln_susut_ak=bb.bln_susut_ak , aa.stop_susut=bb.stop_susut        
        where aa.id=idbi_baru_;
            

      
      insert into penyusutan       
         (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c1,c,d,e,e1,f1,f2,f,g,h,i,j,ket,jns_trans2,id_koreksi,tgl_create,uid_create)
      select       
         tgl_,tahun,sem,bulan,idbi_baru_ ,idbi_awal, harga, uid_, now(),thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c1_,c_,d_,e_,e1_,f1_,f2_,f_,g_,h_,i_,j_,ket,jns_trans2_,id_koreksi, tgl_create_, uid_create_
      from penyusutan           
      where idbi = idbi_ and (id_koreksi is null or id_koreksi='' or id_koreksi=0);
       set cek_ = concat(cek_,'  salin penyusutan ke baru |');     
            
      if harga_susut_ <> 0 then
        
        insert into t_jurnal_aset
          (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j,
          jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
        value
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_baru_, idawal_,a1_, a_, b_,c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_,
          0, 0, 0, harga_susut_,  tgl_, 0, 0, 0, 0, jns_trans_,  l1_, l2_, l3_, l4_, l5_, l6_ , uid_, now(), tgl_create_, uid_create_);          
      end if;
      set cek_ = concat(cek_,'  jurnal bertambah |');
    end if; 
        

  end if; 
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_pemanfaatan`(id_ int(11)) RETURNS text CHARSET latin1
BEGIN

  declare cek_ text;
  declare qry varchar(300);
  declare idbi_, idawal_, jns_trans2_, jns_trans_,status_barang_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare tgl_create_ datetime;
  declare susut_mode_ int;  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;
  
   
  
  select staset,tgl_pemanfaatan,id_bukuinduk,idbi_awal, ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid, tgl_create
     into staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,tgl_create_ from pemanfaatan where id = id_;    
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j, status_barang into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, status_barang_  from buku_induk where id = idbi_;    

  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);  
    

 

  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);        
  
    
  

    
set jns_trans2_ = 19; 
set jns_trans_= 9 ;

  
  set difstaset_ = 7-staset_;
 
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  
  if akum_susut_ >0 then    
       
    
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19, rkint_, rka_, rkb_, 19, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   
    
    set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19, rkint_, rka_, rkb_, 19, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;  
  
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_pemanfaatan_20180213`(id_ int(11)) RETURNS text CHARSET latin1
BEGIN

  declare cek_ text;
  declare qry varchar(300);
  declare idbi_, idawal_, jns_trans2_, jns_trans_,status_barang_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare tgl_create_ datetime;
  declare susut_mode_ int;  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;
  
   
  
  select staset,tgl_pemanfaatan,id_bukuinduk,idbi_awal, ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid, tgl_create
     into staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,tgl_create_ from pemanfaatan where id = id_;    
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j, status_barang into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, status_barang_  from buku_induk where id = idbi_;    

  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);  
    

 

  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);        
  
    
  

    
set jns_trans2_ = 19; 
set jns_trans_= 9 ;

  
  set difstaset_ = 7-staset_;
 
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  
  if akum_susut_ >0 then    
       
    
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19, rkint_, rka_, rkb_, 19, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   
    
    set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19, rkint_, rka_, rkb_, 19, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;  
  
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_penghapusan`(id_ int(11)) RETURNS text CHARSET latin1
BEGIN


  declare cek_ text;
  declare idbi_, idawal_, refid_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_, mutasi_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,2);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_, uid_create varchar(20);    
  declare tgl_create_ datetime; 
  declare uid_create_ datetime;
  
  
  
  
  declare thn_perolehan_ char(4);  
  declare susut_mode_ int;  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;
    
  set cek_ =concat('id=',id_);
  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi,  tgl_create, uid_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, tgl_create_,uid_create_ from penghapusan where id = id_;  


  
  if mutasi_ = 0 or mutasi_=4 or mutasi_=5 then 
      set cek_ =concat(cek_,' mutasi=',mutasi_); 
    if mutasi_ = 0 then
       set jns_trans2_ = 14;         
    elseif mutasi_ = 4 then    
       set jns_trans2_ = 37;       
    elseif mutasi_ = 5 then        
       set jns_trans2_ = 38;       
    end if;
    
    
     
    
    set jns_trans_ = 10;       


    
    
    select sf_getAkumSusut(idbi_, tgl_) into harga_susut_;

    
    select a1, a, b, c, d, e, e1, f, g, h, i, j
       into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
       from buku_induk where id = idbi_;  
  


   

    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;     

    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_; 

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=jns_trans_ and refid=id_ ;
    
    
    
      insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,
       jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
      value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
       0, 0, harga_susut_, 0, tgl_, 0, 0, 0, 0, jns_trans_, l1_, l2_, l3_, l4_, l5_, l6_ , uid_, now(), tgl_create_, uid_create_);
 
    
    end if; 

    
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_penghapusan_20180213`(id_ int(11)) RETURNS text CHARSET latin1
BEGIN


  declare cek_ text;
  declare idbi_, idawal_, refid_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_, mutasi_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,2);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_, uid_create varchar(20);    
  declare tgl_create_ datetime; 
  declare uid_create_ datetime;
  
  
  
  
  declare thn_perolehan_ char(4);  
  declare susut_mode_ int;  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;
    
  set cek_ =concat('id=',id_);
  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi,  tgl_create, uid_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, tgl_create_,uid_create_ from penghapusan where id = id_;  


  
  if mutasi_ = 0 or mutasi_=4 or mutasi_=5 then 
      set cek_ =concat(cek_,' mutasi=',mutasi_); 
    if mutasi_ = 0 then
       set jns_trans2_ = 14;         
    elseif mutasi_ = 4 then    
       set jns_trans2_ = 37;       
    elseif mutasi_ = 5 then        
       set jns_trans2_ = 38;       
    end if;
    
    
     
    
    set jns_trans_ = 10;       


    
    
    select sf_getAkumSusut(idbi_, tgl_) into harga_susut_;

    
    select a1, a, b, c, d, e, e1, f, g, h, i, j
       into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
       from buku_induk where id = idbi_;  
  


   

    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;     

    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_; 

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=jns_trans_ and refid=id_ ;
    
    
    
      insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,
       jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
      value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
       0, 0, harga_susut_, 0, tgl_, 0, 0, 0, 0, jns_trans_, l1_, l2_, l3_, l4_, l5_, l6_ , uid_, now(), tgl_create_, uid_create_);
 
    
    end if; 

    
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_pindahtangan`(id_ int(11)) RETURNS text CHARSET latin1
BEGIN
 
  declare cek_ text;
  declare qry varchar(300);
  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare bentuk_pemindahtanganan_ , jns_trans_, jns_trans2_ int;
  declare tgl_create_ datetime;
  declare susut_mode_ int;  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;  
  
  select staset, tgl_pemindahtanganan, id_bukuinduk, idbi_awal, uid , bentuk_pemindahtanganan,tgl_create
     into staset_, tgl_, idbi_, idawal_, uid_ , bentuk_pemindahtanganan_,tgl_create_ from pemindahtanganan 
     where id = id_;         

  
  select a1, a, b, c, d, e, e1, f, g, h, i, j, status_barang into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_ , status_barang_ from buku_induk where id = idbi_;    

   
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  
   
   
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);         
  
    
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    

  if bentuk_pemindahtanganan_ = 1 then 
     set difstaset_ = 5-staset_;          
     set jns_trans_ = 10;     
     set jns_trans2_ = 17;     
  elseif bentuk_pemindahtanganan_ = 2 then  
     set difstaset_ = 11-staset_;          
     set jns_trans_ = 10;   
     set jns_trans2_ = 27;     
  elseif bentuk_pemindahtanganan_ = 3 then    
     set difstaset_ = 12-staset_;    
     set jns_trans_ = 4;  
     set jns_trans2_ = 26;     
  else   
     set difstaset_ = 13-staset_;   
     set jns_trans_ = 10;  
     set jns_trans2_ = 32;      
  end if;  
  
  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;

    
  if bentuk_pemindahtanganan_ = 1 then 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ;
  else
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;
  end if;  
 
  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;   

return cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_pindahtangan_20180213`(id_ int(11)) RETURNS text CHARSET latin1
BEGIN
 
  declare cek_ text;
  declare qry varchar(300);
  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare bentuk_pemindahtanganan_ , jns_trans_, jns_trans2_ int;
  declare tgl_create_ datetime;
  declare susut_mode_ int;  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;  
  
  select staset, tgl_pemindahtanganan, id_bukuinduk, idbi_awal, uid , bentuk_pemindahtanganan,tgl_create
     into staset_, tgl_, idbi_, idawal_, uid_ , bentuk_pemindahtanganan_,tgl_create_ from pemindahtanganan 
     where id = id_;         

  
  select a1, a, b, c, d, e, e1, f, g, h, i, j, status_barang into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_ , status_barang_ from buku_induk where id = idbi_;    

   
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  
   
   
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);         
  
    
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    

  if bentuk_pemindahtanganan_ = 1 then 
     set difstaset_ = 5-staset_;          
     set jns_trans_ = 10;     
     set jns_trans2_ = 17;     
  elseif bentuk_pemindahtanganan_ = 2 then  
     set difstaset_ = 11-staset_;          
     set jns_trans_ = 10;   
     set jns_trans2_ = 27;     
  elseif bentuk_pemindahtanganan_ = 3 then    
     set difstaset_ = 12-staset_;    
     set jns_trans_ = 4;  
     set jns_trans2_ = 26;     
  else   
     set difstaset_ = 13-staset_;   
     set jns_trans_ = 10;  
     set jns_trans2_ = 32;      
  end if;  
  
  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;

    
  if bentuk_pemindahtanganan_ = 1 then 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ;
  else
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;
  end if;  
 
  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;   

return cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_reklas`(id_ int(11), SUSUT_MODE_ int(11) ) RETURNS text CHARSET latin1
BEGIN


  declare cek_ text;
  declare idbi_, idawal_, refid_, idbi_baru_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_, mutasi_,sudahmutasi_ tinyint(3);
  declare tgl_, tgl_susut_baru_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,2);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_, uid_create varchar(20);    
  declare tgl_create_ datetime; 
  declare uid_create_ datetime;
  
  
  
  
  declare thn_perolehan_ char(4);      
declare maxthn_, thnak_, blnak_ int;
  

  
  

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi,  sudahmutasi, tgl_create, uid_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_,uid_create_ from penghapusan where id = id_;  


  if mutasi_ = 2 then 
    
    if SUSUT_MODE_ = 3 then  
       delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
    else 
       delete from penyusutan where idbi=idbi_ and tgl>= tgl_ and jns_trans2=30;      
    end if; 
    select max(tahun*12 + bulan) into maxthn_ from penyusutan where idbi = idbi_  ; 
    select tahun , bulan into thnak_, blnak_  from penyusutan where idbi = idbi_ and tahun*12 + bulan = maxthn_;
    update buku_induk set thn_susut_ak=thnak_, bln_susut_ak=blnak_ where id =idbi_;

    
    
    select sf_getAkumSusut(idbi_, tgl_) into harga_susut_;

    
    select a1, a, b, c, d, e, e1, f, g, h, i, j
       into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
       from buku_induk where id = idbi_;  
  


    
    set jns_trans2_= 16;    
    set jns_trans_ = 10;    

    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 9 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '05' ;   
    elseif staset_ = 10 then    
      set rkint_ = '02'; set rka_ = '00'; set rkb_ = '00' ;   
    elseif staset_ = 8 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '04' ;   
    end if;             

   
    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=jns_trans_ and refid=id_ ;
    
    
    insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,
       jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
    value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
       0, 0, harga_susut_, 0, tgl_, 0, 0, 0, 0, jns_trans_, l1_, l2_, l3_, l4_, l5_, l6_, uid_, now(), tgl_create_, uid_create_);
    
    
    if sudahmutasi_ = 1 then
      
      select id, a1, a, b, c, d, e, e1, f, g, h, i, j
        into idbi_baru_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
        from buku_induk where id_lama = idbi_;
      
      
      
      
      
      select max(tgl) into tgl_susut_baru_ from penyusutan where idbi = idbi_;      
if tgl_susut_baru_ is not null then
      
      delete from penyusutan where idbi = idbi_baru_;    
      
      update buku_induk set 
      masa_manfaat=0,nilai_sisa=0,thn_susut_aw=0,thn_susut_ak=0,bln_susut_aw=0,bln_susut_ak=0,masa_manfaat_tot=0,stop_susut=0
      where id =  idbi_baru_;      
      
      select sf_susut(idbi_baru_, tgl_susut_baru_, uid_ , jns_trans2_,  SUSUT_MODE_) into cek_; 
      update penyusutan set tgl = tgl_  where idbi = idbi_baru_;
      
      select sf_getAkumSusut(idbi_baru_, tgl_) into harga_susut_;
end if;
      
      select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
        into l1_, l2_, l3_, l4_, l5_, l6_ 
        from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_; 
        
      
      if staset_ = 3 then 
        
        if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
        else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
        end if;     
      elseif staset_ = 8 then          
        if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
        else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
        end if;                  
      elseif staset_ = 9 then    
        set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
      elseif staset_ = 10 then    
        set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
      end if;          

      
      insert into t_jurnal_aset
        (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,
        jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
      value
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_baru_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
        0, 0, 0, harga_susut_,  tgl_, 0, 0, 0, 0, jns_trans_,  l1_, l2_, l3_, l4_, l5_, l6_ , uid_, now(), tgl_create_, uid_create_);
    
    end if; 
        

  end if; 
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_reklas_20180213`(id_ int(11), SUSUT_MODE_ int(11) ) RETURNS text CHARSET latin1
BEGIN


  declare cek_ text;
  declare idbi_, idawal_, refid_, idbi_baru_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_, mutasi_,sudahmutasi_ tinyint(3);
  declare tgl_, tgl_susut_baru_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,2);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_, uid_create varchar(20);    
  declare tgl_create_ datetime; 
  declare uid_create_ datetime;
  
  
  
  
  declare thn_perolehan_ char(4);      
declare maxthn_, thnak_, blnak_ int;
  

  
  

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi,  sudahmutasi, tgl_create, uid_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_,uid_create_ from penghapusan where id = id_;  


  if mutasi_ = 2 then 
    
    if SUSUT_MODE_ = 3 then  
       delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
    else 
       delete from penyusutan where idbi=idbi_ and tgl>= tgl_ and jns_trans2=30;      
    end if; 
    select max(tahun*12 + bulan) into maxthn_ from penyusutan where idbi = idbi_  ; 
    select tahun , bulan into thnak_, blnak_  from penyusutan where idbi = idbi_ and tahun*12 + bulan = maxthn_;
    update buku_induk set thn_susut_ak=thnak_, bln_susut_ak=blnak_ where id =idbi_;

    
    
    select sf_getAkumSusut(idbi_, tgl_) into harga_susut_;

    
    select a1, a, b, c, d, e, e1, f, g, h, i, j
       into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
       from buku_induk where id = idbi_;  
  


    
    set jns_trans2_= 16;    
    set jns_trans_ = 10;    

    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 9 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '05' ;   
    elseif staset_ = 10 then    
      set rkint_ = '02'; set rka_ = '00'; set rkb_ = '00' ;   
    elseif staset_ = 8 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '04' ;   
    end if;             

   
    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=jns_trans_ and refid=id_ ;
    
    
    insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,
       jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
    value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
       0, 0, harga_susut_, 0, tgl_, 0, 0, 0, 0, jns_trans_, l1_, l2_, l3_, l4_, l5_, l6_, uid_, now(), tgl_create_, uid_create_);
    
    
    if sudahmutasi_ = 1 then
      
      select id, a1, a, b, c, d, e, e1, f, g, h, i, j
        into idbi_baru_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
        from buku_induk where id_lama = idbi_;
      
      
      
      
      
      select max(tgl) into tgl_susut_baru_ from penyusutan where idbi = idbi_;      
if tgl_susut_baru_ is not null then
      
      delete from penyusutan where idbi = idbi_baru_;    
      
      update buku_induk set 
      masa_manfaat=0,nilai_sisa=0,thn_susut_aw=0,thn_susut_ak=0,bln_susut_aw=0,bln_susut_ak=0,masa_manfaat_tot=0,stop_susut=0
      where id =  idbi_baru_;      
      
      select sf_susut(idbi_baru_, tgl_susut_baru_, uid_ , jns_trans2_,  SUSUT_MODE_) into cek_; 
      update penyusutan set tgl = tgl_  where idbi = idbi_baru_;
      
      select sf_getAkumSusut(idbi_baru_, tgl_) into harga_susut_;
end if;
      
      select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
        into l1_, l2_, l3_, l4_, l5_, l6_ 
        from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_; 
        
      
      if staset_ = 3 then 
        
        if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
        else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
        end if;     
      elseif staset_ = 8 then          
        if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
        else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
        end if;                  
      elseif staset_ = 9 then    
        set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
      elseif staset_ = 10 then    
        set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
      end if;          

      
      insert into t_jurnal_aset
        (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,
        jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
      value
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_baru_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
        0, 0, 0, harga_susut_,  tgl_, 0, 0, 0, 0, jns_trans_,  l1_, l2_, l3_, l4_, l5_, l6_ , uid_, now(), tgl_create_, uid_create_);
    
    end if; 
        

  end if; 
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_reklas_tes`(id_ int(11), SUSUT_MODE_ int(11) ) RETURNS text CHARSET latin1 COLLATE latin1_general_ci
BEGIN


  declare cek_ text;
  declare idbi_, idawal_, refid_, idbi_baru_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_, mutasi_,sudahmutasi_ tinyint(3);
  declare tgl_, tgl_susut_baru_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,2);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_, uid_create varchar(20);    
  declare tgl_create_ datetime; 
  declare uid_create_ datetime;
  
  
  
  
  declare thn_perolehan_ char(4);    
  

  
  

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi,  sudahmutasi, tgl_create, uid_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_,uid_create_ from penghapusan where id = id_;  


  if mutasi_ = 2 then 
    
    if SUSUT_MODE_ = 3  then  
       delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
    else 
       delete from penyusutan where idbi=idbi_ and tgl>= tgl_;    
    end if; 
 

    
    select sum(harga) into harga_susut_ from penyusutan where idbi = idbi_ and (id_koreksi is null or id_koreksi ='');
  

    
    select a1, a, b, c, d, e, e1, f, g, h, i, j
       into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
       from buku_induk where id = idbi_;  
  


    
    set jns_trans2_= 16;    
    set jns_trans_ = 10;    

    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 9 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '05' ;   
    elseif staset_ = 10 then    
      set rkint_ = '02'; set rka_ = '00'; set rkb_ = '00' ;   
    elseif staset_ = 8 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '04' ;   
    end if;             

   
    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=jns_trans_ and refid=id_ ;
    
    
    insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,
       jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
    value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
       0, 0, harga_susut_, 0, tgl_, 0, 0, 0, 0, jns_trans_, l1_, l2_, l3_, l4_, l5_, l6_, uid_, now(), tgl_create_, uid_create_);
    
    
    if sudahmutasi_ = 1 then
      
      select id, a1, a, b, c, d, e, e1, f, g, h, i, j
        into idbi_baru_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
        from buku_induk where id_lama = idbi_;
      
      
      
      select sf_susut_get_periode_ak(tgl_, SUSUT_MODE_, idbi_) into tgl_susut_baru_ ;  
      
      delete from penyusutan where idbi = idbi_baru_;    
      
      update buku_induk set 
      masa_manfaat=0,nilai_sisa=0,thn_susut_aw=0,thn_susut_ak=0,bln_susut_aw=0,bln_susut_ak=0,masa_manfaat_tot=0,stop_susut=0
      where id =  idbi_baru_;      
      
      select sf_susut(idbi_baru_, tgl_susut_baru_, uid_ , jns_trans2_,  SUSUT_MODE_) into cek_; 
      select sum(ifnull(harga,0)) into harga_susut_ from penyusutan where idbi = idbi_baru_ and (id_koreksi is null or id_koreksi ='');


      
      select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
        into l1_, l2_, l3_, l4_, l5_, l6_ 
        from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_; 
        
      
      if staset_ = 3 then 
        
        if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
        else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
        end if;     
      elseif staset_ = 8 then          
        if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
        else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
        end if;                  
      elseif staset_ = 9 then    
        set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
      elseif staset_ = 10 then    
        set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
      end if;          

      
      insert into t_jurnal_aset
        (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,
        jml_barang_d,jml_barang_k,debet,kredit, tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
      value
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 0, id_, 0, idbi_baru_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
        0, 0, 0, harga_susut_,  tgl_, 0, 0, 0, 0, jns_trans_,  l1_, l2_, l3_, l4_, l5_, l6_ , uid_, now(), tgl_create_, uid_create_);
    
    end if; 
        

  end if; 
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_staset`(id_ int(11) ) RETURNS text CHARSET latin1 COLLATE latin1_general_ci
BEGIN








  declare cek_ text;                                                                     
  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare staset_, staset_baru_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ , jns_trans_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);
  declare jns_, refid_ int(11);  
  declare tgl_create_ datetime;
  declare susut_mode_ int;  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  
  select tgl,idbi,uid, staset, staset_baru, idbi_awal, jns,refid,tgl_create      
     into tgl_,idbi_, uid_, staset_, staset_baru_ , idawal_, jns_, refid_ ,tgl_create_ from t_history_aset where Id = id_;      

  
 

if staset_ <> '0' then 
   


  
  select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;      
  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);     

  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);      


  if staset_baru_ = 9 then 
    
    set q_= 21; set jns_trans2_ = 21;      
        
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;  
      
      select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=10 and refid=id_ ;
              
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    
        
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_,  '01', '02', '05', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;      
                    

  elseif staset_baru_ = 10 then 
  
    set q_= 22; set jns_trans2_ = 22; 
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;     
      
      select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
        from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;   
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;     

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=10 and refid=id_ ;

    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    

    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, '02', '00', '00', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    
 
  elseif staset_baru_ = 3 then 
  
    if staset_ = 9 then    
       set q_= 21; set jns_trans2_ = 21;         
    elseif staset_ = 10 then    
       set q_= 22; set jns_trans2_ = 22; 
    end if;    

    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;  set jns_trans_=9;         
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; set jns_trans_=9;         
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; set jns_trans_=9;    
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ; set jns_trans_ = 3;
    end if;     

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=10 and refid=id_ ;

    
        
    
    
    
        
    
    if staset_ = 9 then        
       set ka_ = '1' ; set kb_ = '5'; set kc_ = '4'; set kd_='1' ; set ke_= f_ ; set kf_=g_;        
    elseif staset_=10 then    
       set ka_ = '' ; set kb_ = ''; set kc_ = ''; set kd_='' ; set ke_= ''; set kf_='';  
    end if;

    
    if akum_susut_ >0 then                
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0,  tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
          
    
    if f_<> '07' then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    else 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    end if;     

    
    if akum_susut_ >0 then                
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
  
  elseif staset_baru_ = 8 then 
  
    if staset_ = 9 then    
       set q_= 21; set jns_trans2_ = 21;         
    elseif staset_ = 10 then    
       set q_= 22; set jns_trans2_ = 22; 
    end if;    

    
    if staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; set jns_trans_=9;    
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ; set jns_trans_ = 3;
    end if;     

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=10 and refid=id_ ;

    
        
    
    if staset_ = 9 then        
       set ka_ = '1' ; set kb_ = '5'; set kc_ = '4'; set kd_='1' ; set ke_= f_ ; set kf_=g_;        
    elseif staset_=10 then    
       set ka_ = '' ; set kb_ = ''; set kc_ = ''; set kd_='' ; set ke_= ''; set kf_='';  
    end if;
    
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;     
          
    
    if f_<> '07' then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    else
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    end if;    

     
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;  
        
  end if;     


end if;  

return cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_jurnal_susut_staset_20180213`(id_ int(11) ) RETURNS text CHARSET latin1 COLLATE latin1_general_ci
BEGIN








  declare cek_ text;                                                                     
  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare staset_, staset_baru_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ , jns_trans_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);
  declare jns_, refid_ int(11);  
  declare tgl_create_ datetime;
  declare susut_mode_ int;  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  
  select tgl,idbi,uid, staset, staset_baru, idbi_awal, jns,refid,tgl_create      
     into tgl_,idbi_, uid_, staset_, staset_baru_ , idawal_, jns_, refid_ ,tgl_create_ from t_history_aset where Id = id_;      

  
 

if staset_ <> '0' then 
   


  
  select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;      
  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);     

  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);      


  if staset_baru_ = 9 then 
    
    set q_= 21; set jns_trans2_ = 21;      
        
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;  
      
      select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=10 and refid=id_ ;
              
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    
        
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_,  '01', '02', '05', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;      
                    

  elseif staset_baru_ = 10 then 
  
    set q_= 22; set jns_trans2_ = 22; 
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;     
      
      select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
        from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;   
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;     

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=10 and refid=id_ ;

    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    

    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, '02', '00', '00', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    
 
  elseif staset_baru_ = 3 then 
  
    if staset_ = 9 then    
       set q_= 21; set jns_trans2_ = 21;         
    elseif staset_ = 10 then    
       set q_= 22; set jns_trans2_ = 22; 
    end if;    

    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;  set jns_trans_=9;         
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; set jns_trans_=9;         
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; set jns_trans_=9;    
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ; set jns_trans_ = 3;
    end if;     

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=10 and refid=id_ ;

    
        
    
    
    
        
    
    if staset_ = 9 then        
       set ka_ = '1' ; set kb_ = '5'; set kc_ = '4'; set kd_='1' ; set ke_= f_ ; set kf_=g_;        
    elseif staset_=10 then    
       set ka_ = '' ; set kb_ = ''; set kc_ = ''; set kd_='' ; set ke_= ''; set kf_='';  
    end if;

    
    if akum_susut_ >0 then                
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0,  tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
          
    
    if f_<> '07' then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    else 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    end if;     

    
    if akum_susut_ >0 then                
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
  
  elseif staset_baru_ = 8 then 
  
    if staset_ = 9 then    
       set q_= 21; set jns_trans2_ = 21;         
    elseif staset_ = 10 then    
       set q_= 22; set jns_trans2_ = 22; 
    end if;    

    
    if staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; set jns_trans_=9;    
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ; set jns_trans_ = 3;
    end if;     

    
    delete from t_jurnal_aset where jns_trans2=jns_trans2_ and jns_trans=10 and refid=id_ ;

    
        
    
    if staset_ = 9 then        
       set ka_ = '1' ; set kb_ = '5'; set kc_ = '4'; set kd_='1' ; set ke_= f_ ; set kf_=g_;        
    elseif staset_=10 then    
       set ka_ = '' ; set kb_ = ''; set kc_ = ''; set kd_='' ; set ke_= ''; set kf_='';  
    end if;
    
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;     
          
    
    if f_<> '07' then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    else
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    end if;    

     
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;  
        
  end if;     


end if;  

return cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_penerimaan_posting`(`Id_PenDet_` int, `thn_bast_` char(4), `harga_satuan_perolehan_` DECIMAL(18,2), `harga_satuan_perolehan_akhir_`  DECIMAL(18,2), `staset_` char(4),`a_` char(2), `a1_` char(2),`b_` char(2), `tgl_dok_sum_` date, `no_dokumen_sumber_` text, `asal_usul_` char(2), `tgl_buku_` date,`JMLBRGNY_` int, `barang_sudah_proses_` int, harga_beli_barang_ DECIMAL(18,2), harga_atribusi_barang_ DECIMAL(18,2), `bk_` char(3), `ck_` char(3), `dk_` char(3), `p_` char(3), `q_` char(3), `thn_anggaran_` char(4),`uid_` text, noreg_max_ int, sumber_dana_ text, HargaTotalPengadaan_ DECIMAL(18,2), nomor_kontraknya_ text, tgl_kontraknya_ date) RETURNS text CHARSET latin1
BEGIN

	DECLARE c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_,hasilstat_,hasilstat2_, satuan_, noreg_baru_text_, bk_ur_, ck_ur_, dk_ur_, ket_barang_, keterangan_, nm_barangnya_, ambil_noreg_, Hasil_Distribusi_ text;
	DECLARE refid_terima_, jumlah_data_input_,jml_barang_dplh_, noreg_, refid_atribusi_, noreg_baru_, hit_bi, jml_barang_selesai_proses_, cek_harga_diBI_, ID_BI_barunya_, cntskpd_urusan_, barangdistribusi_, Id_Distribusi_, jumlah_total_input_BI_, jumlah_Barang_pendet_ int;
	DECLARE harga_satuan_, harga_atribusi_, harga_barang_satuan_dplh_, harga_totat_diBI_ DECIMAL(18,2);
	
	
	SELECT c1,c,d,e,e1,f1,f2,f,g,h,i,j, harga_satuan, refid_terima, jml, satuan,ket_barang, keterangan, barangdistribusi INTO c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, harga_satuan_, refid_terima_, jml_barang_dplh_, satuan_, ket_barang_, keterangan_, barangdistribusi_ FROM t_penerimaan_barang_det WHERE Id=Id_PenDet_;
	
    SET hasilstat_ = "NEXT";        
    SET harga_barang_satuan_dplh_ = 0;
      

    WHILE barang_sudah_proses_ < JMLBRGNY_ DO	
    	
    	SELECT COUNT(*) as jml INTO jumlah_data_input_ FROM buku_induk WHERE refid_terima_det=Id_PenDet_ AND refid_terima=refid_terima_;    

    			
    	
    	IF jumlah_data_input_ + 1 > jml_barang_dplh_ THEN
    		SET hasilstat_ = "NEXT";    
            SET barang_sudah_proses_ = barang_sudah_proses_ + JMLBRGNY_;
    	ELSEIF barang_sudah_proses_ >= JMLBRGNY_ THEN
    		SET hasilstat_ = "LANJUT";
    	ELSE    
                
        IF barangdistribusi_ = 1 THEN        
           SET barangdistribusi_ = 1;           
           SELECT sf_penerimaan_posting_distribusi(Id_PenDet_, c1_, c_, d_, e_, e1_) INTO Hasil_Distribusi_; 
           
           SET e_ = SUBSTRING(Hasil_Distribusi_, 1,2);
           SET e1_ = SUBSTRING(Hasil_Distribusi_, 4,3);
           SET Id_Distribusi_ = SUBSTRING_INDEX(Hasil_Distribusi_, ' ', -1);           
        END IF;
    		
			SELECT nm_barang INTO nm_barangnya_ FROM ref_barang WHERE f1=f1_ AND f2=f2_ AND f=f_ AND g=g_ AND h=h_ AND i=i_ AND j=j_;
			     
            
            SELECT sf_penerimaan_posting_noreg(c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, thn_bast_,nm_barangnya_, noreg_max_) INTO ambil_noreg_ ;  
			SET j_=SUBSTRING(ambil_noreg_, 1,3);
			SET noreg_baru_text_ = SUBSTRING(ambil_noreg_,5);
				
    		
    		IF jumlah_data_input_ + 1 = jml_barang_dplh_ THEN
    			SET hasilstat_ = "LANJUT";
    			  
                SELECT COUNT(*) INTO cek_harga_diBI_ FROM buku_induk WHERE refid_terima_det = Id_PenDet_ AND harga = harga_satuan_perolehan_akhir_ ;                
                IF cek_harga_diBI_ = 0 THEN                
                   SET harga_barang_satuan_dplh_ = harga_satuan_perolehan_akhir_;                                    
                ELSE                
                   SET harga_barang_satuan_dplh_ = harga_satuan_perolehan_;                   
                END IF;
                                
                
                
                
   	            SELECT COUNT(*) as jml, IFNULL(SUM(harga),0) INTO jumlah_total_input_BI_, harga_totat_diBI_ FROM buku_induk WHERE refid_terima=refid_terima_;
                SELECT SUM(jml)  INTO jumlah_Barang_pendet_ FROM t_penerimaan_barang_det WHERE refid_terima=refid_terima_ AND sttemp='0'; 
                    
                IF jumlah_total_input_BI_ + 1 >= jumlah_Barang_pendet_ THEN
                   SET harga_barang_satuan_dplh_ = HargaTotalPengadaan_ - harga_totat_diBI_;
                END IF;  

    		ELSE
    			SET harga_barang_satuan_dplh_ = harga_satuan_perolehan_;
    			SET hasilstat_ = "OK";
    		END IF;
    		
    		SET harga_atribusi_ = harga_barang_satuan_dplh_ - harga_satuan_;
    		
    		IF harga_atribusi_ < 0 THEN
    			SET harga_atribusi_ = 0;
    		END IF;
    	 	
    		
    		SELECT Id INTO refid_atribusi_ FROM t_atribusi WHERE refid_terima=refid_terima_ LIMIT 0,1;    

            
            SELECT bk, ck, dk, COUNT(*) INTO bk_ur_, ck_ur_, dk_ur_, cntskpd_urusan_ FROM ref_skpd_urusan WHERE c=c_ AND d=d_;            

            IF cntskpd_urusan_ <= 0 THEN             
               SET bk_ur_ = 0;               
               SET ck_ur_ = 0;               
               SET dk_ur_ = 0;
            
            END IF;
    				
    		
    		INSERT INTO buku_induk (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, thn_perolehan, jml_barang, satuan, harga, jml_harga, asal_usul, kondisi, status_barang, staset, tgl_buku, tahun, uid, harga_beli, harga_atribusi, ref_idatribusi, no_ba, tgl_ba, bk_p, ck_p, dk_p, p, q, refid_terima, refid_terima_det, bk,ck,dk, jns_hibah, no_spk, tgl_spk) values (a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_, thn_bast_, '1', satuan_, harga_barang_satuan_dplh_, harga_barang_satuan_dplh_, asal_usul_, '1', '1', staset_, tgl_buku_, thn_anggaran_, uid_, harga_beli_barang_, harga_atribusi_barang_, refid_atribusi_, no_dokumen_sumber_, tgl_dok_sum_, bk_, ck_, dk_, p_, q_, refid_terima_, Id_PenDet_, bk_ur_, ck_ur_, dk_ur_, sumber_dana_, nomor_kontraknya_, tgl_kontraknya_);
    		    
            
            SELECT id INTO ID_BI_barunya_ FROM buku_induk WHERE a1=a1_ AND a=a_ AND b=b_ AND c1=c1_ AND c=c_ AND d=d_ AND e=e_ AND e1=e1_ AND f1=f1_ AND f2=f2_ AND f=f_ AND g=g_ AND h=h_ AND i=i_ AND j=j_ AND noreg=noreg_baru_text_ AND thn_perolehan=thn_bast_ AND staset=staset_ AND refid_terima=refid_terima_ AND refid_terima_det=Id_PenDet_ AND uid=uid_ AND asal_usul=asal_usul_ ORDER BY id DESC;
            
            IF f_='01' THEN
               INSERT INTO kib_a (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, alamat, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);            
            ELSEIF f_='02' THEN            
               INSERT INTO kib_b (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, merk, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            ELSEIF f_='03' THEN            
               INSERT INTO kib_c (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, alamat, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            ELSEIF f_='04' THEN            
               INSERT INTO kib_d (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, alamat, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            ELSEIF f_='05' THEN            
               INSERT INTO kib_e (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, buku_judul, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            ELSEIF f_='06' THEN            
               INSERT INTO kib_f (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, alamat, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            ELSEIF f_='07' THEN            
               INSERT INTO kib_g (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, uraian, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            END IF;
                        
            UPDATE buku_induk SET idawal=ID_BI_barunya_ WHERE id=ID_BI_barunya_; 
            
            
            
            

    		SET barang_sudah_proses_ = barang_sudah_proses_ + 1;    
    
    	END IF;	
    END WHILE;
        
    SELECT COUNT(*) INTO jml_barang_selesai_proses_ FROM buku_induk WHERE refid_terima=refid_terima_;
    
    SET hasilstat_ = CONCAT(hasilstat_," ",jml_barang_selesai_proses_, " ", harga_barang_satuan_dplh_);     

 RETURN hasilstat_; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_penerimaan_posting_distribusi`(`Id_Pendet_` int(11), c1_ char(1), c_ char(2), d_ char(2), e_ char(2), e1_ char(3)) RETURNS text CHARSET latin1
BEGIN
     DECLARE hasil, e_Baru_, e1_Baru_ text; 
     DECLARE jumlah_Baru_ bigint;
     DECLARE Id_distribusi_, jumlah_barang_BI_ int;    
	 DECLARE habis BOOLEAN DEFAULT FALSE;
     DECLARE datat_barang CURSOR FOR SELECT e,e1, jumlah, Id FROM t_distribusi WHERE refid_penerimaan_det=Id_Pendet_ AND sttemp='0' GROUP BY c1,c,d,e,e1;
     DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET habis = TRUE; 
    
     SET Id_distribusi_ = 0;     

     OPEN datat_barang;
		REPEAT
		FETCH datat_barang INTO e_Baru_, e1_Baru_, jumlah_Baru_, Id_distribusi_ ;          
        IF habis = FALSE THEN  
              SELECT COUNT(id) as jml_barng_bi INTO jumlah_barang_BI_ FROM buku_induk WHERE refid_terima_det=Id_Pendet_ AND c1=c1_ AND c=c_ AND d=d_ AND e=e_Baru_ AND e1=e1_Baru_ ;              
              IF jumlah_barang_BI_ + 1 <= jumlah_Baru_ THEN              
                  SET habis = TRUE;                  
                  SET e_ = e_Baru_;                  
                  SET e1_ = e1_Baru_;
              END IF;
        END IF;
        UNTIL habis END REPEAT;
     CLOSE datat_barang;
     
     SET hasil = CONCAT(e_,' ', e1_, ' ', Id_distribusi_) ;
       
  RETURN hasil;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_penerimaan_posting_noreg`(c1_ char(1), c_ char(2), d_ char(2), e_ char(2), e1_ char(3), f1_ char(1), f2_ char(1), f_ char(2), g_ char(2), h_ char(2), i_ char(2), j_ char(3), thn_bast_ char(4), nama_barang_ text, noreg_max_ int) RETURNS text CHARSET latin1
BEGIN
	
	DECLARE noreg_baru_text_, j_baru_, j_akhir_text_, kode_gabung_, hasil_stat_, cekak_ text ;
	DECLARE noreg_baru_,hit_bi_, hit_barang_, input_barang_, j_akhir_, noreg_ int;
	DECLARE habis BOOLEAN DEFAULT FALSE;
    DECLARE datat_barang CURSOR FOR SELECT j FROM ref_barang WHERE f1=f1_ AND f2=f2_ AND f=f_ AND g=g_ AND h=h_ AND i=i_ AND j!='000' AND j!=j_ AND nm_barang=nama_barang_  ORDER BY j DESC;
    DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET habis = TRUE;
	
    SET cekak_ = 'ini';
	SET input_barang_ = 1;
    SET hit_barang_ = 0;
	SELECT COUNT(*) as cnt INTO hit_bi_ FROM buku_induk WHERE c1=c1_ AND c=c_ AND d=d_ AND e=e_ AND e1=e1_ AND f1=f1_ AND f2=f2_ AND f=f_ AND g=g_ AND h=h_ AND i=i_ AND j=j_ AND thn_perolehan = thn_bast_;
	
	
	IF hit_bi_ > 0 THEN    
    		
    		SELECT IFNULL(CAST(SUBSTRING_INDEX(noreg, '-', -1) AS UNSIGNED),0) as noreg INTO noreg_ FROM buku_induk WHERE c1=c1_ AND c=c_ AND d=d_ AND e=e_ AND e1=e1_ AND f1=f1_ AND f2=f2_ AND f=f_ AND g=g_ AND h=h_ AND i=i_ AND j=j_ AND thn_perolehan = thn_bast_ ORDER BY noreg DESC LIMIT 0,1;	        
    
    	 	SET noreg_baru_ = noreg_ + 1;
			IF noreg_baru_ <= noreg_max_ THEN
	    		IF LENGTH(noreg_baru_) = 1 THEN
	    			SET noreg_baru_text_ = concat('000',noreg_baru_);
	    		ELSEIF LENGTH(noreg_baru_) = 2 THEN
	    			SET noreg_baru_text_ = concat('00',noreg_baru_);
	    		ELSEIF LENGTH(noreg_baru_) = 3 THEN
	    			SET noreg_baru_text_ = concat('0',noreg_baru_);
	    		ELSE
	    			SET noreg_baru_text_ = noreg_baru_;
	    		END IF; 
                
                SET input_barang_ = 0; 
                
			ELSE
				
				SELECT COUNT(*) INTO hit_barang_ FROM ref_barang WHERE f1=f1_ AND f2=f2_ AND f=f_ AND g=g_ AND h=h_ AND i=i_ AND j!='000' AND j!= j_ AND nm_barang=nama_barang_  ORDER BY j DESC;
				
				IF hit_barang_ > 0 THEN

                      OPEN datat_barang;
		          		REPEAT
		          		FETCH datat_barang INTO j_baru_ ;          
			              IF habis = FALSE THEN
			                	
								SELECT IFNULL(CAST(SUBSTRING_INDEX(noreg, '-', -1) AS UNSIGNED),0) as noreg INTO noreg_ FROM buku_induk WHERE c1=c1_ AND c=c_ AND d=d_ AND e=e_ AND e1=e1_ AND f1=f1_ AND f2=f2_ AND f=f_ AND g=g_ AND h=h_ AND i=i_ AND j=j_baru_ AND thn_perolehan = thn_bast_ ORDER BY noreg DESC LIMIT 0,1;	        
    
    	 						SET noreg_baru_ = noreg_ + 1;
								
								IF noreg_baru_ <= noreg_max_ THEN
						    		IF LENGTH(noreg_baru_) = 1 THEN
						    			SET noreg_baru_text_ = concat('000',noreg_baru_);
						    		ELSEIF LENGTH(noreg_baru_) = 2 THEN
						    			SET noreg_baru_text_ = concat('00',noreg_baru_);
						    		ELSEIF LENGTH(noreg_baru_) = 3 THEN
						    			SET noreg_baru_text_ = concat('0',noreg_baru_);
						    		ELSE
						    			SET noreg_baru_text_ = noreg_baru_;
						    		END IF; 
									
									SET habis = TRUE;  
									SET input_barang_ = 0;
                                    SET j_=j_baru_; 
								END IF;	
																			
			              END IF;
			          UNTIL habis END REPEAT;
			    	CLOSE datat_barang;    

				ELSE
					SET input_barang_ = 1;
				END IF;
				
				IF input_barang_ = 1 THEN
					
					
					SELECT IFNULL(CAST(SUBSTRING_INDEX(j, '-', -1) AS UNSIGNED),0) INTO j_akhir_ FROM ref_barang WHERE f1=f1_ AND f2=f2_ AND f=f_ AND g=g_ AND h=h_ AND i=i_ AND j!='000' ORDER BY j DESC LIMIT 0,1;
					
					SET j_akhir_ = j_akhir_ + 1;
					
					IF LENGTH(j_akhir_) = 1 THEN
						SET j_akhir_text_ = concat('00',j_akhir_);
					ELSEIF LENGTH(j_akhir_) = 2 THEN
						SET j_akhir_text_ = concat('0',j_akhir_);
					ELSE
						SET j_akhir_text_ = j_akhir_;
					END IF; 
					
					SET kode_gabung_ = concat(f1_,f2_,f_,g_,h_,i_,j_);
					
					INSERT INTO ref_barang (f1,f2,f,g,h,i,j,nm_barang,kodeawal) values (f1_,f2_,f_,g_,h_,i_,j_akhir_text_,nama_barang_, kode_gabung_);
					
					SET noreg_baru_text_ = "0001";
					
					SET j_ = j_akhir_text_;
				END IF;
								
			END IF;
			 
      ELSE      
            SET noreg_baru_text_ = "0001";            
      END IF;

SET hasil_stat_ = concat(j_, ' ',noreg_baru_text_);  

	
 RETURN hasil_stat_ ; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_penerimaan_posting_pemeliharaan`(`IdDistribusi` int(11), `tahun_dari_` int(4), `asal_usulnya_` char(1)) RETURNS text CHARSET latin1
BEGIN
     DECLARE hasil_,c1_,c_,d_,e_,e1_,f1_,f2_,f_,g_,h_,i_,j_, tahun_,uid_, nomor_, tgl_dok_, refid_jns_pemeliharaan_, jns_pemeliharaan_, cara_perolehan_, no_dokumen_sumber_, tgl_pemeliharaan_nya_, nomor_kontrak_nya_ text;
     DECLARE tgl_buku_, tgl_kontrak_nya_, tgl_dokumen_sumber_nya_ date;
     DECLARE hit_pemeliharaan_, refid_terima_, refid_penerimaan_det_, refid_buku_induk_, menambah_aset_, menambah_manfaat_, JML_DATA_SELESAI_PEMELIHARAAN_, JML_DATA_SELESAI_KPTLS_, tahun_ambil_  int;
     DECLARE jumlahKPTLS_ DECIMAL(18,2);

     SELECT c1,c,d,e,e1,f1,f2,f,g,h,i,j,jumlah, refid_terima, refid_penerimaan_det, uid, nomor, tgl_dok, refid_jns_pemeliharaan, jns_pemeliharaan, refid_buku_induk, CAST(tahun AS UNSIGNED) INTO c1_,c_,d_,e_,e1_,f1_,f2_,f_,g_,h_,i_,j_,jumlahKPTLS_, refid_terima_, refid_penerimaan_det_,uid_, nomor_, tgl_dok_, refid_jns_pemeliharaan_, jns_pemeliharaan_, refid_buku_induk_, tahun_ambil_ FROM t_distribusi WHERE Id=IdDistribusi;

     IF tahun_dari_ > tahun_ambil_ THEN
        SET tgl_pemeliharaan_nya_ = CONCAT(tahun_ambil_, "-12-31");
     ELSE
         SET tgl_pemeliharaan_nya_ = NOW();
     END IF;

     #CEK di Pemeliharaan
     SELECT COUNT(*) INTO hit_pemeliharaan_ FROM pemeliharaan WHERE refid_terima=refid_terima_ AND refid_terima_det=refid_penerimaan_det_ AND id_bukuinduk=refid_buku_induk_;

     IF hit_pemeliharaan_ = 0 THEN
        SELECT menambah_aset, menambah_manfaat INTO menambah_aset_, menambah_manfaat_ FROM ref_jenis_pemeliharaan WHERE Id=refid_jns_pemeliharaan_;
        SELECT tgl_buku, asal_usul, no_dokumen_sumber, nomor_kontrak,tgl_kontrak,tgl_dokumen_sumber INTO tgl_buku_, cara_perolehan_, no_dokumen_sumber_,nomor_kontrak_nya_, tgl_kontrak_nya_, tgl_dokumen_sumber_nya_ FROM t_penerimaan_barang WHERE Id=refid_terima_;

        #INSERT INTO pemeliharaan(id_bukuinduk, tgl_pemeliharaan,jenis_pemeliharaan,surat_no,surat_tgl,biaya_pemeliharaan, idbi_awal,uid,tambah_aset, tambah_masamanfaat, cara_perolehan, tgl_perolehan, no_bast, refid_terima, refid_terima_det, surat_no, surat_tgl, tgl_bast) values (refid_buku_induk_, tgl_pemeliharaan_nya_, jns_pemeliharaan_, nomor_, tgl_dok_, jumlahKPTLS_, refid_buku_induk_, uid_, menambah_aset_, menambah_manfaat_, asal_usulnya_, tgl_buku_, no_dokumen_sumber_, refid_terima_, refid_penerimaan_det_, nomor_kontrak_nya_, tgl_kontrak_nya_, tgl_dokumen_sumber_nya_) ;
        INSERT INTO pemeliharaan(id_bukuinduk, tgl_pemeliharaan,jenis_pemeliharaan,surat_no,surat_tgl,biaya_pemeliharaan, idbi_awal,uid,tambah_aset, tambah_masamanfaat, cara_perolehan, tgl_perolehan, no_bast, refid_terima, refid_terima_det, tgl_bast) values (refid_buku_induk_, tgl_buku_, jns_pemeliharaan_, nomor_kontrak_nya_, tgl_kontrak_nya_, jumlahKPTLS_, refid_buku_induk_, uid_, menambah_aset_, menambah_manfaat_, asal_usulnya_, tgl_dokumen_sumber_nya_, no_dokumen_sumber_, refid_terima_, refid_penerimaan_det_, tgl_dokumen_sumber_nya_) ;

     END IF;

     SELECT COUNT(*) INTO JML_DATA_SELESAI_PEMELIHARAAN_ FROM pemeliharaan WHERE refid_terima=refid_terima_;
     SELECT COUNT(*) INTO JML_DATA_SELESAI_KPTLS_ FROM t_distribusi WHERE refid_terima=refid_terima_ AND sttemp='0';

     IF JML_DATA_SELESAI_PEMELIHARAAN_ < JML_DATA_SELESAI_KPTLS_ THEN
        SET hasil_ = CONCAT("NEXT", " ", JML_DATA_SELESAI_PEMELIHARAAN_);
     ELSE
        SET hasil_ = CONCAT("END", " ", JML_DATA_SELESAI_PEMELIHARAAN_);
     END IF;

  RETURN hasil_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_penerimaan_posting_v2`(`Id_PenDet_` int, `thn_bast_` char(4), `staset_` char(4),`a_` char(2), `a1_` char(2),`b_` char(2), `asal_usul_` char(2), `tgl_buku_` date,`JMLBRGNY_` int, `barang_sudah_proses_` int, `thn_anggaran_` char(4),`uid_` text, noreg_max_ int, sumber_dana_ text) RETURNS text CHARSET latin1
BEGIN

	DECLARE c1_, c_, d_, e_, e1_ text; 
    DECLARE f1_, f2_, f_, g_, h_, i_, j_ text; 
    DECLARE hasilstat_,hasilstat2_ text;
    DECLARE satuan_, noreg_baru_text_, bk_ur_, ck_ur_, dk_ur_, ket_barang_, keterangan_, nm_barangnya_, ambil_noreg_, Hasil_Distribusi_ text;
	DECLARE refid_terima_, jumlah_data_input_,jml_barang_dplh_, noreg_, refid_atribusi_, noreg_baru_, hit_bi int;
    DECLARE jml_barang_selesai_proses_, cek_harga_diBI_, ID_BI_barunya_, cntskpd_urusan_, barangdistribusi_, Id_Distribusi_, jumlah_total_input_BI_, jumlah_Barang_pendet_ int;
	DECLARE harga_beli_barang_,harga_atribusi_barang_, harga_satuan_, harga_atribusi_, harga_barang_satuan_dplh_, harga_totat_diBI_ DECIMAL(18,2);
    
    DECLARE harga_satuan_perolehan_, harga_satuan_perolehan_akhir_  DECIMAL(18,2);  
    DECLARE harga_beli_barang1_ , harga_atribusi_barang1_   DECIMAL(18,2);    
    DECLARE harga_beli_barang2_ , harga_atribusi_barang2_   DECIMAL(18,2);  
    DECLARE tgl_dok_sum_, tgl_kontraknya_,tgl_bukunya_  date;    
    DECLARE no_dokumen_sumber_, bk_, ck_, dk_, p_, q_, nomor_kontraknya_  text;    
    DECLARE hitungSelesai_ int;
	
	
	SELECT c1,c,d,e,e1,f1,f2,f,g,h,i,j, refid_terima, jml, satuan,ket_barang, keterangan, barangdistribusi, dat_hargabeli1, dat_hargabeli2, dat_atribusi1, dat_atribusi2 INTO c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, refid_terima_, jml_barang_dplh_, satuan_, ket_barang_, keterangan_, barangdistribusi_, harga_beli_barang1_, harga_beli_barang2_, harga_atribusi_barang1_, harga_atribusi_barang2_ FROM t_penerimaan_barang_det WHERE Id=Id_PenDet_;
	
    SET harga_satuan_perolehan_ = harga_beli_barang1_ + harga_atribusi_barang1_;    
    SET harga_satuan_perolehan_akhir_ = harga_beli_barang2_ + harga_atribusi_barang2_;    

    SELECT tgl_dokumen_sumber, no_dokumen_sumber, bk, ck, dk, p, q, nomor_kontrak, tgl_kontrak, tgl_buku INTO tgl_dok_sum_, no_dokumen_sumber_, bk_, ck_, dk_, p_, q_, nomor_kontraknya_, tgl_kontraknya_, tgl_bukunya_ FROM t_penerimaan_barang WHERE Id=refid_terima_;
      
    SET hasilstat_ = "NEXT";        
    SET harga_barang_satuan_dplh_ = 0;    
    SET hitungSelesai_ = 0;   

    WHILE barang_sudah_proses_ < JMLBRGNY_ DO	
    	
    	SELECT COUNT(*) as jml INTO jumlah_data_input_ FROM buku_induk WHERE refid_terima_det=Id_PenDet_ AND refid_terima=refid_terima_;    		
    	
    	IF jumlah_data_input_ + 1 > jml_barang_dplh_ THEN
    		SET hasilstat_ = "NEXT";    
            SET barang_sudah_proses_ = barang_sudah_proses_ + JMLBRGNY_;
    	ELSEIF barang_sudah_proses_ >= JMLBRGNY_ THEN
    		SET hasilstat_ = "LANJUT";
    	ELSE    
                
        IF barangdistribusi_ = 1 THEN        
           SET barangdistribusi_ = 1;           
           SELECT sf_penerimaan_posting_distribusi(Id_PenDet_, c1_, c_, d_, e_, e1_) INTO Hasil_Distribusi_; 
           
           SET e_ = SUBSTRING(Hasil_Distribusi_, 1,2);
           SET e1_ = SUBSTRING(Hasil_Distribusi_, 4,3);
           SET Id_Distribusi_ = SUBSTRING_INDEX(Hasil_Distribusi_, ' ', -1);           
        END IF;
    		
			SELECT nm_barang INTO nm_barangnya_ FROM ref_barang WHERE f1=f1_ AND f2=f2_ AND f=f_ AND g=g_ AND h=h_ AND i=i_ AND j=j_;
			     
            
            SELECT sf_penerimaan_posting_noreg(c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, thn_bast_,nm_barangnya_, noreg_max_) INTO ambil_noreg_ ;  
			SET j_=SUBSTRING(ambil_noreg_, 1,3);
			SET noreg_baru_text_ = SUBSTRING(ambil_noreg_,5);
				
    		
    		IF jumlah_data_input_ + 1 = jml_barang_dplh_ THEN
    			SET hasilstat_ = "LANJUT";
    			  
                SELECT COUNT(*) INTO cek_harga_diBI_ FROM buku_induk WHERE refid_terima_det = Id_PenDet_ AND harga = harga_satuan_perolehan_akhir_ ;                
                IF cek_harga_diBI_ = 0 THEN                
                   SET harga_barang_satuan_dplh_ = harga_satuan_perolehan_akhir_; 
                   SET harga_beli_barang_ = harga_beli_barang2_;
                   SET harga_atribusi_barang_ = harga_atribusi_barang2_;                                  
                ELSE    
                   SET harga_beli_barang_ = harga_beli_barang1_;
                   SET harga_atribusi_barang_ = harga_atribusi_barang1_;                  
                END IF;
                
    		ELSE
    			SET harga_barang_satuan_dplh_ = harga_satuan_perolehan_;    
                SET harga_beli_barang_ = harga_beli_barang1_;
                SET harga_atribusi_barang_ = harga_atribusi_barang1_;    
    			SET hasilstat_ = "OK";
    		END IF;
    		
    		
    		SELECT Id INTO refid_atribusi_ FROM t_atribusi WHERE refid_terima=refid_terima_ LIMIT 0,1;    

            
            SELECT bk, ck, dk, COUNT(*) INTO bk_ur_, ck_ur_, dk_ur_, cntskpd_urusan_ FROM ref_skpd_urusan WHERE c=c_ AND d=d_;            

            IF cntskpd_urusan_ <= 0 THEN             
               SET bk_ur_ = 0;               
               SET ck_ur_ = 0;               
               SET dk_ur_ = 0;
            
            END IF;
    				
    		
    		INSERT INTO buku_induk (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, thn_perolehan, jml_barang, satuan, harga, jml_harga, asal_usul, kondisi, status_barang, staset, tgl_buku, tahun, uid, harga_beli, harga_atribusi, ref_idatribusi, no_ba, tgl_ba, bk_p, ck_p, dk_p, p, q, refid_terima, refid_terima_det, bk,ck,dk, jns_hibah, no_spk, tgl_spk) values (a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_, thn_bast_, '1', satuan_, harga_barang_satuan_dplh_, harga_barang_satuan_dplh_, asal_usul_, '1', '1', staset_, tgl_bukunya_, thn_anggaran_, uid_, harga_beli_barang_, harga_atribusi_barang_, refid_atribusi_, no_dokumen_sumber_, tgl_dok_sum_, bk_, ck_, dk_, p_, q_, refid_terima_, Id_PenDet_, bk_ur_, ck_ur_, dk_ur_, sumber_dana_, nomor_kontraknya_, tgl_kontraknya_);
    		    
            
            SELECT id INTO ID_BI_barunya_ FROM buku_induk WHERE a1=a1_ AND a=a_ AND b=b_ AND c1=c1_ AND c=c_ AND d=d_ AND e=e_ AND e1=e1_ AND f1=f1_ AND f2=f2_ AND f=f_ AND g=g_ AND h=h_ AND i=i_ AND j=j_ AND noreg=noreg_baru_text_ AND thn_perolehan=thn_bast_ AND staset=staset_ AND refid_terima=refid_terima_ AND refid_terima_det=Id_PenDet_ AND uid=uid_ AND asal_usul=asal_usul_ ORDER BY id DESC;
            
            IF f_='01' THEN
               INSERT INTO kib_a (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, alamat, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);            
            ELSEIF f_='02' THEN            
               INSERT INTO kib_b (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, merk, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            ELSEIF f_='03' THEN            
               INSERT INTO kib_c (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, alamat, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            ELSEIF f_='04' THEN            
               INSERT INTO kib_d (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, alamat, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            ELSEIF f_='05' THEN            
               INSERT INTO kib_e (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, buku_judul, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            ELSEIF f_='06' THEN            
               INSERT INTO kib_f (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, alamat, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            ELSEIF f_='07' THEN            
               INSERT INTO kib_g (a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, noreg, uraian, ket, tahun, idbi) VALUES(a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, noreg_baru_text_,ket_barang_, keterangan_, thn_anggaran_, ID_BI_barunya_);
            END IF;
                        
            UPDATE buku_induk SET idawal=ID_BI_barunya_ WHERE id=ID_BI_barunya_; 
            
            SET hitungSelesai_ = hitungSelesai_+1;            

    		SET barang_sudah_proses_ = barang_sudah_proses_ + 1;    
    
    	END IF;	
    END WHILE;
        
    SELECT COUNT(*) INTO jml_barang_selesai_proses_ FROM buku_induk WHERE refid_terima=refid_terima_;
    
    SET hasilstat_ = CONCAT(hasilstat_," ",jml_barang_selesai_proses_, " ", harga_barang_satuan_dplh_, " ",hitungSelesai_);     

 RETURN hasilstat_; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), SUSUT_MODE_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN 
  declare cek_ longtext;
  declare thn_perolehan_ int(11);
      
  
  select thn_perolehan into thn_perolehan_ from buku_induk where id = idbi_;    


  if SUSUT_MODE_ = 2 then 
    select sf_susut_mode2(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_;    
  elseif SUSUT_MODE_ = 3 && thn_perolehan_ <= 2014 then 
    select sf_susut_mode3_thn(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_;     
  elseif SUSUT_MODE_ = 3 && thn_perolehan_ > 2014 then  
    select sf_susut_mode3_bln(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_;    
  elseif SUSUT_MODE_ = 4 then  
    select sf_susut_mode4(idbi_ , tgl_susut_ , uid_ , jns_trans2_ ,0)  into cek_;    
  elseif SUSUT_MODE_ = 5 then  
    select sf_susut_mode5(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_;    
  elseif SUSUT_MODE_ = 6 then  
    select sf_susut_mode6(idbi_ , tgl_susut_ , uid_ , jns_trans2_ ,0)  into cek_;    
  elseif SUSUT_MODE_ = 7 then  
    select sf_susut_mode7(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_;    
  elseif SUSUT_MODE_ = 8 then  
    select sf_susut_mode8(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_;    
  elseif SUSUT_MODE_ = 9 && thn_perolehan_ <= 2015 then  
    select sf_susut_mode9_bln(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_;        
    select sf_susut_mode9(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_;    
  elseif SUSUT_MODE_ = 9 && thn_perolehan_ > 2015 then  
    select sf_susut_mode9(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_;      
  elseif SUSUT_MODE_ = 10 then  
    select sf_susut_mode10(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_;    
  elseif SUSUT_MODE_ = 11 then  
    select sf_susut_mode11(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_;    
  elseif SUSUT_MODE_ = 12 then  
    select sf_susut_mode12(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_; 
  elseif SUSUT_MODE_ = 13 then  
    select sf_susut_mode13(idbi_ , tgl_susut_ , uid_ , jns_trans2_ , 0)  into cek_; 
  end if;

   

  return cek_;
end ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_get_periode_ak`(`tgl_` date, susut_mode_ int(11), idbi_ int(11)) RETURNS date
BEGIN
  declare tgl_periode_ak_ date;   
  declare tahun, bulan, tanggal int(2);  
  declare tahun_, bulan_, tanggal_ int(2);  
  declare thn_perolehan_ int(11);

  set tahun = year(tgl_);
  set bulan = month(tgl_);
  set tanggal = day(tgl_);

  
  select thn_perolehan into thn_perolehan_ from buku_induk where id = idbi_;    

  if (susut_mode_ = 3 && thn_perolehan_ > 2014) or susut_mode_ = 11 then 
      if bulan = 12 then      
          set tahun_ = tahun;
          set bulan_ = 6;
          set tanggal_ = DATE_FORMAT(LAST_DAY(concat(tahun,'-',bulan_,'-','30')),'%d');            
      else      
          set tahun_ = tahun-1;
          set bulan_ = 12;
          set tanggal_ = DATE_FORMAT(LAST_DAY(concat(tahun,'-',bulan_,'-','31')),'%d');
      end if;   
  elseif susut_mode_ = 8 or susut_mode_ = 4 then  
      if bulan = 12 then      
          set tahun_ = tahun;
          set bulan_ = 6;
          set tanggal_ = DATE_FORMAT(LAST_DAY(concat(tahun,'-',bulan_,'-','30')),'%d');            
      else      
          set tahun_ = tahun-1;
          set bulan_ = 12;
          set tanggal_ = DATE_FORMAT(LAST_DAY(concat(tahun,'-',bulan_,'-','31')),'%d');
      end if; 
  else  
      set tahun_ = tahun-1;
      set bulan_ = 12;
      set tanggal_ = 31;
  end if;

    

  set tgl_periode_ak_ = concat(tahun_,'-',bulan_,'-',tanggal_);
 
  RETURN tgl_periode_ak_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode10`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ INT(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  
  
  
         
  declare stop_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);   
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;  
  declare percen_pemelihaaan int;
  declare cek_, hasil_susut_ longtext;    
  declare tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;  
  set percen_pemelihaaan=0;
  
  set stop_ = 0;
  set cek_ = '';  
  set hasil_susut_ = 'gagal';  
      
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
      
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;
           
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
      if con_thn_mulai_susut_ is null then            
         set con_thn_mulai_susut_ = 0;
      end if;
      
      select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset  
        into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;        

      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = residu_bi_;         
      end if;
 
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 and id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
          
       while stop_ = 0 do
    
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > umur ekoknomis barang');
          end if; 
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
                            
         
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
          
          if akum_masa_manfaat_ = '' then 
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_ 
                and tambah_aset=1; 
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else       
              select ifnull(sum(biaya_pemeliharaan),0)
              into tot_rehab_aset_
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              
              
              if tot_rehab_aset_ <> 0 && (f_ = '03' or f_ = '04') then     
                    set percen_pemelihaaan=(tot_rehab_aset_/akum_stlh_susut_)*100;                
                set percen_pemelihaaan=if(percen_pemelihaaan is null,0,percen_pemelihaaan);            
                if percen_pemelihaaan > 50 then                            
                   set masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;              
                end if;
              end if;          
                                     
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0);  
              
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              
              if akum_stlh_susut_ <> 0 and (hrg_rehab_+akum_stlh_susut_) <= 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_ , 'stop karena hasil dari penambahan rehab ditambah nilai buku menjadi kurang dari 0');
              end if;
          end if;              
        
         if akum_masa_manfaat_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;           
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          if akum_masa_manfaat_ = ''  then      
              set sisa_masa_manfaat_=sisa_masa_manfaat_awl_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;     
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
          
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;  
          if stop_ = 0 then
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,bulan_awl, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,1, id_koreksi_);   
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;
                set hasil_susut_ = 'sukses';                                        
             end if;          
          end if;
      end while;
   else
       set cek_='idbi NULL';   
   end if;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode10_20170130`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  
  
         
  declare stop_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c_,d_,e_ char(2);   
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;  
  declare percen_pemelihaaan int;
  declare cek_ longtext;    

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;  
  set percen_pemelihaaan=0;
  
  set stop_ = 0;
  set cek_ = '';  
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset  
        into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     

      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 and id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       
       
       
        
       while stop_ = 0 do
    
       
       set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn mulai susut=',thn_mulai_susut_+masa_manfaat_tot_-1,' ',masa_manfaat_tot_);   
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > umur ekoknomis barang');
          end if; 
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  from penghapusan where year(tgl_penghapusan)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  select count(*) into jml_data_
                  from t_history_aset where year(tgl)=thn_susut_ak_ and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pindah aset');
                  end if;
                  
                  select count(*) into jml_data_
                  from gantirugi where year(tgl_gantirugi)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where year(tgl_pemindahtanganan)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn susut=',thn_mulai_susut_+masa_manfaat_tot_-1); 
                            
         
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
          
          
          
          
          
          
          select ifnull(sum(biaya_pemeliharaan),0)
          into tot_rehab_aset_
            from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1; 
          
          
          if tot_rehab_aset_ <> 0 && (f_ = '03' or f_ = '04') then          
            set percen_pemelihaaan=(tot_rehab_aset_/akum_stlh_susut_)*100;            
            if percen_pemelihaaan > 50 then            
                set masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;              
            end if;
            set cek_=concat(cek_,' | percen_pemelihaaan=',percen_pemelihaaan,' | tot_rehab_aset_=',tot_rehab_aset_,' | akum_stlh_susut_=',akum_stlh_susut_,'\n');                                  
          end if;          
                    
          
          
          
          
          
          
          
          
          
          
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
        
                    
         if akum_harga_susut_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if akum_harga_susut_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;     
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          
          if stop_ = 0 then
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,bulan_awl)
                   values
                   (tgl_susut_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,1);   
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             end if;          
          end if;
          set cek_=concat(cek_,' | stop=',stop_,'\n');     
          
          
       end while;
   else
       set cek_='idbi NULL';   
   end if;

  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode10_20170223`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  
  
  
         
  declare stop_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c_,d_,e_ char(2);   
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;  
  declare percen_pemelihaaan int;
  declare cek_ longtext;    

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;  
  set percen_pemelihaaan=0;
  
  set stop_ = 0;
  set cek_ = '';  
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    

           
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
      if con_thn_mulai_susut_ is null then            
         set con_thn_mulai_susut_ = 0;
      end if;
      
      select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset  
        into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     

      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 and id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       
       
       
                

            

       while stop_ = 0 do
    
       
       set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn mulai susut=',thn_mulai_susut_+masa_manfaat_tot_-1,' ',masa_manfaat_tot_);   
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > umur ekoknomis barang');
          end if; 
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  select count(*) into jml_data_
                  
                  from t_history_aset where (year(tgl)=thn_susut_ak_  or tgl_susut_>=tgl) and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pindah aset');
                  end if;
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn susut=',thn_mulai_susut_+masa_manfaat_tot_-1); 
                            
         
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
          
          
          
          
          
          
          select ifnull(sum(biaya_pemeliharaan),0)
          into tot_rehab_aset_
            from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_;
          
          
          if tot_rehab_aset_ <> 0 && (f_ = '03' or f_ = '04') then          
            set percen_pemelihaaan=(tot_rehab_aset_/akum_stlh_susut_)*100;
            set percen_pemelihaaan=if(percen_pemelihaaan is null,0,percen_pemelihaaan);            
            if akum_stlh_susut_ = 0 then 
               set masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_;                               
            elseif percen_pemelihaaan > 50 then                            
               set masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;              
            end if;
            set cek_=concat(cek_,' | percen_pemelihaaan=',percen_pemelihaaan,' | tot_rehab_aset_=',tot_rehab_aset_,' | akum_stlh_susut_=',akum_stlh_susut_,'\n');                                  
          end if;          
                    
          
          
          
          
          
          
          
          
          
          
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0);  
          
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
        
                    
         if akum_harga_susut_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if akum_harga_susut_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;     
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
          
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          
          if stop_ = 0 then
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,bulan_awl, id_koreksi_tambah)
                   values
                   (tgl_susut_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,1, id_koreksi_);   
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             end if;          
          end if;
          set cek_=concat(cek_,' | stop=',stop_,'\n');     
          
          
       end while;
   else
       set cek_='idbi NULL';   
   end if;

  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode11`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN 
   
  declare stop_, stat_ int;
  declare update_bi int; 
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, thn_ke_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_,cek_susut_thn_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int; 
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,5);
  declare nilai_buku_ decimal(18,5);  
  declare masa_manfaat_tot_, masa_manfaat_tot_bi_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,5);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,5);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,5);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,5);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,5);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,5);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_  decimal(18,5);  
  declare nilai_perolehan_ decimal(18,5); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,5);
  declare masa_manfaat_rehab_,masa_manfaat_rehab_susut_thn_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_,sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,5);   
  declare jml_data_,jml_data_cek_, cek_thn_susut_ak_ int;  
  declare jml_bln_ int;  
  
  declare cek_susut_first int;  
  declare cek_idlama_ int;  
  declare ket_ varchar(255);
  declare cek_, hasil_susut_ longtext; 
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_tot_bi_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_susut_thn_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set thn_ke_=1;
  set stop_ = 0;  
  set stat_ = 0;
  set cek_ = '';  
  set cek_susut_thn_=0;
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set ket_ = '';  
  set hasil_susut_ = 'gagal'; 
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_;  
 if idbi_awal_ is not NULL then   
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';  
      
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;             
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        from buku_induk where id = idbi_;    
    
     
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;    

       
      
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_buku_) <> 0 ,  month(tgl_buku_),month(tgl_ba_));      
      
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,stat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;        

      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
          
       
       
       
       
     
       
       if akum_masa_manfaat_ = '' then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);
       end if;   
          
    
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
       while stop_ = 0 do
          
      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
 
       
       
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
          
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);   
          
          
          

        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_) or tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;              
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
    
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
           
          
          if akum_masa_manfaat_ = '' then 
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) <= thn_susut_ak_*12+bln_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) <= thn_susut_ak_*12+bln_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) <= thn_susut_ak_*12+bln_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) <= thn_susut_ak_*12+bln_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) <= thn_susut_ak_*12+bln_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else
              select  ifnull(sum(biaya_pemeliharaan),0) 
              into tot_rehab_aset_
                from pemeliharaan where idbi_awal = idbi_awal_                 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1; 
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_                 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_;  
                        
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              if tot_rehab_aset_ <> 0 then 
                  if thn_susut_ak_ <=2015 then 
                    set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
                    set masa_manfaat_rehab_ = 0;
                  else
                    select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_aset_,nilai_perolehan_) into masa_manfaat_rehab_;          
                      if (masa_manfaat_rehab_*12+sisa_masa_manfaat_) > masa_manfaat_brg_*12 then
                         set masa_manfaat_rehab_ = masa_manfaat_brg_*12-sisa_masa_manfaat_+1;
                      else
                         set masa_manfaat_rehab_ = masa_manfaat_rehab_*12;                
                      end if;      
                    set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
                  end if;
              end if;  
              
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_                 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_                 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_                 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_                 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          end if;                  
        
        
        if akum_masa_manfaat_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;                            
    
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          
          
          
          
          
          
              set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
              set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
              
              set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/12); 
          
    
    
          
    
          
          
          if akum_masa_manfaat_ = '' then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ <= 1 && penambahan_hrg_rehab_ <> 0 && penambahan_masa_manfaat_rehab_ = 0 then           
             set sisa_masa_manfaat_ = 1;
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;       
    
          
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;            
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_; 
           
    
          
    
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and (bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1 and thn_susut_ak_<=thn_tgl_susut_) or jml_data_cek_ > 0) then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then      
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and (bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1 and thn_susut_ak_<=thn_tgl_susut_) or jml_data_cek_ > 0) then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;
        end if;
        
               
        
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
               
          set update_bi = 1;
           
                
         select ifnull(stat,0) into cek_susut_thn_
         from penyusutan where idbi = idbi_ and stat=1 limit 0,1;        
         
         
         select sum(masa_manfaat) into masa_manfaat_tot_bi_
         from penyusutan where idbi = idbi_;  
     
         if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=if(cek_susut_thn_=1,masa_manfaat_tot_bi_,masa_manfaat_tot_/12), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;
            set hasil_susut_ = 'sukses';                             
         end if;
 
          set bln_susut_ak_=bln_susut_ak_+1;
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
             
             set thn_ke_=thn_ke_+1;
          end if; 
          
          
                
          
       end while;                    
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;   
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode11_20171207`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN 
   
  declare stop_, stat_ int;
  declare update_bi int; 
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, thn_ke_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_,cek_susut_thn_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int; 
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,5);
  declare nilai_buku_ decimal(18,5);  
  declare masa_manfaat_tot_, masa_manfaat_tot_bi_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,5);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,5);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,5);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,5);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,5);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,5);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_  decimal(18,5);  
  declare nilai_perolehan_ decimal(18,5); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,5);
  declare masa_manfaat_rehab_,masa_manfaat_rehab_susut_thn_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_,sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,5);   
  declare jml_data_,jml_data_cek_, cek_thn_susut_ak_ int;  
  declare jml_bln_ int;  
  
  declare cek_susut_first int;  
  declare cek_idlama_ int;  
  declare ket_ varchar(255);
  declare cek_, hasil_susut_ longtext; 
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_tot_bi_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_susut_thn_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set thn_ke_=1;
  set stop_ = 0;  
  set stat_ = 0;
  set cek_ = '';  
  set cek_susut_thn_=0;
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set ket_ = '';  
  set hasil_susut_ = 'gagal'; 
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_;  
 if idbi_awal_ is not NULL then   
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';  
      
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;             
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        from buku_induk where id = idbi_;    
    
     
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;    

       
      
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_buku_) <> 0 ,  month(tgl_buku_),month(tgl_ba_));
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,stat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;        

      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
          
       
       
       
       
     
       
       if akum_masa_manfaat_ = '' then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_awl_/12;
             set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set thn_ke_=thn_ke_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;
           end if;       
           if stat_ = 1 then
             
    
             set penambahan_masa_manfaat_rehab_prev_ = 0;         
             set masa_manfaat_=(sisa_masa_manfaat_-1)*12;
             set penambahan_masa_manfaat_prev_ = masa_manfaat_;  
             set masa_manfaat_tot_ =masa_manfaat_;  
             set sisa_masa_manfaat_ = masa_manfaat_;       
             set thn_mulai_susut_ = thn_susut_ak_;
             set bln_mulai_susut_ = 1;          
           else       
             
             select tahun into cek_thn_susut_ak_
             from penyusutan where idbi = idbi_ and stat=1 order by id DESC limit 0,1;  
             
             if cek_thn_susut_ak_ is not null then
             
    
              
              select sum(ifnull(masa_manfaat_rehab,0)),((sisa_masa_manfaat_thn+sum(ifnull(masa_manfaat_rehab,0)))*12), sisa_masa_manfaat_thn*12
                into penambahan_masa_manfaat_rehab_prev_,penambahan_masa_manfaat_prev_,masa_manfaat_ 
                from penyusutan where idbi = idbi_ and stat=2 order by Id ASC;            
    
                 set penambahan_masa_manfaat_rehab_prev_ = penambahan_masa_manfaat_rehab_prev_*12;         
                 set masa_manfaat_tot_ =penambahan_masa_manfaat_prev_;
                 
                 
                 
                          
                   
                 set thn_mulai_susut_ = cek_thn_susut_ak_+1;
                 set bln_mulai_susut_ = 1;
                 
                 
             else        
                 set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
                 set masa_manfaat_ =  if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);     
             end if;     
                 
                 
           end if;       
       end if;   
          
    
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
       while stop_ = 0 do
          
      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
 
       
       
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
          
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);   
          
          
          

        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_) or tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;              
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
    
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
           
              select  ifnull(sum(biaya_pemeliharaan),0) 
              into tot_rehab_aset_
                from pemeliharaan where idbi_awal = idbi_awal_                 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1; 
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_                 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_;  
                        
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              if thn_susut_ak_ <=2015 then 
                set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
                set masa_manfaat_rehab_ = 0;
              else
                select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_aset_,nilai_perolehan_) into masa_manfaat_rehab_;          
                set masa_manfaat_rehab_ = masa_manfaat_rehab_*12;      
                set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
                set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              end if;
              
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_                 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_                 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_                 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_                 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
                    
        
        
        if akum_masa_manfaat_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;                            
    
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          
          
          
          
          
          
              set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
              set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
              
              set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/12); 
          
    
    
          
    
          
          
          if akum_masa_manfaat_ = '' then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ <= 1 && penambahan_hrg_rehab_ <> 0 && penambahan_masa_manfaat_rehab_ = 0 then           
             set sisa_masa_manfaat_ = 1;
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;       
    
          
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;            
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_; 
           
    
          
    
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and (bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0) then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then      
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and (bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0) then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;
        end if;
        
               
        
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
               
          set update_bi = 1;
           
                
         select ifnull(stat,0) into cek_susut_thn_
         from penyusutan where idbi = idbi_ and stat=1 limit 0,1;        
         
         
         select sum(masa_manfaat) into masa_manfaat_tot_bi_
         from penyusutan where idbi = idbi_;  
     
         if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=if(cek_susut_thn_=1,masa_manfaat_tot_bi_,masa_manfaat_tot_/12), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;
            set hasil_susut_ = 'sukses';                             
         end if;
 
          set bln_susut_ak_=bln_susut_ak_+1;
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
             
             set thn_ke_=thn_ke_+1;
          end if; 
          
          
                
          
       end while;                    
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;   
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode11_20180108`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN 
   
  declare stop_, stat_ int;
  declare update_bi int; 
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, thn_ke_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_,cek_susut_thn_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int; 
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,5);
  declare nilai_buku_ decimal(18,5);  
  declare masa_manfaat_tot_, masa_manfaat_tot_bi_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,5);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,5);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,5);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,5);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,5);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,5);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_  decimal(18,5);  
  declare nilai_perolehan_ decimal(18,5); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,5);
  declare masa_manfaat_rehab_,masa_manfaat_rehab_susut_thn_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_,sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,5);   
  declare jml_data_,jml_data_cek_, cek_thn_susut_ak_ int;  
  declare jml_bln_ int;  
  
  declare cek_susut_first int;  
  declare cek_idlama_ int;  
  declare ket_ varchar(255);
  declare cek_, hasil_susut_ longtext; 
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_tot_bi_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_susut_thn_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set thn_ke_=1;
  set stop_ = 0;  
  set stat_ = 0;
  set cek_ = '';  
  set cek_susut_thn_=0;
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set ket_ = '';  
  set hasil_susut_ = 'gagal'; 
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_;  
 if idbi_awal_ is not NULL then   
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';  
      
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;             
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        from buku_induk where id = idbi_;    
    
     
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;    

       
      
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_buku_) <> 0 ,  month(tgl_buku_),month(tgl_ba_));
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,stat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;        

      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
          
       
       
       
       
     
       
       if akum_masa_manfaat_ = '' then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_awl_/12;
             set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set thn_ke_=thn_ke_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;
           end if;       
           if stat_ = 1 then
             
    
             set penambahan_masa_manfaat_rehab_prev_ = 0;         
             set masa_manfaat_=(sisa_masa_manfaat_-1)*12;
             set penambahan_masa_manfaat_prev_ = masa_manfaat_;  
             set masa_manfaat_tot_ =masa_manfaat_;  
             set sisa_masa_manfaat_ = masa_manfaat_;       
             set thn_mulai_susut_ = thn_susut_ak_;
             set bln_mulai_susut_ = 1;          
           else       
             
             select tahun into cek_thn_susut_ak_
             from penyusutan where idbi = idbi_ and stat=1 order by id DESC limit 0,1;  
             
             if cek_thn_susut_ak_ is not null then
             
    
              
              select sum(ifnull(masa_manfaat_rehab,0)),((sisa_masa_manfaat_thn+sum(ifnull(masa_manfaat_rehab,0)))*12), sisa_masa_manfaat_thn*12
                into penambahan_masa_manfaat_rehab_prev_,penambahan_masa_manfaat_prev_,masa_manfaat_ 
                from penyusutan where idbi = idbi_ and stat=2 order by Id ASC;            
    
                 set penambahan_masa_manfaat_rehab_prev_ = penambahan_masa_manfaat_rehab_prev_*12;         
                 set masa_manfaat_tot_ =penambahan_masa_manfaat_prev_;
                 
                 
                 
                          
                   
                 set thn_mulai_susut_ = cek_thn_susut_ak_+1;
                 set bln_mulai_susut_ = 1;
                 
                 
             else        
                 set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
                 set masa_manfaat_ =  if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);     
             end if;     
                 
                 
           end if;       
       end if;   
          
    
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
       while stop_ = 0 do
          
      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
 
       
       
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
          
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);   
          
          
          

        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_) or tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;              
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
    
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
           
              select  ifnull(sum(biaya_pemeliharaan),0) 
              into tot_rehab_aset_
                from pemeliharaan where idbi_awal = idbi_awal_                 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1; 
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_                 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_;  
                        
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              if thn_susut_ak_ <=2015 then 
                set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
                set masa_manfaat_rehab_ = 0;
              else
                select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_aset_,nilai_perolehan_) into masa_manfaat_rehab_;          
                set masa_manfaat_rehab_ = masa_manfaat_rehab_*12;      
                set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
                set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              end if;
              
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_                 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_                 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_                 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_                 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
                    
        
        
        if akum_masa_manfaat_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;                            
    
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          
          
          
          
          
          
              set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
              set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
              
              set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/12); 
          
    
    
          
    
          
          
          if akum_masa_manfaat_ = '' then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ <= 1 && penambahan_hrg_rehab_ <> 0 && penambahan_masa_manfaat_rehab_ = 0 then           
             set sisa_masa_manfaat_ = 1;
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;       
    
          
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;            
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_; 
           
    
          
    
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and (bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0) then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then      
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and (bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0) then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;
        end if;
        
               
        
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
               
          set update_bi = 1;
           
                
         select ifnull(stat,0) into cek_susut_thn_
         from penyusutan where idbi = idbi_ and stat=1 limit 0,1;        
         
         
         select sum(masa_manfaat) into masa_manfaat_tot_bi_
         from penyusutan where idbi = idbi_;  
     
         if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=if(cek_susut_thn_=1,masa_manfaat_tot_bi_,masa_manfaat_tot_/12), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;
            set hasil_susut_ = 'sukses';                             
         end if;
 
          set bln_susut_ak_=bln_susut_ak_+1;
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
             
             set thn_ke_=thn_ke_+1;
          end if; 
          
          
                
          
       end while;                    
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;   
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode11_20180219`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN 
   
  declare stop_, stat_ int;
  declare update_bi int; 
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, thn_ke_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_,cek_susut_thn_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int; 
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,5);
  declare nilai_buku_ decimal(18,5);  
  declare masa_manfaat_tot_, masa_manfaat_tot_bi_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,5);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,5);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,5);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,5);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,5);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,5);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_  decimal(18,5);  
  declare nilai_perolehan_ decimal(18,5); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,5);
  declare masa_manfaat_rehab_,masa_manfaat_rehab_susut_thn_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_,sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,5);   
  declare jml_data_,jml_data_cek_, cek_thn_susut_ak_ int;  
  declare jml_bln_ int;  
  
  declare cek_susut_first int;  
  declare cek_idlama_ int;  
  declare ket_ varchar(255);
  declare cek_, hasil_susut_ longtext; 
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_tot_bi_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_susut_thn_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set thn_ke_=1;
  set stop_ = 0;  
  set stat_ = 0;
  set cek_ = '';  
  set cek_susut_thn_=0;
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set ket_ = '';  
  set hasil_susut_ = 'gagal'; 
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_;  
 if idbi_awal_ is not NULL then   
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';  
      
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;             
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        from buku_induk where id = idbi_;    
    
     
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;    

       
      
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_ba_) <> 0 ,  month(tgl_ba_),month(tgl_buku_));
      
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,stat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;        

      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
          
       
       
       
       
     
       
       if akum_masa_manfaat_ = '' then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);
       end if;   
          
    
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
       while stop_ = 0 do
          
      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
 
       
       
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
          
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);   
          
          
          

        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_) or tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;              
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
    
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
           
          
          if akum_masa_manfaat_ = '' then 
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) <= thn_susut_ak_*12+bln_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) <= thn_susut_ak_*12+bln_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) <= thn_susut_ak_*12+bln_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) <= thn_susut_ak_*12+bln_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) <= thn_susut_ak_*12+bln_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else
              select  ifnull(sum(biaya_pemeliharaan),0) 
              into tot_rehab_aset_
                from pemeliharaan where idbi_awal = idbi_awal_                 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1; 
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_                 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_;  
                        
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              if tot_rehab_aset_ <> 0 then 
                  if thn_susut_ak_ <=2015 then 
                    set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
                    set masa_manfaat_rehab_ = 0;
                  else
                    select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_aset_,nilai_perolehan_) into masa_manfaat_rehab_;          
                      if (masa_manfaat_rehab_*12+sisa_masa_manfaat_) > masa_manfaat_brg_*12 then
                         set masa_manfaat_rehab_ = masa_manfaat_brg_*12-sisa_masa_manfaat_+1;
                      else
                         set masa_manfaat_rehab_ = masa_manfaat_rehab_*12;                
                      end if;      
                    set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
                  end if;
              end if;  
              
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_                 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_                 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_                 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_                 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          end if;                  
        
        
        if akum_masa_manfaat_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;                            
    
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          
          
          
          
          
          
              set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
              set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
              
              set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/12); 
          
    
    
          
    
          
          
          if akum_masa_manfaat_ = '' then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ <= 1 && penambahan_hrg_rehab_ <> 0 && penambahan_masa_manfaat_rehab_ = 0 then           
             set sisa_masa_manfaat_ = 1;
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;       
    
          
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;            
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_; 
           
    
          
    
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and (bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1 and thn_susut_ak_<=thn_tgl_susut_) or jml_data_cek_ > 0) then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then      
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and (bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1 and thn_susut_ak_<=thn_tgl_susut_) or jml_data_cek_ > 0) then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;
        end if;
        
               
        
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
               
          set update_bi = 1;
           
                
         select ifnull(stat,0) into cek_susut_thn_
         from penyusutan where idbi = idbi_ and stat=1 limit 0,1;        
         
         
         select sum(masa_manfaat) into masa_manfaat_tot_bi_
         from penyusutan where idbi = idbi_;  
     
         if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=if(cek_susut_thn_=1,masa_manfaat_tot_bi_,masa_manfaat_tot_/12), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;
            set hasil_susut_ = 'sukses';                             
         end if;
 
          set bln_susut_ak_=bln_susut_ak_+1;
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
             
             set thn_ke_=thn_ke_+1;
          end if; 
          
          
                
          
       end while;                    
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;   
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode12`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11),  id_koreksi_ INT(11) ) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    
 
  
  
  declare stop_, kondisi_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_, hasil_susut_ longtext;    
  declare tgl_susut2_ , tgl_koreksi_ date;  

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;
  
  set stop_ = 0;
  set cek_ = '';    
  set hasil_susut_ = 'gagal';  
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    
    if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select kondisi, ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into kondisi_, masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = if(residu_brg_ is null, 0, residu_brg_);   
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = if(residu_brg_ is null, 0, residu_brg_);        
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ AND id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ AND id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
                  
       while stop_ = 0 do   
         
          if stop_ = 0 && kondisi_ = 3 then       
             set stop_ = 1 ;         
             set cek_ = concat(cek_ , 'stop karena rusak berat ');
          end if;  
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');
          end if; 
          if stop_ = 0 then 
               if thn_susut_ak_<=thn_tgl_susut_ then 
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
                            
         
         

          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else       
             set tgl_susut2_ = tgl_susut_;
          end if;  

          
         if akum_masa_manfaat_ = '' then
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_ 
                and tambah_aset=1; 
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else             
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
              
              into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 and year(tgl_pemeliharaan)<=year(tgl_susut2_); 
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1 and year(tgl_pemeliharaan)<=year(tgl_susut2_);  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              
              select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
              if (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_ THEN          
    			  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;
              else          
                  SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
              end if; 
        
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 and year(tgl_pengamanan)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and year(tgl_penghapusan)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_  and year(tgl)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and year(tgl_penilaian)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
          end if;                    
        
          if akum_masa_manfaat_ = ''  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          if akum_masa_manfaat_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
      
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
          
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             
          if stop_ = 0 then          
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else       
             set tgl_susut2_ = tgl_susut_;
          end if;  
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_, id_koreksi_);   
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             set hasil_susut_ = 'sukses';   
             end if;          
          end if;
        end while;
   else
       set cek_='idbi NULL';   
   end if;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode12_bck`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11),  id_koreksi_ INT(11) ) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    
 
  
  
  declare stop_, kondisi_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_ longtext;    
  declare tgl_susut2_ , tgl_koreksi_ date;  

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;
  
  set stop_ = 0;
  set cek_ = '';    

    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    
    if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select kondisi, ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into kondisi_, masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     





      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ AND id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ AND id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       
       
       
        
       while stop_ = 0 do
    
       
       set cek_=concat(cek_,thn_tgl_susut_,'thn susut ak=',thn_susut_ak_,'thn mulai susut=',thn_mulai_susut_+masa_manfaat_tot_-1,'masa_manfaat=',masa_manfaat_tot_);   
          
          if stop_ = 0 && kondisi_ = 3 then       
             set stop_ = 1 ;         
             set cek_ = concat(cek_ , 'stop karena rusak berat ');
          end if;  
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');
          end if; 
          if stop_ = 0 then 
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  select count(*) into jml_data_
                  from t_history_aset where year(tgl)=thn_susut_ak_ and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pindah aset');
                  end if;
                  
                  select count(*) into jml_data_
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn susut=',thn_mulai_susut_+masa_manfaat_tot_-1); 
                            
         
         

          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else       
             set tgl_susut2_ = tgl_susut_;
          end if;  

                  SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                    FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                    and tgl_pemeliharaan <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014 
                    and tambah_aset=1; 
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                    FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                    and tgl_pengamanan <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                    FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                    and tgl_penghapusan <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                    FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                    and tgl <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                    FROM penilaian WHERE idbi_awal = idbi_awal_ 
                    and tgl_penilaian <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
                  SET masa_manfaat_rehab_ = 0;  
          
          
          
          
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_awal_ 
            and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 
            and tgl_pemeliharaan <= tgl_susut2_; 
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_awal_ 
            and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1 
            and year(tgl_pemeliharaan)<=year(tgl_susut2_);  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
          
          select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
          if (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_ THEN          
			  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;
          else          
              SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
          end if; 
    
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_awal_ 
            and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 
            and tgl_pengamanan <= tgl_susut2_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_awal_ 
            and year(tgl_perolehan)=thn_susut_ak_ 
            and tgl_penghapusan <= tgl_susut2_;
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_awal_ 
            and year(tgl_perolehan)=thn_susut_ak_  
            and tgl <= tgl_susut2_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_awal_ 
            and year(tgl_perolehan)=thn_susut_ak_  
            and tgl_penilaian <= tgl_susut2_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
        
                    
         if akum_masa_manfaat_ = 0  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if akum_masa_manfaat_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
  
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
          
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             
          if stop_ = 0 then          
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else       
             set tgl_susut2_ = tgl_susut_;
          end if;  
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_, id_koreksi_);   
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             end if;          
          end if;
          set cek_=concat(cek_,' | stop=',stop_,'\n');     
          
          
       end while;
   else
       set cek_='idbi NULL';   
   end if;

  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode13`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11),  id_koreksi_ INT(11) ) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    
 
  
  
  declare stop_, kondisi_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_, hasil_susut_ longtext;    
  declare tgl_susut2_ , tgl_koreksi_ date;  

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;
  
  set stop_ = 0;
  set cek_ = '';    
  set hasil_susut_ = 'gagal';  
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    
    if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;      

      
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select kondisi, ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into kondisi_, masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = if(residu_brg_ is null, 0, residu_brg_);   
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = if(residu_brg_ is null, 0, residu_brg_);        
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ AND id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ AND id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;  
        
       while stop_ = 0 do
    
          
          if stop_ = 0 && kondisi_ = 3 then       
             set stop_ = 1 ;         
             set cek_ = concat(cek_ , 'stop karena rusak berat ');
          end if;  
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');
          end if; 
          if stop_ = 0 then 
               if thn_susut_ak_<=thn_tgl_susut_ then 
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          
         

          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else       
             set tgl_susut2_ = tgl_susut_;
          end if;  

          
          if akum_masa_manfaat_ = '' then 
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_ 
                and tambah_aset=1; 
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else          
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
             into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 and year(tgl_pemeliharaan)<=year(tgl_susut2_); 
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1 and year(tgl_pemeliharaan)<=year(tgl_susut2_);  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              
              select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,akum_stlh_susut_) into masa_manfaat_rehab_;
              if (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_ THEN 
    			  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;
              else          
                  SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
              end if; 
        
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
       
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 and year(tgl_pengamanan)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and year(tgl_penghapusan)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_  and year(tgl)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
               
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and year(tgl_penilaian)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          end if; 
        
         if akum_masa_manfaat_ = ''  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          if akum_masa_manfaat_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
  
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
          
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             
          if stop_ = 0 then          
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else       
             set tgl_susut2_ = tgl_susut_;
          end if;  
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_, id_koreksi_);   
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             set hasil_susut_ = 'sukses';   
             end if;          
          end if;
       end while;
   else
       set cek_='idbi NULL';   
   end if;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode2`(idbi_ INT(11), tgl_susut_ DATE, uid_ VARCHAR(20), jns_trans2_ INT(11), id_koreksi_ INT(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  DECLARE stop_ INT;
  DECLARE update_bi, con_thn_mulai_susut_, thn_mulai_susut_ INT;  
  DECLARE thn_tgl_susut_, sem_tgl_susut_ INT;
  DECLARE masa_manfaat_awl_,masa_manfaat_, persen_residu_ INT;  
  DECLARE masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ INT;  
  DECLARE thn_susut_ak_,thn_ke_ INT;
  DECLARE cek_thn_susut_ INT; 
  DECLARE residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ INT;
  DECLARE tgl_buku_, tgl_ba_ DATE;  
  DECLARE masa_manfaat_brg_, residu_brg_ INT;  
  DECLARE jml_harga_bi_ DECIMAL(18,2);
  DECLARE nilai_buku_ DECIMAL(18,2);  
  DECLARE masa_manfaat_tot_ INT;  
  DECLARE harga_susut_ DECIMAL(18,2);
  DECLARE c_,d_,e_ CHAR(2);   
  DECLARE e1_ CHAR(3);
  DECLARE f_,g_,h_,i_ CHAR(2);  
  DECLARE j_ CHAR(3);
  DECLARE flama_,glama_,hlama_,ilama_ CHAR(2);  
  DECLARE jlama_ CHAR(3);  
  DECLARE staset_ INT;
  DECLARE penambahan_nilai_buku_, penambahan_hrg_rehab_ DECIMAL(18,2);
  DECLARE penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ INT;
  DECLARE penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ DECIMAL(18,2);
  DECLARE penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ INT;
  DECLARE tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ DECIMAL(18,2);  
  DECLARE nilai_perolehan_ DECIMAL(18,2); 
  DECLARE tot_manfaat_ INT;
  DECLARE hrg_rehab_ DECIMAL(18,2);
  DECLARE masa_manfaat_rehab_ INT;
  DECLARE sisa_masa_manfaat_,sisa_masa_manfaat_awl_ INT;  
  DECLARE akum_masa_manfaat_ INT;
  DECLARE akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ DECIMAL(18,2);   
  DECLARE jml_data_ INT;
  DECLARE cek_idlama_ INT;  
  DECLARE ket_ VARCHAR(255);
  DECLARE cek_, hasil_susut_ LONGTEXT;      
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  SET nilai_buku_ = 0;
  SET masa_manfaat_ = 0;
  SET masa_manfaat_tot_ = 0;
  SET masa_manfaat_awl_ = 0;
  SET masa_manfaat_rehab_ = 0;    
  SET persen_residu_ = 0;  
  SET con_thn_mulai_susut_ = 0;  
  SET thn_tgl_susut_ = YEAR(tgl_susut_);  
  SET sem_tgl_susut_ = 2;
  SET penambahan_nilai_buku_prev_ = 0;
  SET penambahan_hrg_rehab_prev_ = 0;
  SET penambahan_masa_manfaat_prev_ = 0;  
  SET penambahan_masa_manfaat_rehab_prev_ = 0;
  SET hrg_rehab_ = 0; 
  SET masa_manfaat_rehab_ = 0;    
  SET akum_nilai_buku_ = 0;
  SET akum_harga_susut_ = 0;  
  SET akum_stlh_susut_ = 0;
  SET akum_masa_manfaat_ = 0;  
  SET sisa_masa_manfaat_=0;  
  SET thn_ke_=1;
  
  SET stop_ = 0;
  SET cek_ = ''; 
  set ket_='';
  set hasil_susut_ = 'gagal';  
    
 
 SELECT idawal INTO idbi_awal_ FROM buku_induk WHERE id = idbi_; 
 IF idbi_awal_ IS NOT NULL THEN  
     
     
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;

     
      SELECT nilai INTO con_thn_mulai_susut_ FROM setting WHERE Id = 'THN_MULAI_SUSUT';        
    
      
      SELECT IFNULL(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, IF(bln_susut_ak > 6, 2,1) , idawal, staset  
        INTO masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        FROM buku_induk WHERE id = idbi_;    

     
      IF idbi_awal_ <> idbi_ THEN    
          
          IF idbi_lama_ IS NOT NULL THEN              
             
             SELECT COUNT(*) INTO cek_idlama_ FROM penyusutan WHERE idbi = idbi_lama_;
              IF cek_idlama_ > 0 THEN                 
                  SELECT tgl_ba, tgl_buku
                    INTO tgl_ba_, tgl_buku_
                    FROM buku_induk WHERE id = idbi_lama_;                    
              ELSE
                  SELECT f,g,h,i,j INTO flama_,glama_,hlama_,ilama_,jlama_ 
                    FROM buku_induk WHERE id = idbi_lama_;       
                  IF flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) THEN                                    
                      SET tgl_ba_=tgl_ba_;    
                      SET tgl_buku_=tgl_buku_;                                                  
                  ELSE
                      SELECT tgl_ba, tgl_buku
                        INTO tgl_ba_, tgl_buku_
                        FROM buku_induk WHERE id = idbi_lama_;  
                  END IF;    
              END IF;                         
          ELSE 
              SELECT tgl_ba, tgl_buku
                INTO tgl_ba_, tgl_buku_
                FROM buku_induk WHERE id = idbi_awal_;
          END IF;      
      END IF;    

       SET tgl_ba_ = IF(tgl_ba_ IS NULL, '0000-00-00', tgl_ba_);  
      
      
      SELECT masa_manfaat, residu INTO masa_manfaat_brg_, residu_brg_
        FROM  ref_barang WHERE f= f_ AND g=g_ AND h=h_ AND i= i_ AND j=j_;
    
      
      IF masa_manfaat_bi_ = NULL OR masa_manfaat_bi_ = 0 THEN  
         SET masa_manfaat_ = masa_manfaat_brg_;     
         SET persen_residu_ = residu_brg_;     
      ELSE   
         SET masa_manfaat_ = masa_manfaat_bi_;     
         SET persen_residu_ = residu_bi_;         
      END IF;
      
      
      SET thn_mulai_susut_ = IF( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      SET thn_susut_ak_ = IF( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     
      
      SELECT SUM(IFNULL(hrg_perolehan,0)), SUM(masa_manfaat)
        INTO penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        FROM penyusutan WHERE idbi = idbi_ AND id_koreksi=0;    
    
      
       SELECT (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        INTO thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        FROM penyusutan WHERE idbi = idbi_ AND id_koreksi=0 ORDER BY id DESC LIMIT 0,1;
    
      SET penambahan_nilai_buku_prev_ = IF(penambahan_nilai_buku_prev_ IS NULL, 0, penambahan_nilai_buku_prev_);  
      SET penambahan_hrg_rehab_prev_ = IF(penambahan_hrg_rehab_prev_ IS NULL, 0, penambahan_hrg_rehab_prev_);  
      SET penambahan_masa_manfaat_prev_ = IF(penambahan_masa_manfaat_prev_ IS NULL, 0, penambahan_masa_manfaat_prev_);  
      SET penambahan_masa_manfaat_rehab_prev_ = IF(penambahan_masa_manfaat_rehab_prev_ IS NULL, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       SET masa_manfaat_tot_ = IF(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       SET nilai_buku_ = IF(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       SET masa_manfaat_ = masa_manfaat_tot_;
       SET sisa_masa_manfaat_awl_=masa_manfaat_;   
        
       WHILE stop_ = 0 DO
    
          
          IF stop_ = 0 && masa_manfaat_ <= 0 THEN  
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena masa manfaat belum di set ');
          ELSEIF stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ THEN  
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          ELSEIF stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal susut > umur ekoknomis barang');              
          ELSEIF stop_ = 0 && tgl_buku_ > tgl_susut_ THEN
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal buku > tanggl periode penyusutan');                                   
          END IF; 
          IF stop_ = 0 THEN
               IF thn_susut_ak_<=thn_tgl_susut_ THEN 
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM penghapusan WHERE YEAR(tgl_penghapusan)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_,'stop karena penghapusan');
                  END IF;        
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM t_history_aset WHERE YEAR(tgl)=thn_susut_ak_ AND (staset_baru=9 OR staset_baru=10) AND idbi = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena pindah aset');
                  END IF;
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM gantirugi WHERE YEAR(tgl_gantirugi)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena ganti rugi');
                  END IF;          
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM pemindahtanganan WHERE YEAR(tgl_pemindahtanganan)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena pemindahtanganan');
                  END IF;              
               END IF;
          END IF;
                            
         
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
           
          if akum_masa_manfaat_ = '' then 
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_ 
                and tambah_aset=1; 
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else       
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
              
              into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_  
                and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1;  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
             if tot_rehab_manfaat_ <> 0 then
                  if thn_susut_ak_= 2015 or akum_masa_manfaat_ = '' then               
                     set masa_manfaat_rehab_ = 0;
                  elseif akum_stlh_susut_ = 0 then               
                     
                     select masa_manfaat into masa_manfaat_rehab_ from ref_tambah_manfaat
                     where CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and CAST(h AS UNSIGNED)=h_ and (i='00' or i is null) and (j='000' or j is null)
                     ORDER by persen2 DESC limit 0,1 ;
                     set ket_ = concat(ket_, 'penambahan masamanfaat diambil persentase terbesar \n' );                                    
                  else
                      select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,akum_stlh_susut_) into masa_manfaat_rehab_;
                      if (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_ THEN          
            			  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;
                          set ket_ = concat(ket_, 'penambahan ' ,masa_manfaat_rehab_,' melebihi masa manfaat awal. \n' );   
                      else          
                          SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
                      end if;           
                  end if;    
              end if;    
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);               
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          end if;                    
        
                
         IF akum_masa_manfaat_ = 0  THEN       
              
              SET nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              SET masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          ELSE          
              
              SET nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              SET masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          END IF; 
          
          
          SET penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          SET penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          SET penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          SET penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          IF akum_masa_manfaat_ = ''  THEN      
             SET sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          ELSEIF sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 THEN          
             SET sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          ELSEIF sisa_masa_manfaat_ = 0 THEN          
             SET sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          ELSE
            SET sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          END IF;     
    
          
          SET akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          SET harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);           
          SET akum_harga_susut_=akum_harga_susut_+harga_susut_;
          SET akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_;           
          IF stop_ = 0 THEN          
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
              
              INSERT INTO penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   VALUES
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, NOW(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);   
                   
             SET penambahan_nilai_buku_prev_ = nilai_buku_;         
             SET penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             SET penambahan_hrg_rehab_prev_ = hrg_rehab_;
             SET penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             SET update_bi = 1;
             SET thn_susut_ak_ = thn_susut_ak_+1;         
             SET ket_ = "";
             
             SET thn_ke_=thn_ke_+1;
                
             IF update_bi =1 THEN     
                UPDATE buku_induk SET masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 WHERE id=idbi_;
                set hasil_susut_ = 'sukses';                      
             END IF;          
          END IF;
       END WHILE;
   ELSE
       SET cek_='idbi NULL';   
   END IF;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode2_20170413`(idbi_ INT(11), tgl_susut_ DATE, uid_ VARCHAR(20), jns_trans2_ INT(11), id_koreksi_ INT(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  DECLARE stop_ INT;
  DECLARE update_bi, con_thn_mulai_susut_, thn_mulai_susut_ INT;  
  DECLARE thn_tgl_susut_, sem_tgl_susut_ INT;
  DECLARE masa_manfaat_awl_,masa_manfaat_, persen_residu_ INT;  
  DECLARE masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ INT;  
  DECLARE thn_susut_ak_,thn_ke_ INT;
  DECLARE cek_thn_susut_ INT;
  DECLARE residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ INT;
  DECLARE tgl_buku_, tgl_ba_ DATE;  
  DECLARE masa_manfaat_brg_, residu_brg_ INT;  
  DECLARE jml_harga_bi_ DECIMAL(18,2);
  DECLARE nilai_buku_ DECIMAL(18,2);  
  DECLARE masa_manfaat_tot_ INT;  
  DECLARE harga_susut_ DECIMAL(18,2);
  DECLARE c_,d_,e_ CHAR(2);   
  DECLARE e1_ CHAR(3);
  DECLARE f_,g_,h_,i_ CHAR(2);  
  DECLARE j_ CHAR(3);
  DECLARE flama_,glama_,hlama_,ilama_ CHAR(2);  
  DECLARE jlama_ CHAR(3);  
  DECLARE staset_ INT;
  DECLARE penambahan_nilai_buku_, penambahan_hrg_rehab_ DECIMAL(18,2);
  DECLARE penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ INT;
  DECLARE penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ DECIMAL(18,2);
  DECLARE penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ INT;
  DECLARE tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ DECIMAL(18,2);  
  DECLARE nilai_perolehan_ DECIMAL(18,2); 
  DECLARE tot_manfaat_ INT;
  DECLARE hrg_rehab_ DECIMAL(18,2);
  DECLARE masa_manfaat_rehab_ INT;
  DECLARE sisa_masa_manfaat_,sisa_masa_manfaat_awl_ INT;  
  DECLARE akum_masa_manfaat_ INT;
  DECLARE akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ DECIMAL(18,2);   
  DECLARE jml_data_ INT;
  DECLARE cek_idlama_ INT;  
  DECLARE ket_ VARCHAR(255);
  DECLARE cek_ LONGTEXT;      
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  SET nilai_buku_ = 0;
  SET masa_manfaat_ = 0;
  SET masa_manfaat_tot_ = 0;
  SET masa_manfaat_awl_ = 0;
  SET masa_manfaat_rehab_ = 0;    
  SET persen_residu_ = 0;  
  SET con_thn_mulai_susut_ = 0;  
  SET thn_tgl_susut_ = YEAR(tgl_susut_);  
  SET sem_tgl_susut_ = 2;
  SET penambahan_nilai_buku_prev_ = 0;
  SET penambahan_hrg_rehab_prev_ = 0;
  SET penambahan_masa_manfaat_prev_ = 0;  
  SET penambahan_masa_manfaat_rehab_prev_ = 0;
  SET hrg_rehab_ = 0; 
  SET masa_manfaat_rehab_ = 0;    
  SET akum_nilai_buku_ = 0;
  SET akum_harga_susut_ = 0;  
  SET akum_stlh_susut_ = 0;
  SET akum_masa_manfaat_ = 0;  
  SET sisa_masa_manfaat_=0;  
  SET thn_ke_=1;
  
  SET stop_ = 0;
  SET cek_ = '';  
    
 
 SELECT idawal INTO idbi_awal_ FROM buku_induk WHERE id = idbi_; 
 IF idbi_awal_ IS NOT NULL THEN  
    

      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;

     
      SELECT nilai INTO con_thn_mulai_susut_ FROM setting WHERE Id = 'THN_MULAI_SUSUT';        
    
      
      SELECT IFNULL(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, IF(bln_susut_ak > 6, 2,1) , idawal, staset  
        INTO masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        FROM buku_induk WHERE id = idbi_;    

     
      IF idbi_awal_ <> idbi_ THEN    
          
          IF idbi_lama_ IS NOT NULL THEN              
             
             SELECT COUNT(*) INTO cek_idlama_ FROM penyusutan WHERE idbi = idbi_lama_;
              IF cek_idlama_ > 0 THEN                 
                  SELECT tgl_ba, tgl_buku
                    INTO tgl_ba_, tgl_buku_
                    FROM buku_induk WHERE id = idbi_lama_;                    
              ELSE
                  SELECT f,g,h,i,j INTO flama_,glama_,hlama_,ilama_,jlama_ 
                    FROM buku_induk WHERE id = idbi_lama_;       
                  IF flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) THEN                                    
                      SET tgl_ba_=tgl_ba_;    
                      SET tgl_buku_=tgl_buku_;                                                  
                  ELSE
                      SELECT tgl_ba, tgl_buku
                        INTO tgl_ba_, tgl_buku_
                        FROM buku_induk WHERE id = idbi_lama_;  
                  END IF;    
              END IF;                         
          ELSE 
              SELECT tgl_ba, tgl_buku
                INTO tgl_ba_, tgl_buku_
                FROM buku_induk WHERE id = idbi_awal_;
          END IF;      
      END IF;    

       SET tgl_ba_ = IF(tgl_ba_ IS NULL, '0000-00-00', tgl_ba_);  
      SET cek_=CONCAT(cek_,'tgl_ba_=',tgl_ba_,' | tgl_buku_=',tgl_buku_);
      
      
      SELECT masa_manfaat, residu INTO masa_manfaat_brg_, residu_brg_
        FROM  ref_barang WHERE f= f_ AND g=g_ AND h=h_ AND i= i_ AND j=j_;
    
      
      IF masa_manfaat_bi_ = NULL OR masa_manfaat_bi_ = 0 THEN  
         SET masa_manfaat_ = masa_manfaat_brg_;     
         SET persen_residu_ = residu_brg_;     
      ELSE   
         SET masa_manfaat_ = masa_manfaat_bi_;     
         SET persen_residu_ = residu_bi_;         
      END IF;
      
      
      SET thn_mulai_susut_ = IF( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      SET thn_susut_ak_ = IF( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     




      
      SELECT SUM(IFNULL(hrg_perolehan,0)), SUM(masa_manfaat)
        INTO penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        FROM penyusutan WHERE idbi = idbi_ AND id_koreksi=0;    
    
      
       SELECT (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        INTO thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        FROM penyusutan WHERE idbi = idbi_ AND id_koreksi=0 ORDER BY id DESC LIMIT 0,1;
    
      SET penambahan_nilai_buku_prev_ = IF(penambahan_nilai_buku_prev_ IS NULL, 0, penambahan_nilai_buku_prev_);  
      SET penambahan_hrg_rehab_prev_ = IF(penambahan_hrg_rehab_prev_ IS NULL, 0, penambahan_hrg_rehab_prev_);  
      SET penambahan_masa_manfaat_prev_ = IF(penambahan_masa_manfaat_prev_ IS NULL, 0, penambahan_masa_manfaat_prev_);  
      SET penambahan_masa_manfaat_rehab_prev_ = IF(penambahan_masa_manfaat_rehab_prev_ IS NULL, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       SET masa_manfaat_tot_ = IF(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       SET nilai_buku_ = IF(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       SET masa_manfaat_ = masa_manfaat_tot_;
       SET sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       
       
       
        
       WHILE stop_ = 0 DO
    
       
       SET cek_=CONCAT(cek_,'thn susut ak=',thn_susut_ak_,'thn mulai susut=',thn_mulai_susut_+masa_manfaat_tot_-1,' ',masa_manfaat_tot_);   
          
          IF stop_ = 0 && masa_manfaat_ <= 0 THEN  
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena masa manfaat belum di set ');
          ELSEIF stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ THEN  
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          ELSEIF stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal susut > umur ekoknomis barang');
          END IF; 
          IF stop_ = 0 THEN
               IF thn_susut_ak_<=thn_tgl_susut_ THEN 
               
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM penghapusan WHERE YEAR(tgl_penghapusan)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_,'stop karena penghapusan');
                  END IF;        
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM t_history_aset WHERE YEAR(tgl)=thn_susut_ak_ AND (staset_baru=9 OR staset_baru=10) AND idbi = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena pindah aset');
                  END IF;
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM gantirugi WHERE YEAR(tgl_gantirugi)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena ganti rugi');
                  END IF;          
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM pemindahtanganan WHERE YEAR(tgl_pemindahtanganan)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena pemindahtanganan');
                  END IF;              
               END IF;
          END IF;
          SET cek_=CONCAT(cek_,'thn susut ak=',thn_susut_ak_,'thn susut=',thn_mulai_susut_+masa_manfaat_tot_-1); 
                            
         
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
          
          
          
          IF thn_susut_ak_ <=2014 THEN 
             IF akum_masa_manfaat_ = '' THEN
                  
                  SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                    FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                    and tgl_pemeliharaan <= tgl_susut2_  
                    AND YEAR(tgl_perolehan) <= 2014 and tambah_aset=1; 
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                    FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                    and tgl_pengamanan <= tgl_susut2_  
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                    FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                    and tgl_penghapusan <= tgl_susut2_   
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                    FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                    and tgl <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                    FROM penilaian WHERE idbi_awal = idbi_awal_ 
                    and tgl_penilaian <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
                  SET masa_manfaat_rehab_ = 0;  
                  
             ELSE             
                  SET masa_manfaat_rehab_ = 0; 
                  SET hrg_rehab_ = 0;                              
             END IF;                            
          ELSE          
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
              
              into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_  
                and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1;  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              IF thn_susut_ak_= 2015 or akum_masa_manfaat_ = '' then 
                 set masa_manfaat_rehab_ = 0;
              else 
                  select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
                  if (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_ THEN          
        			  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;
                 else          
                      SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
                  end if;           
              end if;    
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
         end if;                    
        
                
                    
         IF akum_masa_manfaat_ = 0  THEN       
              
              SET nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              SET masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          ELSE          
              
              SET nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              SET masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          END IF; 
          
          
          SET penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          SET penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          SET penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          SET penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          IF akum_masa_manfaat_ = ''  THEN      
             SET sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          ELSEIF sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 THEN          
             SET sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          ELSEIF sisa_masa_manfaat_ = 0 THEN          
             SET sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          ELSE
            SET sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          END IF;     
    
          
          SET akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          SET harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);           
          SET akum_harga_susut_=akum_harga_susut_+harga_susut_;
          SET akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_;           
          IF stop_ = 0 THEN          
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
              
              INSERT INTO penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   VALUES
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, NOW(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);   
                   
             SET penambahan_nilai_buku_prev_ = nilai_buku_;         
             SET penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             SET penambahan_hrg_rehab_prev_ = hrg_rehab_;
             SET penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             SET update_bi = 1;
             SET thn_susut_ak_ = thn_susut_ak_+1;         
             SET ket_ = "";
             
             SET thn_ke_=thn_ke_+1;
                
             IF update_bi =1 THEN     
                UPDATE buku_induk SET masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 WHERE id=idbi_;               
             END IF;          
          END IF;
          SET cek_=CONCAT(cek_,' | stop=',stop_,'\n');     
          
          
       END WHILE;
   ELSE
       SET cek_='idbi NULL';   
   END IF;

  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode2_20170503`(idbi_ INT(11), tgl_susut_ DATE, uid_ VARCHAR(20), jns_trans2_ INT(11), id_koreksi_ INT(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  DECLARE stop_ INT;
  DECLARE update_bi, con_thn_mulai_susut_, thn_mulai_susut_ INT;  
  DECLARE thn_tgl_susut_, sem_tgl_susut_ INT;
  DECLARE masa_manfaat_awl_,masa_manfaat_, persen_residu_ INT;  
  DECLARE masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ INT;  
  DECLARE thn_susut_ak_,thn_ke_ INT;
  DECLARE cek_thn_susut_ INT;
  DECLARE residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ INT;
  DECLARE tgl_buku_, tgl_ba_ DATE;  
  DECLARE masa_manfaat_brg_, residu_brg_ INT;  
  DECLARE jml_harga_bi_ DECIMAL(18,2);
  DECLARE nilai_buku_ DECIMAL(18,2);  
  DECLARE masa_manfaat_tot_ INT;  
  DECLARE harga_susut_ DECIMAL(18,2);
  DECLARE c_,d_,e_ CHAR(2);   
  DECLARE e1_ CHAR(3);
  DECLARE f_,g_,h_,i_ CHAR(2);  
  DECLARE j_ CHAR(3);
  DECLARE flama_,glama_,hlama_,ilama_ CHAR(2);  
  DECLARE jlama_ CHAR(3);  
  DECLARE staset_ INT;
  DECLARE penambahan_nilai_buku_, penambahan_hrg_rehab_ DECIMAL(18,2);
  DECLARE penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ INT;
  DECLARE penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ DECIMAL(18,2);
  DECLARE penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ INT;
  DECLARE tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ DECIMAL(18,2);  
  DECLARE nilai_perolehan_ DECIMAL(18,2); 
  DECLARE tot_manfaat_ INT;
  DECLARE hrg_rehab_ DECIMAL(18,2);
  DECLARE masa_manfaat_rehab_ INT;
  DECLARE sisa_masa_manfaat_,sisa_masa_manfaat_awl_ INT;  
  DECLARE akum_masa_manfaat_ INT;
  DECLARE akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ DECIMAL(18,2);   
  DECLARE jml_data_ INT;
  DECLARE cek_idlama_ INT;  
  DECLARE ket_ VARCHAR(255);
  DECLARE cek_ LONGTEXT;      
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  SET nilai_buku_ = 0;
  SET masa_manfaat_ = 0;
  SET masa_manfaat_tot_ = 0;
  SET masa_manfaat_awl_ = 0;
  SET masa_manfaat_rehab_ = 0;    
  SET persen_residu_ = 0;  
  SET con_thn_mulai_susut_ = 0;  
  SET thn_tgl_susut_ = YEAR(tgl_susut_);  
  SET sem_tgl_susut_ = 2;
  SET penambahan_nilai_buku_prev_ = 0;
  SET penambahan_hrg_rehab_prev_ = 0;
  SET penambahan_masa_manfaat_prev_ = 0;  
  SET penambahan_masa_manfaat_rehab_prev_ = 0;
  SET hrg_rehab_ = 0; 
  SET masa_manfaat_rehab_ = 0;    
  SET akum_nilai_buku_ = 0;
  SET akum_harga_susut_ = 0;  
  SET akum_stlh_susut_ = 0;
  SET akum_masa_manfaat_ = 0;  
  SET sisa_masa_manfaat_=0;  
  SET thn_ke_=1;
  
  SET stop_ = 0;
  SET cek_ = '';  
    
 
 SELECT idawal INTO idbi_awal_ FROM buku_induk WHERE id = idbi_; 
 IF idbi_awal_ IS NOT NULL THEN  
    if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;
    

      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;

     
      SELECT nilai INTO con_thn_mulai_susut_ FROM setting WHERE Id = 'THN_MULAI_SUSUT';        
    
      
      SELECT IFNULL(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, IF(bln_susut_ak > 6, 2,1) , idawal, staset  
        INTO masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        FROM buku_induk WHERE id = idbi_;    

     
      IF idbi_awal_ <> idbi_ THEN    
          
          IF idbi_lama_ IS NOT NULL THEN              
             
             SELECT COUNT(*) INTO cek_idlama_ FROM penyusutan WHERE idbi = idbi_lama_;
              IF cek_idlama_ > 0 THEN                 
                  SELECT tgl_ba, tgl_buku
                    INTO tgl_ba_, tgl_buku_
                    FROM buku_induk WHERE id = idbi_lama_;                    
              ELSE
                  SELECT f,g,h,i,j INTO flama_,glama_,hlama_,ilama_,jlama_ 
                    FROM buku_induk WHERE id = idbi_lama_;       
                  IF flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) THEN                                    
                      SET tgl_ba_=tgl_ba_;    
                      SET tgl_buku_=tgl_buku_;                                                  
                  ELSE
                      SELECT tgl_ba, tgl_buku
                        INTO tgl_ba_, tgl_buku_
                        FROM buku_induk WHERE id = idbi_lama_;  
                  END IF;    
              END IF;                         
          ELSE 
              SELECT tgl_ba, tgl_buku
                INTO tgl_ba_, tgl_buku_
                FROM buku_induk WHERE id = idbi_awal_;
          END IF;      
      END IF;    

       SET tgl_ba_ = IF(tgl_ba_ IS NULL, '0000-00-00', tgl_ba_);  
      SET cek_=CONCAT(cek_,'tgl_ba_=',tgl_ba_,' | tgl_buku_=',tgl_buku_);
      
      
      SELECT masa_manfaat, residu INTO masa_manfaat_brg_, residu_brg_
        FROM  ref_barang WHERE f= f_ AND g=g_ AND h=h_ AND i= i_ AND j=j_;
    
      
      IF masa_manfaat_bi_ = NULL OR masa_manfaat_bi_ = 0 THEN  
         SET masa_manfaat_ = masa_manfaat_brg_;     
         SET persen_residu_ = residu_brg_;     
      ELSE   
         SET masa_manfaat_ = masa_manfaat_bi_;     
         SET persen_residu_ = residu_bi_;         
      END IF;
      
      
      SET thn_mulai_susut_ = IF( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      SET thn_susut_ak_ = IF( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     




      
      SELECT SUM(IFNULL(hrg_perolehan,0)), SUM(masa_manfaat)
        INTO penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        FROM penyusutan WHERE idbi = idbi_ AND id_koreksi=0;    
    
      
       SELECT (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        INTO thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        FROM penyusutan WHERE idbi = idbi_ AND id_koreksi=0 ORDER BY id DESC LIMIT 0,1;
    
      SET penambahan_nilai_buku_prev_ = IF(penambahan_nilai_buku_prev_ IS NULL, 0, penambahan_nilai_buku_prev_);  
      SET penambahan_hrg_rehab_prev_ = IF(penambahan_hrg_rehab_prev_ IS NULL, 0, penambahan_hrg_rehab_prev_);  
      SET penambahan_masa_manfaat_prev_ = IF(penambahan_masa_manfaat_prev_ IS NULL, 0, penambahan_masa_manfaat_prev_);  
      SET penambahan_masa_manfaat_rehab_prev_ = IF(penambahan_masa_manfaat_rehab_prev_ IS NULL, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       SET masa_manfaat_tot_ = IF(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       SET nilai_buku_ = IF(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       SET masa_manfaat_ = masa_manfaat_tot_;
       SET sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       
       
       
        
       WHILE stop_ = 0 DO
    
       
       SET cek_=CONCAT(cek_,'thn susut ak=',thn_susut_ak_,'thn mulai susut=',thn_mulai_susut_+masa_manfaat_tot_-1,' ',masa_manfaat_tot_);   
          
          IF stop_ = 0 && masa_manfaat_ <= 0 THEN  
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena masa manfaat belum di set ');
          ELSEIF stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ THEN  
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          ELSEIF stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal susut > umur ekoknomis barang');
          END IF; 
          IF stop_ = 0 THEN
               IF thn_susut_ak_<=thn_tgl_susut_ THEN 
               
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM penghapusan WHERE YEAR(tgl_penghapusan)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_,'stop karena penghapusan');
                  END IF;        
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM t_history_aset WHERE YEAR(tgl)=thn_susut_ak_ AND (staset_baru=9 OR staset_baru=10) AND idbi = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena pindah aset');
                  END IF;
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM gantirugi WHERE YEAR(tgl_gantirugi)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena ganti rugi');
                  END IF;          
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM pemindahtanganan WHERE YEAR(tgl_pemindahtanganan)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena pemindahtanganan');
                  END IF;              
               END IF;
          END IF;
          SET cek_=CONCAT(cek_,'thn susut ak=',thn_susut_ak_,'thn susut=',thn_mulai_susut_+masa_manfaat_tot_-1); 
                            
         
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
          
          
          
                    
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
              
              into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_  
                and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1;  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              
              
              
                  select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
               
        		
                
                
                
              
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);               
              set cek_ = concat(cek_,'hrg_koreksi_ = ',tgl_susut2_);
              
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
         
        
                
                    
         IF akum_masa_manfaat_ = 0  THEN       
              
              SET nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              SET masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          ELSE          
              
              SET nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              SET masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          END IF; 
          
          
          SET penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          SET penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          SET penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          SET penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          IF akum_masa_manfaat_ = ''  THEN      
             SET sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          ELSEIF sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 THEN          
             SET sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          ELSEIF sisa_masa_manfaat_ = 0 THEN          
             SET sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          ELSE
            SET sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          END IF;     
    
          
          SET akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          SET harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);           
          SET akum_harga_susut_=akum_harga_susut_+harga_susut_;
          SET akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_;           
          IF stop_ = 0 THEN          
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
              
              INSERT INTO penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   VALUES
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, NOW(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);   
                   
             SET penambahan_nilai_buku_prev_ = nilai_buku_;         
             SET penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             SET penambahan_hrg_rehab_prev_ = hrg_rehab_;
             SET penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             SET update_bi = 1;
             SET thn_susut_ak_ = thn_susut_ak_+1;         
             SET ket_ = "";
             
             SET thn_ke_=thn_ke_+1;
                
             IF update_bi =1 THEN     
                UPDATE buku_induk SET masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 WHERE id=idbi_;               
             END IF;          
          END IF;
          SET cek_=CONCAT(cek_,' | stop=',stop_,'\n');     
          
          
       END WHILE;
   ELSE
       SET cek_='idbi NULL';   
   END IF;

  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode2_20180113`(idbi_ INT(11), tgl_susut_ DATE, uid_ VARCHAR(20), jns_trans2_ INT(11), id_koreksi_ INT(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  DECLARE stop_ INT;
  DECLARE update_bi, con_thn_mulai_susut_, thn_mulai_susut_ INT;  
  DECLARE thn_tgl_susut_, sem_tgl_susut_ INT;
  DECLARE masa_manfaat_awl_,masa_manfaat_, persen_residu_ INT;  
  DECLARE masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ INT;  
  DECLARE thn_susut_ak_,thn_ke_ INT;
  DECLARE cek_thn_susut_ INT; 
  DECLARE residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ INT;
  DECLARE tgl_buku_, tgl_ba_ DATE;  
  DECLARE masa_manfaat_brg_, residu_brg_ INT;  
  DECLARE jml_harga_bi_ DECIMAL(18,2);
  DECLARE nilai_buku_ DECIMAL(18,2);  
  DECLARE masa_manfaat_tot_ INT;  
  DECLARE harga_susut_ DECIMAL(18,2);
  DECLARE c_,d_,e_ CHAR(2);   
  DECLARE e1_ CHAR(3);
  DECLARE f_,g_,h_,i_ CHAR(2);  
  DECLARE j_ CHAR(3);
  DECLARE flama_,glama_,hlama_,ilama_ CHAR(2);  
  DECLARE jlama_ CHAR(3);  
  DECLARE staset_ INT;
  DECLARE penambahan_nilai_buku_, penambahan_hrg_rehab_ DECIMAL(18,2);
  DECLARE penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ INT;
  DECLARE penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ DECIMAL(18,2);
  DECLARE penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ INT;
  DECLARE tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ DECIMAL(18,2);  
  DECLARE nilai_perolehan_ DECIMAL(18,2); 
  DECLARE tot_manfaat_ INT;
  DECLARE hrg_rehab_ DECIMAL(18,2);
  DECLARE masa_manfaat_rehab_ INT;
  DECLARE sisa_masa_manfaat_,sisa_masa_manfaat_awl_ INT;  
  DECLARE akum_masa_manfaat_ INT;
  DECLARE akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ DECIMAL(18,2);   
  DECLARE jml_data_ INT;
  DECLARE cek_idlama_ INT;  
  DECLARE ket_ VARCHAR(255);
  DECLARE cek_, hasil_susut_ LONGTEXT;      
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  SET nilai_buku_ = 0;
  SET masa_manfaat_ = 0;
  SET masa_manfaat_tot_ = 0;
  SET masa_manfaat_awl_ = 0;
  SET masa_manfaat_rehab_ = 0;    
  SET persen_residu_ = 0;  
  SET con_thn_mulai_susut_ = 0;  
  SET thn_tgl_susut_ = YEAR(tgl_susut_);  
  SET sem_tgl_susut_ = 2;
  SET penambahan_nilai_buku_prev_ = 0;
  SET penambahan_hrg_rehab_prev_ = 0;
  SET penambahan_masa_manfaat_prev_ = 0;  
  SET penambahan_masa_manfaat_rehab_prev_ = 0;
  SET hrg_rehab_ = 0; 
  SET masa_manfaat_rehab_ = 0;    
  SET akum_nilai_buku_ = 0;
  SET akum_harga_susut_ = 0;  
  SET akum_stlh_susut_ = 0;
  SET akum_masa_manfaat_ = 0;  
  SET sisa_masa_manfaat_=0;  
  SET thn_ke_=1;
  
  SET stop_ = 0;
  SET cek_ = ''; 
  set ket_='';
  set hasil_susut_ = 'gagal';  
    
 
 SELECT idawal INTO idbi_awal_ FROM buku_induk WHERE id = idbi_; 
 IF idbi_awal_ IS NOT NULL THEN  
     
     
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;

     
      SELECT nilai INTO con_thn_mulai_susut_ FROM setting WHERE Id = 'THN_MULAI_SUSUT';        
    
      
      SELECT IFNULL(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, IF(bln_susut_ak > 6, 2,1) , idawal, staset  
        INTO masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        FROM buku_induk WHERE id = idbi_;    

     
      IF idbi_awal_ <> idbi_ THEN    
          
          IF idbi_lama_ IS NOT NULL THEN              
             
             SELECT COUNT(*) INTO cek_idlama_ FROM penyusutan WHERE idbi = idbi_lama_;
              IF cek_idlama_ > 0 THEN                 
                  SELECT tgl_ba, tgl_buku
                    INTO tgl_ba_, tgl_buku_
                    FROM buku_induk WHERE id = idbi_lama_;                    
              ELSE
                  SELECT f,g,h,i,j INTO flama_,glama_,hlama_,ilama_,jlama_ 
                    FROM buku_induk WHERE id = idbi_lama_;       
                  IF flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) THEN                                    
                      SET tgl_ba_=tgl_ba_;    
                      SET tgl_buku_=tgl_buku_;                                                  
                  ELSE
                      SELECT tgl_ba, tgl_buku
                        INTO tgl_ba_, tgl_buku_
                        FROM buku_induk WHERE id = idbi_lama_;  
                  END IF;    
              END IF;                         
          ELSE 
              SELECT tgl_ba, tgl_buku
                INTO tgl_ba_, tgl_buku_
                FROM buku_induk WHERE id = idbi_awal_;
          END IF;      
      END IF;    

       SET tgl_ba_ = IF(tgl_ba_ IS NULL, '0000-00-00', tgl_ba_);  
      
      
      
      SELECT masa_manfaat, residu INTO masa_manfaat_brg_, residu_brg_
        FROM  ref_barang WHERE f= f_ AND g=g_ AND h=h_ AND i= i_ AND j=j_;
    
      
      IF masa_manfaat_bi_ = NULL OR masa_manfaat_bi_ = 0 THEN  
         SET masa_manfaat_ = masa_manfaat_brg_;     
         SET persen_residu_ = residu_brg_;     
      ELSE   
         SET masa_manfaat_ = masa_manfaat_bi_;     
         SET persen_residu_ = residu_bi_;         
      END IF;
      
      
      SET thn_mulai_susut_ = IF( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      SET thn_susut_ak_ = IF( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     




      
      SELECT SUM(IFNULL(hrg_perolehan,0)), SUM(masa_manfaat)
        INTO penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        FROM penyusutan WHERE idbi = idbi_ AND id_koreksi=0;    
    
      
       SELECT (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        INTO thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        FROM penyusutan WHERE idbi = idbi_ AND id_koreksi=0 ORDER BY id DESC LIMIT 0,1;
    
      SET penambahan_nilai_buku_prev_ = IF(penambahan_nilai_buku_prev_ IS NULL, 0, penambahan_nilai_buku_prev_);  
      SET penambahan_hrg_rehab_prev_ = IF(penambahan_hrg_rehab_prev_ IS NULL, 0, penambahan_hrg_rehab_prev_);  
      SET penambahan_masa_manfaat_prev_ = IF(penambahan_masa_manfaat_prev_ IS NULL, 0, penambahan_masa_manfaat_prev_);  
      SET penambahan_masa_manfaat_rehab_prev_ = IF(penambahan_masa_manfaat_rehab_prev_ IS NULL, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       SET masa_manfaat_tot_ = IF(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       SET nilai_buku_ = IF(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       SET masa_manfaat_ = masa_manfaat_tot_;
       SET sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       
       
       
        
       WHILE stop_ = 0 DO
    
       
       
          
          IF stop_ = 0 && masa_manfaat_ <= 0 THEN  
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena masa manfaat belum di set ');
          ELSEIF stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ THEN  
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          ELSEIF stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal susut > umur ekoknomis barang');              
          ELSEIF stop_ = 0 && tgl_buku_ > tgl_susut_ THEN
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal buku > tanggl periode penyusutan');                                   
          END IF; 
          IF stop_ = 0 THEN
               IF thn_susut_ak_<=thn_tgl_susut_ THEN 
               
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM penghapusan WHERE YEAR(tgl_penghapusan)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_,'stop karena penghapusan');
                  END IF;        
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM t_history_aset WHERE YEAR(tgl)=thn_susut_ak_ AND (staset_baru=9 OR staset_baru=10) AND idbi = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena pindah aset');
                  END IF;
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM gantirugi WHERE YEAR(tgl_gantirugi)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena ganti rugi');
                  END IF;          
                  
                  SELECT COUNT(*) INTO jml_data_
                  FROM pemindahtanganan WHERE YEAR(tgl_pemindahtanganan)=thn_susut_ak_ AND id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena pemindahtanganan');
                  END IF;              
               END IF;
          END IF;
          
                            
         
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
          
          
          
                   
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
              
              into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_  
                and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1;  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
             if tot_rehab_manfaat_ <> 0 then
                  if thn_susut_ak_= 2015 or akum_masa_manfaat_ = '' then               
                     set masa_manfaat_rehab_ = 0;
                  elseif akum_stlh_susut_ = 0 then               
                     
                     select masa_manfaat into masa_manfaat_rehab_ from ref_tambah_manfaat
                     where CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and CAST(h AS UNSIGNED)=h_ and (i='00' or i is null) and (j='000' or j is null)
                     ORDER by persen2 DESC limit 0,1 ;
                     set ket_ = concat(ket_, 'penambahan masamanfaat diambil persentase terbesar \n' );                                    
                  else
                      select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,akum_stlh_susut_) into masa_manfaat_rehab_;
                      if (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_ THEN          
            			  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;
                          set ket_ = concat(ket_, 'penambahan ' ,masa_manfaat_rehab_,' melebihi masa manfaat awal. \n' );   
                      else          
                          SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
                      end if;           
                  end if;    
              end if;    
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);               
              
              
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
         
        
                
                    
         IF akum_masa_manfaat_ = 0  THEN       
              
              SET nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              SET masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          ELSE          
              
              SET nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              SET masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          END IF; 
          
          
          SET penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          SET penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          SET penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          SET penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          IF akum_masa_manfaat_ = ''  THEN      
             SET sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          ELSEIF sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 THEN          
             SET sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          ELSEIF sisa_masa_manfaat_ = 0 THEN          
             SET sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          ELSE
            SET sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          END IF;     
    
          
          SET akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          SET harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);           
          SET akum_harga_susut_=akum_harga_susut_+harga_susut_;
          SET akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_;           
          IF stop_ = 0 THEN          
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
              
              INSERT INTO penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   VALUES
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, NOW(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);   
                   
             SET penambahan_nilai_buku_prev_ = nilai_buku_;         
             SET penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             SET penambahan_hrg_rehab_prev_ = hrg_rehab_;
             SET penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             SET update_bi = 1;
             SET thn_susut_ak_ = thn_susut_ak_+1;         
             SET ket_ = "";
             
             SET thn_ke_=thn_ke_+1;
                
             IF update_bi =1 THEN     
                UPDATE buku_induk SET masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 WHERE id=idbi_;
                set hasil_susut_ = 'sukses';                      
             END IF;          
          END IF;
          
          
          
       END WHILE;
   ELSE
       SET cek_='idbi NULL';   
   END IF;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode3_bln`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ INT(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN 
   
  declare stop_, stat_ int;
  declare update_bi int; 
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, thn_ke_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_,cek_susut_thn_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int; 
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,5);
  declare nilai_buku_ decimal(18,5);  
  declare masa_manfaat_tot_, masa_manfaat_tot_bi_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,5);
  declare c1_, c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,5);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,5);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,5);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,5);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,5);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_  decimal(18,5);  
  declare nilai_perolehan_ decimal(18,5); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,5);
  declare masa_manfaat_rehab_,masa_manfaat_rehab_susut_thn_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_,sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,5);   
  declare jml_data_,jml_data_cek_, cek_thn_susut_ak_ int;  
  declare jml_bln_ int;  
  
  declare cek_susut_first int;  
  declare cek_idlama_ int;  
  declare ket_ varchar(255);
  declare cek_, test_, hasil_susut_ longtext;    
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_tot_bi_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_susut_thn_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set thn_ke_=1;
  set stop_ = 0;  
  set stat_ = 0;
  set cek_ = '';  
  set cek_susut_thn_=0;
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set ket_ = '';  
  set hasil_susut_ = 'gagal';    
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_;  
 if idbi_awal_ is not NULL then   

      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;      

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';         
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        from buku_induk where id = idbi_;    
    
     
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;    

       set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
      
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_ba_) <> 0 ,  month(tgl_ba_),month(tgl_buku_));
      
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
                
      
      if thn_perolehan_<=2014 then 
         set bln_mulai_susut_ = 1;         
      end if;      
   
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
   
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,stat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;        

      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
          
       
       
       
       
     
       
       if akum_masa_manfaat_ = '' then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);
       end if;
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
      
      while stop_ = 0 do
          
      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
 
       
       
       set cek_=concat(cek_,'perbadingan tgl susut - > ',thn_susut_ak_*12+bln_susut_ak_,' > ',thn_tgl_susut_*12 + bln_tgl_susut_);         
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <=  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
          
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);       
          
        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_) or tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
    
          
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
           
          if thn_susut_ak_ <=2014 then 
             if akum_masa_manfaat_ = '' then
                  
                  select  ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_
                    from pemeliharaan where idbi_awal = idbi_ 
                    and tgl_pemeliharaan <= tgl_susut2_ 
                    and year(tgl_perolehan)*12+month(tgl_perolehan) <= 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                    from pengamanan where idbi_awal = idbi_ 
                    and tgl_pengamanan <= tgl_susut2_ 
                    and year(tgl_perolehan)*12+month(tgl_perolehan) <= 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(harga_hapus),0) into tot_rehab_
                    from penghapusan_sebagian where idbi_awal = idbi_ 
                    and tgl_penghapusan <= tgl_susut2_ 
                    and year(tgl_perolehan)*12+month(tgl_perolehan) <= 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                    from t_koreksi where idbi_awal = idbi_ 
                    and tgl <= tgl_susut2_ 
                    and year(tgl_perolehan)*12+month(tgl_perolehan) <= 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
                    from penilaian where idbi_awal = idbi_ 
                    and tgl_penilaian <= tgl_susut2_ 
                    and year(tgl_perolehan)*12+month(tgl_perolehan) <= 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);
                  set masa_manfaat_rehab_ = 0;  
                  
             else             
                  set masa_manfaat_rehab_ = 0; 
                  set hrg_rehab_ = 0;                              
             end if;                            
          else
              select ifnull(sum(biaya_pemeliharaan),0)
              into tot_rehab_aset_
                from pemeliharaan where idbi_awal = idbi_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1; 
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_;  
                        
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
                      
              if tot_rehab_aset_ <> 0 then              
                  if akum_masa_manfaat_ = '' then
                     set masa_manfaat_rehab_ = 0;            
                  elseif akum_stlh_susut_ = 0 then    
                     
                     
                     set masa_manfaat_rehab_ = masa_manfaat_brg_*12-sisa_masa_manfaat_+1;                 
                     set ket_ = 'sesuai kebijakan 7.(a) Jika nilai_buku=0, maka Penambahan masa manfaat sama dengan masa manfaat perolehan awal aset tetap';
                     
                  elseif tot_rehab_aset_ > akum_stlh_susut_ then 
                     
                     
                     set masa_manfaat_rehab_ = masa_manfaat_brg_*12-sisa_masa_manfaat_+1;                     
                     set ket_ = 'sesuai kebijakan 7.(c) Jika realisasi Belanja melebihi nilai perolehan terakhir';
                  elseif thn_susut_ak_= 2015 then 
                     set masa_manfaat_rehab_ = 0;         
                  else          
                     select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_aset_,akum_stlh_susut_) into masa_manfaat_rehab_;          
                     if (masa_manfaat_rehab_*12+sisa_masa_manfaat_) > masa_manfaat_brg_*12 then
                         
                         
                         set masa_manfaat_rehab_ = masa_manfaat_brg_*12-sisa_masa_manfaat_+1;
                         set ket_ = 'sesuai kebijakan 7.(d) Jika hasil perhitungan masa manfaat ditambah dengan sisa manfaat melebihi masa manfaat awal aset tetap'; 
                     else
                         set masa_manfaat_rehab_ = masa_manfaat_rehab_*12;                
                     end if;      
                  end if;
               end if;       
                             
              
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              set cek_=concat(cek_,' | sisa_masa_manfaat_=',sisa_masa_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          end if;                          
        
        
        if akum_masa_manfaat_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;                            
    
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
          
          set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/12);                   
    
          
          
          if akum_masa_manfaat_ = '' then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;       
    
          
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;            
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_; 
           
    
          
          
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;             
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then      
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;
        end if;
    
         
         set penambahan_nilai_buku_prev_ = nilai_buku_;         
         set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
         set penambahan_hrg_rehab_prev_ = hrg_rehab_;
         set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
               
          set update_bi = 1;
           
                
         select ifnull(stat,0) into cek_susut_thn_
         from penyusutan where idbi = idbi_ and stat=1 limit 0,1;        
         
         
         select sum(masa_manfaat) into masa_manfaat_tot_bi_
         from penyusutan where idbi = idbi_;  
     
         if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=if(cek_susut_thn_=1,masa_manfaat_tot_bi_,masa_manfaat_tot_/12), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;               
            set hasil_susut_ = 'sukses';       
         end if;
  
          set bln_susut_ak_=bln_susut_ak_+1;
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
             
             set thn_ke_=thn_ke_+1;
          end if; 
          
          
                
          
       end while;                    
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;   
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode3_bln_20161124`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN
   
  declare stop_, stat_ int;
  declare update_bi int; 
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, thn_ke_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_,cek_susut_thn_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int; 
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,3);
  declare nilai_buku_ decimal(18,3);  
  declare masa_manfaat_tot_, masa_manfaat_tot_bi_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,3);
  declare c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,3);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,3);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,3);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,3);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,3);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_  decimal(18,3);  
  declare nilai_perolehan_ decimal(18,3); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,3);
  declare masa_manfaat_rehab_,masa_manfaat_rehab_susut_thn_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_,sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,3);   
  declare jml_data_,jml_data_cek_, cek_thn_susut_ak_ int;  
  declare jml_bln_ int;  
  
  declare cek_idlama_ int;
  declare cek_ longtext;    

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_tot_bi_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_susut_thn_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set thn_ke_=1;
  set stop_ = 0;  
  set stat_ = 0;
  set cek_ = '';  
  set cek_susut_thn_=0;
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_;  
 if idbi_awal_ is not NULL then   
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';         
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        from buku_induk where id = idbi_;    
    
     
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;    

    

    
       set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
      set cek_=concat(cek_,'tgl_ba_=',tgl_ba_,' | tgl_buku_=',tgl_buku_);  
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_buku_) >  month(tgl_ba_) ,  month(tgl_buku_),month(tgl_ba_));
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
        
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,stat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_*12);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
          
       
       if sisa_masa_manfaat_ = 1  then      
          set stop_ = 1;                 
       end if;
     set cek_=concat(cek_,'masa_manfaat_1=',masa_manfaat_);  
       
       if sisa_masa_manfaat_ = 0 then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_awl_/12;
             set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set thn_ke_=thn_ke_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;
           end if;       
           if stat_ = 1 then
             
    
             set penambahan_masa_manfaat_rehab_prev_ = 0;         
             set masa_manfaat_=(sisa_masa_manfaat_-1)*12;
             set penambahan_masa_manfaat_prev_ = masa_manfaat_;  
             set masa_manfaat_tot_ =masa_manfaat_;         
             set thn_mulai_susut_ = thn_susut_ak_;
             set bln_mulai_susut_ = 1;          
           else       
             
             select tahun into cek_thn_susut_ak_
             from penyusutan where idbi = idbi_ and stat=1 order by id DESC limit 0,1;  
             
             if cek_thn_susut_ak_ is not null then
             
    
              
              select sum(ifnull(masa_manfaat_rehab,0)),((sisa_masa_manfaat_thn+sum(ifnull(masa_manfaat_rehab,0)))*12), sisa_masa_manfaat_thn*12
                into penambahan_masa_manfaat_rehab_prev_,penambahan_masa_manfaat_prev_,masa_manfaat_ 
                from penyusutan where idbi = idbi_ and stat=2 order by Id ASC;            
    
                 set penambahan_masa_manfaat_rehab_prev_ = penambahan_masa_manfaat_rehab_prev_*12;         
                 set masa_manfaat_tot_ =penambahan_masa_manfaat_prev_;
                 
                 
                 
                          
                   
                 set thn_mulai_susut_ = cek_thn_susut_ak_+1;
                 set bln_mulai_susut_ = 1;
                 
                 
             else        
                 set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
                 set masa_manfaat_ =  if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);     
             end if;     
                 
                 
           end if;       
       end if;   
          set cek_=concat(cek_,'masa_manfaat_=',masa_manfaat_,'masa_manfaat_tot_=',masa_manfaat_tot_,'\n');
    
       
    
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
       while stop_ = 0 do
          
       
        set cek_=concat(cek_,thn_mulai_susut_,'-',thn_susut_ak_,'-',bln_tgl_susut_,'-',bln_susut_ak_,'-',bln_mulai_susut_,'-');   
       set cek_=concat(cek_,thn_susut_ak_*12+bln_susut_ak_,' > ',thn_mulai_susut_*12+bln_mulai_susut_+masa_manfaat_tot_-1);         
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
          
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);       
          
        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  from penghapusan where year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  select count(*) into jml_data_
                  from t_history_aset where year(tgl)=thn_susut_ak_ and month(tgl)=bln_susut_ak_ and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_ , 'stop karena pindah aset');
                  end if;
                  
                  select count(*) into jml_data_
                  from gantirugi where year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
    
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
            
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_ and tambah_masamanfaat=1;  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
          select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0)*12;
          set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
             
                    
        
        
        if sisa_masa_manfaat_ = 0  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;                            
    
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_-penambahan_hrg_rehab_prev_;      
     
          
          
          
          
              
          
          
              set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
              set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_-penambahan_masa_manfaat_rehab_prev_;      
              
              set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/12); 
          
    
    
          
    
          
          
          if akum_harga_susut_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;       
    
          set cek_=concat(cek_,'penambahan_masa_manfaat_=',penambahan_masa_manfaat_,'penambahan_masa_manfaat_rehab_=',penambahan_masa_manfaat_rehab_,'masa_manfaat_tot_=',masa_manfaat_tot_,'masa_manfaat_rehab_=',masa_manfaat_rehab_,'penambahan_masa_manfaat_=',penambahan_masa_manfaat_,'penambahan_masa_manfaat_prev_=',penambahan_masa_manfaat_prev_);   
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;            
    
           set cek_=concat(cek_,' | akum_masa_manfaat_=',akum_masa_manfaat_);
    
          
    
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2)
                   values
                   (tgl_susut_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_);         
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;                 
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then      
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2)
                   values
                   (tgl_susut_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_);         
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;                 
          end if;
        end if;
        
               
        
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
               
          set update_bi = 1;
           
                
         select ifnull(stat,0) into cek_susut_thn_
         from penyusutan where idbi = idbi_ and stat=1 limit 0,1;        
         set cek_=concat(cek_,'cek_susut_thn_=',cek_susut_thn_);
         
         select sum(masa_manfaat) into masa_manfaat_tot_bi_
         from penyusutan where idbi = idbi_;  
     
         if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=if(cek_susut_thn_=1,masa_manfaat_tot_bi_,masa_manfaat_tot_/12), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;               
         end if;
 
          set bln_susut_ak_=bln_susut_ak_+1;
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
             
             set thn_ke_=thn_ke_+1;
          end if; 
          
          
                
          set cek_=concat(cek_,'\n');     
       end while;                    
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode3_bln_20161128`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN
   
  declare stop_, stat_ int;
  declare update_bi int; 
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, thn_ke_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_,cek_susut_thn_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int; 
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,3);
  declare nilai_buku_ decimal(18,3);  
  declare masa_manfaat_tot_, masa_manfaat_tot_bi_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,3);
  declare c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,3);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,3);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,3);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,3);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,3);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_  decimal(18,3);  
  declare nilai_perolehan_ decimal(18,3); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,3);
  declare masa_manfaat_rehab_,masa_manfaat_rehab_susut_thn_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_,sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,3);   
  declare jml_data_,jml_data_cek_, cek_thn_susut_ak_ int;  
  declare jml_bln_ int;  
  
  declare cek_idlama_ int;
  declare cek_ longtext;    

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_tot_bi_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_susut_thn_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set thn_ke_=1;
  set stop_ = 0;  
  set stat_ = 0;
  set cek_ = '';  
  set cek_susut_thn_=0;
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_;  
 if idbi_awal_ is not NULL then   
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';         
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        from buku_induk where id = idbi_;    
    
     
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;    

    

    
       set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
      set cek_=concat(cek_,'tgl_ba_=',tgl_ba_,' | tgl_buku_=',tgl_buku_);  
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_buku_) >  month(tgl_ba_) ,  month(tgl_buku_),month(tgl_ba_));
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
        
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,stat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_*12);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
          
       
       
     set cek_=concat(cek_,'masa_manfaat_1=',masa_manfaat_);  
       
       if akum_masa_manfaat_ = '' then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_awl_/12;
             set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set thn_ke_=thn_ke_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;
           end if;       
           if stat_ = 1 then
             
    
             set penambahan_masa_manfaat_rehab_prev_ = 0;         
             set masa_manfaat_=(sisa_masa_manfaat_-1)*12;
             set penambahan_masa_manfaat_prev_ = masa_manfaat_;  
             set masa_manfaat_tot_ =masa_manfaat_;         
             set thn_mulai_susut_ = thn_susut_ak_;
             set bln_mulai_susut_ = 1;          
           else       
             
             select tahun into cek_thn_susut_ak_
             from penyusutan where idbi = idbi_ and stat=1 order by id DESC limit 0,1;  
             
             if cek_thn_susut_ak_ is not null then
             
    
              
              select sum(ifnull(masa_manfaat_rehab,0)),((sisa_masa_manfaat_thn+sum(ifnull(masa_manfaat_rehab,0)))*12), sisa_masa_manfaat_thn*12
                into penambahan_masa_manfaat_rehab_prev_,penambahan_masa_manfaat_prev_,masa_manfaat_ 
                from penyusutan where idbi = idbi_ and stat=2 order by Id ASC;            
    
                 set penambahan_masa_manfaat_rehab_prev_ = penambahan_masa_manfaat_rehab_prev_*12;         
                 set masa_manfaat_tot_ =penambahan_masa_manfaat_prev_;
                 
                 
                 
                          
                   
                 set thn_mulai_susut_ = cek_thn_susut_ak_+1;
                 set bln_mulai_susut_ = 1;
                 
                 
             else        
                 set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
                 set masa_manfaat_ =  if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);     
             end if;     
                 
                 
           end if;       
       end if;   
          set cek_=concat(cek_,'masa_manfaat_=',masa_manfaat_,'masa_manfaat_tot_=',masa_manfaat_tot_,'\n');
    
       
    
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
       while stop_ = 0 do
          
       
        set cek_=concat(cek_,thn_mulai_susut_,'-',thn_susut_ak_,'-',bln_tgl_susut_,'-',bln_susut_ak_,'-',bln_mulai_susut_,'-');   
       set cek_=concat(cek_,thn_susut_ak_*12+bln_susut_ak_,' > ',thn_mulai_susut_*12+bln_mulai_susut_+masa_manfaat_tot_-1);         
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
          
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);       
          
        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  from penghapusan where year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  select count(*) into jml_data_
                  from t_history_aset where year(tgl)=thn_susut_ak_ and month(tgl)=bln_susut_ak_ and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_ , 'stop karena pindah aset');
                  end if;
                  
                  select count(*) into jml_data_
                  from gantirugi where year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
    
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
 
          if thn_susut_ak_ <=2014 then 
             if akum_masa_manfaat_ = '' then
                  
                  select  ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_
                    from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) < 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                    from pengamanan where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) < 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(harga_hapus),0) into tot_rehab_
                    from penghapusan_sebagian where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) < 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                    from t_koreksi where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) < 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
                    from penilaian where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) < 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);
                  set masa_manfaat_rehab_ = 0;  
                  
             else             
                  set masa_manfaat_rehab_ = 0; 
                  set hrg_rehab_ = 0;                              
             end if;                            
          else           
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0)
              
              
              into tot_rehab_aset_
                from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_;  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_aset_,akum_stlh_susut_) into masa_manfaat_rehab_;
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0)*12;
              set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);
          end if;     
             
                    
        
        
        if akum_masa_manfaat_ = ''  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;                            
    
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          
          
          
              
          
          
              set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
              set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
              
              set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/12); 
          
    
    
          
    
          
          
          if akum_masa_manfaat_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;       
    
          set cek_=concat(cek_,'penambahan_masa_manfaat_=',penambahan_masa_manfaat_,'penambahan_masa_manfaat_rehab_=',penambahan_masa_manfaat_rehab_,'masa_manfaat_tot_=',masa_manfaat_tot_,'masa_manfaat_rehab_=',masa_manfaat_rehab_,'penambahan_masa_manfaat_=',penambahan_masa_manfaat_,'penambahan_masa_manfaat_prev_=',penambahan_masa_manfaat_prev_);   
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;            
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_;    
           set cek_=concat(cek_,' | akum_masa_manfaat_=',akum_masa_manfaat_);
    
          
    
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2)
                   values
                   (tgl_susut_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_);         
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;                 
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then      
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2)
                   values
                   (tgl_susut_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_);         
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;                 
          end if;
        end if;
        
               
        
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
               
          set update_bi = 1;
           
                
         select ifnull(stat,0) into cek_susut_thn_
         from penyusutan where idbi = idbi_ and stat=1 limit 0,1;        
         set cek_=concat(cek_,'cek_susut_thn_=',cek_susut_thn_);
         
         select sum(masa_manfaat) into masa_manfaat_tot_bi_
         from penyusutan where idbi = idbi_;  
     
         if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=if(cek_susut_thn_=1,masa_manfaat_tot_bi_,masa_manfaat_tot_/12), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;               
         end if;
 
          set bln_susut_ak_=bln_susut_ak_+1;
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
             
             set thn_ke_=thn_ke_+1;
          end if; 
          
          
                
          set cek_=concat(cek_,'\n');     
       end while;                    
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode3_bln_20171030`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ INT(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN 

  declare stop_, stat_ int;
  declare update_bi int; 
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, thn_ke_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_,cek_susut_thn_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int; 
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,5);
  declare nilai_buku_ decimal(18,5);  
  declare masa_manfaat_tot_, masa_manfaat_tot_bi_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,5);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,5);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,5);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,5);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,5);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,5);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_  decimal(18,5);  
  declare nilai_perolehan_ decimal(18,5); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,5);
  declare masa_manfaat_rehab_,masa_manfaat_rehab_susut_thn_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_,sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,5);   
  declare jml_data_,jml_data_cek_, cek_thn_susut_ak_ int;  
  declare jml_bln_ int;  
  
  declare cek_susut_first int;  
  declare cek_idlama_ int;  
  declare ket_ varchar(255);
  declare cek_ longtext;
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_tot_bi_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_susut_thn_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set thn_ke_=1;
  set stop_ = 0;  
  set stat_ = 0;
  set cek_ = '';  
  set cek_susut_thn_=0;
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set ket_ = '';
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_;  
 if idbi_awal_ is not NULL then   
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';         
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        from buku_induk where id = idbi_;    
    
     
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;    

       set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
      set cek_=concat(cek_,'tgl_ba_=',tgl_ba_,' | tgl_buku_=',tgl_buku_);  
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if( month(tgl_ba_) = '00'  ,  month(tgl_buku_),month(tgl_ba_));
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;

      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
      
      
      if thn_susut_ak_ <= 2014 then                
         set bln_susut_ak_ = 1;            
      end if;      

     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,stat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;        

      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
          
       
       
       
       
     set cek_=concat(cek_,'masa_manfaat_1=',masa_manfaat_);  
       
       if akum_masa_manfaat_ = '' then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_awl_/12;
             set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set thn_ke_=thn_ke_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;
           end if;       
           if stat_ = 1 then
             
    
             set penambahan_masa_manfaat_rehab_prev_ = 0;         
             set masa_manfaat_=(sisa_masa_manfaat_-1)*12;
             set penambahan_masa_manfaat_prev_ = masa_manfaat_;  
             set masa_manfaat_tot_ =masa_manfaat_;  
             set sisa_masa_manfaat_ = masa_manfaat_;       
             set thn_mulai_susut_ = thn_susut_ak_;
             set bln_mulai_susut_ = 1;          
           else       
             
             select tahun into cek_thn_susut_ak_
             from penyusutan where idbi = idbi_ and stat=1 order by id DESC limit 0,1;  
             
             if cek_thn_susut_ak_ is not null then
             
    
              
              select sum(ifnull(masa_manfaat_rehab,0)),((sisa_masa_manfaat_thn+sum(ifnull(masa_manfaat_rehab,0)))*12), sisa_masa_manfaat_thn*12
                into penambahan_masa_manfaat_rehab_prev_,penambahan_masa_manfaat_prev_,masa_manfaat_ 
                from penyusutan where idbi = idbi_ and stat=2 order by Id ASC;            
    
                 set penambahan_masa_manfaat_rehab_prev_ = penambahan_masa_manfaat_rehab_prev_*12;         
                 set masa_manfaat_tot_ =penambahan_masa_manfaat_prev_;
                 
                 
                 
                          
                   
                 set thn_mulai_susut_ = cek_thn_susut_ak_+1;
                 set bln_mulai_susut_ = 1;
                 
                 
             else        
                 set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
                 set masa_manfaat_ =  if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);     
             end if;     
                 
                 
           end if;       
       end if;   
          set cek_=concat(cek_,'masa_manfaat_=',masa_manfaat_,'masa_manfaat_tot_=',masa_manfaat_tot_,'\n');
    
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
       while stop_ = 0 do
          
      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
 
       
       
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
          
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);       
          
        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  from penghapusan where year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  from gantirugi where year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
    
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
           
          if thn_susut_ak_ <=2014 then 
             if akum_masa_manfaat_ = '' then
                  
                  select  ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_
                    from pemeliharaan where idbi_awal = idbi_ 
                    and tgl_pemeliharaan <= tgl_susut2_ 
                    and year(tgl_perolehan)*12+month(tgl_perolehan) <= 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                    from pengamanan where idbi_awal = idbi_ 
                    and tgl_pengamanan <= tgl_susut2_ 
                    and year(tgl_perolehan)*12+month(tgl_perolehan) <= 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(harga_hapus),0) into tot_rehab_
                    from penghapusan_sebagian where idbi_awal = idbi_ 
                    and tgl_penghapusan <= tgl_susut2_ 
                    and year(tgl_perolehan)*12+month(tgl_perolehan) <= 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                    from t_koreksi where idbi_awal = idbi_ 
                    and tgl <= tgl_susut2_ 
                    and year(tgl_perolehan)*12+month(tgl_perolehan) <= 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
                  
                  select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
                    from penilaian where idbi_awal = idbi_ 
                    and tgl_penilaian <= tgl_susut2_ 
                    and year(tgl_perolehan)*12+month(tgl_perolehan) <= 2014*12+12;
                  set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);
                  set masa_manfaat_rehab_ = 0;  
                  
             else             
                  set masa_manfaat_rehab_ = 0; 
                  set hrg_rehab_ = 0;                              
             end if;                            
          else
              select ifnull(sum(biaya_pemeliharaan),0)
              into tot_rehab_aset_
                from pemeliharaan where idbi_awal = idbi_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1; 
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_;  
                        
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
                      
              if tot_rehab_aset_ <> 0 then              
                  if akum_masa_manfaat_ = '' then
                     set masa_manfaat_rehab_ = 0;            
                  elseif akum_stlh_susut_ = 0 then    
                     
                     
                     set masa_manfaat_rehab_ = masa_manfaat_brg_*12-sisa_masa_manfaat_+1;                 
                     set ket_ = 'sesuai kebijakan 7.(a) Jika nilai_buku=0, maka Penambahan masa manfaat sama dengan masa manfaat perolehan awal aset tetap';
                     
                  elseif tot_rehab_aset_ > akum_stlh_susut_ then 
                     
                     
                     set masa_manfaat_rehab_ = masa_manfaat_brg_*12-sisa_masa_manfaat_+1;                     
                     set ket_ = 'sesuai kebijakan 7.(c) Jika realisasi Belanja melebihi nilai perolehan terakhir';
                  elseif thn_susut_ak_= 2015 then 
                     set masa_manfaat_rehab_ = 0;         
                  else          
                     select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_aset_,akum_stlh_susut_) into masa_manfaat_rehab_;          
                     if (masa_manfaat_rehab_*12+sisa_masa_manfaat_) > masa_manfaat_brg_*12 then
                         
                         
                         set masa_manfaat_rehab_ = masa_manfaat_brg_*12-sisa_masa_manfaat_+1;
                         set ket_ = 'sesuai kebijakan 7.(d) Jika hasil perhitungan masa manfaat ditambah dengan sisa manfaat melebihi masa manfaat awal aset tetap'; 
                     else
                         set masa_manfaat_rehab_ = masa_manfaat_rehab_*12;                
                     end if;      
                  end if;
               end if;       
                             
              
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              set cek_=concat(cek_,' | sisa_masa_manfaat_=',sisa_masa_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          end if;        
             
                    
        
        
        if akum_masa_manfaat_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;                            
    
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          
          
          
          
          
          
              set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
              set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
              
              set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/12); 
          
    
    
          
    
          
          
          if akum_masa_manfaat_ = '' then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;       
    
          set cek_=concat(cek_,'penambahan_masa_manfaat_=',penambahan_masa_manfaat_,'penambahan_masa_manfaat_rehab_=',penambahan_masa_manfaat_rehab_,'masa_manfaat_tot_=',masa_manfaat_tot_,'masa_manfaat_rehab_=',masa_manfaat_rehab_,'penambahan_masa_manfaat_=',penambahan_masa_manfaat_,'penambahan_masa_manfaat_prev_=',penambahan_masa_manfaat_prev_);   
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);            
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;            
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_; 
           set cek_=concat(cek_,' | akum_masa_manfaat_=',akum_masa_manfaat_);
    
          
    
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_; 
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then      
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;
        end if;
        
               
        
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
               
          set update_bi = 1;
           
                
         select ifnull(stat,0) into cek_susut_thn_
         from penyusutan where idbi = idbi_ and stat=1 limit 0,1;        
         set cek_=concat(cek_,'cek_susut_thn_=',cek_susut_thn_);
         
         select sum(masa_manfaat) into masa_manfaat_tot_bi_
         from penyusutan where idbi = idbi_;  
     
         if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=if(cek_susut_thn_=1,masa_manfaat_tot_bi_,masa_manfaat_tot_/12), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;               
         end if;
 
          set bln_susut_ak_=bln_susut_ak_+1;
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
             
             set thn_ke_=thn_ke_+1;
          end if; 
          
          
                
          set cek_=concat(cek_,'ket',ket_,'\n');     
       end while;                    
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode3_bln_bck`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN
  
  declare stop_, i int;
  declare update_bi int;
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;  
  declare thn_susut_ak_, bln_susut_ak_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_ decimal(18,2);
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_ longtext;    

  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 2010;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;
  
  set stop_ = 0;
  set cek_ = '';
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;   
    
  
  select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal 
    into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_
    from buku_induk where id = idbi_;
   set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
         
  
  select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
    from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
  
  
  if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
     set masa_manfaat_ = masa_manfaat_brg_*12;     
     set persen_residu_ = residu_brg_;     
  else   
     set masa_manfaat_ = masa_manfaat_bi_*12;     
     set persen_residu_ = residu_bi_;         
  end if;
  
  
  set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
  set bln_mulai_susut_ = if( con_bln_mulai_susut_ >  month(tgl_ba_) , con_bln_mulai_susut_,month(tgl_ba_));
  set sem_mulai_susut_ = if(month(tgl_buku_) >6 , 2, 1) ;
    
  
  set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
  set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  

 
  
  select sum(ifnull(hrg_perolehan,0)), sum(hrg_rehab), sum(masa_manfaat),sum(ifnull(masa_manfaat_rehab,0))
    into penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_, penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ 
    from penyusutan where idbi = idbi_;    

  
   select tahun,(bulan+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,sisa_masa_manfaat 
    into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,sisa_masa_manfaat_
    from penyusutan where idbi = idbi_ order by id Desc limit 0,1;

  set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
  set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
  set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
  set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
 

   set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
   set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_/12-penambahan_masa_manfaat_rehab_prev_);
   set sisa_masa_manfaat_awl_=masa_manfaat_;
      
   
   if sisa_masa_manfaat_ = 1  then      
      set stop_ = 1;                 
   end if;    
    
   
   set i=0;
   
   set cek_=concat(cek_,'mm tot=',masa_manfaat_tot_,'mm=',masa_manfaat_);   


   while stop_ = 0 do
   
      
   
   
      
      if stop_ = 0 && masa_manfaat_ <= 0 then  
          set stop_ = 1; 
          set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
      elseif stop_ = 0 && thn_tgl_susut_ <= thn_susut_ak_ &&  bln_tgl_susut_ < bln_susut_ak_ then  
          set stop_ = 1; 
          set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
      
      elseif stop_ = 0 && thn_susut_ak_*12+bln_susut_ak_ > thn_mulai_susut_*12+bln_mulai_susut_+masa_manfaat_tot_-1 then
          set stop_ = 1; 
          set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
      end if;
      set sem_ = if(bln_susut_ak_ > 6, 2,1);       
      set cek_=concat(cek_,'thn susut=',thn_tgl_susut_,'thn susut ak=',thn_susut_ak_,' sisa masa manfaat=',sisa_masa_manfaat_,' masa manfaat=',masa_manfaat_,' bln=',bln_susut_ak_,' sem=',sem_);
    
     
      if stop_ = 0 then
           if thn_susut_ak_<=thn_tgl_susut_ then 
           
              
              select count(*) into jml_data_
              from penghapusan where year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_,'stop karena penghapusan');
              end if;        
              
              select count(*) into jml_data_
              from t_history_aset where year(tgl)=thn_susut_ak_ and month(tgl)=bln_susut_ak_ and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_ , 'stop karena pindah aset');
              end if;
              
              select count(*) into jml_data_
              from gantirugi where year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_ , 'stop karena ganti rugi');
              end if;          
              
              select count(*) into jml_data_
              from pemindahtanganan where year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_ and id_bukuinduk = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
              end if;             
           end if;
      end if;
                         
     
     
      set hrg_rehab_ = 0;   
      set masa_manfaat_rehab_ = 0;          
        
      
      select ifnull(sum(biaya_pemeliharaan),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from pemeliharaan where idbi_awal = idbi_ and year(tgl_pemeliharaan)*12+month(tgl_pemeliharaan) <= thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0)*12;
      
      select ifnull(sum(biaya_pengamanan),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from pengamanan where idbi_awal = idbi_ and year(tgl_pengamanan)*12+month(tgl_pengamanan) <= thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0)*12;
      
      select ifnull(sum(harga_hapus),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from penghapusan_sebagian where idbi_awal = idbi_ and year(tgl_penghapusan)*12+month(tgl_penghapusan) <= thn_susut_ak_*12+bln_susut_ak_;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0)*12;
      
      select ifnull(sum(harga_baru-harga),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from t_koreksi where idbi_awal = idbi_ and year(tgl)*12+month(tgl) <= thn_susut_ak_*12+bln_susut_ak_;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0)*12;
      
      select ifnull(sum(nilai_barang+nilai_barang_asal),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from penilaian where idbi_awal = idbi_ and year(tgl_penilaian)*12+month(tgl_penilaian) <= thn_susut_ak_*12+bln_susut_ak_;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0)*12;                
    
      
      set nilai_buku_ = jml_harga_bi_+hrg_rehab_;
      
      
      set masa_manfaat_tot_ =  masa_manfaat_+masa_manfaat_rehab_;
      
      
      set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
            
      
      set penambahan_hrg_rehab_ = hrg_rehab_-penambahan_hrg_rehab_prev_;      
 
      
      set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      

      
      set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_-penambahan_masa_manfaat_rehab_prev_;      

      
      
      if sisa_masa_manfaat_ = 0  then      
         set sisa_masa_manfaat_=sisa_masa_manfaat_awl_;      
      else
        set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_;            
      end if;    

      
      set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 

      
      set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
    
      set akum_harga_susut_=akum_harga_susut_+harga_susut_;
      set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
      set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             
      if stop_ = 0 then
          
          insert into penyusutan 
               (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
               residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,sisa_masa_manfaat)
               values
               (tgl_susut_, thn_susut_ak_, sem_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
               penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
               akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,sisa_masa_manfaat_); 
               
         set penambahan_nilai_buku_prev_ = nilai_buku_;         
         set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
         set penambahan_hrg_rehab_prev_ = hrg_rehab_;
         set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
         
         set update_bi = 1;
      set bln_susut_ak_=bln_susut_ak_+1;
      
      if bln_susut_ak_>12 then     
         set bln_susut_ak_=1;        
         set thn_susut_ak_=thn_susut_ak_+1;
      end if;
             
         if update_bi =1 then     
            update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                   bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
         end if;          
      end if;      
      set cek_=concat(cek_,' | hrg rehab=',hrg_rehab_,'\n');     
   end while;        

      
      
      

  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode3_bln_next`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN
  
  declare stop_ int;
  declare update_bi int;
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,2);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,2);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,2);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,2);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2); 
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_,jml_data_cek_ int;  
  declare jml_bln_ int;  
  
  declare cek_ longtext;    

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;
  
  set stop_ = 0;
  set cek_ = '';
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_
        from buku_induk where id = idbi_;
    
      
      if idbi_awal_ <> idbi_ then    
          select tgl_ba, tgl_buku
            into tgl_ba_, tgl_buku_
            from buku_induk where id = idbi_awal_;
      end if;      
    
       set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
     set bln_mulai_susut_ = if(  month(tgl_buku_) >  month(tgl_ba_) ,  month(tgl_buku_),month(tgl_ba_))+1;
      
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
        
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_ 
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,sisa_masa_manfaat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       if sisa_masa_manfaat_ = 1  then      
          set stop_ = 1;                 
       end if;   
    
       
       if sisa_masa_manfaat_ = 0 then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);
       end if;
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
       while stop_ = 0 do
          
       
       
        set cek_=concat(cek_,thn_tgl_susut_,'-',thn_susut_ak_,'-',bln_tgl_susut_,'-',bln_susut_ak_);   
       set cek_=concat(cek_,thn_susut_ak_*12+bln_susut_ak_,' - ',thn_mulai_susut_*12+bln_mulai_susut_+masa_manfaat_tot_-1);         
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
        
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);       
          set cek_=concat(cek_,'thn susut=',thn_tgl_susut_,'thn susut ak=',thn_susut_ak_,' sisa masa manfaat=',sisa_masa_manfaat_,' masa manfaat=',masa_manfaat_,' bln susut=',bln_tgl_susut_,' bln=',bln_susut_ak_,' sem=',sem_susut_ak_);
        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  from penghapusan where year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_+1 and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  select count(*) into jml_data_
                  from t_history_aset where year(tgl)=thn_susut_ak_ and month(tgl)=bln_susut_ak_+1 and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_ , 'stop karena pindah aset');
                  end if;
                  
                  select count(*) into jml_data_
                  from gantirugi where year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_+1 and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_+1 and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
           set cek_=concat(cek_,' | jml_data=',jml_data_cek_);
    
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
            
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_ and tambah_masamanfaat=1;  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
          select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0)*12;
          set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_ and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
                         
        
        
        if sisa_masa_manfaat_ = 0  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_-penambahan_hrg_rehab_prev_;      
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_-penambahan_masa_manfaat_rehab_prev_;      
    
          
          
          if akum_harga_susut_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             
    
          
    
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,sisa_masa_manfaat,bulan_awl)
                   values
                   (tgl_susut_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,sisa_masa_manfaat_,bln_susut_aw_);        
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;                 
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then      
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,sisa_masa_manfaat,bulan_awl)
                   values
                   (tgl_susut_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,sisa_masa_manfaat_,bln_susut_aw_);        
          
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;                 
          end if;
        end if;
               
        
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
          set update_bi = 1;

          if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=masa_manfaat_tot_/12, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;               
         end if;  

          set bln_susut_ak_=bln_susut_ak_+1;                     
          
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
          end if;            
               
          set cek_=concat(cek_,' | bln_susut_ak_=',bln_susut_ak_,'\n');     
       end while;          
    
            
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode3_thn`(idbi_ INT(11), tgl_susut_ DATE, uid_ VARCHAR(20), jns_trans2_ INT(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  DECLARE stop_ INT;
  DECLARE update_bi, con_thn_mulai_susut_, thn_mulai_susut_ INT;  
  DECLARE thn_tgl_susut_, sem_tgl_susut_ INT;
  DECLARE masa_manfaat_awl_,masa_manfaat_, persen_residu_ INT;  
  DECLARE masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ INT;  
  DECLARE thn_susut_ak_,thn_ke_ INT;
  DECLARE cek_thn_susut_ INT;
  DECLARE residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ INT;
  DECLARE tgl_buku_, tgl_ba_ DATE;  
  DECLARE masa_manfaat_brg_, residu_brg_ INT;  
  DECLARE jml_harga_bi_ DECIMAL(18,2);
  DECLARE nilai_buku_ DECIMAL(18,2);  
  DECLARE masa_manfaat_tot_ INT;  
  DECLARE harga_susut_ DECIMAL(18,2);
  DECLARE c1_,c_,d_,e_ CHAR(2);   
  DECLARE e1_ CHAR(3);
  DECLARE f_,g_,h_,i_ CHAR(2);  
  DECLARE j_ CHAR(3);
  DECLARE flama_,glama_,hlama_,ilama_ CHAR(2);  
  DECLARE jlama_ CHAR(3);  
  DECLARE staset_ INT;
  DECLARE penambahan_nilai_buku_, penambahan_hrg_rehab_ DECIMAL(18,2);
  DECLARE penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ INT;
  DECLARE penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ DECIMAL(18,2);
  DECLARE penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ INT;
  DECLARE tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ DECIMAL(18,2);  
  DECLARE nilai_perolehan_ DECIMAL(18,2); 
  DECLARE tot_manfaat_ INT;
  DECLARE hrg_rehab_ DECIMAL(18,2);
  DECLARE masa_manfaat_rehab_ INT;
  DECLARE sisa_masa_manfaat_,sisa_masa_manfaat_awl_ INT;  
  DECLARE akum_masa_manfaat_ INT;
  DECLARE akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ DECIMAL(18,2);   
  DECLARE jml_data_ INT;
  DECLARE cek_idlama_ INT;  
  DECLARE ket_ VARCHAR(255);
  DECLARE cek_ LONGTEXT;      
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  SET nilai_buku_ = 0;
  SET masa_manfaat_ = 0;
  SET masa_manfaat_tot_ = 0;
  SET masa_manfaat_awl_ = 0;
  SET masa_manfaat_rehab_ = 0;    
  SET persen_residu_ = 0;  
  SET con_thn_mulai_susut_ = 0;  
  SET thn_tgl_susut_ = YEAR(tgl_susut_);  
  SET sem_tgl_susut_ = 2;
  SET penambahan_nilai_buku_prev_ = 0;
  SET penambahan_hrg_rehab_prev_ = 0;
  SET penambahan_masa_manfaat_prev_ = 0;  
  SET penambahan_masa_manfaat_rehab_prev_ = 0;
  SET hrg_rehab_ = 0; 
  SET masa_manfaat_rehab_ = 0;    
  SET akum_nilai_buku_ = 0;
  SET akum_harga_susut_ = 0;  
  SET akum_stlh_susut_ = 0;
  SET akum_masa_manfaat_ = 0;  
  SET sisa_masa_manfaat_=0;  
  SET thn_ke_=1;
  
  SET stop_ = 0;
  SET cek_ = '';  
    
 
 SELECT idawal INTO idbi_awal_ FROM buku_induk WHERE id = idbi_; 
 IF idbi_awal_ IS NOT NULL THEN  
    

      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;

     
      SELECT nilai INTO con_thn_mulai_susut_ FROM setting WHERE Id = 'THN_MULAI_SUSUT';        
    
      
      SELECT IFNULL(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, IF(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset  
        INTO masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        FROM buku_induk WHERE id = idbi_;    

     
      IF idbi_awal_ <> idbi_ THEN    
          
          IF idbi_lama_ IS NOT NULL THEN              
             
             SELECT COUNT(*) INTO cek_idlama_ FROM penyusutan WHERE idbi = idbi_lama_;
              IF cek_idlama_ > 0 THEN                 
                  SELECT tgl_ba, tgl_buku
                    INTO tgl_ba_, tgl_buku_
                    FROM buku_induk WHERE id = idbi_lama_;                    
              ELSE
                  SELECT f,g,h,i,j INTO flama_,glama_,hlama_,ilama_,jlama_ 
                    FROM buku_induk WHERE id = idbi_lama_;       
                  IF flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) THEN                                    
                      SET tgl_ba_=tgl_ba_;    
                      SET tgl_buku_=tgl_buku_;                                                  
                  ELSE
                      SELECT tgl_ba, tgl_buku
                        INTO tgl_ba_, tgl_buku_
                        FROM buku_induk WHERE id = idbi_lama_;  
                  END IF;    
              END IF;                         
          ELSE 
              SELECT tgl_ba, tgl_buku
                INTO tgl_ba_, tgl_buku_
                FROM buku_induk WHERE id = idbi_awal_;
          END IF;      
      END IF;    

       SET tgl_ba_ = IF(tgl_ba_ IS NULL, '0000-00-00', tgl_ba_);  
      SET cek_=CONCAT(cek_,'tgl_ba_=',tgl_ba_,' | tgl_buku_=',tgl_buku_);
      
      
      SELECT masa_manfaat, residu INTO masa_manfaat_brg_, residu_brg_
        FROM  ref_barang WHERE f= f_ AND g=g_ AND h=h_ AND i= i_ AND j=j_;
    
      
      IF masa_manfaat_bi_ = NULL OR masa_manfaat_bi_ = 0 THEN  
         SET masa_manfaat_ = masa_manfaat_brg_;     
         SET persen_residu_ = residu_brg_;     
      ELSE   
         SET masa_manfaat_ = masa_manfaat_bi_;     
         SET persen_residu_ = residu_bi_;         
      END IF;
      
      
      SET thn_mulai_susut_ = IF( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      SET thn_susut_ak_ = IF( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     




      
      SELECT SUM(IFNULL(hrg_perolehan,0)), SUM(masa_manfaat)
        INTO penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        FROM penyusutan WHERE idbi = idbi_ AND id_koreksi=0;    
    
      
       SELECT (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        INTO thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        FROM penyusutan WHERE idbi = idbi_ AND id_koreksi=0 ORDER BY id DESC LIMIT 0,1;
    
      SET penambahan_nilai_buku_prev_ = IF(penambahan_nilai_buku_prev_ IS NULL, 0, penambahan_nilai_buku_prev_);  
      SET penambahan_hrg_rehab_prev_ = IF(penambahan_hrg_rehab_prev_ IS NULL, 0, penambahan_hrg_rehab_prev_);  
      SET penambahan_masa_manfaat_prev_ = IF(penambahan_masa_manfaat_prev_ IS NULL, 0, penambahan_masa_manfaat_prev_);  
      SET penambahan_masa_manfaat_rehab_prev_ = IF(penambahan_masa_manfaat_rehab_prev_ IS NULL, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       SET masa_manfaat_tot_ = IF(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       SET nilai_buku_ = IF(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       SET masa_manfaat_ = masa_manfaat_tot_;
       SET sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       
       
       
        
       WHILE stop_ = 0 DO
    
       
       SET cek_=CONCAT(cek_,'thn susut ak=',thn_susut_ak_,'thn mulai susut=',thn_mulai_susut_+masa_manfaat_tot_-1,' ',masa_manfaat_tot_);   
          
          IF stop_ = 0 && masa_manfaat_ <= 0 THEN  
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena masa manfaat belum di set ');
          ELSEIF stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ THEN  
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          ELSEIF stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              SET stop_ = 1; 
              SET cek_ = CONCAT(cek_ , 'stop karena tanggal susut > umur ekoknomis barang');
          END IF; 
          IF stop_ = 0 THEN
               IF thn_susut_ak_<=thn_tgl_susut_ THEN 
               
                  
                  SELECT COUNT(*) INTO jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_,'stop karena penghapusan');
                  END IF;        
                  
                  
                  
                  SELECT COUNT(*) INTO jml_data_
                  
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena ganti rugi');
                  END IF;          
                  
                  SELECT COUNT(*) INTO jml_data_
                  
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  IF jml_data_ > 0 THEN 
                     SET stop_ = 1;             
                     SET cek_ = CONCAT(cek_ , 'stop karena pemindahtanganan');
                  END IF;              
               END IF;
          END IF;
          SET cek_=CONCAT(cek_,'thn susut ak=',thn_susut_ak_,'thn susut=',thn_mulai_susut_+masa_manfaat_tot_-1); 
                            
         
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          SET hrg_rehab_ = 0;   
          SET masa_manfaat_rehab_ = 0;          

          IF thn_susut_ak_ <=2014 THEN 
             IF akum_masa_manfaat_ = '' THEN
                  
                  SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                    FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                    and tgl_pemeliharaan <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014 
                    and tambah_aset=1; 
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                    FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                    and tgl_pengamanan <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                    FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                    and tgl_penghapusan <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                    FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                    and tgl <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
                  
                  SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                    FROM penilaian WHERE idbi_awal = idbi_awal_ 
                    and tgl_penilaian <= tgl_susut2_ 
                    AND YEAR(tgl_perolehan) <= 2014;
                  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
                  SET masa_manfaat_rehab_ = 0;  
                  
             ELSE             
                  SET masa_manfaat_rehab_ = 0; 
                  SET hrg_rehab_ = 0;                              
             END IF;                            
          ELSE          
		  
		  SELECT IFNULL(SUM(biaya_pemeliharaan),0)
		  INTO tot_rehab_aset_
		    FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
            and tgl_pemeliharaan <= tgl_susut2_ 
            AND YEAR(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
		  
		  
		  
		  
		             
		  IF tot_rehab_aset_ <> 0 THEN
			  if akum_masa_manfaat_ = '' then
                     set masa_manfaat_rehab_ = 0;            
              elseIF akum_stlh_susut_ = 0 and akum_masa_manfaat_ <> '' THEN    
			     
			     
			     SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;                 
                 SET ket_ = 'sesuai kebijakan 7.(a) jika nilai buku = 0, maka Penambahan masa manfaat sama dengan masa manfaat perolehan awal aset tetap';
			     
			  ELSEIF tot_rehab_aset_ > akum_stlh_susut_ THEN 
			     
			     
			     SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;                     
                 SET ket_ = 'sesuai kebijakan 7.(c) Jika realisasi Belanja melebihi nilai perolehan terakhir ';                 
              ELSEIF thn_susut_ak_= 2015 then 
                     set masa_manfaat_rehab_ = 0;  
 			  ELSE          
			     SELECT sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_aset_,akum_stlh_susut_) INTO masa_manfaat_rehab_;          
			     IF (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_ THEN
				 
				 
				 SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;
                 SET ket_ = 'sesuai kebijakan 7.(d) d.	Jika hasil perhitungan penambahan masa manfaat ditambah dengan sisa manfaat melebihi masa manfaat awal aset tetap'; 
			     ELSE
				 SET masa_manfaat_rehab_ = masa_manfaat_rehab_;                
			     END IF;      
			  END IF;
		   END IF;       
		      
		  SET hrg_rehab_ = IFNULL(tot_rehab_aset_,0);
		  SET masa_manfaat_rehab_ = IFNULL(masa_manfaat_rehab_,0);
		  
	  
		  
		  SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
		    FROM pengamanan WHERE idbi_awal = idbi_awal_ 
            and tgl_pengamanan <= tgl_susut2_ 
            AND YEAR(tgl_perolehan)=thn_susut_ak_ AND tambah_aset=1;
		  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
		  
		  
		  SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
		    FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
            and tgl_penghapusan <= tgl_susut2_ 
            AND YEAR(tgl_perolehan)=thn_susut_ak_;
		  SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
		  
		  
		  SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
		    FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
            and tgl <= tgl_susut2_ 
            AND YEAR(tgl_perolehan)=thn_susut_ak_;
		  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
		  
		  
		  SELECT IFNULL(SUM(nilai_barang-nilai_barang_asal),0) INTO tot_rehab_
		    FROM penilaian WHERE idbi_awal = idbi_awal_ 
            and tgl_penilaian <= tgl_susut2_ 
            AND YEAR(tgl_perolehan)=thn_susut_ak_;
		  SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
		  
	END IF;				
        
                    
         IF akum_masa_manfaat_ = 0  THEN       
              
              SET nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              SET masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          ELSE          
              
              SET nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              SET masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          END IF; 
          
          
          SET penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          SET penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          SET penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          SET penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          IF akum_masa_manfaat_ = ''  THEN      
             SET sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          ELSEIF sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 THEN          
             SET sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          ELSEIF sisa_masa_manfaat_ = 0 THEN          
             SET sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          ELSE
            SET sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          END IF;     
    
          
          SET akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          SET harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);           
          SET akum_harga_susut_=akum_harga_susut_+harga_susut_;
          SET akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_;           
          IF stop_ = 0 THEN
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
              
              INSERT INTO penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   VALUES
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, NOW(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);   
                   
             SET penambahan_nilai_buku_prev_ = nilai_buku_;         
             SET penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             SET penambahan_hrg_rehab_prev_ = hrg_rehab_;
             SET penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             SET update_bi = 1;
             SET thn_susut_ak_ = thn_susut_ak_+1;         
             SET ket_ = "";
             
             SET thn_ke_=thn_ke_+1;
                
             IF update_bi =1 THEN     
                UPDATE buku_induk SET masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 WHERE id=idbi_;               
             END IF;          
          END IF;
          SET cek_=CONCAT(cek_,' | stop=',stop_,'\n');     
          
          
       END WHILE;
   ELSE
       SET cek_='idbi NULL';   
   END IF;

  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode3_thn_20161209`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  declare stop_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c_,d_,e_ char(2);   
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_ longtext;    

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;
  
  set stop_ = 0;
  set cek_ = '';  
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset  
        into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     




      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 and id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       if sisa_masa_manfaat_ = 1  then      
          set stop_ = 1;                 
       end if;    
        
       while stop_ = 0 do
    
       
       set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn mulai susut=',thn_mulai_susut_+masa_manfaat_tot_-1,' ',masa_manfaat_tot_);   
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > umur ekoknomis barang');
          end if; 
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  from penghapusan where year(tgl_penghapusan)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  select count(*) into jml_data_
                  from t_history_aset where year(tgl)=thn_susut_ak_ and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pindah aset');
                  end if;
                  
                  select count(*) into jml_data_
                  from gantirugi where year(tgl_gantirugi)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where year(tgl_pemindahtanganan)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn susut=',thn_mulai_susut_+masa_manfaat_tot_-1); 
                            
         
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
          
          
          
          
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1;  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
          select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
        
                    
         if sisa_masa_manfaat_ = 0  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if akum_harga_susut_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;     
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          
          if stop_ = 0 then
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2)
                   values
                   (tgl_susut_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_);   
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             end if;          
          end if;
          set cek_=concat(cek_,' | stop=',stop_,'\n');     
          
          
       end while;
   else
       set cek_='idbi NULL';   
   end if;

  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode3_thn_bck`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN
  
  declare stop_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_ decimal(18,2);
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_ longtext;    

  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 2010;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;
  
  set stop_ = 0;
  set cek_ = '';  
 
    
  
  select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal 
    into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_
    from buku_induk where id = idbi_;    
  
  
  select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
    from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;

  
  if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
     set masa_manfaat_ = masa_manfaat_brg_;     
     set persen_residu_ = residu_brg_;     
  else   
     set masa_manfaat_ = masa_manfaat_bi_;     
     set persen_residu_ = residu_bi_;         
  end if;
  
  
  set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
  
  
  set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  

 
  
  select sum(ifnull(hrg_perolehan,0)), sum(hrg_rehab), sum(masa_manfaat),sum(ifnull(masa_manfaat_rehab,0))
    into penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_, penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ 
    from penyusutan where idbi = idbi_;    

  
   select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,sisa_masa_manfaat 
    into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,sisa_masa_manfaat_
    from penyusutan where idbi = idbi_ order by id Desc limit 0,1;

  set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
  set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
  set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
  set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
 

   set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
   set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_-penambahan_masa_manfaat_rehab_prev_);
   set sisa_masa_manfaat_awl_=masa_manfaat_;
      
   
   if sisa_masa_manfaat_ = 1  then      
      set stop_ = 1;                 
   end if;    
    
   while stop_ = 0 do

   
   
      
      if stop_ = 0 && masa_manfaat_ <= 0 then  
          set stop_ = 1; 
          set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
      elseif stop_ = 0 && thn_tgl_susut_ <= thn_susut_ak_ then  
          set stop_ = 1; 
          set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
      elseif stop_ = 0 && thn_susut_ak_ > thn_mulai_susut_+masa_manfaat_tot_-1 then
          set stop_ = 1; 
          set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');
      end if; 
      if stop_ = 0 then
           if thn_susut_ak_<=thn_tgl_susut_ then 
           
              
              select count(*) into jml_data_
              from penghapusan where year(tgl_penghapusan)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_,'stop karena penghapusan');
              end if;        
              
              select count(*) into jml_data_
              from t_history_aset where year(tgl)=thn_susut_ak_ and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_ , 'stop karena pindah aset');
              end if;
              
              select count(*) into jml_data_
              from gantirugi where year(tgl_gantirugi)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_ , 'stop karena ganti rugi');
              end if;          
              
              select count(*) into jml_data_
              from pemindahtanganan where year(tgl_pemindahtanganan)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
              end if;              
           end if;
      end if;
      set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn susut=',thn_mulai_susut_+masa_manfaat_tot_-1); 
                        
     
     
      set hrg_rehab_ = 0;   
      set masa_manfaat_rehab_ = 0;          
        
      
      select ifnull(sum(biaya_pemeliharaan),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from pemeliharaan where idbi_awal = idbi_ and year(tgl_pemeliharaan)<=thn_susut_ak_ and tambah_aset=1;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);
      
      select ifnull(sum(biaya_pengamanan),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from pengamanan where idbi_awal = idbi_ and year(tgl_pengamanan)<=thn_susut_ak_ and tambah_aset=1;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);
      
      select ifnull(sum(harga_hapus),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from penghapusan_sebagian where idbi_awal = idbi_ and year(tgl_penghapusan)<=thn_susut_ak_;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);
      
      select ifnull(sum(harga_baru-harga),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from t_koreksi where idbi_awal = idbi_ and year(tgl)<=thn_susut_ak_;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);
      
      select ifnull(sum(nilai_barang+nilai_barang_asal),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from penilaian where idbi_awal = idbi_ and year(tgl_penilaian)<=thn_susut_ak_;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);                
    
      
      set nilai_buku_ = jml_harga_bi_+hrg_rehab_;
      
      
      set masa_manfaat_tot_ =  masa_manfaat_+masa_manfaat_rehab_;
      
      
      set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
            
      
      set penambahan_hrg_rehab_ = hrg_rehab_-penambahan_hrg_rehab_prev_;      
 
      
      set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      

      
      set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_-penambahan_masa_manfaat_rehab_prev_;      

      
      
      if sisa_masa_manfaat_ = 0  then      
         set sisa_masa_manfaat_=sisa_masa_manfaat_awl_;      
      else
        set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_;            
      end if;    

      
      set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 

      
      set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      

      
      set akum_harga_susut_=akum_harga_susut_+harga_susut_;
      set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
      
      if stop_ = 0 then
          
          insert into penyusutan 
               (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
               residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,sisa_masa_manfaat)
               values
               (tgl_susut_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
               penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
               akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,sisa_masa_manfaat_); 
               
         set penambahan_nilai_buku_prev_ = nilai_buku_;         
         set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
         set penambahan_hrg_rehab_prev_ = hrg_rehab_;
         set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
         
         set update_bi = 1;
         set thn_susut_ak_ = thn_susut_ak_+1;
            
         if update_bi =1 then     
            update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                   bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
         end if;          
      end if;
      set cek_=concat(cek_,' | stop=',stop_,'\n');     
      
      
   end while;

  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode3_thn_next`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  declare stop_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_ longtext;    

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;
  
  set stop_ = 0;
  set cek_ = '';  
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal 
        into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_)+1;
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     




      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       if sisa_masa_manfaat_ = 1  then      
          set stop_ = 1;                 
       end if;    
        
       while stop_ = 0 do
    
       
       set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn mulai susut=',thn_mulai_susut_+masa_manfaat_tot_-1,' ',masa_manfaat_tot_);   
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');
          end if; 
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  from penghapusan where year(tgl_penghapusan)=thn_susut_ak_-1 and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  select count(*) into jml_data_
                  from t_history_aset where year(tgl)=thn_susut_ak_-1 and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pindah aset');
                  end if;
                  
                  select count(*) into jml_data_
                  from gantirugi where year(tgl_gantirugi)=thn_susut_ak_-1 and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where year(tgl_pemindahtanganan)=thn_susut_ak_-1 and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn susut=',thn_mulai_susut_+masa_manfaat_tot_-1); 
                            
         
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
          
          
          
          
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1;  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
          select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);    
        
                    
         if sisa_masa_manfaat_ = 0  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if akum_harga_susut_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
          
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          
          if stop_ = 0 then
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat)
                   values
                   (tgl_susut_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1); 
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             end if;          
          end if;
          set cek_=concat(cek_,' | stop=',stop_,'\n');     
          
          
       end while;
   else
       set cek_='idbi NULL';   
   end if;

  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode4`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ INT(11) ) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN
    
  
  
  
  

  declare stop_ int;
  declare update_bi int;
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, bln_susut_ak_, sem_susut_ak_, thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int;
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);    
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,2);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,2);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,2);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2); 
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_, sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);  
  declare jml_susut_ int; 
  declare jml_data_,jml_data_cek_ int;  
  declare jml_bln_ int;
  declare cek_idlama_ int;  
  
  declare cek_ longtext;   
  declare tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set stop_ = 0;
  set cek_ = '';
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set thn_ke_=1;      
  set jml_susut_ = 0;
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
        
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_,f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;
 
 set cek_ = concat(cek_, ' dar buku_induk,  bln_susut_ak_bi_=' , bln_susut_ak_bi_, ' sem_susut_ak_bi_=', sem_susut_ak_bi_, '\n');   
    
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05 || f_= 07) then   
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;      
      set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         if masa_manfaat_brg_ <> '' then
             set masa_manfaat_ = masa_manfaat_brg_*2;      
             set persen_residu_ = residu_brg_;     
         else
             set masa_manfaat_ = 0;      
             set persen_residu_ = 0; 
         end if;        
      else   
         set masa_manfaat_ = masa_manfaat_bi_*2;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_ba_) <> 0 ,  month(tgl_ba_),month(tgl_buku_));
      
 set cek_ = concat(cek_, ' dari tgl buku atau tgl ba, bln_mulai_susut_=' , bln_mulai_susut_,  '\n');
      
      
         set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;         
      
         if sem_mulai_susut_ = 2 and jml_susut_>0 then 
            set sem_mulai_susut_ = 1;                    
         else
            set sem_mulai_susut_ = sem_mulai_susut_;  
         end if;         

      
      
      
        
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      
      set sem_susut_ak_ = if( sem_susut_ak_bi_ > sem_mulai_susut_,sem_susut_ak_bi_,sem_mulai_susut_);    
  set cek_ = concat(cek_, ' sem_susut_ak_bi_=' , sem_susut_ak_bi_, ' sem_mulai_susut_=', sem_mulai_susut_ , ' sem_susut_ak_=', sem_susut_ak_, '\n');    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat), count(*)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_ , jml_susut_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,sem,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn 
        into thn_susut_ak_,bln_susut_ak_,sem_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;
 set cek_ = concat(cek_, ' sisa_masa_manfaat_=' , sisa_masa_manfaat_, '\n');        
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_*2);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
       set sisa_masa_manfaat_thn_=sisa_masa_manfaat_awl_/2;          
       
       
       
       
    
       
       
       if jml_susut_ = 0 or jml_susut_ = null or jml_susut_ = '' then 
             set thn_susut_ak_=thn_susut_ak_;         
             set sem_susut_ak_ = sem_susut_ak_;                        
             set masa_manfaat_ = masa_manfaat_; 
       
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 or (sisa_masa_manfaat_ = 0 && (f_ = '03' or f_ = '04')) then 
           set sem_susut_ak_=sem_susut_ak_+1;
           if sem_susut_ak_>2 then     
             set sem_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_tot_);           
                      
           
           if sem_susut_ak_ = 2 then
               set sisa_masa_manfaat_ = (sisa_masa_manfaat_*2);      
           else   
               set sisa_masa_manfaat_ = (sisa_masa_manfaat_*2)-1;     
               if sisa_masa_manfaat_ <0 then
                  set sisa_masa_manfaat_ = 0;
               end if;                        
           end if;
           set sisa_masa_manfaat_thn_ = sisa_masa_manfaat_thn_/2;   
       end if;       
 set cek_ = concat(cek_, ' 2. sisa_masa_manfaat_=' , sisa_masa_manfaat_, '\n');      
      
       if sem_susut_ak_ = 2 then       
          set bln_susut_aw_ = 7;
          set bln_susut_ak_ = 12;
       else       
          set bln_susut_aw_ = 1;
          set bln_susut_ak_ = 6;
       end if; 
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;
      
      
       while stop_ = 0 do
          
       
       
      
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif thn_tgl_susut_*2 + sem_tgl_susut_ <  thn_susut_ak_*2 + if(akum_harga_susut_ = '' && (sem_mulai_susut_ <> if(bln_mulai_susut_ >6 , 2, 1)),if(bln_mulai_susut_ >6 , 2, 1),sem_susut_ak_) then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
        
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');              
          elseif stop_=0 && tgl_susut_ < tgl_buku_ then          
               set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena Tanggal Penyusutan < Tanggal Buku!');   
          end if;
          
          
        
         
         if stop_ = 0 then 
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and if(month(tgl_penghapusan)>=1 and month(tgl_penghapusan)<=6,1,2)=sem_susut_ak_) or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;         
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and if(month(tgl_gantirugi)>=1 and month(tgl_gantirugi)<=6,1,2)=sem_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and if(month(tgl_pemindahtanganan)>=1 and month(tgl_pemindahtanganan)<=6,1,2)=sem_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
          
    
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;    
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
		  
          
          if akum_masa_manfaat_ = '' then 
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) <= thn_susut_ak_*2+sem_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) <= thn_susut_ak_*2+sem_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) <= thn_susut_ak_*2+sem_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) <= thn_susut_ak_*2+sem_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) <= thn_susut_ak_*2+sem_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else		    
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
              
              into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_ 
                and tgl_pemeliharaan <= tgl_susut2_
    			and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_ and tambah_aset=1; 
              
    		  set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,'\n');
    		  
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_    
                 and tgl_pemeliharaan <= tgl_susut2_ 
    			and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) < thn_susut_ak_*2+sem_susut_ak_ and tambah_masamanfaat=1;  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0)*2;
              set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,
    		  	' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_             
                and tgl_pengamanan <= tgl_susut2_
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_             
                and tgl_penghapusan <= tgl_susut2_
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_             
                and tgl <= tgl_susut2_
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_             
                and tgl_penilaian <= tgl_susut2_
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);   
         end if;           
        
  
        
        if akum_masa_manfaat_ = ''  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
        


          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
set cek_=concat(cek_,' | 3. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');  
          set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/2);     
          
          
          
          if jml_susut_ = 0 or jml_susut_ = null or jml_susut_ = '' then     
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif akum_nilai_buku_ = 0 then          
             if sem_susut_ak_ = 2 then
               select sum(hrg_perolehan), (sum(masa_manfaat)*2)-((((max(tahun)+1)-thn_mulai_susut_)*2)-1) into akum_nilai_buku_, sisa_masa_manfaat_ 
               from penyusutan where idbi=idbi_ and id_koreksi=0;    
               set cek_=concat(cek_,' | 3a. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');               
             else   
               select sum(hrg_perolehan), (sum(masa_manfaat)*2)-(((max(tahun)+1)-thn_mulai_susut_)*2) into akum_nilai_buku_, sisa_masa_manfaat_ 
               from penyusutan where idbi=idbi_ and id_koreksi=0;     
               set cek_=concat(cek_,' | 3b. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');              
             end if;
             set sisa_masa_manfaat_=sisa_masa_manfaat_+penambahan_masa_manfaat_;      
             set cek_=concat(cek_,' | 3c. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');              
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
             set cek_=concat(cek_,' | 3d. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');   
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
            set cek_=concat(cek_,' | 3e. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');           
          end if;    

 set cek_=concat(cek_,' |4. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');         
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          if jml_susut_>0 or sem_susut_ak_=1 then
             set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;                   
          else   
             set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/(sisa_masa_manfaat_/2); 
          end if;
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             

          
           if sem_susut_ak_ = 2 then       
              set bln_susut_aw_ = 7;
              set bln_susut_ak_ = 12;
           else       
              set bln_susut_aw_ = 1;
              set bln_susut_ak_ = 6;
           end if;    
             
          if stop_ = 0 then
    			set cek_=concat(cek_,' | insert susut thn_susut_ak_=',thn_susut_ak_, ' sem_susut_ak_=', sem_susut_ak_, '\n');    
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,
                   hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,
                   akum_masa_manfaat,thn_ke,
                   sisa_masa_manfaat,
                   
                   sisa_masa_manfaat_thn, stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,bulan_awl, id_koreksi_tambah)
                   values                   

                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_/2, penambahan_masa_manfaat_rehab_/2, 
                   persen_residu_, akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,
                   masa_manfaat_tot_/2,thn_ke_,
                   if(sem_susut_ak_=2 && sisa_masa_manfaat_ <> 0 && jml_susut_ > 0, (sisa_masa_manfaat_+1)/2,sisa_masa_manfaat_/2) ,                    
                   if(sem_susut_ak_=2 && sisa_masa_manfaat_ <> 0 && jml_susut_ > 0, (sisa_masa_manfaat_+1)/2 ,sisa_masa_manfaat_/2),                    
                   
                   
                                    
                  
                  1,
                   
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,bln_susut_aw_,id_koreksi_);           
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
          
             if sem_susut_ak_ > 1 and jml_susut_ =0 then                          
                set sisa_masa_manfaat_= sisa_masa_manfaat_-1;
             end if;
              set sem_susut_ak_ = sem_susut_ak_+1;         
              if sem_susut_ak_>2 then     
                 set sem_susut_ak_=1;        
                 set thn_susut_ak_=thn_susut_ak_+1;         
                 set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
                 
                 set thn_ke_=thn_ke_+1;
              end if;
              
  set cek_=concat(cek_,' |5. after insert sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');               
    
              if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_/2, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_susut_aw_ where id=idbi_;               
              end if; 
              set jml_susut_ = jml_susut_+1; 
         end if;      
          set cek_=concat(cek_,' | bln_susut_ak_=',bln_susut_ak_,'\n');     
       end while;          
    
            
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode4_20170305`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN
    
  
  

  declare stop_ int;
  declare update_bi int;
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, bln_susut_ak_, sem_susut_ak_, thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int;
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,2);
  declare c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);    
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,2);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,2);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,2);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2); 
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_, sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_,jml_data_cek_ int;  
  declare jml_bln_ int;  
  declare cnt_penyusutan int;
  declare cek_idlama_ int;  
  
  declare cek_ longtext;    

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set stop_ = 0;
  set cek_ = '';
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set thn_ke_=1;    
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_,f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;
    
    
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;      
      set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         if masa_manfaat_brg_ <> '' then
             set masa_manfaat_ = masa_manfaat_brg_*2;      
             set persen_residu_ = residu_brg_;     
         else
             set masa_manfaat_ = 0;      
             set persen_residu_ = 0; 
         end if;        
      else   
         set masa_manfaat_ = masa_manfaat_bi_*2;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_buku_) <> 0 ,  month(tgl_buku_),month(tgl_ba_));
      
      
         set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;         
         if sem_mulai_susut_ = 2 then 
            set sem_mulai_susut_ = 1;                    
         else
            set sem_mulai_susut_ = sem_mulai_susut_;      
         end if;
      
      
      
        
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      
      set sem_susut_ak_ = if( sem_susut_ak_bi_ > sem_mulai_susut_,sem_susut_ak_bi_,sem_mulai_susut_);    
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_ 
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,sem,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn 
        into thn_susut_ak_,bln_susut_ak_,sem_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;

      
      select count(*) into cnt_penyusutan from penyusutan where idbi=idbi_ and id_koreksi=0;   
          
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_*2);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
       set sisa_masa_manfaat_thn_=sisa_masa_manfaat_awl_/2;          
       
       
       
       
    
       
       if cnt_penyusutan = 0 then 
             set thn_susut_ak_=thn_susut_ak_;         
             set sem_susut_ak_ = sem_susut_ak_;                        
             set masa_manfaat_ = masa_manfaat_; 
       
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 or (sisa_masa_manfaat_ = 0 && (f_ = '03' or f_ = '04')) then 
           set sem_susut_ak_=sem_susut_ak_+1;
           if sem_susut_ak_>2 then     
             set sem_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_tot_);           
                      
           
           if sem_susut_ak_ = 2 then
               set sisa_masa_manfaat_ = (sisa_masa_manfaat_*2);           
           else   
               set sisa_masa_manfaat_ = (sisa_masa_manfaat_*2)-1;                              
           end if;
           set sisa_masa_manfaat_thn_ = sisa_masa_manfaat_thn_/2;
       end if;       
      
      
       if sem_susut_ak_ = 2 then       
          set bln_susut_aw_ = 7;
          set bln_susut_ak_ = 12;
       else       
          set bln_susut_aw_ = 1;
          set bln_susut_ak_ = 6;
       end if; 
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
       while stop_ = 0 do
          
       
       
      
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif thn_tgl_susut_*2 + sem_tgl_susut_ <  thn_susut_ak_*2 + if(akum_harga_susut_ = '' && (sem_mulai_susut_ <> if(bln_mulai_susut_ >6 , 2, 1)),if(bln_mulai_susut_ >6 , 2, 1),sem_susut_ak_) then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
        
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          
          
        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and if(month(tgl_penghapusan)>=1 and month(tgl_penghapusan)<=6,1,2)=sem_susut_ak_) or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  select count(*) into jml_data_
                  
                  from t_history_aset where ((year(tgl)=thn_susut_ak_ and if(month(tgl)>=1 and month(tgl)<=6,1,2)=sem_susut_ak_) or tgl_susut_>=tgl) and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_ , 'stop karena pindah aset');
                  end if;
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and if(month(tgl_gantirugi)>=1 and month(tgl_gantirugi)<=6,1,2)=sem_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and if(month(tgl_pemindahtanganan)>=1 and month(tgl_pemindahtanganan)<=6,1,2)=sem_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
          
    
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
            
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) < thn_susut_ak_*2+sem_susut_ak_ and tambah_masamanfaat=1;  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
          select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0)*2;
          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_awal_ and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_awal_ and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_awal_ and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_awal_ and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);            
        
        
        if cnt_penyusutan = 0  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
        


          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
          set cek_=concat(cek_,' | sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');  
          set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/2);     
          
          
          if cnt_penyusutan = 0 then       
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif akum_nilai_buku_ = 0 then          
             if sem_susut_ak_ = 2 then
               select sum(hrg_perolehan), (sum(masa_manfaat)*2)-((((max(tahun)+1)-thn_mulai_susut_)*2)-1) into akum_nilai_buku_, sisa_masa_manfaat_ 
               from penyusutan where idbi=idbi_;                  
             else   
               select sum(hrg_perolehan), (sum(masa_manfaat)*2)-(((max(tahun)+1)-thn_mulai_susut_)*2) into akum_nilai_buku_, sisa_masa_manfaat_ 
               from penyusutan where idbi=idbi_;                  
             end if;
             set sisa_masa_manfaat_=sisa_masa_manfaat_+penambahan_masa_manfaat_;                 
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    

          set cek_=concat(cek_,' | sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');         
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             

          
           if sem_susut_ak_ = 2 then       
              set bln_susut_aw_ = 7;
              set bln_susut_ak_ = 12;
           else       
              set bln_susut_aw_ = 1;
              set bln_susut_ak_ = 6;
           end if;    
            
          if stop_ = 0 then
    
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,bulan_awl, id_koreksi_tambah)
                   values
                   (tgl_susut_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_/2, penambahan_masa_manfaat_rehab_/2, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_/2,thn_ke_,if(sem_susut_ak_=2 && sisa_masa_manfaat_ <> 0,(sisa_masa_manfaat_+1)/2,sisa_masa_manfaat_/2),if(sem_susut_ak_=2 && sisa_masa_manfaat_ <> 0,(sisa_masa_manfaat_+1)/2,sisa_masa_manfaat_/2),1,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,bln_susut_aw_, id_koreksi_);           
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
          
              if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_/2, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                       bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_susut_aw_ where id=idbi_;               
              end if;  

              set sem_susut_ak_ = sem_susut_ak_+1;         
              if sem_susut_ak_>2 then     
                 set sem_susut_ak_=1;        
                 set thn_susut_ak_=thn_susut_ak_+1;         
                 set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
                 
                 set thn_ke_=thn_ke_+1;
              end if;              

              set cnt_penyusutan = cnt_penyusutan+1;             
    

         end if;      
          set cek_=concat(cek_,' | bln_susut_ak_=',bln_susut_ak_,'\n');     
       end while;          
    
            
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode4_20180115`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ INT(11) ) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN
    
  
  
  
  

  declare stop_ int;
  declare update_bi int;
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, bln_susut_ak_, sem_susut_ak_, thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int;
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);    
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,2);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,2);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,2);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2); 
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_, sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);  
  declare jml_susut_ int; 
  declare jml_data_,jml_data_cek_ int;  
  declare jml_bln_ int;
  declare cek_idlama_ int;  
  
  declare cek_ longtext;   
  declare tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set stop_ = 0;
  set cek_ = '';
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set thn_ke_=1;      
  set jml_susut_ = 0;
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
        
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_,f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;
 
 set cek_ = concat(cek_, ' dar buku_induk,  bln_susut_ak_bi_=' , bln_susut_ak_bi_, ' sem_susut_ak_bi_=', sem_susut_ak_bi_, '\n');   
    
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05 || f_= 07) then   
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;      
      set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         if masa_manfaat_brg_ <> '' then
             set masa_manfaat_ = masa_manfaat_brg_*2;      
             set persen_residu_ = residu_brg_;     
         else
             set masa_manfaat_ = 0;      
             set persen_residu_ = 0; 
         end if;        
      else   
         set masa_manfaat_ = masa_manfaat_bi_*2;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_buku_) <> 0 ,  month(tgl_buku_),month(tgl_ba_));      
 set cek_ = concat(cek_, ' dari tgl buku atau tgl ba, bln_mulai_susut_=' , bln_mulai_susut_,  '\n');
      
      
         set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;         
      
         if sem_mulai_susut_ = 2 and jml_susut_>0 then 
            set sem_mulai_susut_ = 1;                    
         else
            set sem_mulai_susut_ = sem_mulai_susut_;  
         end if;         

      
      
      
        
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      
      set sem_susut_ak_ = if( sem_susut_ak_bi_ > sem_mulai_susut_,sem_susut_ak_bi_,sem_mulai_susut_);    
  set cek_ = concat(cek_, ' sem_susut_ak_bi_=' , sem_susut_ak_bi_, ' sem_mulai_susut_=', sem_mulai_susut_ , ' sem_susut_ak_=', sem_susut_ak_, '\n');    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat), count(*)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_ , jml_susut_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,sem,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn 
        into thn_susut_ak_,bln_susut_ak_,sem_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;
 set cek_ = concat(cek_, ' sisa_masa_manfaat_=' , sisa_masa_manfaat_, '\n');        
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_*2);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
       set sisa_masa_manfaat_thn_=sisa_masa_manfaat_awl_/2;          
       
       
       
       
    
       
       
       if jml_susut_ = 0 or jml_susut_ = null or jml_susut_ = '' then 
             set thn_susut_ak_=thn_susut_ak_;         
             set sem_susut_ak_ = sem_susut_ak_;                        
             set masa_manfaat_ = masa_manfaat_; 
       
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 or (sisa_masa_manfaat_ = 0 && (f_ = '03' or f_ = '04')) then 
           set sem_susut_ak_=sem_susut_ak_+1;
           if sem_susut_ak_>2 then     
             set sem_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_tot_);           
                      
           
           if sem_susut_ak_ = 2 then
               set sisa_masa_manfaat_ = (sisa_masa_manfaat_*2);      
           else   
               set sisa_masa_manfaat_ = (sisa_masa_manfaat_*2)-1;     
               if sisa_masa_manfaat_ <0 then
                  set sisa_masa_manfaat_ = 0;
               end if;                        
           end if;
           set sisa_masa_manfaat_thn_ = sisa_masa_manfaat_thn_/2;   
       end if;       
 set cek_ = concat(cek_, ' 2. sisa_masa_manfaat_=' , sisa_masa_manfaat_, '\n');      
      
       if sem_susut_ak_ = 2 then       
          set bln_susut_aw_ = 7;
          set bln_susut_ak_ = 12;
       else       
          set bln_susut_aw_ = 1;
          set bln_susut_ak_ = 6;
       end if; 
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;
      
      
       while stop_ = 0 do
          
       
       
      
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif thn_tgl_susut_*2 + sem_tgl_susut_ <  thn_susut_ak_*2 + if(akum_harga_susut_ = '' && (sem_mulai_susut_ <> if(bln_mulai_susut_ >6 , 2, 1)),if(bln_mulai_susut_ >6 , 2, 1),sem_susut_ak_) then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
        
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');              
          elseif stop_=0 && tgl_susut_ < tgl_buku_ then          
               set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena Tanggal Penyusutan < Tanggal Buku!');   
          end if;
          
          
        
         
         if stop_ = 0 then 
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and if(month(tgl_penghapusan)>=1 and month(tgl_penghapusan)<=6,1,2)=sem_susut_ak_) or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;         
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and if(month(tgl_gantirugi)>=1 and month(tgl_gantirugi)<=6,1,2)=sem_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and if(month(tgl_pemindahtanganan)>=1 and month(tgl_pemindahtanganan)<=6,1,2)=sem_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
          
    
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;    
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
		  set cek_=concat(cek_,' | thn_susut_ak_=',thn_susut_ak_,' | sem_susut_ak_=',sem_susut_ak_, ' | sem_susut_ak_=', sem_susut_ak_); 
		    
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_ 
            and tgl_pemeliharaan <= tgl_susut2_
			and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_ and tambah_aset=1; 
          
		  set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,'\n');
		  
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_    
             and tgl_pemeliharaan <= tgl_susut2_ 
			and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) < thn_susut_ak_*2+sem_susut_ak_ and tambah_masamanfaat=1;  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
          select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0)*2;
          set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,
		  	' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_             
            and tgl_pengamanan <= tgl_susut2_
            and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_             
            and tgl_penghapusan <= tgl_susut2_
            and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_             
            and tgl <= tgl_susut2_
            and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_             
            and tgl_penilaian <= tgl_susut2_
            and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);   


        
        
  
        
        if akum_harga_susut_ = ''  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
        


          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
set cek_=concat(cek_,' | 3. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');  
          set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/2);     
          
          
          
          if jml_susut_ = 0 or jml_susut_ = null or jml_susut_ = '' then     
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif akum_nilai_buku_ = 0 then          
             if sem_susut_ak_ = 2 then
               select sum(hrg_perolehan), (sum(masa_manfaat)*2)-((((max(tahun)+1)-thn_mulai_susut_)*2)-1) into akum_nilai_buku_, sisa_masa_manfaat_ 
               from penyusutan where idbi=idbi_ and id_koreksi=0;    
               set cek_=concat(cek_,' | 3a. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');               
             else   
               select sum(hrg_perolehan), (sum(masa_manfaat)*2)-(((max(tahun)+1)-thn_mulai_susut_)*2) into akum_nilai_buku_, sisa_masa_manfaat_ 
               from penyusutan where idbi=idbi_ and id_koreksi=0;     
               set cek_=concat(cek_,' | 3b. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');              
             end if;
             set sisa_masa_manfaat_=sisa_masa_manfaat_+penambahan_masa_manfaat_;      
             set cek_=concat(cek_,' | 3c. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');              
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
             set cek_=concat(cek_,' | 3d. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');   
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
            set cek_=concat(cek_,' | 3e. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');           
          end if;    

 set cek_=concat(cek_,' |4. sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');         
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          if jml_susut_>0 or sem_susut_ak_=1 then
             set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;                   
          else   
             set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/(sisa_masa_manfaat_/2); 
          end if;
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             

          
           if sem_susut_ak_ = 2 then       
              set bln_susut_aw_ = 7;
              set bln_susut_ak_ = 12;
           else       
              set bln_susut_aw_ = 1;
              set bln_susut_ak_ = 6;
           end if;    
             
          if stop_ = 0 then
    			set cek_=concat(cek_,' | insert susut thn_susut_ak_=',thn_susut_ak_, ' sem_susut_ak_=', sem_susut_ak_, '\n');    
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,
                   hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,
                   akum_masa_manfaat,thn_ke,
                   sisa_masa_manfaat,
                   
                   sisa_masa_manfaat_thn, stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,bulan_awl, id_koreksi_tambah)
                   values                   

                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_/2, penambahan_masa_manfaat_rehab_/2, 
                   persen_residu_, akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,
                   masa_manfaat_tot_/2,thn_ke_,
                   if(sem_susut_ak_=2 && sisa_masa_manfaat_ <> 0 && jml_susut_ > 0, (sisa_masa_manfaat_+1)/2,sisa_masa_manfaat_/2) ,                    
                   if(sem_susut_ak_=2 && sisa_masa_manfaat_ <> 0 && jml_susut_ > 0, (sisa_masa_manfaat_+1)/2 ,sisa_masa_manfaat_/2),                    
                   
                   
                                    
                  
                  1,
                   
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,bln_susut_aw_,id_koreksi_);           
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
          
             if sem_susut_ak_ > 1 and jml_susut_ =0 then                          
                set sisa_masa_manfaat_= sisa_masa_manfaat_-1;
             end if;
              set sem_susut_ak_ = sem_susut_ak_+1;         
              if sem_susut_ak_>2 then     
                 set sem_susut_ak_=1;        
                 set thn_susut_ak_=thn_susut_ak_+1;         
                 set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
                 
                 set thn_ke_=thn_ke_+1;
              end if;
              
  set cek_=concat(cek_,' |5. after insert sisa_masa_manfaat_=',sisa_masa_manfaat_,'\n');               
    
              if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_/2, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_susut_aw_ where id=idbi_;               
              end if; 
              set jml_susut_ = jml_susut_+1; 
         end if;      
          set cek_=concat(cek_,' | bln_susut_ak_=',bln_susut_ak_,'\n');     
       end while;          
    
            
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode4_bck`(idbi_ int, tgl_susut_ date, uid_ varchar(20), log_ int ) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN
     
  declare stop_ int;  
  declare update_bi_, con_thn_mulai_susut_, thn_mulai_susut_  int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_, thn_susut_ak_bi_, residu_bi_   int;    
  declare masa_manfaat_brg_, residu_brg_ int;
  declare masa_manfaat_, persen_residu_ int;  
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);   
  declare jml_harga_bi decimal(18,2);    
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_, penambahan_masa_manfaat_prev_  int;  
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_  int;  
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_  int;
  declare nilai_buku_, harga_susut_, hrg_rehab_ decimal(18,2);  
  declare masa_manfaat_tot_, masa_manfaat_rehab_ int;  
  declare tgl_buku_ date;  
  declare hrg_susut_sem1_ decimal(18,2);  
  declare thn_tgl_susut_ , sem_tgl_susut_ , sem_mulai_susut_, sem_susut_ak_bi_, sem_susut_ak_ int;  
  declare idbi_awal_ int;  
  declare tot_rehab_, nilai_buku_stlh_susut_, akum_susut_  decimal(18,2);  
  declare tot_manfaat_, bln_susut_ak_ int;    
  declare akum_masa_manfaat_, sisa_manfaat_, jml_tahun_, masa_manfaat_tot_prev_ int;  
  declare penambahan_nilai_buku_thn_prev_, akum_susut_thn_prev_, penambahan_hrg_rehab_thn_prev_, harga_susut_sem2_ ,nilai_buku_stlh_susut_sem1_  decimal(18,2);    
  declare tgl_susut_simpan_ date;  
  declare cek_ longtext;

  set cek_ = '';  
  set stop_ = 0;
  set update_bi_ = 0 ;
  set masa_manfaat_bi_ = 0;
  set residu_bi_ = 0;      
  set masa_manfaat_brg_ = 0;  
  set residu_brg_ = 0;
  set masa_manfaat_ = 0;  
  set persen_residu_ = 0;  
  set nilai_buku_ = 0;  
  set penambahan_nilai_buku_prev_= 0;
  set penambahan_hrg_rehab_prev_=0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set masa_manfaat_tot_ = 0;  
  set harga_susut_ = 0;  
  set hrg_susut_sem1_ = 0;
  set penambahan_nilai_buku_sem1_= 0;
  set penambahan_hrg_rehab_sem1_=0;
  set penambahan_masa_manfaat_sem1_ = 0;     
  set hrg_rehab_ = 0;  
  set masa_manfaat_rehab_ = 0;  
  set sem_mulai_susut_ = 0;  
  set sem_susut_ak_bi_ = 0;  
  set sem_susut_ak_ = 0;  
  set idbi_awal_ = 0;  
  set harga_susut_ = 0;
  set nilai_buku_stlh_susut_ = 0;  
  set akum_susut_ = 0;  
  set akum_masa_manfaat_ =0;  
  set sisa_manfaat_ = 0;  
  set jml_tahun_ = 0;  
  set masa_manfaat_tot_prev_ = 0;  
  set penambahan_nilai_buku_thn_prev_=0;
  set akum_susut_thn_prev_=0;
  set penambahan_hrg_rehab_thn_prev_ = 0;  
  set harga_susut_sem2_ = 0;  
  set nilai_buku_stlh_susut_sem1_ = 0;

  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
    
  
  select nilai into con_thn_mulai_susut_ from setting where id = 'THN_MULAI_SUSUT'; 
  
  set cek_ = concat(cek_,'con_thn_mulai_susut_=',con_thn_mulai_susut_ );
    
  
  select masa_manfaat, thn_perolehan, thn_susut_ak, nilai_sisa , jml_harga, tgl_buku, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal 
    into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, residu_bi_, jml_harga_bi, tgl_buku_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_
    from buku_induk where id = idbi_;    
    
  
 
  
  select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
    from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
 
  
  if masa_manfaat_bi_ = 0 or  masa_manfaat_bi_ = null then  
     set masa_manfaat_ = masa_manfaat_brg_;     
     set persen_residu_ = residu_brg_;     
  else   
     set masa_manfaat_ = masa_manfaat_bi_;     
     set persen_residu_ = residu_bi_;         
  end if;
 set cek_ = concat(cek_,'masa_manfaat_=',masa_manfaat_);
 
  
  set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);  
  set sem_mulai_susut_ = if(month(tgl_buku_) >6 , 2, 1) ;
  
  
  set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_, thn_susut_ak_bi_, thn_mulai_susut_ );  
  
  
  if masa_manfaat_bi_  = 0 or  masa_manfaat_bi_ = null then 
     set sem_susut_ak_ = sem_mulai_susut_; 
  else 
     set sem_susut_ak_ = sem_susut_ak_bi_ + 1;     
     if sem_susut_ak_ > 2 then          
        set thn_susut_ak_ = thn_susut_ak_+1;        
        set sem_susut_ak_ = 1;
     end if;
  end if;    
 set cek_ = concat(cek_,'masa_manfaat_bi_=',masa_manfaat_bi_, 'thn_susut_ak_=',thn_susut_ak_,'sem_susut_ak_=',sem_susut_ak_,
     'thn_susut_ak_bi_=',thn_susut_ak_bi_, 'sem_susut_ak_bi_=',sem_susut_ak_bi_ );

  
  select sum(ifnull(hrg_perolehan,0)), sum(hrg_rehab), sum(masa_manfaat) , sum(ifnull(harga,0)), sum(masa_manfaat)  , sum(thn_ke)
    into penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_, penambahan_masa_manfaat_prev_, akum_susut_ , akum_masa_manfaat_ , jml_tahun_   
    from penyusutan where idbi = idbi_ ;      
    
  set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
  set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
  set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);
  set akum_susut_ =   if(akum_susut_ is null, 0, akum_susut_);  
  set akum_masa_manfaat_ = if(akum_masa_manfaat_ is null, 0, akum_masa_manfaat_);  
  set jml_tahun_ = if(jml_tahun_ is null, 0, jml_tahun_);      

  
set cek_ = concat(cek_,'akum_susut_=',akum_susut_,'akum_masa_manfaat_=',akum_masa_manfaat_,
    'penambahan_nilai_buku_prev_=',penambahan_nilai_buku_prev_,    
    'penambahan_hrg_rehab_prev_=',penambahan_hrg_rehab_prev_,    
    'penambahan_masa_manfaat_prev_=',penambahan_masa_manfaat_prev_,    
    'jml_tahun_=',jml_tahun_
    );

  
  set penambahan_nilai_buku_thn_prev_ = 0 ;
  set akum_susut_thn_prev_= 0;
  set penambahan_hrg_rehab_thn_prev_ = 0;  
  select ifnull(sum(hrg_perolehan),0), ifnull(sum(hrg_rehab),0), ifnull(sum(harga),0)  
    into penambahan_nilai_buku_thn_prev_, penambahan_hrg_rehab_thn_prev_, akum_susut_thn_prev_ 
    from penyusutan where idbi = idbi_  and tahun < thn_susut_ak_bi_+if(sem_susut_ak_bi_=2,1,0) ;  
  
  select ifnull(sum(harga),0) into harga_susut_ 
    from penyusutan where idbi = idbi_  and tahun = thn_susut_ak_bi_-if(sem_susut_ak_bi_=2,0,1) ;                 
  set cek_ = 
      concat(cek_ , concat('thn_susut_ak_bi_=',thn_susut_ak_bi_,'sem_susut_ak_bi_=',sem_susut_ak_bi_,'harga_susut_=',harga_susut_,
      'thn_susut_ak_=',thn_susut_ak_,'sem_susut_ak_=',sem_susut_ak_ ) )  ;
      
  
  set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);  

  while stop_ = 0 do    
    set cek_ = concat(cek_,' \n - thn_susut_ak_=',thn_susut_ak_, 'sem_susut_ak_=',sem_susut_ak_);    
    
    if thn_tgl_susut_*2 + sem_tgl_susut_ < thn_mulai_susut_*2+sem_mulai_susut_ then    
      set stop_ = 1; 
      set cek_ = concat(cek_ , 'stop karena belum mulai disusutkan');
    elseif thn_tgl_susut_*2 + sem_tgl_susut_ <  thn_susut_ak_*2 + sem_susut_ak_ then
      set stop_ = 1; 
      set cek_ = concat(cek_ , concat('stop karena sudah sampai tgl disusutkan ',thn_tgl_susut_,'*2+ ',sem_tgl_susut_ ,' <  ',thn_susut_ak_,'*2 + ',sem_susut_ak_));
    elseif thn_susut_ak_ > thn_mulai_susut_+ masa_manfaat_tot_-1   then   
      set stop_ = 1; 
      set cek_ = concat(cek_ , 'stop karena sudah lebih dari umur ekonomis  ');
    end if;      
    

    if stop_ = 0 then        
       
       set hrg_rehab_ = 0;   
       set masa_manfaat_rehab_ = 0;          
       if sem_susut_ak_ = 1 then        
          set bln_susut_ak_ = 6;          
       else       
          set bln_susut_ak_ = 12;          
       end if;
       
       select sum(biaya_pemeliharaan), sum(ifnull(masa_manfaat,0)) into tot_rehab_, tot_manfaat_  from pemeliharaan 
          where tambah_aset=1 and idbi_awal= idbi_awal_ and YEAR(tgl_pemeliharaan)*12+month(tgl_pemeliharaan)  <= thn_susut_ak_*12+bln_susut_ak_;
       set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
       set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);
       
       select sum(biaya_pengamanan), sum(ifnull(masa_manfaat,0)) into tot_rehab_, tot_manfaat_  from pengamanan 
          where tambah_aset=1 and idbi_awal= idbi_awal_ and YEAR(tgl_pengamanan)*12+month(tgl_pengamanan)  <= thn_susut_ak_*12+bln_susut_ak_;     
       set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);    
       set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);
       
       select sum(harga_hapus), sum(ifnull(masa_manfaat,0)) into tot_rehab_, tot_manfaat_ from penghapusan_sebagian 
          where  idbi_awal= idbi_awal_ and YEAR(tgl_penghapusan)*12+month(tgl_penghapusan)  <= thn_susut_ak_*12+bln_susut_ak_;    
       set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);    
       set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);
       
       select sum(harga_baru - harga), sum(ifnull(masa_manfaat,0)) into tot_rehab_, tot_manfaat_ from t_koreksi
          where idbi_awal= idbi_awal_ and YEAR(tgl)*12+month(tgl)  <= thn_susut_ak_*12+bln_susut_ak_;    
       set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);
       set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);        
       
       select sum(nilai_barang - nilai_barang_asal), sum(ifnull(masa_manfaat,0)) into tot_rehab_, tot_manfaat_ from penilaian
          where idbi_awal= idbi_awal_ and YEAR(tgl_penilaian)*12+month(tgl_penilaian)  <= thn_susut_ak_*12+bln_susut_ak_; 
       set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);
       set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0); 
                
       set nilai_buku_ = jml_harga_bi + hrg_rehab_ ;
       set masa_manfaat_tot_ = masa_manfaat_ + masa_manfaat_rehab_;          

       
       set cek_ = concat( cek_, 'penambahan_masa_manfaat_prev_=',penambahan_masa_manfaat_prev_,
               'penambahan_nilai_buku_prev_=',penambahan_nilai_buku_prev_,
               'masa_manfaat_tot_=',masa_manfaat_tot_,
               'nilai_buku_=',nilai_buku_);  
       if penambahan_masa_manfaat_prev_=0 or penambahan_nilai_buku_prev_=0  then               
          set harga_susut_ = (nilai_buku_ - (persen_residu_/100*nilai_buku_))/(masa_manfaat_tot_);
       elseif penambahan_masa_manfaat_prev_ <> masa_manfaat_tot_ or penambahan_nilai_buku_prev_ <> nilai_buku_ 
       then   
          
          set sisa_manfaat_ = masa_manfaat_tot_ - jml_tahun_;
          set harga_susut_ = ((penambahan_nilai_buku_thn_prev_ - akum_susut_thn_prev_) +  (hrg_rehab_ - penambahan_hrg_rehab_thn_prev_) - (persen_residu_/100*nilai_buku_))
              /sisa_manfaat_;
          set cek_ = concat(cek_, 'penambahan_nilai_buku_thn_prev_=',penambahan_nilai_buku_thn_prev_,
               'akum_susut_thn_prev_=',akum_susut_thn_prev_,'hrg_rehab_=',hrg_rehab_,
               'penambahan_hrg_rehab_thn_prev_=',penambahan_hrg_rehab_thn_prev_,
               'sisa_manfaat_=',sisa_manfaat_);    
       end if;
       
       
       
       set penambahan_nilai_buku_ = nilai_buku_ - penambahan_nilai_buku_prev_;
       set penambahan_hrg_rehab_ = hrg_rehab_ - penambahan_hrg_rehab_prev_;         
       set penambahan_masa_manfaat_ = masa_manfaat_tot_ - penambahan_masa_manfaat_prev_;        
              
       
       
            
       set hrg_susut_sem1_ = 0;  
       set penambahan_nilai_buku_sem1_= 0;
       set penambahan_hrg_rehab_sem1_=  0;
       set penambahan_masa_manfaat_sem1_ = 0;        

       
       if sem_susut_ak_ = 1 then
           
           
           
           
           if (hrg_susut_sem1_ = 0 or hrg_susut_sem1_ = null) and (thn_susut_ak_ *2 +sem_susut_ak_ >= thn_mulai_susut_*2 + sem_mulai_susut_)  then       
              
              set hrg_susut_sem1_ = harga_susut_/2;          
              set penambahan_nilai_buku_sem1_= penambahan_nilai_buku_;
              set penambahan_hrg_rehab_sem1_=  penambahan_hrg_rehab_;
              set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_; 
              set akum_susut_ = akum_susut_+  hrg_susut_sem1_;  
              set nilai_buku_stlh_susut_ = nilai_buku_ - akum_susut_;  
              set akum_masa_manfaat_ = akum_masa_manfaat_ + penambahan_masa_manfaat_sem1_;      
              
              
              
              
    
              
              
              
              
              
                              
              if thn_susut_ak_ <= 2014 then
                 set tgl_susut_simpan_ = '2014-12-31';                 
              else
                 set tgl_susut_simpan_ = STR_TO_DATE(concat(thn_susut_ak_,'-06-30') ,'%Y-%m-%d') ;                    
              end if;   
                      
              insert into penyusutan 
                 (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
                 akum_susut, nilai_buku_stlh_susut, akum_masa_manfaat)
                 values
                 (tgl_susut_simpan_, thn_susut_ak_, 1, 6, idbi_, idbi_awal_, hrg_susut_sem1_, uid_, now(), thn_perolehan_, 
                 penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, persen_residu_,
                 akum_susut_, nilai_buku_stlh_susut_, akum_masa_manfaat_); 
                 
                 
              set update_bi_ = 1;
              
           end if;           
       end if;

       
       if sem_susut_ak_ = 2 then       
           
             
           select ifnull(harga,0), hrg_perolehan, hrg_rehab, masa_manfaat, nilai_buku_stlh_susut
              into hrg_susut_sem1_, penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_ , nilai_buku_stlh_susut_sem1_ 
              from penyusutan where idbi = idbi_ and tahun=thn_susut_ak_ and sem=1 ;       
           
           
           
           
           
                         
                      
           set harga_susut_sem2_ = harga_susut_ -  hrg_susut_sem1_ ;           
           if thn_susut_ak_ =  thn_mulai_susut_ + akum_masa_manfaat_ - 1 then                      
              set harga_susut_sem2_ = nilai_buku_stlh_susut_sem1_ ;
           end if;        
           set cek_ = concat(cek_, '*harga_susut_sem2_=', harga_susut_sem2_, 'harga_susut_=',harga_susut_,
                  'hrg_susut_sem1_=',hrg_susut_sem1_,'thn_susut_ak_=',thn_susut_ak_,                  
                  'akum_masa_manfaat_=',akum_masa_manfaat_,'nilai_buku_stlh_susut_sem1_=',nilai_buku_stlh_susut_sem1_                  
           );

           set akum_susut_ = akum_susut_+  harga_susut_sem2_;  
           set nilai_buku_stlh_susut_ = nilai_buku_ - akum_susut_;   
           set akum_masa_manfaat_ = akum_masa_manfaat_ + penambahan_masa_manfaat_;                          
           
           
           if thn_susut_ak_ <= 2014 then
              set tgl_susut_simpan_ = '2014-12-31';                 
           else
              set tgl_susut_simpan_ = STR_TO_DATE(concat(thn_susut_ak_,'-12-31'),'%Y-%m-%d') ;                         
           end if;            

          insert into penyusutan 
            (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu, 
            nilai_buku_stlh_susut, akum_susut, akum_masa_manfaat, thn_ke)
            values
            (tgl_susut_simpan_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
            penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, persen_residu_, 
            nilai_buku_stlh_susut_, akum_susut_, akum_masa_manfaat_, 1);  
                    
          set update_bi_ = 1;
          set jml_tahun_=jml_tahun_+1;          
          set penambahan_nilai_buku_thn_prev_ = nilai_buku_ ;
          set akum_susut_thn_prev_= akum_susut_;
          set penambahan_hrg_rehab_thn_prev_ = hrg_rehab_;
       end if;
       
                            
       set penambahan_nilai_buku_prev_ = nilai_buku_;
       set penambahan_hrg_rehab_prev_ = hrg_rehab_;         
       set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;
       
       
       
       
       
            
       set sem_susut_ak_ = sem_susut_ak_+1;                
       if sem_susut_ak_ > 2 then
          set thn_susut_ak_ = thn_susut_ak_ + 1;                           
          set sem_susut_ak_ = 1;
       end if;

    end if;
    

  end while;

  if update_bi_=1 then   
     set sem_susut_ak_ = sem_susut_ak_-1;          
     if sem_susut_ak_ <= 0 then
        set thn_susut_ak_ = thn_susut_ak_ - 1;                           
        set sem_susut_ak_ = 2;
     end if;
     update buku_induk set masa_manfaat = masa_manfaat_, masa_manfaat_tot = masa_manfaat_tot_, 
     thn_susut_ak = thn_susut_ak_, 
       bln_susut_ak = if(sem_susut_ak_>1 , 12, 6), 
       nilai_sisa = persen_residu_,       
      thn_susut_aw = thn_mulai_susut_,      
      bln_susut_aw = if(sem_mulai_susut_>1 , 12, 6)
       where id = idbi_; 
  end if;
    
  if log_ <>1 then    
     set cek_ = '';
  end if;  
  return cek_ ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode5`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11),  id_koreksi_ INT(11) ) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    
 
  
  
  declare stop_, kondisi_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_, hasil_susut_ longtext;    
  declare tgl_susut2_ , tgl_koreksi_ date;  

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;
  
  set stop_ = 0;
  set cek_ = '';    
  set hasil_susut_ = 'gagal';  
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    
    if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select kondisi, ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into kondisi_, masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = if(residu_brg_ is null, 0, residu_brg_);   
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = if(residu_brg_ is null, 0, residu_brg_);        
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ AND id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ AND id_koreksi=0 order by id Desc limit 0,1;
        
        
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       
       
       
        
       while stop_ = 0 do
    
       
       
          
          if stop_ = 0 && kondisi_ = 3 then       
             set stop_ = 1 ;         
             set cek_ = concat(cek_ , 'stop karena rusak berat ');
          end if;  
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');
          end if; 
          if stop_ = 0 then 
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          
                            
         
         

          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else       
             set tgl_susut2_ = tgl_susut_;
          end if;  
          
          
          if akum_masa_manfaat_ = '' then 
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_ 
                and tambah_aset=1; 
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
              
              into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 and year(tgl_pemeliharaan)<=year(tgl_susut2_); 
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1 and year(tgl_pemeliharaan)<=year(tgl_susut2_);  
              
              if akum_masa_manfaat_ = '' then
                 set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              else   
                 set nilai_perolehan_ = akum_stlh_susut_ + tot_rehab_manfaat_;                         
              end if;
              
              
              select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
              if (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_ THEN          
    			  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;
              else          
                  SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
              end if; 
        
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 and year(tgl_pengamanan)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and year(tgl_penghapusan)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_  and year(tgl)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and year(tgl_penilaian)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
         end if; 
        
                    
         if akum_masa_manfaat_ = ''  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if akum_masa_manfaat_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
  
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
          
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             
          if stop_ = 0 then          
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else       
             set tgl_susut2_ = tgl_susut_;
          end if;  
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_, id_koreksi_);   
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             set hasil_susut_ = 'sukses';   
             end if;          
          end if;
          
          
          
       end while;
   else
       set cek_='idbi NULL';   
   end if;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode5_20180113`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11),  id_koreksi_ INT(11) ) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    
 
  
  
  declare stop_, kondisi_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_, hasil_susut_ longtext;    
  declare tgl_susut2_ , tgl_koreksi_ date;  

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;
  
  set stop_ = 0;
  set cek_ = '';    
  set hasil_susut_ = 'gagal';  
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    
    if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select kondisi, ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into kondisi_, masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = if(residu_brg_ is null, 0, residu_brg_);   
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = if(residu_brg_ is null, 0, residu_brg_);        
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ AND id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ AND id_koreksi=0 order by id Desc limit 0,1;
        
        
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       
       
       
        
       while stop_ = 0 do
    
       
       
          
          if stop_ = 0 && kondisi_ = 3 then       
             set stop_ = 1 ;         
             set cek_ = concat(cek_ , 'stop karena rusak berat ');
          end if;  
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');
          end if; 
          if stop_ = 0 then 
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          
                            
         
         

          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else       
             set tgl_susut2_ = tgl_susut_;
          end if;  
          
          
          
          
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 and year(tgl_pemeliharaan)<=year(tgl_susut2_); 
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1 and year(tgl_pemeliharaan)<=year(tgl_susut2_);  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
          
          select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
          if akum_masa_manfaat_ = '' then
              SET masa_manfaat_rehab_ = 0;            
          elseif (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_ THEN          
			  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;
          else          
              SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
          end if; 
    
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 and year(tgl_pengamanan)<=year(tgl_susut2_);
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and year(tgl_penghapusan)<=year(tgl_susut2_);
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_  and year(tgl)<=year(tgl_susut2_);
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and year(tgl_penilaian)<=year(tgl_susut2_);
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
        
                    
         if akum_masa_manfaat_ = 0  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if akum_masa_manfaat_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
  
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
          
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             
          if stop_ = 0 then          
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else       
             set tgl_susut2_ = tgl_susut_;
          end if;  
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_, id_koreksi_);   
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             set hasil_susut_ = 'sukses';   
             end if;          
          end if;
          
          
          
       end while;
   else
       set cek_='idbi NULL';   
   end if;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode5_bck`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN 
  

 declare stop_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_ decimal(18,2);
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_ longtext;    

  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;
  
  set stop_ = 0;
  set cek_ = '';  
 
 
  select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        

  
  select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal 
    into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_
    from buku_induk where id = idbi_;    
  
  
  select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
    from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;

  
  if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
     set masa_manfaat_ = masa_manfaat_brg_;     
     set persen_residu_ = residu_brg_;     
  else   
     set masa_manfaat_ = masa_manfaat_bi_;     
     set persen_residu_ = residu_bi_;         
  end if;
  
  
  set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_)+1;
  
  
  set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  

 
  
  select sum(ifnull(hrg_perolehan,0)), sum(hrg_rehab), sum(masa_manfaat),sum(ifnull(masa_manfaat_rehab,0))
    into penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_, penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ 
    from penyusutan where idbi = idbi_;    

  
   select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
    into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
    from penyusutan where idbi = idbi_ order by id Desc limit 0,1;

  set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
  set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
  set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
  set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
 

   set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
   set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_-penambahan_masa_manfaat_rehab_prev_);
   set sisa_masa_manfaat_awl_=masa_manfaat_;
      
   
   if sisa_masa_manfaat_ = 1  then      
      set stop_ = 1;                 
   end if;    
    
   while stop_ = 0 do

   
   set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn mulai susut=',thn_mulai_susut_+masa_manfaat_tot_-1,' ',masa_manfaat_tot_);   
      
      if stop_ = 0 && masa_manfaat_ <= 0 then  
          set stop_ = 1; 
          set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
      elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
          set stop_ = 1; 
          set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
      elseif stop_ = 0 && thn_susut_ak_ > thn_mulai_susut_+masa_manfaat_tot_-1 then
          set stop_ = 1; 
          set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');
      end if; 
      if stop_ = 0 then
           if thn_susut_ak_<=thn_tgl_susut_ then 
           
              
              select count(*) into jml_data_
              from penghapusan where year(tgl_penghapusan)=thn_susut_ak_-1 and id_bukuinduk = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_,'stop karena penghapusan');
              end if;        
              
              select count(*) into jml_data_
              from t_history_aset where year(tgl)=thn_susut_ak_-1 and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_ , 'stop karena pindah aset');
              end if;
              
              select count(*) into jml_data_
              from gantirugi where year(tgl_gantirugi)=thn_susut_ak_-1 and id_bukuinduk = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_ , 'stop karena ganti rugi');
              end if;          
              
              select count(*) into jml_data_
              from pemindahtanganan where year(tgl_pemindahtanganan)=thn_susut_ak_-1 and id_bukuinduk = idbi_ ;
              if jml_data_ > 0 then 
                 set stop_ = 1;             
                 set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
              end if;              
           end if;
      end if;
      set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn susut=',thn_mulai_susut_+masa_manfaat_tot_-1); 
                        
     
     
      set hrg_rehab_ = 0;   
      set masa_manfaat_rehab_ = 0;          
        
      
      select ifnull(sum(biaya_pemeliharaan),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_pemeliharaan)<=thn_susut_ak_ and tambah_aset=1;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);
      
      select ifnull(sum(biaya_pengamanan),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from pengamanan where idbi_awal = idbi_awal_ and year(tgl_pengamanan)<=thn_susut_ak_ and tambah_aset=1;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);
      
      select ifnull(sum(harga_hapus),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from penghapusan_sebagian where idbi_awal = idbi_awal_ and year(tgl_penghapusan)<=thn_susut_ak_;
      set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);
      
      select ifnull(sum(harga_baru-harga),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from t_koreksi where idbi_awal = idbi_awal_ and year(tgl)<=thn_susut_ak_;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);
      
      select ifnull(sum(nilai_barang-nilai_barang_asal),0), ifnull(sum(masa_manfaat),0) into tot_rehab_, tot_manfaat_
        from penilaian where idbi_awal = idbi_awal_ and year(tgl_penilaian)<=thn_susut_ak_;
      set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
      set masa_manfaat_rehab_ = masa_manfaat_rehab_ + ifnull(tot_manfaat_,0);                
    
      
      set nilai_buku_ = jml_harga_bi_+hrg_rehab_;
      
      
      set masa_manfaat_tot_ =  masa_manfaat_+masa_manfaat_rehab_;
      
      
      set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
            
      
      set penambahan_hrg_rehab_ = hrg_rehab_-penambahan_hrg_rehab_prev_;      
 
      
      set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      

      
      set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_-penambahan_masa_manfaat_rehab_prev_;      

      
      
      if sisa_masa_manfaat_ = 0  then      
         set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;      
      else
        set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_;            
      end if;    

      
      set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 

      
      set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
      set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
      
      set akum_harga_susut_=akum_harga_susut_+harga_susut_;
      set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
      
      if stop_ = 0 then
          
          insert into penyusutan 
               (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
               residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,jns_trans2)
               values
               (tgl_susut_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
               penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
               akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,jns_trans2_); 
               
         set penambahan_nilai_buku_prev_ = nilai_buku_;         
         set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
         set penambahan_hrg_rehab_prev_ = hrg_rehab_;
         set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
         
         set update_bi = 1;
         set thn_susut_ak_ = thn_susut_ak_+1;         

         
         set thn_ke_=thn_ke_+1;
            
         if update_bi =1 then     
            update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                   bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
         end if;          
      end if;
      set cek_=concat(cek_,' | stop=',stop_,'\n');     
      
      
   end while;

  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode5_bck2`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ INT(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN 
   
  declare stop_, stat_ int;
  declare update_bi int; 
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, thn_ke_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_,cek_susut_thn_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int; 
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,5);
  declare nilai_buku_ decimal(18,5);  
  declare masa_manfaat_tot_, masa_manfaat_tot_bi_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,5);
  declare c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,5);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,5);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,5);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,5);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,5);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_  decimal(18,5);  
  declare nilai_perolehan_ decimal(18,5); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,5);
  declare masa_manfaat_rehab_,masa_manfaat_rehab_susut_thn_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_,sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,5);   
  declare jml_data_,jml_data_cek_, cek_thn_susut_ak_ int;  
  declare jml_bln_ int;  
  
  declare cek_susut_first int;  
  declare cek_idlama_ int;  
  declare ket_ varchar(255);
  declare cek_, test_, hasil_susut_ longtext;    
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_tot_bi_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_susut_thn_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set thn_ke_=1;
  set stop_ = 0;  
  set stat_ = 0;
  set cek_ = '';  
  set cek_susut_thn_=0;
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set ket_ = '';  
  set hasil_susut_ = 'gagal';    
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_;  
 if idbi_awal_ is not NULL then   

      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;      

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';         
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        from buku_induk where id = idbi_;    
    
     
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;    

       set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
      
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_buku_) <> 0 ,  month(tgl_buku_),month(tgl_ba_));
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,stat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;        

      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
          
       
       
       
       
     
       
       if akum_masa_manfaat_ = '' then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);
       end if;
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
      
      while stop_ = 0 do
          
      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
 
       
       
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <=  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
          
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);       
          
        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_) or tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  select count(*) into jml_data_
                  
                  from t_history_aset where ((year(tgl)=thn_susut_ak_ and month(tgl)=bln_susut_ak_) or tgl_susut_ >= tgl) and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_ , 'stop karena pindah aset');
                  end if;
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
    
         
         if jns_trans2_=31 then  
           set tgl_susut2_ = tgl_koreksi_;
         else       
           set tgl_susut2_ = tgl_susut_;
         end if;              

          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
           
          select  ifnull(sum(biaya_pemeliharaan),0) 
          into tot_rehab_aset_
            from pemeliharaan where idbi_awal = idbi_awal_             
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1; 
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_awal_             
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_;  
                     
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
                  
          if tot_rehab_aset_ <> 0 then
             select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_aset_,jml_harga_bi_) into masa_manfaat_rehab_;          
             if akum_masa_manfaat_ = 0 then             
                 set masa_manfaat_rehab_ = 0;
             elseif (masa_manfaat_rehab_*12+sisa_masa_manfaat_) > masa_manfaat_brg_*12 then
                 
                 
                 
                 set masa_manfaat_rehab_ = masa_manfaat_brg_*12-sisa_masa_manfaat_;                               
                 
                 
             else
                 set masa_manfaat_rehab_ = masa_manfaat_rehab_*12;                
             end if;      
           end if;       
                         
          
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_awal_ 
            and tgl_pengamanan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_             
            and tgl_penghapusan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_awal_             
            and tgl <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_awal_ 
            and tgl_penilaian <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);                          
        
        
        if akum_masa_manfaat_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;                            
    
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
          
          set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/12);                   
    
          
          
          if akum_masa_manfaat_ = '' then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;       
    
          
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;            
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_; 
           
    
          
          
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;             
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then      
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;
        end if;
    
         
         set penambahan_nilai_buku_prev_ = nilai_buku_;         
         set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
         set penambahan_hrg_rehab_prev_ = hrg_rehab_;
         set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
               
          set update_bi = 1;
           
                
         select ifnull(stat,0) into cek_susut_thn_
         from penyusutan where idbi = idbi_ and stat=1 limit 0,1;        
         
         
         select sum(masa_manfaat) into masa_manfaat_tot_bi_
         from penyusutan where idbi = idbi_;  
     
         if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=if(cek_susut_thn_=1,masa_manfaat_tot_bi_,masa_manfaat_tot_/12), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;               
            set hasil_susut_ = 'sukses';       
         end if;
  
          set bln_susut_ak_=bln_susut_ak_+1;
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
             
             set thn_ke_=thn_ke_+1;
          end if; 
          
          
                
          
       end while;                    
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;   
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode5_bck20171219`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ INT(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN 
   
  declare stop_, stat_ int;
  declare update_bi int; 
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, thn_ke_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_,cek_susut_thn_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int; 
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,5);
  declare nilai_buku_ decimal(18,5);  
  declare masa_manfaat_tot_, masa_manfaat_tot_bi_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,5);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,5);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,5);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,5);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,5);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,5);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_  decimal(18,5);  
  declare nilai_perolehan_ decimal(18,5); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,5);
  declare masa_manfaat_rehab_,masa_manfaat_rehab_susut_thn_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_,sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,5);   
  declare jml_data_,jml_data_cek_, cek_thn_susut_ak_ int;  
  declare jml_bln_ int;  
  
  declare cek_susut_first int;  
  declare cek_idlama_ int;  
  declare ket_ text;
  declare cek_, test_, hasil_susut_ longtext;    
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 
declare vmasa_manfaat_ int;

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_tot_bi_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_susut_thn_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set thn_ke_=1;
  set stop_ = 0;  
  set stat_ = 0;
  set cek_ = '';  
  set cek_susut_thn_=0;
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set ket_ = '';  
  set vmasa_manfaat_ = 0;  
  set hasil_susut_ = 'gagal';    
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_;  
 if idbi_awal_ is not NULL then   

      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;      

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';         
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        from buku_induk where id = idbi_;    
    
     
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;    

       set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
      
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;              
         
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_buku_) <> 0 ,  month(tgl_buku_),month(tgl_ba_));
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,stat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;        

      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
          
       
       
       
       
     
       
       if akum_masa_manfaat_ = '' then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);
       end if;
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
      set ket_ = '';   
      while stop_ = 0 do
       
      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
 
       
       
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
          
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);       
          
        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_) or tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;     

                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
    
         
         if jns_trans2_=31 then  
           set tgl_susut2_ = tgl_koreksi_;
         else       
           set tgl_susut2_ = tgl_susut_;
         end if;              

          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
           
          select  ifnull(sum(biaya_pemeliharaan),0) 
          into tot_rehab_aset_
            from pemeliharaan where idbi_awal = idbi_awal_             
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;             

          select  ifnull(sum(biaya_pemeliharaan),0) 
          into tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_awal_             
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_masamanfaat=1;   
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_awal_             
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_;  
                     
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
                  
          
          if tot_rehab_manfaat_ <> 0 && akum_masa_manfaat_ = '' then
                 set masa_manfaat_rehab_ = 0;  
          
             
          elseif tot_rehab_manfaat_ <> 0 then          
             
             select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,akum_stlh_susut_) into masa_manfaat_rehab_;     
             
             if (masa_manfaat_rehab_*12+sisa_masa_manfaat_) > masa_manfaat_brg_*12 then
                 set ket_ = concat(ket_, 'penambahan masa manfaat ' ,masa_manfaat_rehab_*12,' melebihi masa manfaat max. \n' );
                 set masa_manfaat_rehab_ = masa_manfaat_brg_*12-sisa_masa_manfaat_+1;                 
                 
             else
                 set masa_manfaat_rehab_ = masa_manfaat_rehab_*12;                
             end if;    
             set vmasa_manfaat_ = masa_manfaat_rehab_;  
           end if;       
                         
          
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_awal_ 
            and tgl_pengamanan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_             
            and tgl_penghapusan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_awal_             
            and tgl <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_awal_ 
            and tgl_penilaian <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);                          
        
        
        if akum_masa_manfaat_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;                            
    
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
          
          set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/12);                   
    
          
          
          if akum_masa_manfaat_ = '' then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_-1;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;       
    
          
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;   
          
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;            
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_; 
           
    
          
          
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and (bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0) then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;             
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,
                   hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,
                   sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, 
                   persen_residu_, akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,
                   sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then    
          
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and (bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0) then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;
        end if;
    
         
         set penambahan_nilai_buku_prev_ = nilai_buku_;         
         set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
         set penambahan_hrg_rehab_prev_ = hrg_rehab_;
         set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
               
          set update_bi = 1;
           
                
         select ifnull(stat,0) into cek_susut_thn_
         from penyusutan where idbi = idbi_ and stat=1 limit 0,1;        
         
         
         select sum(masa_manfaat) into masa_manfaat_tot_bi_
         from penyusutan where idbi = idbi_;  
     
         if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=if(cek_susut_thn_=1,masa_manfaat_tot_bi_,masa_manfaat_tot_/12), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;               
            set hasil_susut_ = 'sukses';       
         end if;
 
          set bln_susut_ak_=bln_susut_ak_+1;
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
             
             set thn_ke_=thn_ke_+1;
          end if; 
          
          
                
          
       end while;                    
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;   
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode6`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  
  declare stop_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_,masa_manfaat_blm_neraca_,masa_manfaat_sdh_neraca_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;  
  declare neraca_awal_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2);  
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_, masa_manfaat_rehab_stlh_habis_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_, hasil_susut_ longtext; 
  declare umur_neraca_awal_, selisih_tahun_ int;
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0; 
  set masa_manfaat_blm_neraca_ = 0;     
  set masa_manfaat_sdh_neraca_ = 0;
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_stlh_habis_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;  
  set neraca_awal_=0;  
  set umur_neraca_awal_ = 0;  
  set selisih_tahun_ = 0;
  set harga_susut_ = 0;
  set stop_ = 0;
  set cek_ = '';    
  set hasil_susut_ = 'gagal';    
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;      

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1 ,c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select ifnull(masa_manfaat,0), residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
                 
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;                
         set umur_neraca_awal_ =  con_thn_mulai_susut_ - thn_perolehan_;              

         
         if thn_perolehan_ < con_thn_mulai_susut_ and  umur_neraca_awal_< masa_manfaat_brg_ then          
            
            
            set masa_manfaat_ = masa_manfaat_brg_ -umur_neraca_awal_; 
              
            
         end if;
         set persen_residu_ = residu_brg_;
          
          
          set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ and  umur_neraca_awal_< masa_manfaat_brg_, con_thn_mulai_susut_,thn_perolehan_);       
      else   
         set masa_manfaat_ = masa_manfaat_bi_;
         set umur_neraca_awal_ =  con_thn_mulai_susut_ - thn_perolehan_;              
             
         
         if thn_perolehan_ < con_thn_mulai_susut_ and  umur_neraca_awal_< masa_manfaat_bi_ then          
            
            set masa_manfaat_ = masa_manfaat_bi_ -umur_neraca_awal_; 
               
            
         end if;              
         set persen_residu_ = residu_bi_;         
          
          
          set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ and  umur_neraca_awal_< masa_manfaat_bi_, con_thn_mulai_susut_,thn_perolehan_);       
      end if;      

      set masa_manfaat_ = if(masa_manfaat_ is null, 0, masa_manfaat_);
     
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);
 
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
                                                                                                                                        
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
               
       
       
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
       while stop_ = 0 do
    
         
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if; 
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
                            
         
         
         if jns_trans2_=31 then  
           set tgl_susut2_ = tgl_koreksi_;
         else       
           set tgl_susut2_ = tgl_susut_;
         end if;

          
          if akum_masa_manfaat_ = '' then 
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_ 
                and tambah_aset=1; 
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else            
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
              
              into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_pemeliharaan) <= thn_susut_ak_ and year(tgl_perolehan)=thn_susut_ak_;
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)<=thn_susut_ak_ and tambah_masamanfaat=1;  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              
    
               
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_pengamanan) < thn_susut_ak_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_penghapusan) < thn_susut_ak_ and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl) < thn_susut_ak_ and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_penilaian) < thn_susut_ak_ and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);              
          end if;    
        
          if akum_masa_manfaat_ = ''  then         
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;              
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if akum_masa_manfaat_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);  
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             
          
 
          if stop_ = 0 then
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;          
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_, id_koreksi_); 
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then      
                update buku_induk set masa_manfaat=if(umur_neraca_awal_>=0,masa_manfaat_tot_+umur_neraca_awal_,masa_manfaat_tot_), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             end if;  
            set hasil_susut_ = 'sukses';                          
          end if;
       end while;
   else
       set cek_='idbi NULL';   
   end if;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode6_20180113`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  
  declare stop_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_,masa_manfaat_blm_neraca_,masa_manfaat_sdh_neraca_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;  
  declare neraca_awal_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2);  
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_, masa_manfaat_rehab_stlh_habis_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_, hasil_susut_ longtext; 
  declare umur_neraca_awal_, selisih_tahun_ int;
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0; 
  set masa_manfaat_blm_neraca_ = 0;     
  set masa_manfaat_sdh_neraca_ = 0;
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_stlh_habis_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;  
  set neraca_awal_=0;  
  set umur_neraca_awal_ = 0;  
  set selisih_tahun_ = 0;
  set harga_susut_ = 0;
  set stop_ = 0;
  set cek_ = '';    
  set hasil_susut_ = 'gagal';    
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    

      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;      

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1 ,c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select ifnull(masa_manfaat,0), residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
                 
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;                
         set umur_neraca_awal_ =  con_thn_mulai_susut_ - thn_perolehan_;              

         
         if thn_perolehan_ < con_thn_mulai_susut_ and  umur_neraca_awal_< masa_manfaat_brg_ then          
            
            
            set masa_manfaat_ = masa_manfaat_brg_ -umur_neraca_awal_; 
              
            
         end if;
         set persen_residu_ = residu_brg_;
          
          
          set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ and  umur_neraca_awal_< masa_manfaat_brg_, con_thn_mulai_susut_,thn_perolehan_);       
      else   
         set masa_manfaat_ = masa_manfaat_bi_;
         set umur_neraca_awal_ =  con_thn_mulai_susut_ - thn_perolehan_;              
             
         
         if thn_perolehan_ < con_thn_mulai_susut_ and  umur_neraca_awal_< masa_manfaat_bi_ then          
            
            set masa_manfaat_ = masa_manfaat_bi_ -umur_neraca_awal_; 
               
            
         end if;              
         set persen_residu_ = residu_bi_;         
          
          
          set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ and  umur_neraca_awal_< masa_manfaat_bi_, con_thn_mulai_susut_,thn_perolehan_);       
      end if;      

      set masa_manfaat_ = if(masa_manfaat_ is null, 0, masa_manfaat_);

      


     
     

      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);
 
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
                                                                                                                                        
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
              

          
       
       
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
       while stop_ = 0 do
    
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if; 
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          
                            
         
         
         if jns_trans2_=31 then  
           set tgl_susut2_ = tgl_koreksi_;
         else       
           set tgl_susut2_ = tgl_susut_;
         end if;
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;                     

          
          
          
          
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_awal_ 
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_pemeliharaan) < thn_susut_ak_ and year(tgl_perolehan)=thn_susut_ak_;
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_awal_ 
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1;  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
          select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          

           
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_awal_ 
            and tgl_pengamanan <= tgl_susut2_ 
            and year(tgl_pengamanan) < thn_susut_ak_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_awal_ 
            and tgl_penghapusan <= tgl_susut2_ 
            and year(tgl_penghapusan) < thn_susut_ak_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_awal_ 
            and tgl <= tgl_susut2_ 
            and year(tgl) < thn_susut_ak_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_awal_ 
            and tgl_penilaian <= tgl_susut2_ 
            and year(tgl_penilaian) < thn_susut_ak_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);
        
          if akum_harga_susut_ = ''  then         
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;              
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if akum_harga_susut_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);  
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          
          
 
          if stop_ = 0 then
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;          
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_, id_koreksi_); 
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then      
                update buku_induk set masa_manfaat=if(umur_neraca_awal_>=0,masa_manfaat_tot_+umur_neraca_awal_,masa_manfaat_tot_), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             end if;  
            set hasil_susut_ = 'sukses';                          
          end if;
          
          
          
       end while;
   else
       set cek_='idbi NULL';   
   end if;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode6_bck`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  
  declare stop_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_,masa_manfaat_blm_neraca_,masa_manfaat_sdh_neraca_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;  
  declare neraca_awal_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2);  
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_, masa_manfaat_rehab_stlh_habis_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_ longtext; 
  declare umur_neraca_awal_, selisih_tahun_ int;   

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0; 
  set masa_manfaat_blm_neraca_ = 0;     
  set masa_manfaat_sdh_neraca_ = 0;
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_stlh_habis_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;  
  set neraca_awal_=0;  
  set umur_neraca_awal_ = 0;  
  set selisih_tahun_ = 0;
  set harga_susut_ = 0;
  set stop_ = 0;
  set cek_ = '';  
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select ifnull(masa_manfaat,0), residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
                 
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;                
         set umur_neraca_awal_ =  con_thn_mulai_susut_ - thn_perolehan_;              

         
         if thn_perolehan_ < con_thn_mulai_susut_ and  umur_neraca_awal_< masa_manfaat_brg_ then          
            
            
            set masa_manfaat_ = masa_manfaat_brg_ -umur_neraca_awal_; 
              
            
         end if;
         set persen_residu_ = residu_brg_;
          
          
          set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ and  umur_neraca_awal_< masa_manfaat_brg_, con_thn_mulai_susut_,thn_perolehan_);       
      else   
         set masa_manfaat_ = masa_manfaat_bi_;
         set umur_neraca_awal_ =  con_thn_mulai_susut_ - thn_perolehan_;              
             
         
         if thn_perolehan_ < con_thn_mulai_susut_ and  umur_neraca_awal_< masa_manfaat_bi_ then          
            
            set masa_manfaat_ = masa_manfaat_bi_ -umur_neraca_awal_; 
               
            
         end if;              
         set persen_residu_ = residu_bi_;         
          
          
          set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ and  umur_neraca_awal_< masa_manfaat_bi_, con_thn_mulai_susut_,thn_perolehan_);       
      end if;      

      set masa_manfaat_ = if(masa_manfaat_ is null, 0, masa_manfaat_);

      set cek_ = concat(cek_ , ' masa_manfaat_=', masa_manfaat_, ' thn_perolehan_=', thn_perolehan_,
          ' con_thn_mulai_susut_=', con_thn_mulai_susut_,
          ' umur_neraca_awal_=', con_thn_mulai_susut_ - thn_perolehan_ );


     
     

      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);
 
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
                                                                                                                                        
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
              
       
         
       
      
       if sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then 
          set stop_ = 1;                 
       end if;    
       
       
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
       while stop_ = 0 do
    
       
       set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn mulai susut=',thn_mulai_susut_+masa_manfaat_tot_-1,'nilai_buku_',nilai_buku_,'masa_manfaat_tot_',masa_manfaat_tot_,'thn_mulai_susut_',thn_mulai_susut_);   
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && thn_susut_ak_ > thn_mulai_susut_+masa_manfaat_tot_-1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if; 
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  from penghapusan where year(tgl_penghapusan)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  select count(*) into jml_data_
                  from t_history_aset where year(tgl)=thn_susut_ak_ and (staset_baru=9 or staset_baru=10) and idbi = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pindah aset');
                  end if;
                  
                  select count(*) into jml_data_
                  from gantirugi where year(tgl_gantirugi)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where year(tgl_pemindahtanganan)=thn_susut_ak_ and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          
                            
         
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
            
          
          
          
          
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_ and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1;  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
          select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          

           
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);
        
         if thn_ke_ = 1  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;              
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if thn_ke_ = 1  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;      
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;    
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_;            
          end if;    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);  
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          
          set cek_=concat(cek_,'masa_manfaat_tot_,sisa_masa_manfaat_,akum_nilai_buku_,harga_susut_,akum_harga_susut_,akum_stlh_susut_ =',masa_manfaat_tot_,sisa_masa_manfaat_,akum_nilai_buku_,harga_susut_,akum_harga_susut_,akum_stlh_susut_); 
 
          if stop_ = 0 then
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,id_koreksi)
                   values
                   (tgl_susut_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,0); 
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then      
                update buku_induk set masa_manfaat=if(umur_neraca_awal_>=0,masa_manfaat_tot_+umur_neraca_awal_,masa_manfaat_tot_), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             end if;          
          end if;
          set cek_=concat(cek_,'| masa_manfaat_bi_=',masa_manfaat_bi_,'| masa_manfaat_=',masa_manfaat_,' | stop=',stop_,'\n');     
          
          
       end while;
   else
       set cek_='idbi NULL';   
   end if;

  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode7`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11),  id_koreksi_ INT(11) ) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    
 
  
  
  declare stop_, kondisi_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_, hasil_susut_ longtext;    
  declare tgl_susut2_ , tgl_koreksi_ date;  

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;
  
  set stop_ = 0;
  set cek_ = '';    
  set hasil_susut_ = 'gagal';
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    
    if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;
     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select kondisi, ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into kondisi_, masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ AND id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ AND id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;  
        
       while stop_ = 0 do
    
          
          if stop_ = 0 && kondisi_ = 3 then       
             set stop_ = 1 ;         
             set cek_ = concat(cek_ , 'stop karena rusak berat ');
          end if;  
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');
          end if; 
          if stop_ = 0 then 
               if thn_susut_ak_<=thn_tgl_susut_ then 
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                 from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          
                            
         
         

          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else       
             set tgl_susut2_ = tgl_susut_;
          end if;  

          
          if akum_masa_manfaat_ = '' then 
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_ 
                and tambah_aset=1; 
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else            
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
              
              into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 and year(tgl_pemeliharaan)<=year(tgl_susut2_); 
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1 and year(tgl_pemeliharaan)<=year(tgl_susut2_);  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              
              select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,akum_stlh_susut_) into masa_manfaat_rehab_;
              if akum_masa_manfaat_ = '' then
                SET masa_manfaat_rehab_ = 0; 
              elseif (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_ THEN          
    		  	  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;
              else          
                  SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
              end if;
        
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1 and year(tgl_pengamanan)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and year(tgl_penghapusan)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_  and year(tgl)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and year(tgl_penilaian)<=year(tgl_susut2_);
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          end if;               
        
        
        if akum_masa_manfaat_ = 0  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if akum_masa_manfaat_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ <= 1 && penambahan_hrg_rehab_ <> 0 && penambahan_masa_manfaat_rehab_ = 0 then           
             set sisa_masa_manfaat_ = 1;
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
  
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
          
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             
          if stop_ = 0 then
          if jns_trans2_=31 then  
            set tgl_susut2_ = tgl_koreksi_;
          else        
             set tgl_susut2_ = tgl_susut_;
          end if; 
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_, id_koreksi_);   
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;          
                set hasil_susut_ = 'sukses';                               
             end if;          
          end if;
       end while;
   else
       set cek_='idbi NULL';   
   end if;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode7_20170503`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    

  
  
  declare stop_, kondisi_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;
  declare cek_ longtext;    

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;
  
  set stop_ = 0;
  set cek_ = '';  
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select kondisi, ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into kondisi_, masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     




      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ AND id_koreksi=0;    
    
      
       select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat 
        into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_
        from penyusutan where idbi = idbi_ AND id_koreksi=0 order by id Desc limit 0,1;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
          
       
       
       
       
        
       while stop_ = 0 do
    
       
       set cek_=concat(cek_,thn_tgl_susut_,'thn susut ak=',thn_susut_ak_,'thn mulai susut=',thn_mulai_susut_+masa_manfaat_tot_-1,'masa_manfaat=',masa_manfaat_tot_);   
          
          if stop_ = 0 && kondisi_ = 3 then       
             set stop_ = 1 ;         
             set cek_ = concat(cek_ , 'stop karena rusak berat ');
          end if;  
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' OR f_ = '02' OR f_ = '05' OR f_ = '06') THEN
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');
          end if; 
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          set cek_=concat(cek_,'thn susut ak=',thn_susut_ak_,'thn susut=',thn_mulai_susut_+masa_manfaat_tot_-1); 
                            
         
         
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
          
          
          
          
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_;
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_awal_ and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1;  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
          select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
          if akum_masa_manfaat_ = '' then
            SET masa_manfaat_rehab_ = 0; 
          elseif (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_ THEN          
		  	  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;
          else          
              SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
          end if;
          
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          set cek_=concat(cek_,' | tot_rehab_aset_=',tot_rehab_aset_,' | tot_rehab_manfaat_=',tot_rehab_manfaat_,' | nilai_perolehan_=',nilai_perolehan_,' | hrg_rehab_=',hrg_rehab_, '| masa_manfaat_rehab_=',masa_manfaat_rehab_,'\n');          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_awal_ and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
        
                    
         if akum_harga_susut_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
    
          
          
          if akum_harga_susut_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ <= 1 && penambahan_hrg_rehab_ <> 0 && penambahan_masa_manfaat_rehab_ = 0 then           
             set sisa_masa_manfaat_ = 1;
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
  
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          
          if stop_ = 0 then
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c,d,e,e1,f,g,h,i,j,jns_trans2,id_koreksi_tambah)
                   values
                   (tgl_susut_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_,1,
                   staset_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_, id_koreksi_);   
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=1 where id=idbi_;               
             end if;          
          end if;
          set cek_=concat(cek_,' | stop=',stop_,'\n');     
          
          
       end while;
   else
       set cek_='idbi NULL';   
   end if;

  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode8`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN
    
  
   
   

  declare stop_ int;
  declare update_bi int;
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, bln_susut_ak_, sem_susut_ak_, thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int;
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);    
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,2);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,2);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,2);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2); 
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_, sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_,jml_data_cek_ int;  
  declare jml_bln_ int;
  declare cek_idlama_ int;
  declare percen_pemelihaaan, cek_persen_ decimal(18,2);    
  
  declare cek_, test_, hasil_susut_ longtext; 
  declare tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set stop_ = 0;
  set cek_ = '';
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set thn_ke_=1;
  set percen_pemelihaaan=0;      
  set cek_persen_=0;
  set hasil_susut_ = 'gagal';      
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  

      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;      

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_,f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;
    
    
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;      
      set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         if masa_manfaat_brg_ <> '' then
             set masa_manfaat_ = masa_manfaat_brg_*2;      
             set persen_residu_ = residu_brg_;     
         else
             set masa_manfaat_ = 0;      
             set persen_residu_ = 0; 
         end if;        
      else   
         set masa_manfaat_ = masa_manfaat_bi_*2;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_ba_) <> 0 ,  month(tgl_ba_),month(tgl_buku_));
      
      
      if thn_perolehan_< 2015 then            
         set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;         
         if sem_mulai_susut_ = 2 then 
            set sem_mulai_susut_ = 1;                    
         else
            set sem_mulai_susut_ = sem_mulai_susut_;      
         end if;
      else      
         set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
      end if;
        
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      
      set sem_susut_ak_ = if( sem_susut_ak_bi_ > sem_mulai_susut_,sem_susut_ak_bi_,sem_mulai_susut_);    
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_ 
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,sem,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn 
        into thn_susut_ak_,bln_susut_ak_,sem_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;
          
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
       set sisa_masa_manfaat_thn_=sisa_masa_manfaat_awl_/2;          
    
       
       if akum_harga_susut_ = '' then 
             set thn_susut_ak_=thn_susut_ak_;         
             set sem_susut_ak_ = sem_susut_ak_;                        
             set masa_manfaat_ = masa_manfaat_;
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 or (sisa_masa_manfaat_ = 0 && (f_ = '03' or f_ = '04')) then 
           set sem_susut_ak_=sem_susut_ak_+1;
           if sem_susut_ak_>2 then     
             set sem_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);
       end if;       
          
           if sem_susut_ak_ = 2 then       
              set bln_susut_aw_ = 7;
              set bln_susut_ak_ = 12;
           else       
              set bln_susut_aw_ = 1;
              set bln_susut_ak_ = 6;
           end if; 
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
       while stop_ = 0 do
          
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif thn_tgl_susut_*2 + sem_tgl_susut_ <  thn_susut_ak_*2 + if(akum_harga_susut_ = '' && (sem_mulai_susut_ <> if(bln_mulai_susut_ >6 , 2, 1)),if(bln_mulai_susut_ >6 , 2, 1),sem_susut_ak_) then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
        
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          
          
        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and if(month(tgl_penghapusan)>=1 and month(tgl_penghapusan)<=6,1,2)=sem_susut_ak_) or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and if(month(tgl_gantirugi)>=1 and month(tgl_gantirugi)<=6,1,2)=sem_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and if(month(tgl_pemindahtanganan)>=1 and month(tgl_pemindahtanganan)<=6,1,2)=sem_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
          
    
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if; 
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0; 
           
          
          if akum_masa_manfaat_ = '' then 
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) <= thn_susut_ak_*2+sem_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) <= thn_susut_ak_*2+sem_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) <= thn_susut_ak_*2+sem_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) <= thn_susut_ak_*2+sem_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) <= thn_susut_ak_*2+sem_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else                
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
              
              into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) < thn_susut_ak_*2+sem_susut_ak_ and tambah_masamanfaat=1;  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
               
              
              if tot_rehab_manfaat_ <> 0 then          
                  if f_ = '03' or f_ = '04' then          
                     set percen_pemelihaaan=(tot_rehab_manfaat_/akum_stlh_susut_)*100;
                     set percen_pemelihaaan=if(percen_pemelihaaan is null,0,percen_pemelihaaan);
                     
                     select max(persen2) into cek_persen_ from ref_tambah_manfaat
                     where CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and CAST(h AS UNSIGNED)=h_ and (i='00' or i is null) and (j='000' or j is null);                               
                     
                     if (tot_rehab_aset_ > akum_stlh_susut_) or (percen_pemelihaaan > cek_persen_) then 
                        set masa_manfaat_rehab_ = masa_manfaat_brg_*2;
                     
                     
                     else              
                         select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,akum_stlh_susut_)*2 into masa_manfaat_rehab_;          
                     end if;        
                     
                  else
                     select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,akum_stlh_susut_)*2 into masa_manfaat_rehab_;          
                  end if;  
                     
                     if (masa_manfaat_rehab_+sisa_masa_manfaat_) > (masa_manfaat_brg_*2) then 
                        set masa_manfaat_rehab_ = (masa_manfaat_brg_*2)-sisa_masa_manfaat_+1;
                     else                 
                        set masa_manfaat_rehab_ = masa_manfaat_rehab_;                                     
                     end if;                            
                  set cek_=concat(cek_,' | masa_manfaat_rehab_1=',(masa_manfaat_rehab_*2),'\n');   

              end if;       
              
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
                set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
               set cek_=concat(cek_,' | masa_manfaat_rehab_2=',(masa_manfaat_rehab_*2),'\n');   
         end if;                
        
        set cek_=concat(cek_,' | masa_manfaat_rehab_3=',(masa_manfaat_rehab_*2),'\n');           
        if akum_masa_manfaat_ = ''  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;

          set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/2);     
          
          
          if akum_masa_manfaat_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             

          
           if sem_susut_ak_ = 2 then       
              set bln_susut_aw_ = 7;
              set bln_susut_ak_ = 12;
           else       
              set bln_susut_aw_ = 1;
              set bln_susut_ak_ = 6;
           end if;    
            
          if stop_ = 0 then
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;    
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,bulan_awl,id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,1,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,bln_susut_aw_,id_koreksi_);          
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
          
              if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_/2, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                       bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_susut_aw_ where id=idbi_; 
                set hasil_susut_ = 'sukses';                                          
              end if;  

              set sem_susut_ak_ = sem_susut_ak_+1;         
              if sem_susut_ak_>2 then     
                 set sem_susut_ak_=1;        
                 set thn_susut_ak_=thn_susut_ak_+1;         
                 set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
                 
                 set thn_ke_=thn_ke_+1;
              end if;    

         end if;      
          
       end while;          
    
            
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;   
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode8_20171129`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN
    
  
   

  declare stop_ int;
  declare update_bi int;
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, bln_susut_ak_, sem_susut_ak_, thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int;
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,2);
  declare c1_,c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);    
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,2);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,2);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,2);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2); 
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_, sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_,jml_data_cek_ int;  
  declare jml_bln_ int;
  declare cek_idlama_ int;
  declare percen_pemelihaaan, cek_persen_ decimal(18,2);    
  
  declare cek_, test_, hasil_susut_ longtext; 
  declare tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set stop_ = 0;
  set cek_ = '';
  set thn_tgl_susut_ = year(tgl_susut_);
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set thn_ke_=1;
  set percen_pemelihaaan=0;      
  set cek_persen_=0;
  set hasil_susut_ = 'gagal';      
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  

      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;      

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_,f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;
    
    
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;      
      set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         if masa_manfaat_brg_ <> '' then
             set masa_manfaat_ = masa_manfaat_brg_*2;      
             set persen_residu_ = residu_brg_;     
         else
             set masa_manfaat_ = 0;      
             set persen_residu_ = 0; 
         end if;        
      else   
         set masa_manfaat_ = masa_manfaat_bi_*2;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
     set bln_mulai_susut_ = if(  month(tgl_buku_) <> 0 ,  month(tgl_buku_),month(tgl_ba_));
      
      if thn_perolehan_< 2015 then            
         set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;         
         if sem_mulai_susut_ = 2 then 
            set sem_mulai_susut_ = 1;                    
         else
            set sem_mulai_susut_ = sem_mulai_susut_;      
         end if;
      else      
         set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
      end if;
        
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      
      set sem_susut_ak_ = if( sem_susut_ak_bi_ > sem_mulai_susut_,sem_susut_ak_bi_,sem_mulai_susut_);    
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_ 
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,sem,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn 
        into thn_susut_ak_,bln_susut_ak_,sem_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;
          
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
       set sisa_masa_manfaat_thn_=sisa_masa_manfaat_awl_/2;          
       
       
       
       
    
       
       if akum_harga_susut_ = '' then 
             set thn_susut_ak_=thn_susut_ak_;         
             set sem_susut_ak_ = sem_susut_ak_;                        
             set masa_manfaat_ = masa_manfaat_;
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 or (sisa_masa_manfaat_ = 0 && (f_ = '03' or f_ = '04')) then 
           set sem_susut_ak_=sem_susut_ak_+1;
           if sem_susut_ak_>2 then     
             set sem_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);
       end if;       
          
           if sem_susut_ak_ = 2 then       
              set bln_susut_aw_ = 7;
              set bln_susut_ak_ = 12;
           else       
              set bln_susut_aw_ = 1;
              set bln_susut_ak_ = 6;
           end if; 
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
       while stop_ = 0 do
          
       
       
      
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif thn_tgl_susut_*2 + sem_tgl_susut_ <  thn_susut_ak_*2 + if(akum_harga_susut_ = '' && (sem_mulai_susut_ <> if(bln_mulai_susut_ >6 , 2, 1)),if(bln_mulai_susut_ >6 , 2, 1),sem_susut_ak_) then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
        
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          
          
        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and if(month(tgl_penghapusan)>=1 and month(tgl_penghapusan)<=6,1,2)=sem_susut_ak_) or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and if(month(tgl_gantirugi)>=1 and month(tgl_gantirugi)<=6,1,2)=sem_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and if(month(tgl_pemindahtanganan)>=1 and month(tgl_pemindahtanganan)<=6,1,2)=sem_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
          
    
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if; 
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
            
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_awal_ 
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_awal_ 
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) < thn_susut_ak_*2+sem_susut_ak_ and tambah_masamanfaat=1;  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
           
          
          if tot_rehab_manfaat_ <> 0 && (f_ = '03' or f_ = '04') then          
             set percen_pemelihaaan=(tot_rehab_manfaat_/akum_stlh_susut_)*100;
             set percen_pemelihaaan=if(percen_pemelihaaan is null,0,percen_pemelihaaan);
             
             select max(persen2) into cek_persen_ from ref_tambah_manfaat
             where CAST(f AS UNSIGNED) = f_ and CAST(g AS UNSIGNED)=g_ and CAST(h AS UNSIGNED)=h_ and (i='00' or i is null) and (j='000' or j is null);    

             if akum_stlh_susut_ = 0 then 
                set masa_manfaat_rehab_ = (masa_manfaat_brg_*2)-sisa_masa_manfaat_;                               
             
             elseif (tot_rehab_aset_ > akum_stlh_susut_) or (percen_pemelihaaan > cek_persen_) then 
                set masa_manfaat_rehab_ = (masa_manfaat_brg_*2)-sisa_masa_manfaat_+1;              
             else
                 select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,akum_stlh_susut_)*2 into masa_manfaat_rehab_;          
             end if;
             
          else
             select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,akum_stlh_susut_)*2 into masa_manfaat_rehab_;          
          end if;        


          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_awal_ 
            and tgl_pengamanan <= tgl_susut2_ 
            and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_awal_ 
            and tgl_penghapusan <= tgl_susut2_ 
            and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_awal_ 
            and tgl <= tgl_susut2_ 
            and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_awal_ 
            and tgl_penilaian <= tgl_susut2_ 
            and year(tgl_perolehan)*2+if(month(tgl_perolehan)>=1 and month(tgl_perolehan)<=6,1,2) = thn_susut_ak_*2+sem_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);            
        
        
        if akum_masa_manfaat_ = ''  then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;

          set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/2);     
          
          
          if akum_masa_manfaat_ = ''  then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             

          
           if sem_susut_ak_ = 2 then       
              set bln_susut_aw_ = 7;
              set bln_susut_ak_ = 12;
           else       
              set bln_susut_aw_ = 1;
              set bln_susut_ak_ = 6;
           end if;    
            
          if stop_ = 0 then
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;    
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,bulan_awl,id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,1,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,bln_susut_aw_,id_koreksi_);          
    
              
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
          
              if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_/2, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                       bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_susut_aw_ where id=idbi_; 
                set hasil_susut_ = 'sukses';                                          
              end if;  

              set sem_susut_ak_ = sem_susut_ak_+1;         
              if sem_susut_ak_>2 then     
                 set sem_susut_ak_=1;        
                 set thn_susut_ak_=thn_susut_ak_+1;         
                 set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
                 
                 set thn_ke_=thn_ke_+1;
              end if;    

         end if;      
          
       end while;          
    
            
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;   
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode9`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    
 
  
  
  declare stop_, stat_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_aw_, thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c1_, c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;  
  declare ket_ varchar(255);
  declare cek_, hasil_susut_ longtext;      
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;  
  set thn_susut_aw_=0;
  
  set stop_ = 0;  
  set ket_ = '';
  set cek_ = ''; 
  set stat_ = 0; 
  set hasil_susut_ = 'gagal'; 
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    
      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;      

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';        
    
      
      select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
     if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = residu_brg_;     
      else   
         if masa_manfaat_bi_ <> masa_manfaat_brg_ then         
             set masa_manfaat_ = masa_manfaat_brg_;     
             set persen_residu_ = residu_brg_;     
         else         
             set masa_manfaat_ = masa_manfaat_bi_;     
             set persen_residu_ = residu_bi_;         
         end if;
      end if;

      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
            
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(if(stat=2,masa_manfaat/12,masa_manfaat)), sum(hrg_rehab),sum(ifnull(masa_manfaat_rehab,0))
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_, penambahan_hrg_rehab_prev_, penambahan_masa_manfaat_rehab_prev_ 
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
     
      select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat,stat  
       into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,stat_ 
       from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;  

     
     select min(tahun) into thn_susut_aw_ from penyusutan where idbi=idbi_;       

      set thn_susut_aw_ = if(thn_susut_aw_ is null, thn_mulai_susut_, thn_susut_aw_);   
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_; 
        
       while stop_ = 0 do
    
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06' or f_ = '07') then
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > umur ekoknomis barang  ');
          end if; 
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;                           
         
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
           
          if akum_masa_manfaat_ = '' then 
              SELECT  IFNULL(SUM(biaya_pemeliharaan),0) INTO tot_rehab_
                FROM pemeliharaan WHERE idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_ 
                and tambah_aset=1; 
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(biaya_pengamanan),0) INTO tot_rehab_
                FROM pengamanan WHERE idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_hapus),0) INTO tot_rehab_
                FROM penghapusan_sebagian WHERE idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ - IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(harga_baru-harga),0) INTO tot_rehab_
                FROM t_koreksi WHERE idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0); 
              
              SELECT IFNULL(SUM(nilai_barang+nilai_barang_asal),0) INTO tot_rehab_
                FROM penilaian WHERE idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                AND YEAR(tgl_perolehan) <= thn_susut_ak_;
              SET hrg_rehab_ = hrg_rehab_ + IFNULL(tot_rehab_,0);
              SET masa_manfaat_rehab_ = 0;                      
          else               
              select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
              ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
              
              into tot_rehab_aset_, tot_rehab_manfaat_ 
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              
              
              select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
                from pemeliharaan where idbi_awal = idbi_awal_ 
                and tgl_pemeliharaan <= tgl_susut2_ 
                and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1;  
              
              
              set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
              
              
              select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
              if (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_  THEN    
                   set ket_ = concat(ket_, 'penambahan ' ,masa_manfaat_rehab_,' melebihi masa manfaat awal. \n' );    
    			  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;          
              else          
                  SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
              end if;           
              
              set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
              set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
              
      
              
              select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
                from pengamanan where idbi_awal = idbi_awal_ 
                and tgl_pengamanan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_hapus),0) into tot_rehab_
                from penghapusan_sebagian where idbi_awal = idbi_awal_ 
                and tgl_penghapusan <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(harga_baru-harga),0) into tot_rehab_
                from t_koreksi where idbi_awal = idbi_awal_ 
                and tgl <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
              
              
              select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
                from penilaian where idbi_awal = idbi_awal_ 
                and tgl_penilaian <= tgl_susut2_ 
                and year(tgl_perolehan)=thn_susut_ak_;
              set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);               
          end if;    

        
          
         if penambahan_nilai_buku_prev_ = 0 && akum_harga_susut_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 

          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
  
          if penambahan_nilai_buku_prev_ <> 0 and akum_harga_susut_ = 0 then                        
             
             if thn_susut_aw_ <> thn_perolehan_ then                          
                 select sum(harga) , sum(masa_manfaat)-((max(tahun))-thn_mulai_susut_),sum(hrg_perolehan) 
                 into akum_harga_susut_, sisa_masa_manfaat_, akum_nilai_buku_
                 from penyusutan where idbi=idbi_;                  
             else             
                 select sum(harga) , sum(masa_manfaat)-((max(tahun)+1)-thn_mulai_susut_),sum(hrg_perolehan) 
                 into akum_harga_susut_, sisa_masa_manfaat_, akum_nilai_buku_
                 from penyusutan where idbi=idbi_;                  
             end if;         
             set sisa_masa_manfaat_=sisa_masa_manfaat_+penambahan_masa_manfaat_;
          elseif akum_masa_manfaat_ = '' then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;  
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;                              
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else            
             set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_;            
          end if;    
        
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 

          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;                                            
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
            
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          set akum_masa_manfaat_=akum_masa_manfaat_+masa_manfaat_tot_;             
          if stop_ = 0 then
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,                   
                   staset,c1, c,d,e,e1,f,g,h,i,j,ket,jns_trans2,id_koreksi_tambah,stat,bulan_awl)
                   values
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,
                   staset_,c1_, c_,d_,e_,e1_,f_,g_,h_,i_,j_,ket_,jns_trans2_,id_koreksi_,1,1); 
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_susut_aw_, bln_susut_aw=1 where id=idbi_;
                set ket_ = '';
             set hasil_susut_ = 'sukses';                                           
             end if;          
          end if;
       end while;
       
   else
       set cek_='idbi NULL';   
   end if;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode9_20180113`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ int(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN    
 
  
  
  declare stop_, stat_ int;
  declare update_bi, con_thn_mulai_susut_, thn_mulai_susut_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_ int;  
  declare thn_susut_aw_, thn_susut_ak_,thn_ke_ int;
  declare cek_thn_susut_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_ int;
  declare tgl_buku_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,2);
  declare nilai_buku_ decimal(18,2);  
  declare masa_manfaat_tot_ int;  
  declare harga_susut_ decimal(18,2);
  declare c1_, c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,2);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,2);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_ decimal(18,2);  
  declare nilai_perolehan_ decimal(18,2); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,2);
  declare masa_manfaat_rehab_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,2);   
  declare jml_data_ int;  
  declare ket_ varchar(255);
  declare cek_, hasil_susut_ longtext;      
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;  
  set thn_tgl_susut_ = year(tgl_susut_);  
  set sem_tgl_susut_ = 2;
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set thn_ke_=1;  
  set thn_susut_aw_=0;
  
  set stop_ = 0;  
  set ket_ = '';
  set cek_ = ''; 
  set stat_ = 0; 
  set hasil_susut_ = 'gagal'; 
    
 
 select idawal into idbi_awal_ from buku_induk where id = idbi_; 
 if idbi_awal_ is not NULL then  
    

      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;      

     
      
    
      
      select ifnull(masa_manfaat,0), thn_perolehan, thn_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, staset 
        into masa_manfaat_bi_, thn_perolehan_, thn_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, sem_susut_ak_bi_  ,idbi_awal_, staset_
        from buku_induk where id = idbi_;    
      
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
    
      
     if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_;     
         set persen_residu_ = residu_brg_;     
      else   
         if masa_manfaat_bi_ <> masa_manfaat_brg_ then         
             set masa_manfaat_ = masa_manfaat_brg_;     
             set persen_residu_ = residu_brg_;     
         else         
             set masa_manfaat_ = masa_manfaat_bi_;     
             set persen_residu_ = residu_bi_;         
         end if;
      end if;

      
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
            
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
    
     

      
      select sum(ifnull(hrg_perolehan,0)), sum(if(stat=2,masa_manfaat/12,masa_manfaat)), sum(hrg_rehab),sum(ifnull(masa_manfaat_rehab,0))
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_, penambahan_hrg_rehab_prev_, penambahan_masa_manfaat_rehab_prev_ 
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
     
      select (tahun+1),akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke+1,sisa_masa_manfaat,stat  
       into thn_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,stat_ 
       from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;  
       
       
       if stat_ = 2 then       
          set sisa_masa_manfaat_ = CEIL(sisa_masa_manfaat_/12)+1;
          
          set ket_ = "sisa manfaat berubah menjadi tahunan";
       end if;     

     
     select min(tahun) into thn_susut_aw_ from penyusutan where idbi=idbi_;       

      set thn_susut_aw_ = if(thn_susut_aw_ is null, thn_mulai_susut_, thn_susut_aw_);   
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       set masa_manfaat_ = masa_manfaat_tot_;
       set sisa_masa_manfaat_awl_=masa_manfaat_;
 

          
       
       
       
       
        
       while stop_ = 0 do
    
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          elseif stop_ = 0 && thn_tgl_susut_ < thn_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06' or f_ = '07') then
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > umur ekoknomis barang  ');
          end if; 
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where (year(tgl_penghapusan)=thn_susut_ak_ or  tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ; 
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ( year(tgl_gantirugi)=thn_susut_ak_ or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  from pemindahtanganan where ( year(tgl_pemindahtanganan)=thn_susut_ak_ or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;              
               end if;
          end if;
          
                            
         
         
           if jns_trans2_=31 then  
              set tgl_susut2_ = tgl_koreksi_;
           else       
              set tgl_susut2_ = tgl_susut_;
           end if;   
          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
          
          
          
          
          
          select ifnull(sum(if(tambah_aset=1,biaya_pemeliharaan,0)),0), 
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_awal_ 
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)=thn_susut_ak_;
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_awal_ 
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)<thn_susut_ak_ and tambah_masamanfaat=1;  
          
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
              
              select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;
                  if akum_masa_manfaat_ = 0 then
                    SET masa_manfaat_rehab_ = 0; 
                  elseif (masa_manfaat_rehab_+sisa_masa_manfaat_) > masa_manfaat_brg_  THEN    
                       set ket_ = concat(ket_, 'penambahan ' ,masa_manfaat_rehab_,' melebihi masa manfaat awal. \n' );    
        			  SET masa_manfaat_rehab_ = masa_manfaat_brg_-sisa_masa_manfaat_+1;          
                  else          
                      SET masa_manfaat_rehab_ = masa_manfaat_rehab_;  
                  end if;           
          
          
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_awal_ 
            and tgl_pengamanan <= tgl_susut2_ 
            and year(tgl_perolehan)=thn_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_awal_ 
            and tgl_penghapusan <= tgl_susut2_ 
            and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_awal_ 
            and tgl <= tgl_susut2_ 
            and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          
          select ifnull(sum(nilai_barang-nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_awal_ 
            and tgl_penilaian <= tgl_susut2_ 
            and year(tgl_perolehan)=thn_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
        
                    
         
              
          
              
              
          
          
         if penambahan_nilai_buku_prev_ = 0 && akum_harga_susut_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if; 
          
          
          
          

          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
    
          
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;

    
          
          
    
          if penambahan_nilai_buku_prev_ <> 0 and akum_harga_susut_ = 0 then                        
             
             if thn_susut_aw_ <> thn_perolehan_ then                          
                 select sum(harga) , sum(masa_manfaat)-((max(tahun))-thn_mulai_susut_),sum(hrg_perolehan) 
                 into akum_harga_susut_, sisa_masa_manfaat_, akum_nilai_buku_
                 from penyusutan where idbi=idbi_;                  
             else             
                 select sum(harga) , sum(masa_manfaat)-((max(tahun)+1)-thn_mulai_susut_),sum(hrg_perolehan) 
                 into akum_harga_susut_, sisa_masa_manfaat_, akum_nilai_buku_
                 from penyusutan where idbi=idbi_;                  
             end if;         
             set sisa_masa_manfaat_=sisa_masa_manfaat_+penambahan_masa_manfaat_;
             
             
             
             
             
             
          elseif akum_masa_manfaat_ = '' then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;  
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;                              
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else            
             set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_;            
          end if;    
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
          
          
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;                                            
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);

          
              
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;      
          
          if stop_ = 0 then
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
              
              insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,                   
                   staset,c1, c,d,e,e1,f,g,h,i,j,ket,jns_trans2,id_koreksi_tambah,stat,bulan_awl)
                   values
                   (tgl_susut2_, thn_susut_ak_, 2, 12, idbi_, idbi_awal_, harga_susut_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_, penambahan_hrg_rehab_, penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,masa_manfaat_tot_,thn_ke_,sisa_masa_manfaat_,
                   staset_,c1_, c_,d_,e_,e1_,f_,g_,h_,i_,j_,ket_,jns_trans2_,id_koreksi_,1,1); 
                   
             set penambahan_nilai_buku_prev_ = nilai_buku_;         
             set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
             set penambahan_hrg_rehab_prev_ = hrg_rehab_;
             set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
             
             set update_bi = 1;
             set thn_susut_ak_ = thn_susut_ak_+1;         
    
             
             set thn_ke_=thn_ke_+1;
                
             if update_bi =1 then     
                update buku_induk set masa_manfaat=masa_manfaat_tot_, nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_-1,        
                       bln_susut_ak=12, thn_susut_aw=thn_susut_aw_, bln_susut_aw=1 where id=idbi_;
                set ket_ = '';
             set hasil_susut_ = 'sukses';                                           
             end if;          
          end if;
          
          
          
       end while;

   
   
   
       
   else
       set cek_='idbi NULL';   
   end if;
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `sf_susut_mode9_bln`(idbi_ int(11), tgl_susut_ date, uid_ varchar(20), jns_trans2_ int(11), id_koreksi_ INT(11)) RETURNS longtext CHARSET latin1
    DETERMINISTIC
BEGIN 
   
  declare stop_, stat_ int;
  declare update_bi int; 
  declare con_thn_mulai_susut_, thn_mulai_susut_, thn_susut_ak_bi_, con_bln_mulai_susut_, sem_mulai_susut_, bln_mulai_susut_, bln_susut_ak_bi_ int;  
  declare thn_tgl_susut_, sem_tgl_susut_, bln_tgl_susut_, sem_ int;
  declare masa_manfaat_awl_,masa_manfaat_, persen_residu_ int;  
  declare masa_manfaat_bi_, thn_perolehan_ int;
  declare bln_susut_aw_ int;  
  declare thn_susut_ak_, thn_ke_, bln_susut_ak_, sem_susut_ak_ int;
  declare cek_thn_susut_,cek_susut_thn_ int;
  declare residu_bi_, nilai_sisa_, sem_susut_ak_bi_, idbi_awal_, idbi_lama_ int; 
  declare tgl_buku_, tgl_ba_ date;  
  declare masa_manfaat_brg_, residu_brg_ int;  
  declare jml_harga_bi_ decimal(18,5);
  declare nilai_buku_ decimal(18,5);  
  declare masa_manfaat_tot_, masa_manfaat_tot_bi_ int;  
  declare harga_susut_, harga_susut_sem1_, harga_susut_sem2_, harga_susut_smm_ decimal(18,5);
  declare c1_, c_,d_,e_ char(2);  
  declare e1_ char(3);
  declare f_,g_,h_,i_ char(2);  
  declare j_ char(3);  
  declare flama_,glama_,hlama_,ilama_ char(2);  
  declare jlama_ char(3);
  declare staset_ int;
  declare penambahan_nilai_buku_, penambahan_hrg_rehab_ decimal(18,5);
  declare penambahan_masa_manfaat_, penambahan_masa_manfaat_rehab_ int;
  declare penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_ decimal(18,5);
  declare penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_ int;
  declare penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_ decimal(18,5);
  declare penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_ int;
  declare penambahan_nilai_buku_smm_, penambahan_hrg_rehab_smm_ decimal(18,5);
  declare penambahan_masa_manfaat_smm_, penambahan_masa_manfaat_rehab_smm_ int;
  declare penambahan_nilai_buku_prev_, penambahan_hrg_rehab_prev_ decimal(18,5);
  declare penambahan_masa_manfaat_prev_, penambahan_masa_manfaat_rehab_prev_ int;
  declare tot_rehab_, tot_rehab_aset_, tot_rehab_manfaat_, tot_rehab_prev_  decimal(18,5);  
  declare nilai_perolehan_ decimal(18,5); 
  declare tot_manfaat_ int;
  declare hrg_rehab_ decimal(18,5);
  declare masa_manfaat_rehab_,masa_manfaat_rehab_susut_thn_ int;
  declare sisa_masa_manfaat_,sisa_masa_manfaat_awl_,sisa_masa_manfaat_thn_ int;  
  declare akum_masa_manfaat_ int;
  declare akum_nilai_buku_,akum_harga_susut_,akum_stlh_susut_ decimal(18,5);   
  declare jml_data_,jml_data_cek_, cek_thn_susut_ak_ int;  
  declare jml_bln_ int;  
  
  declare cek_susut_first int;  
  declare cek_idlama_ int;  
  declare ket_ varchar(255);
  declare cek_, test_, hasil_susut_ longtext;    
  DECLARE tgl_susut2_, tgl_koreksi_ date ; 

  set nilai_buku_ = 0;
  set masa_manfaat_ = 0;
  set masa_manfaat_tot_ = 0;
  set masa_manfaat_tot_bi_ = 0;
  set masa_manfaat_awl_ = 0;
  set masa_manfaat_rehab_ = 0;    
  set persen_residu_ = 0;  
  set con_thn_mulai_susut_ = 0;
  set con_bln_mulai_susut_ = 1;  
  set penambahan_nilai_buku_prev_ = 0;
  set penambahan_hrg_rehab_prev_ = 0;
  set penambahan_masa_manfaat_prev_ = 0;  
  set penambahan_masa_manfaat_rehab_prev_ = 0;
  set hrg_rehab_ = 0; 
  set masa_manfaat_rehab_ = 0;
  set masa_manfaat_rehab_susut_thn_ = 0;    
  set akum_nilai_buku_ = 0;
  set akum_harga_susut_ = 0;  
  set akum_stlh_susut_ = 0;
  set akum_masa_manfaat_ = 0;  
  set sisa_masa_manfaat_=0;  
  set sisa_masa_manfaat_thn_=0;
  
  set thn_ke_=1;
  set stop_ = 0;  
  set stat_ = 0;
  set cek_ = '';  
  set cek_susut_thn_=0;
  set thn_tgl_susut_ = if(year(tgl_susut_)>2015,2015,year(tgl_susut_));
  set bln_tgl_susut_ = month(tgl_susut_);     
  set sem_tgl_susut_ = if(month(tgl_susut_) >6 , 2, 1) ;  
  set jml_bln_ =0;  
  set jml_data_ =0;  
  set jml_data_cek_ =0;  
  set ket_ = '';  
  set hasil_susut_ = 'gagal';    
  
  
 select idawal into idbi_awal_ from buku_induk where id = idbi_;  
 if idbi_awal_ is not NULL then   

      if jns_trans2_ = 31 then            
         select tgl into tgl_koreksi_ from t_koreksi_penyusutan where id = id_koreksi_;
      end if;      

     
      select nilai into con_thn_mulai_susut_ from setting where Id = 'THN_MULAI_SUSUT';         
        
      
      select ifnull(masa_manfaat,0), thn_perolehan, tgl_ba, thn_susut_ak, bln_susut_ak, jml_harga, nilai_sisa , tgl_buku, c1, c, d, e, e1, f, g, h, i, j, if(bln_susut_ak > 6, 2,1) , idawal, id_lama, staset 
        into masa_manfaat_bi_, thn_perolehan_, tgl_ba_, thn_susut_ak_bi_, bln_susut_ak_bi_, jml_harga_bi_, residu_bi_, tgl_buku_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_ , j_, sem_susut_ak_bi_  ,idbi_awal_, idbi_lama_, staset_
        from buku_induk where id = idbi_;    
    
     
      if idbi_awal_ <> idbi_ then    
          
          if idbi_lama_ is not NULL then              
             
             select count(*) into cek_idlama_ from penyusutan where idbi = idbi_lama_;
              if cek_idlama_ > 0 then                 
                  select tgl_ba, tgl_buku
                    into tgl_ba_, tgl_buku_
                    from buku_induk where id = idbi_lama_;                    
              else
                  select f,g,h,i,j into flama_,glama_,hlama_,ilama_,jlama_ 
                    from buku_induk where id = idbi_lama_;       
                  if flama_=06 && (f_= 02 || f_= 03 || f_ = 04 || f_ = 05) then                                    
                      set tgl_ba_=tgl_ba_;    
                      set tgl_buku_=tgl_buku_;                                                  
                  else
                      select tgl_ba, tgl_buku
                        into tgl_ba_, tgl_buku_
                        from buku_induk where id = idbi_lama_;  
                  end if;    
              end if;                         
          else 
              select tgl_ba, tgl_buku
                into tgl_ba_, tgl_buku_
                from buku_induk where id = idbi_awal_;
          end if;      
      end if;    

       set tgl_ba_ = if(tgl_ba_ is null, '0000-00-00', tgl_ba_);  
      
             
      
      select masa_manfaat, residu into masa_manfaat_brg_, residu_brg_
        from  ref_barang where f= f_ and g=g_ and h=h_ and i= i_ and j=j_;
      
      
      if masa_manfaat_bi_ = NULL or masa_manfaat_bi_ = 0 then  
         set masa_manfaat_ = masa_manfaat_brg_*12;     
         set persen_residu_ = residu_brg_;     
      else   
         set masa_manfaat_ = masa_manfaat_bi_*12;     
         set persen_residu_ = residu_bi_;         
      end if;
      
      
      set thn_mulai_susut_ = if( con_thn_mulai_susut_ >  thn_perolehan_ , con_thn_mulai_susut_,thn_perolehan_);
      set bln_mulai_susut_ = if(  month(tgl_buku_) <> 0 ,  month(tgl_buku_),month(tgl_ba_));
      set sem_mulai_susut_ = if(bln_mulai_susut_ >6 , 2, 1) ;
      
      
      set thn_susut_ak_ = if( thn_susut_ak_bi_ > thn_mulai_susut_,thn_susut_ak_bi_,thn_mulai_susut_);  
      set bln_susut_ak_ = if( bln_susut_ak_bi_ > bln_mulai_susut_,bln_susut_ak_bi_,bln_mulai_susut_);  
    
     
      
      select sum(ifnull(hrg_perolehan,0)), sum(masa_manfaat)
        into penambahan_nilai_buku_prev_, penambahan_masa_manfaat_prev_
        from penyusutan where idbi = idbi_ and id_koreksi=0;    
    
      
       select tahun,bulan,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat 
        into thn_susut_ak_,bln_susut_ak_,akum_nilai_buku_,akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,stat_
        from penyusutan where idbi = idbi_ and id_koreksi=0 order by id Desc limit 0,1;        

      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
    
      set penambahan_nilai_buku_prev_ = if(penambahan_nilai_buku_prev_ is null, 0, penambahan_nilai_buku_prev_);  
      set penambahan_hrg_rehab_prev_ = if(penambahan_hrg_rehab_prev_ is null, 0, penambahan_hrg_rehab_prev_);  
      set penambahan_masa_manfaat_prev_ = if(penambahan_masa_manfaat_prev_ is null, 0, penambahan_masa_manfaat_prev_);  
      set penambahan_masa_manfaat_rehab_prev_ = if(penambahan_masa_manfaat_rehab_prev_ is null, 0, penambahan_masa_manfaat_rehab_prev_);
     
    
       set masa_manfaat_tot_ = if(penambahan_masa_manfaat_prev_ = 0, masa_manfaat_, penambahan_masa_manfaat_prev_);
       set nilai_buku_ = if(penambahan_nilai_buku_prev_ = 0, nilai_buku_, penambahan_nilai_buku_prev_);
       
       set sisa_masa_manfaat_awl_=masa_manfaat_;
    
          
       
       
       
       
     
       
       if akum_masa_manfaat_ = '' then 
             set bln_susut_ak_=bln_susut_ak_;        
             set thn_susut_ak_=thn_susut_ak_;         
             set masa_manfaat_ = masa_manfaat_;
       elseif sisa_masa_manfaat_ <> 1 or sisa_masa_manfaat_ <> 0 then 
           set bln_susut_ak_=bln_susut_ak_+1;
           if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;
           end if;       
           set masa_manfaat_ = if(penambahan_masa_manfaat_rehab_prev_ = 0, masa_manfaat_, masa_manfaat_);
       end if;
       
    
      set penambahan_nilai_buku_sem1_ = 0;
      set penambahan_masa_manfaat_sem1_ = 0;  
      set penambahan_hrg_rehab_sem1_ = 0;
      set penambahan_masa_manfaat_rehab_sem1_ = 0;  
      set penambahan_nilai_buku_sem2_ = 0;
      set penambahan_masa_manfaat_sem2_ = 0;  
      set penambahan_hrg_rehab_sem2_ = 0;
      set penambahan_masa_manfaat_rehab_sem2_ = 0;  
      set penambahan_nilai_buku_smm_ = 0;
      set penambahan_masa_manfaat_smm_ = 0;  
      set penambahan_hrg_rehab_smm_ = 0;
      set penambahan_masa_manfaat_rehab_smm_ = 0;  
      set harga_susut_sem1_ = 0;
      set harga_susut_sem2_ = 0;
      set harga_susut_smm_ = 0;  
      
      while stop_ = 0 do
          
      
      select count(*) into cek_susut_first from penyusutan where idbi = idbi_ and id_koreksi=0;
 
       
       
       
       
          
          if stop_ = 0 && masa_manfaat_ <= 0 then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena masa manfaat belum di set ');
          
          
          elseif thn_tgl_susut_*12 + bln_tgl_susut_ <=  thn_susut_ak_*12 + bln_susut_ak_ then  
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena tanggal susut > tanggal terakhir disusutkan');            
          
          elseif stop_ = 0 && sisa_masa_manfaat_ = 1 && (f_ = '01' or f_ = '02' or f_ = '05' or f_ = '06') then
          
              set stop_ = 1; 
              set cek_ = concat(cek_ , 'stop karena sisa manfaat sudah habis');
          end if;
          set sem_susut_ak_ = if(bln_susut_ak_ > 6, 2,1);       
          
        
         
          if stop_ = 0 then
               if thn_susut_ak_<=thn_tgl_susut_ then 
               
                  
                  select count(*) into jml_data_
                  
                  from penghapusan where ((year(tgl_penghapusan)=thn_susut_ak_ and month(tgl_penghapusan)=bln_susut_ak_) or tgl_susut_ >= tgl_penghapusan) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;            
                     set cek_ = concat(cek_,'stop karena penghapusan');
                  end if;        
                  
                  
                  
                  select count(*) into jml_data_
                  
                  from gantirugi where ((year(tgl_gantirugi)=thn_susut_ak_ and month(tgl_gantirugi)=bln_susut_ak_) or tgl_susut_>=tgl_gantirugi) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena ganti rugi');
                  end if;          
                  
                  select count(*) into jml_data_
                  
                  from pemindahtanganan where ((year(tgl_pemindahtanganan)=thn_susut_ak_ and month(tgl_pemindahtanganan)=bln_susut_ak_) or tgl_susut_>=tgl_pemindahtanganan ) and id_bukuinduk = idbi_ ;
                  if jml_data_ > 0 then 
                     set stop_ = 1;
                     set jml_data_cek_ = jml_data_;             
                     set cek_ = concat(cek_ , 'stop karena pemindahtanganan');
                  end if;             
               end if;
          end if;
          
         
    
         
         if jns_trans2_=31 then  
           set tgl_susut2_ = tgl_koreksi_;
         else       
           set tgl_susut2_ = tgl_susut_;
         end if;              

          set hrg_rehab_ = 0;   
          set masa_manfaat_rehab_ = 0;          
           
          select  ifnull(sum(biaya_pemeliharaan),0),
          ifnull(sum(if(tambah_masamanfaat=1,biaya_pemeliharaan,0)),0)
          into tot_rehab_aset_, tot_rehab_manfaat_ 
            from pemeliharaan where idbi_awal = idbi_awal_             
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1; 
          
          
          select ifnull(sum(biaya_pemeliharaan),0) into tot_rehab_prev_
            from pemeliharaan where idbi_awal = idbi_awal_             
            and tgl_pemeliharaan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) < thn_susut_ak_*12+bln_susut_ak_ and tambah_masamanfaat=1;  
                     
          
          set nilai_perolehan_ = jml_harga_bi_ + tot_rehab_prev_;
          
          
                  
          
              if tot_rehab_aset_ <> 0 then
                 select sf_get_tambah_manfaat(f_,g_,h_,i_,j_,tot_rehab_manfaat_,nilai_perolehan_) into masa_manfaat_rehab_;          
                 if akum_masa_manfaat_ = 0 then             
                     set masa_manfaat_rehab_ = 0;
                 elseif (masa_manfaat_rehab_*12+sisa_masa_manfaat_) > masa_manfaat_brg_*12 then
                     set masa_manfaat_rehab_ = masa_manfaat_brg_*12-sisa_masa_manfaat_;                               
                 else
                     set masa_manfaat_rehab_ = masa_manfaat_rehab_*12;                
                 end if;      
               end if;       
          
                         
          
          set hrg_rehab_ = ifnull(tot_rehab_aset_,0);
          set masa_manfaat_rehab_ = ifnull(masa_manfaat_rehab_,0);
          
  
          
          select ifnull(sum(biaya_pengamanan),0) into tot_rehab_
            from pengamanan where idbi_awal = idbi_awal_ 
            and tgl_pengamanan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_ and tambah_aset=1;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_hapus),0) into tot_rehab_
            from penghapusan_sebagian where idbi_awal = idbi_             
            and tgl_penghapusan <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ - ifnull(tot_rehab_,0); 
          
          select ifnull(sum(harga_baru-harga),0) into tot_rehab_
            from t_koreksi where idbi_awal = idbi_awal_             
            and tgl <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0); 
          
          select ifnull(sum(nilai_barang+nilai_barang_asal),0) into tot_rehab_
            from penilaian where idbi_awal = idbi_awal_ 
            and tgl_penilaian <= tgl_susut2_ 
            and year(tgl_perolehan)*12+month(tgl_perolehan) = thn_susut_ak_*12+bln_susut_ak_;
          set hrg_rehab_ = hrg_rehab_ + ifnull(tot_rehab_,0);                          
        
        
        if akum_masa_manfaat_ = '' then       
              
              set nilai_buku_ = nilai_buku_+jml_harga_bi_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          else          
              
              set nilai_buku_ = nilai_buku_+hrg_rehab_;
              
              
              set masa_manfaat_tot_ =  masa_manfaat_tot_+masa_manfaat_rehab_;
          end if;                            
    
          
          set penambahan_nilai_buku_ = nilai_buku_-penambahan_nilai_buku_prev_;      
                
          
          set penambahan_hrg_rehab_ = hrg_rehab_;
     
          
          set penambahan_masa_manfaat_ = masa_manfaat_tot_-penambahan_masa_manfaat_prev_;      
          set penambahan_masa_manfaat_rehab_ = masa_manfaat_rehab_;
          
          set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_+(penambahan_masa_manfaat_rehab_/12);                   
    
          
          
          if akum_masa_manfaat_ = '' then      
             set sisa_masa_manfaat_=sisa_masa_manfaat_awl_+penambahan_masa_manfaat_rehab_;   
          elseif sisa_masa_manfaat_ = 0 && penambahan_masa_manfaat_rehab_ <> 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_+penambahan_masa_manfaat_;    
          elseif sisa_masa_manfaat_ = 0 then          
             set sisa_masa_manfaat_ = sisa_masa_manfaat_;  
          else
            set sisa_masa_manfaat_=sisa_masa_manfaat_-1+penambahan_masa_manfaat_; 
          end if;       
    
          
    
    
          
          set akum_nilai_buku_ = akum_nilai_buku_+penambahan_nilai_buku_; 
    
          
          set harga_susut_ = ((akum_nilai_buku_-akum_harga_susut_)-(persen_residu_/100*akum_nilai_buku_))/sisa_masa_manfaat_;      
          set harga_susut_ = if(harga_susut_ is null, 0, harga_susut_);
        
          set akum_harga_susut_=akum_harga_susut_+harga_susut_;
          set akum_stlh_susut_=nilai_buku_-akum_harga_susut_;            
          set akum_masa_manfaat_=akum_masa_manfaat_+penambahan_masa_manfaat_; 
           
    
          
          
        if sem_susut_ak_ = 1 then    
          set penambahan_nilai_buku_sem1_ = penambahan_nilai_buku_sem1_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem1_ = penambahan_masa_manfaat_sem1_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem1_ = penambahan_hrg_rehab_sem1_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem1_ = penambahan_masa_manfaat_rehab_sem1_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem1_ = harga_susut_sem1_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=6 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;             
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem1_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem1_, penambahan_hrg_rehab_sem1_, penambahan_masa_manfaat_sem1_, penambahan_masa_manfaat_rehab_sem1_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem1_ = 0;
          set penambahan_masa_manfaat_sem1_ = 0;  
          set penambahan_hrg_rehab_sem1_ = 0;
          set penambahan_masa_manfaat_rehab_sem1_ = 0;  
          set harga_susut_sem1_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;      
        end if;    
        if sem_susut_ak_ = 2 then      
          set penambahan_nilai_buku_sem2_ = penambahan_nilai_buku_sem2_+penambahan_nilai_buku_;
          set penambahan_masa_manfaat_sem2_ = penambahan_masa_manfaat_sem2_+penambahan_masa_manfaat_;  
          set penambahan_hrg_rehab_sem2_ = penambahan_hrg_rehab_sem2_+penambahan_hrg_rehab_;
          set penambahan_masa_manfaat_rehab_sem2_ = penambahan_masa_manfaat_rehab_sem2_+penambahan_masa_manfaat_rehab_;  
          set harga_susut_sem2_ = harga_susut_sem2_+harga_susut_;
          set bln_susut_aw_=bln_susut_ak_-jml_bln_;     
          set jml_bln_=jml_bln_+1;
          if stop_ = 0 and bln_susut_ak_=12 or (thn_susut_ak_=thn_tgl_susut_ and bln_susut_ak_=bln_tgl_susut_) or (sisa_masa_manfaat_=1) or jml_data_cek_ > 0 then      
             if jns_trans2_ = 31 then    
                set tgl_susut2_ = tgl_koreksi_;  
             else              
               set tgl_susut2_ = tgl_susut_;
             end if;
             insert into penyusutan 
                   (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,masa_manfaat_rehab,
                   residu,akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,sisa_masa_manfaat_thn,stat,bulan_awl,                   
                   staset,c1,c,d,e,e1,f,g,h,i,j,jns_trans2,ket, id_koreksi_tambah)
                   values
                   (tgl_susut2_, thn_susut_ak_, sem_susut_ak_, bln_susut_ak_, idbi_, idbi_awal_, harga_susut_sem2_, uid_, now(), thn_perolehan_, 
                   penambahan_nilai_buku_sem2_, penambahan_hrg_rehab_sem2_, penambahan_masa_manfaat_sem2_, penambahan_masa_manfaat_rehab_sem2_, persen_residu_,
                   akum_nilai_buku_, akum_stlh_susut_,akum_harga_susut_,akum_masa_manfaat_,thn_ke_,sisa_masa_manfaat_,sisa_masa_manfaat_thn_,2,bln_susut_aw_,
                   staset_,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,jns_trans2_,ket_, id_koreksi_);         
          set penambahan_nilai_buku_sem2_ = 0;
          set penambahan_masa_manfaat_sem2_ = 0;  
          set penambahan_hrg_rehab_sem2_ = 0;
          set penambahan_masa_manfaat_rehab_sem2_ = 0;  
          set harga_susut_sem2_ = 0;
          set jml_bln_= 0;
          set ket_ = '';                        
          end if;
        end if;
    
         
         set penambahan_nilai_buku_prev_ = nilai_buku_;         
         set penambahan_masa_manfaat_prev_ = masa_manfaat_tot_;        
         set penambahan_hrg_rehab_prev_ = hrg_rehab_;
         set penambahan_masa_manfaat_rehab_prev_ = masa_manfaat_rehab_;
               
          set update_bi = 1;
           
                
         select ifnull(stat,0) into cek_susut_thn_
         from penyusutan where idbi = idbi_ and stat=1 limit 0,1;        
         
         
         select sum(masa_manfaat) into masa_manfaat_tot_bi_
         from penyusutan where idbi = idbi_;  
     
         if stop_ = 0 and update_bi =1 then     
            update buku_induk set masa_manfaat=if(cek_susut_thn_=1,masa_manfaat_tot_bi_,masa_manfaat_tot_/12), nilai_sisa=persen_residu_, thn_susut_ak=thn_susut_ak_,        
                   bln_susut_ak=bln_susut_ak_, thn_susut_aw=thn_mulai_susut_, bln_susut_aw=bln_mulai_susut_ where id=idbi_;               
            set hasil_susut_ = 'sukses';       
         end if;
  
          set bln_susut_ak_=bln_susut_ak_+1;
          if bln_susut_ak_>12 then     
             set bln_susut_ak_=1;        
             set thn_susut_ak_=thn_susut_ak_+1;         
             set sisa_masa_manfaat_thn_=sisa_masa_manfaat_thn_-1;         
             
             set thn_ke_=thn_ke_+1;
          end if; 
          
          
                
          
       end while;                    
    
          
          
          
   else
       set cek_='idbi NULL';   
   end if;   
   set cek_=concat(cek_,'|||', hasil_susut_);
  RETURN cek_;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sf_jurnal_susut`(id_ int(11))
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, refid_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,2);
  
  
  
  declare uid_ varchar(20);  
  
  
  
  
  declare thn_perolehan_ char(4);  

  
  select tgl, idbi, idbi_awal, harga, thn_perolehan, staset, uid
     into tgl_, idbi_,idawal_, harga_susut_, thn_perolehan_, staset_, uid_
     from penyusutan where Id = id_;
  
  
  set jns_trans2_ = 30;         

  
  if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
  elseif staset_ = 9 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '05' ;   
  elseif staset_ = 10 then    
      set rkint_ = '01'; set rka_ = '00'; set rkb_ = '00' ;   
  end if;       
  

  
  select a1, a, b, c, d, e, e1, f, g, h, i, j
     into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
     from buku_induk where id = idbi_;     

 
 insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c,d,e,e1,f,g,h,i,j,jml_barang_d,jml_barang_k,debet,kredit,
       tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,uid, tgl_update)
    value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 30, idbi_, 0, idbi_, idawal_,a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
       0, 0, harga_susut_, 0, tgl_penghapusan_, 0, 0, 0, 0, 10, uid_, now());
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_cek_kib`(`f_` char(2), mode_ int)
BEGIN



if mode_ = 1 then 

if f_= '01' then
  
  select count(*) as cnt from
   (select aa.*, bb.id as idkib from buku_induk  aa 
   left join kib_a bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';    
elseif f_ ='02' then
  
  select count(*) as cnt from
   (select aa.*, bb.id as idkib  from buku_induk  aa 
   left join kib_b bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';      
elseif f_ ='03' then
  
  select count(*) as cnt from
   (select aa.*, bb.id as idkib  from buku_induk  aa 
   left join kib_c bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';     
elseif f_ ='04' then
  
  select count(*) as cnt from
   (select aa.*, bb.id as idkib  from buku_induk  aa 
   left join kib_d bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';     
elseif f_ ='05' then
  
  select count(*) as cnt from
   (select aa.*, bb.id as idkib  from buku_induk  aa 
   left join kib_e bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';     
elseif f_ ='06' then
  
  select count(*) as cnt from
   (select aa.*, bb.id as idkib  from buku_induk  aa 
   left join kib_f bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';   
end if;


elseif mode_ =2 then

if f_= '01' then
  
  select * from
   (select aa.*, bb.id as idkib  from buku_induk  aa 
   left join kib_a bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';    
elseif f_ ='02' then
  
  select * from
   (select aa.*, bb.id as idkib  from buku_induk  aa 
   left join kib_b bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';      
elseif f_ ='03' then
  
  select * from
   (select aa.*, bb.id as idkib  from buku_induk  aa 
   left join kib_c bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';     
elseif f_ ='04' then
  
  select * from
   (select aa.*, bb.id as idkib  from buku_induk  aa 
   left join kib_d bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';     
elseif f_ ='05' then
  
  select * from
   (select aa.*, bb.id as idkib  from buku_induk  aa 
   left join kib_e bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';     
elseif f_ ='06' then
  
  select * from
   (select aa.*, bb.id as idkib  from buku_induk  aa 
   left join kib_f bb on aa.id = bb.idbi
   where aa.f = f_
   ) as cc
  where cc.idkib is null or cc.idkib='';   
end if;

end if;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_insert_log`(`log_` varchar(255))
BEGIN


  insert into t_log (log) values(log_);     


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_bi`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, id_lama_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, jns_trans3_, staset_, staset2_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_atribusi_, jml_harga_, harga_beli_ decimal(18,2);
  
  declare thn_buku_, thn_perolehan_, asal_usul_, jml_barang_, kondisi_ int(11);  
  declare tgl_create_ datetime;  
  declare cnt_ int;  
  declare refid_terima_ int;  
  declare f1_, f2_ char(1); 
  declare thn_login_ char(4);  
  declare status_barang_ char(1);
    

  
  select a1, a, b, c1, c, d, e, e1, f1,f2, f, g, h, i, j, tgl_buku, thn_perolehan, year(tgl_buku), asal_usul, staset, id, jml_harga, jml_barang, status_barang,
     harga_beli, harga_atribusi, idawal, uid, id_lama, kondisi, tgl_create, refid_terima
     into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_,tgl_, thn_perolehan_, thn_buku_ , asal_usul_, staset_, idbi_ , jml_harga_, jml_barang_, status_barang_, 
     harga_beli_, harga_atribusi_, idawal_, uid_, id_lama_, kondisi_, tgl_create_, refid_terima_
     from buku_induk where id = id_;     

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
  
if (thn_buku_ >= thn_login_) then
      
  
  select sum(div_staset) into staset2_ from t_history_aset where idbi_awal = idawal_ and tgl<=tgl_ ;  
  if staset2_ is not null and  staset2_ <> 0 then    
    set staset_ = staset2_;
  end if;
       
  
  set jns_trans2_=0;  
  set jns_trans_ = 0;   
  set difstaset_ = 0;  
  set jns_trans3_ = 1 ; 
    
  
  set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ; 

  if thn_buku_ <> thn_perolehan_ then 
    set jns_trans2_ = 7;  
    set jns_trans_ = 8; 
  else  
    
    if asal_usul_ = 1 then 
      set jns_trans2_ = 1;  
      
    elseif asal_usul_ = 2 then 
      set jns_trans2_ = 2;              
    elseif asal_usul_ = 3 then 
      set jns_trans2_ = 3;      
    elseif asal_usul_ = 4 and id_lama_ is null then 
      set jns_trans2_ = 4;      
    elseif asal_usul_ = 5 and id_lama_ is null then 
      set jns_trans2_ = 5;     
    elseif asal_usul_ = 6 and id_lama_ is null then 
      set jns_trans2_ = 6;        
    elseif asal_usul_ = 7 and id_lama_ is null then 
      set jns_trans2_ = 7;        
    end if;

    if asal_usul_=1 then
      set jns_trans_ = 1;       
    elseif asal_usul_ =2 or asal_usul_ =3 then
      set jns_trans_ = 4 ;           
    elseif asal_usul_ = 4 then
      set jns_trans_ = 5 ;     
    elseif asal_usul_ = 5 then    
      set jns_trans_ = 9  ;    
    elseif asal_usul_ =6 then    
      set jns_trans_ = 3;      
    elseif asal_usul_ =7 then    
      set jns_trans_ = 8;      
      
    end if; 
  end if; 

  
  if jns_trans2_ >0 then  

    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;          

    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;                  
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;  
    elseif staset_ = 10 then
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;     
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;   
    end if;  


    
    select count(*) into cnt_ from t_transaksi where jns_trans2 in (1,2,3,4,5,6,7,8,28) and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        jns_trans3=jns_trans3_, jns_trans2=jns_trans2_, idbi=idbi_, 
        idawal = idbi_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=jml_harga_,kredit = 0,
        kondisi=kondisi_, asal_usul=asal_usul_, status_barang=status_barang_, refid_terima=refid_terima_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset,jns_trans,  debet,kredit, tgl_update,uid, 
        kondisi, asal_usul, status_barang, tgl_create,refid_terima)   
      values  
        (rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, staset_, jns_trans_, jml_harga_, 0, now(), uid_, 
        kondisi_, asal_usul_, 1 , tgl_create_,refid_terima_);                    
    end if;
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0),
      ifnull(m1,0), ifnull(m2,0), ifnull(m3,0), ifnull(m4,0), ifnull(m5,0), ifnull(m6,0)  
      into  ka_, kb_, kc_, kd_, ke_, kf_, m1_, m2_, m3_, m4_, m5_, m6_
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  

    
   if jns_trans2_ = 1 or jns_trans2_= 2 or jns_trans2_=3 or jns_trans2_=4 or jns_trans2_=5 or 
      jns_trans2_=6 or jns_trans2_=7 or jns_trans2_=8 or jns_trans2_=28 then  
      
      if jns_trans2_ = 1 then      
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, harga_beli_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);                     

        
        if harga_atribusi_ <> 0 then
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 0, 
            0, 0, harga_atribusi_, 0 , tgl_, 0, 2, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , 0, tgl_create_, 0);                           
        end if;
      else            
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, jml_harga_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);             

      end if;
    end if;    

    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;      

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;          
   
    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '01', '02', '05', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 9, 
        1, 5, 4, 1, 0, 0,  now(), uid_, tgl_create_ );     
    end if;     

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 3, 
        0, 0, 0, 0, 0, 0,  now(), uid_, tgl_create_ ); 
    end if; 
                

    
    if staset_=10 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );          

       
       insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         jml_barang_,0, jml_harga_, 0,  tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );                        
    end if;        




  end if;  
end if;   

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_bi_20160510`(id_ int(11) )
BEGIN





  declare qry varchar(300);
  declare idbi_, idawal_, id_lama_, idtrans_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_atribusi_, jml_harga_ decimal(18,2);
  
  declare thn_buku_, thn_perolehan_, asal_usul_, jml_barang_ int(11);
  

  
    
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j, tgl_buku, thn_perolehan, year(tgl_buku), asal_usul, staset, id, jml_harga, jml_barang, harga_atribusi, idawal, uid, id_lama
     into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,tgl_, thn_perolehan_, thn_buku_ , asal_usul_, staset_, idbi_ , jml_harga_, jml_barang_, harga_atribusi_, idawal_, uid_, id_lama_
     from buku_induk where id = id_;     


if id_ = idawal_  then

  
  set jns_trans2_=0;  
  set jns_trans_ = 0;   
  set difstaset_ = 0;
    
  if thn_buku_ <> thn_perolehan_ then 
    set jns_trans2_ = 7;  
    set jns_trans_ = 8; 
  else  
        
    if staset_ = 10 then 
      set jns_trans2_ = 8;        
    elseif staset_ = 9 then 
      set jns_trans2_ = 28; 
    elseif asal_usul_ = 1 then 
      set jns_trans2_ = 1;      
    elseif asal_usul_ = 2 then 
      set jns_trans2_ = 2;              
    elseif asal_usul_ = 3 then 
      set jns_trans2_ = 3;      
    elseif asal_usul_ = 4 and id_lama_ is null then 
      set jns_trans2_ = 4;      
    elseif asal_usul_ = 5 and id_lama_ is null then 
      set jns_trans2_ = 5;     
    elseif asal_usul_ = 6 and id_lama_ is null then 
      set jns_trans2_ = 6;        
    elseif asal_usul_ = 7 and id_lama_ is null then 
      set jns_trans2_ = 7;  
    end if;

    if asal_usul_=1 then
      set jns_trans_ = 1;       
    elseif asal_usul_ =2 or asal_usul_ =3 then
      set jns_trans_ = 4 ;           
    elseif asal_usul_ = 4 then
      set jns_trans_ = 5 ;     
    elseif asal_usul_ = 5 then    
      set jns_trans_ = 9  ;    
    elseif asal_usul_ =6 then    
      set jns_trans_ = 3;      
    elseif asal_usul_ =7 then    
      set jns_trans_ = 8;      
      
    end if;
  end if;


  if jns_trans2_ >0 then
    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;    
    elseif staset_ = 9 and thn_buku_ = thn_perolehan_ then  
      if f_ ='07' then 
         set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
      else  
         set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
      end if;           
    elseif staset_ = 9 and thn_buku_ <> thn_perolehan_ then  
       set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;        
    elseif staset_ = 10 and thn_buku_ = thn_perolehan_ and asal_usul_=1 then 
       set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 10 and thn_buku_ = thn_perolehan_ and asal_usul_<>1 then 
       set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    elseif staset_ = 10 and thn_buku_ <> thn_perolehan_ then 
       set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;  


    
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset,jns_trans,  debet,kredit, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, staset_, jns_trans_, jml_harga_, 0, now(), uid_ );      
    set idtrans_ = LAST_INSERT_ID();  
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0),
      ifnull(m1,0), ifnull(m2,0), ifnull(m3,0), ifnull(m4,0), ifnull(m5,0), ifnull(m6,0)  
      into  ka_, kb_, kc_, kd_, ke_, kf_, m1_, m2_, m3_, m4_, m5_, m6_
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  


    
    
   
   if jns_trans2_ = 1 or jns_trans2_= 2 or jns_trans2_=3 or jns_trans2_=4 or jns_trans2_=5 or jns_trans2_=6 or jns_trans2_=7 or jns_trans2_=8 or jns_trans2_=28 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_);     
    end if;    


    
    if staset_=9 and thn_buku_ = thn_perolehan_ then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ); 
    end if;      

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ); 
    end if;          


    
    if staset_=9 and thn_buku_ = thn_perolehan_ then  
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, '01', '02', '05', jns_trans2_, idtrans_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 9, 
        1, 5, 4, 1, 0, 0,  now(), uid_ );     
    end if;     

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans2_, idtrans_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 3, 
        0, 0, 0, 0, 0, 0,  now(), uid_ ); 
    end if; 
        

  end if;  
  
end if; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_bi_20160811`(id_ int(11) )
BEGIN















  declare qry varchar(300);
  declare idbi_, idawal_, id_lama_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, staset2_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_atribusi_, jml_harga_ decimal(18,2);
  
  declare thn_buku_, thn_perolehan_, asal_usul_, jml_barang_, kondisi_ int(11);
    

  
    
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j, tgl_buku, thn_perolehan, year(tgl_buku), asal_usul, staset, id, jml_harga, jml_barang, harga_atribusi, idawal, uid, id_lama, kondisi
     into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,tgl_, thn_perolehan_, thn_buku_ , asal_usul_, staset_, idbi_ , jml_harga_, jml_barang_, harga_atribusi_, idawal_, uid_, id_lama_, kondisi_
     from buku_induk where id = id_;     
      
  
  select sum(div_staset) into staset2_ from t_history_aset where idbi_awal = idawal_ and tgl<=tgl_ ;  
  if staset2_ is not null and  staset2_ <> 0 then    
    set staset_ = staset2_;
  end if;



  
  set jns_trans2_=0;  
  set jns_trans_ = 0;   
  set difstaset_ = 0;
  
  if thn_buku_ <> thn_perolehan_ then 
    set jns_trans2_ = 7;  
    set jns_trans_ = 8; 
  else  
      
    if staset_ = 10 then 
      set jns_trans2_ = 8;        
    elseif staset_ = 9 then 
      set jns_trans2_ = 28; 
    elseif asal_usul_ = 1 then 
      set jns_trans2_ = 1;      
    elseif asal_usul_ = 2 then 
      set jns_trans2_ = 2;              
    elseif asal_usul_ = 3 then 
      set jns_trans2_ = 3;      
    elseif asal_usul_ = 4 and id_lama_ is null then 
      set jns_trans2_ = 4;      
    elseif asal_usul_ = 5 and id_lama_ is null then 
      set jns_trans2_ = 5;     
    elseif asal_usul_ = 6 and id_lama_ is null then 
      set jns_trans2_ = 6;        
    elseif asal_usul_ = 7 and id_lama_ is null then 
      set jns_trans2_ = 7;  
    end if;

    if asal_usul_=1 then
      set jns_trans_ = 1;       
    elseif asal_usul_ =2 or asal_usul_ =3 then
      set jns_trans_ = 4 ;           
    elseif asal_usul_ = 4 then
      set jns_trans_ = 5 ;     
    elseif asal_usul_ = 5 then    
      set jns_trans_ = 9  ;    
    elseif asal_usul_ =6 then    
      set jns_trans_ = 3;      
    elseif asal_usul_ =7 then    
      set jns_trans_ = 8;      
      
    end if;
  end if;


  if jns_trans2_ >0 then
    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;    
    elseif staset_ = 9 and thn_buku_ = thn_perolehan_ then  
      if f_ ='07' then 
         set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
      else  
         set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
      end if;           
    elseif staset_ = 9 and thn_buku_ <> thn_perolehan_ then  
       set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;        
    elseif staset_ = 10 and thn_buku_ = thn_perolehan_ and asal_usul_=1 then 
      if f_ ='07' then 
         set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
      else  
         set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
      end if; 
    elseif staset_ = 10 and thn_buku_ = thn_perolehan_ and asal_usul_<>1 then 
       set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    elseif staset_ = 10 and thn_buku_ <> thn_perolehan_ then 
       set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;  


    
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset,jns_trans,  debet,kredit, tgl_update,uid, kondisi, asal_usul, status_barang)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, staset_, jns_trans_, jml_harga_, 0, now(), uid_, kondisi_, asal_usul_, 1 );      
    
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0),
      ifnull(m1,0), ifnull(m2,0), ifnull(m3,0), ifnull(m4,0), ifnull(m5,0), ifnull(m6,0)  
      into  ka_, kb_, kc_, kd_, ke_, kf_, m1_, m2_, m3_, m4_, m5_, m6_
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  


    
    
   
   if jns_trans2_ = 1 or jns_trans2_= 2 or jns_trans2_=3 or jns_trans2_=4 or jns_trans2_=5 or jns_trans2_=6 or jns_trans2_=7 or jns_trans2_=8 or jns_trans2_=28 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, jml_harga_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_);     
    end if;    


    
    if staset_=9 and thn_buku_ = thn_perolehan_ then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ); 
    end if;      

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ); 
    end if;          


    
    if staset_=9 and thn_buku_ = thn_perolehan_ then  
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, '01', '02', '05', jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 9, 
        1, 5, 4, 1, 0, 0,  now(), uid_ );     
    end if;     

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 3, 
        0, 0, 0, 0, 0, 0,  now(), uid_ ); 
    end if; 
        

  end if;  
  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_bi_20161011`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, id_lama_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, staset2_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_atribusi_, jml_harga_ decimal(18,2);
  
  declare thn_buku_, thn_perolehan_, asal_usul_, jml_barang_, kondisi_ int(11);  
  declare tgl_create_ datetime;
    

  
    
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j, tgl_buku, thn_perolehan, year(tgl_buku), asal_usul, staset, id, jml_harga, jml_barang, harga_atribusi, idawal, uid, id_lama, kondisi, tgl_create
     into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,tgl_, thn_perolehan_, thn_buku_ , asal_usul_, staset_, idbi_ , jml_harga_, jml_barang_, harga_atribusi_, idawal_, uid_, id_lama_, kondisi_, tgl_create_
     from buku_induk where id = id_;     
      
  
  select sum(div_staset) into staset2_ from t_history_aset where idbi_awal = idawal_ and tgl<=tgl_ ;  
  if staset2_ is not null and  staset2_ <> 0 then    
    set staset_ = staset2_;
  end if;



  
  set jns_trans2_=0;  
  set jns_trans_ = 0;   
  set difstaset_ = 0;
  
  if thn_buku_ <> thn_perolehan_ then 
    set jns_trans2_ = 7;  
    set jns_trans_ = 8; 
  else  
    
    if asal_usul_ = 1 then 
      set jns_trans2_ = 1;      
    elseif asal_usul_ = 2 then 
      set jns_trans2_ = 2;              
    elseif asal_usul_ = 3 then 
      set jns_trans2_ = 3;      
    elseif asal_usul_ = 4 and id_lama_ is null then 
      set jns_trans2_ = 4;      
    elseif asal_usul_ = 5 and id_lama_ is null then 
      set jns_trans2_ = 5;     
    elseif asal_usul_ = 6 and id_lama_ is null then 
      set jns_trans2_ = 6;        
    elseif asal_usul_ = 7 and id_lama_ is null then 
      set jns_trans2_ = 7;        
    end if;

    if asal_usul_=1 then
      set jns_trans_ = 1;       
    elseif asal_usul_ =2 or asal_usul_ =3 then
      set jns_trans_ = 4 ;           
    elseif asal_usul_ = 4 then
      set jns_trans_ = 5 ;     
    elseif asal_usul_ = 5 then    
      set jns_trans_ = 9  ;    
    elseif asal_usul_ =6 then    
      set jns_trans_ = 3;      
    elseif asal_usul_ =7 then    
      set jns_trans_ = 8;      
      
    end if;
  end if;


  if jns_trans2_ >0 then
    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;          

    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;                  
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;      

        
    elseif staset_ = 10 then
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;     
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;   
    
    end if;  


    
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset,jns_trans,  debet,kredit, tgl_update,uid, kondisi, asal_usul, status_barang, tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, staset_, jns_trans_, jml_harga_, 0, now(), uid_, kondisi_, asal_usul_, 1 , tgl_create_);      
    
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0),
      ifnull(m1,0), ifnull(m2,0), ifnull(m3,0), ifnull(m4,0), ifnull(m5,0), ifnull(m6,0)  
      into  ka_, kb_, kc_, kd_, ke_, kf_, m1_, m2_, m3_, m4_, m5_, m6_
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  


    
    
   
   if jns_trans2_ = 1 or jns_trans2_= 2 or jns_trans2_=3 or jns_trans2_=4 or jns_trans2_=5 or 
      jns_trans2_=6 or jns_trans2_=7 or jns_trans2_=8 or jns_trans2_=28 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, jml_harga_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);     
    end if;    


    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;      

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;          


    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '01', '02', '05', jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 9, 
        1, 5, 4, 1, 0, 0,  now(), uid_, tgl_create_ );     
    end if;     

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 3, 
        0, 0, 0, 0, 0, 0,  now(), uid_, tgl_create_ ); 
    end if; 
                

    
    if staset_=10 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );          

       
       insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         jml_barang_,0, jml_harga_, 0,  tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );                        
    end if;        




  end if;  
  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_bi_20170914`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, id_lama_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, jns_trans3_, staset_, staset2_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_atribusi_, jml_harga_, harga_beli_ decimal(18,2);
  
  declare thn_buku_, thn_perolehan_, asal_usul_, jml_barang_, kondisi_ int(11);  
  declare tgl_create_ datetime;  
  declare cnt_ int;  
  declare  refid_terima_ int;
    

  
    
  
  select a1, a, b, c1, c, d, e, e1, f, g, h, i, j, tgl_buku, thn_perolehan, year(tgl_buku), asal_usul, staset, id, jml_harga, jml_barang, 
     harga_beli, harga_atribusi, idawal, uid, id_lama, kondisi, tgl_create, refid_terima
     into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,tgl_, thn_perolehan_, thn_buku_ , asal_usul_, staset_, idbi_ , jml_harga_, jml_barang_, 
     harga_beli_, harga_atribusi_, idawal_, uid_, id_lama_, kondisi_, tgl_create_, refid_terima_
     from buku_induk where id = id_;     
      
  
  select sum(div_staset) into staset2_ from t_history_aset where idbi_awal = idawal_ and tgl<=tgl_ ;  
  if staset2_ is not null and  staset2_ <> 0 then    
    set staset_ = staset2_;
  end if;



  
  set jns_trans2_=0;  
  set jns_trans_ = 0;   
  set difstaset_ = 0;  
  set jns_trans3_ = 1 ; 
    
  
  set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ; 

  if thn_buku_ <> thn_perolehan_ then 
    set jns_trans2_ = 7;  
    set jns_trans_ = 8; 
  else  
    
    if asal_usul_ = 1 then 
      set jns_trans2_ = 1;  
      
    elseif asal_usul_ = 2 then 
      set jns_trans2_ = 2;              
    elseif asal_usul_ = 3 then 
      set jns_trans2_ = 3;      
    elseif asal_usul_ = 4 and id_lama_ is null then 
      set jns_trans2_ = 4;      
    elseif asal_usul_ = 5 and id_lama_ is null then 
      set jns_trans2_ = 5;     
    elseif asal_usul_ = 6 and id_lama_ is null then 
      set jns_trans2_ = 6;        
    elseif asal_usul_ = 7 and id_lama_ is null then 
      set jns_trans2_ = 7;        
    end if;

    if asal_usul_=1 then
      set jns_trans_ = 1;       
    elseif asal_usul_ =2 or asal_usul_ =3 then
      set jns_trans_ = 4 ;           
    elseif asal_usul_ = 4 then
      set jns_trans_ = 5 ;     
    elseif asal_usul_ = 5 then    
      set jns_trans_ = 9  ;    
    elseif asal_usul_ =6 then    
      set jns_trans_ = 3;      
    elseif asal_usul_ =7 then    
      set jns_trans_ = 8;      
      
    end if;
  end if;


  if jns_trans2_ >0 then
    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;          

    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;                  
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;      

        
    elseif staset_ = 10 then
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;     
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;   
        
    
    end if;  


    
        
      insert into t_transaksi
        (kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f,g,h,i,j, tgl_buku, staset,jns_trans,  debet,kredit, tgl_update,uid, kondisi, asal_usul, status_barang, tgl_create,refid_terima)   
      values  
        (rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, staset_, jns_trans_, jml_harga_, 0, now(), uid_, kondisi_, asal_usul_, 1 , tgl_create_,refid_terima_);                    
   
    
    
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0),
      ifnull(m1,0), ifnull(m2,0), ifnull(m3,0), ifnull(m4,0), ifnull(m5,0), ifnull(m6,0)  
      into  ka_, kb_, kc_, kd_, ke_, kf_, m1_, m2_, m3_, m4_, m5_, m6_
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  


    
    
   
   if jns_trans2_ = 1 or jns_trans2_= 2 or jns_trans2_=3 or jns_trans2_=4 or jns_trans2_=5 or 
      jns_trans2_=6 or jns_trans2_=7 or jns_trans2_=8 or jns_trans2_=28 then  
      
      if jns_trans2_ = 1 then      
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, harga_beli_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);                     

        
        if harga_atribusi_ <> 0 then
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 0, 
            0, 0, harga_atribusi_, 0 , tgl_, 0, 2, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , 0, tgl_create_, 0);                           
        end if;
      else            
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, jml_harga_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);             

      end if;
    end if;    


    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;      

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;          


    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '01', '02', '05', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 9, 
        1, 5, 4, 1, 0, 0,  now(), uid_, tgl_create_ );     
    end if;     

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 3, 
        0, 0, 0, 0, 0, 0,  now(), uid_, tgl_create_ ); 
    end if; 
                

    
    if staset_=10 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );          

       
       insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         jml_barang_,0, jml_harga_, 0,  tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );                        
    end if;        




  end if;  
  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_bi_20180125`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, id_lama_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, staset2_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_atribusi_, jml_harga_, harga_beli_ decimal(18,2);
  
  declare thn_buku_, thn_perolehan_, asal_usul_, jml_barang_, kondisi_ int(11);  
  declare tgl_create_ datetime;
    
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j, tgl_buku, thn_perolehan, year(tgl_buku), asal_usul, staset, id, jml_harga, jml_barang, 
     harga_beli, harga_atribusi, idawal, uid, id_lama, kondisi, tgl_create
     into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,tgl_, thn_perolehan_, thn_buku_ , asal_usul_, staset_, idbi_ , jml_harga_, jml_barang_, 
     harga_beli_, harga_atribusi_, idawal_, uid_, id_lama_, kondisi_, tgl_create_
     from buku_induk where id = id_;     
      
  
  select sum(div_staset) into staset2_ from t_history_aset where idbi_awal = idawal_ and tgl<=tgl_ ;  
  if staset2_ is not null and  staset2_ <> 0 then    
    set staset_ = staset2_;
  end if;



  
  set jns_trans2_=0;  
  set jns_trans_ = 0;   
  set difstaset_ = 0;
    
  
  set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ; 

  if thn_buku_ <> thn_perolehan_ then 
    set jns_trans2_ = 7;  
    set jns_trans_ = 8; 
  else  
    
    if asal_usul_ = 1 then 
      set jns_trans2_ = 1;  
      
    elseif asal_usul_ = 2 then 
      set jns_trans2_ = 2;              
    elseif asal_usul_ = 3 then 
      set jns_trans2_ = 3;      
    elseif asal_usul_ = 4 and id_lama_ is null then 
      set jns_trans2_ = 4;      
    elseif asal_usul_ = 5 and id_lama_ is null then 
      set jns_trans2_ = 5;     
    elseif asal_usul_ = 6 and id_lama_ is null then 
      set jns_trans2_ = 6;        
    elseif asal_usul_ = 7 and id_lama_ is null then 
      set jns_trans2_ = 7;        
    end if;

    if asal_usul_=1 then
      set jns_trans_ = 1;       
    elseif asal_usul_ =2 or asal_usul_ =3 then
      set jns_trans_ = 4 ;           
    elseif asal_usul_ = 4 then
      set jns_trans_ = 5 ;     
    elseif asal_usul_ = 5 then    
      set jns_trans_ = 9  ;    
    elseif asal_usul_ =6 then    
      set jns_trans_ = 3;      
    elseif asal_usul_ =7 then    
      set jns_trans_ = 8;      
      
    end if;
  end if;


  if jns_trans2_ >0 then
    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;          

    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;                  
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;      

        
    elseif staset_ = 10 then
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;     
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;   
        
    
    end if;  


    
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset,jns_trans,  debet,kredit, tgl_update,uid, kondisi, asal_usul, status_barang, tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, staset_, jns_trans_, jml_harga_, 0, now(), uid_, kondisi_, asal_usul_, 1 , tgl_create_);            
    
    
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0),
      ifnull(m1,0), ifnull(m2,0), ifnull(m3,0), ifnull(m4,0), ifnull(m5,0), ifnull(m6,0)  
      into  ka_, kb_, kc_, kd_, ke_, kf_, m1_, m2_, m3_, m4_, m5_, m6_
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  


    
    
   
   if jns_trans2_ = 1 or jns_trans2_= 2 or jns_trans2_=3 or jns_trans2_=4 or jns_trans2_=5 or 
      jns_trans2_=6 or jns_trans2_=7 or jns_trans2_=8 or jns_trans2_=28 then  
      
      if jns_trans2_ = 1 then      
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, harga_beli_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);                     

        
        if harga_atribusi_ <> 0 then
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 0, 
            0, 0, harga_atribusi_, 0 , tgl_, 0, 2, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , 0, tgl_create_, 0);                           
        end if;
      else            
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, jml_harga_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);             

      end if;
    end if;    


    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;      

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;          


    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '01', '02', '05', jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 9, 
        1, 5, 4, 1, 0, 0,  now(), uid_, tgl_create_ );     
    end if;     

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 3, 
        0, 0, 0, 0, 0, 0,  now(), uid_, tgl_create_ ); 
    end if; 
                

    
    if staset_=10 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );          

       
       insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         jml_barang_,0, jml_harga_, 0,  tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );                        
    end if;        




  end if;  
  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_bi_20180130`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, id_lama_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, jns_trans3_, staset_, staset2_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_atribusi_, jml_harga_, harga_beli_ decimal(18,2);
  
  declare thn_buku_, thn_perolehan_, asal_usul_, jml_barang_, kondisi_ int(11);  
  declare tgl_create_ datetime;  
  declare cnt_ int;  
  declare refid_terima_ int;  
  declare f1_, f2_ char(1); 
    

  
  select a1, a, b, c1, c, d, e, e1, f1,f2, f, g, h, i, j, tgl_buku, thn_perolehan, year(tgl_buku), asal_usul, staset, id, jml_harga, jml_barang, 
     harga_beli, harga_atribusi, idawal, uid, id_lama, kondisi, tgl_create, refid_terima
     into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_,tgl_, thn_perolehan_, thn_buku_ , asal_usul_, staset_, idbi_ , jml_harga_, jml_barang_, 
     harga_beli_, harga_atribusi_, idawal_, uid_, id_lama_, kondisi_, tgl_create_, refid_terima_
     from buku_induk where id = id_;     
      
  
  select sum(div_staset) into staset2_ from t_history_aset where idbi_awal = idawal_ and tgl<=tgl_ ;  
  if staset2_ is not null and  staset2_ <> 0 then    
    set staset_ = staset2_;
  end if;
       
  
  set jns_trans2_=0;  
  set jns_trans_ = 0;   
  set difstaset_ = 0;  
  set jns_trans3_ = 1 ; 
    
  
  set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ; 

  if thn_buku_ <> thn_perolehan_ then 
    set jns_trans2_ = 7;  
    set jns_trans_ = 8; 
  else  
    
    if asal_usul_ = 1 then 
      set jns_trans2_ = 1;  
      
    elseif asal_usul_ = 2 then 
      set jns_trans2_ = 2;              
    elseif asal_usul_ = 3 then 
      set jns_trans2_ = 3;      
    elseif asal_usul_ = 4 and id_lama_ is null then 
      set jns_trans2_ = 4;      
    elseif asal_usul_ = 5 and id_lama_ is null then 
      set jns_trans2_ = 5;     
    elseif asal_usul_ = 6 and id_lama_ is null then 
      set jns_trans2_ = 6;        
    elseif asal_usul_ = 7 and id_lama_ is null then 
      set jns_trans2_ = 7;        
    end if;

    if asal_usul_=1 then
      set jns_trans_ = 1;       
    elseif asal_usul_ =2 or asal_usul_ =3 then
      set jns_trans_ = 4 ;           
    elseif asal_usul_ = 4 then
      set jns_trans_ = 5 ;     
    elseif asal_usul_ = 5 then    
      set jns_trans_ = 9  ;    
    elseif asal_usul_ =6 then    
      set jns_trans_ = 3;      
    elseif asal_usul_ =7 then    
      set jns_trans_ = 8;      
      
    end if; 
  end if; 

  
  if jns_trans2_ >0 then  

    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;          

    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;                  
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;  
    elseif staset_ = 10 then
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;     
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;   
    end if;  


    
    select count(*) into cnt_ from t_transaksi where jns_trans2 in (1,2,3,4,5,6,7,8,28) and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        jns_trans3=jns_trans3_, jns_trans2=jns_trans2_, idbi=idbi_, 
        idawal = idbi_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=jml_harga_,kredit = 0,
        kondisi=kondisi_, asal_usul=asal_usul_, status_barang=status_barang_, refid_terima=refid_terima_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset,jns_trans,  debet,kredit, tgl_update,uid, 
        kondisi, asal_usul, status_barang, tgl_create,refid_terima)   
      values  
        (rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, staset_, jns_trans_, jml_harga_, 0, now(), uid_, 
        kondisi_, asal_usul_, 1 , tgl_create_,refid_terima_);                    
    end if;
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0),
      ifnull(m1,0), ifnull(m2,0), ifnull(m3,0), ifnull(m4,0), ifnull(m5,0), ifnull(m6,0)  
      into  ka_, kb_, kc_, kd_, ke_, kf_, m1_, m2_, m3_, m4_, m5_, m6_
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  

    
   if jns_trans2_ = 1 or jns_trans2_= 2 or jns_trans2_=3 or jns_trans2_=4 or jns_trans2_=5 or 
      jns_trans2_=6 or jns_trans2_=7 or jns_trans2_=8 or jns_trans2_=28 then  
      
      if jns_trans2_ = 1 then      
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, harga_beli_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);                     

        
        if harga_atribusi_ <> 0 then
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 0, 
            0, 0, harga_atribusi_, 0 , tgl_, 0, 2, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , 0, tgl_create_, 0);                           
        end if;
      else            
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, jml_harga_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);             

      end if;
    end if;    

    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;      

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;          
   
    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '01', '02', '05', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 9, 
        1, 5, 4, 1, 0, 0,  now(), uid_, tgl_create_ );     
    end if;     

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 3, 
        0, 0, 0, 0, 0, 0,  now(), uid_, tgl_create_ ); 
    end if; 
                

    
    if staset_=10 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );          

       
       insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         jml_barang_,0, jml_harga_, 0,  tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );                        
    end if;        




  end if;  
  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_bi_20180213`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, id_lama_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, jns_trans3_, staset_, staset2_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_atribusi_, jml_harga_, harga_beli_ decimal(18,2);
  
  declare thn_buku_, thn_perolehan_, asal_usul_, jml_barang_, kondisi_ int(11);  
  declare tgl_create_ datetime;  
  declare cnt_ int;  
  declare refid_terima_ int;  
  declare f1_, f2_ char(1); 
  declare thn_login_ char(4);
    

  
  select a1, a, b, c1, c, d, e, e1, f1,f2, f, g, h, i, j, tgl_buku, thn_perolehan, year(tgl_buku), asal_usul, staset, id, jml_harga, jml_barang, 
     harga_beli, harga_atribusi, idawal, uid, id_lama, kondisi, tgl_create, refid_terima
     into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_,tgl_, thn_perolehan_, thn_buku_ , asal_usul_, staset_, idbi_ , jml_harga_, jml_barang_, 
     harga_beli_, harga_atribusi_, idawal_, uid_, id_lama_, kondisi_, tgl_create_, refid_terima_
     from buku_induk where id = id_;     

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
  
if (thn_buku_ >= thn_login_) then
      
  
  select sum(div_staset) into staset2_ from t_history_aset where idbi_awal = idawal_ and tgl<=tgl_ ;  
  if staset2_ is not null and  staset2_ <> 0 then    
    set staset_ = staset2_;
  end if;
       
  
  set jns_trans2_=0;  
  set jns_trans_ = 0;   
  set difstaset_ = 0;  
  set jns_trans3_ = 1 ; 
    
  
  set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ; 

  if thn_buku_ <> thn_perolehan_ then 
    set jns_trans2_ = 7;  
    set jns_trans_ = 8; 
  else  
    
    if asal_usul_ = 1 then 
      set jns_trans2_ = 1;  
      
    elseif asal_usul_ = 2 then 
      set jns_trans2_ = 2;              
    elseif asal_usul_ = 3 then 
      set jns_trans2_ = 3;      
    elseif asal_usul_ = 4 and id_lama_ is null then 
      set jns_trans2_ = 4;      
    elseif asal_usul_ = 5 and id_lama_ is null then 
      set jns_trans2_ = 5;     
    elseif asal_usul_ = 6 and id_lama_ is null then 
      set jns_trans2_ = 6;        
    elseif asal_usul_ = 7 and id_lama_ is null then 
      set jns_trans2_ = 7;        
    end if;

    if asal_usul_=1 then
      set jns_trans_ = 1;       
    elseif asal_usul_ =2 or asal_usul_ =3 then
      set jns_trans_ = 4 ;           
    elseif asal_usul_ = 4 then
      set jns_trans_ = 5 ;     
    elseif asal_usul_ = 5 then    
      set jns_trans_ = 9  ;    
    elseif asal_usul_ =6 then    
      set jns_trans_ = 3;      
    elseif asal_usul_ =7 then    
      set jns_trans_ = 8;      
      
    end if; 
  end if; 

  
  if jns_trans2_ >0 then  

    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;          

    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;                  
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;  
    elseif staset_ = 10 then
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;     
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;   
    end if;  


    
    select count(*) into cnt_ from t_transaksi where jns_trans2 in (1,2,3,4,5,6,7,8,28) and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        jns_trans3=jns_trans3_, jns_trans2=jns_trans2_, idbi=idbi_, 
        idawal = idbi_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=jml_harga_,kredit = 0,
        kondisi=kondisi_, asal_usul=asal_usul_, status_barang=status_barang_, refid_terima=refid_terima_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset,jns_trans,  debet,kredit, tgl_update,uid, 
        kondisi, asal_usul, status_barang, tgl_create,refid_terima)   
      values  
        (rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, staset_, jns_trans_, jml_harga_, 0, now(), uid_, 
        kondisi_, asal_usul_, 1 , tgl_create_,refid_terima_);                    
    end if;
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0),
      ifnull(m1,0), ifnull(m2,0), ifnull(m3,0), ifnull(m4,0), ifnull(m5,0), ifnull(m6,0)  
      into  ka_, kb_, kc_, kd_, ke_, kf_, m1_, m2_, m3_, m4_, m5_, m6_
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  

    
   if jns_trans2_ = 1 or jns_trans2_= 2 or jns_trans2_=3 or jns_trans2_=4 or jns_trans2_=5 or 
      jns_trans2_=6 or jns_trans2_=7 or jns_trans2_=8 or jns_trans2_=28 then  
      
      if jns_trans2_ = 1 then      
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, harga_beli_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);                     

        
        if harga_atribusi_ <> 0 then
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 0, 
            0, 0, harga_atribusi_, 0 , tgl_, 0, 2, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , 0, tgl_create_, 0);                           
        end if;
      else            
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, jml_harga_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);             

      end if;
    end if;    

    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;      

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;          
   
    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '01', '02', '05', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 9, 
        1, 5, 4, 1, 0, 0,  now(), uid_, tgl_create_ );     
    end if;     

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 3, 
        0, 0, 0, 0, 0, 0,  now(), uid_, tgl_create_ ); 
    end if; 
                

    
    if staset_=10 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );          

       
       insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         jml_barang_,0, jml_harga_, 0,  tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );                        
    end if;        




  end if;  
end if;   

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_bi_bck20160108`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, idtrans_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_atribusi_, jml_harga_ decimal(18,2);
  
  declare thn_buku_, thn_perolehan_, asal_usul_, jml_barang_ int(11);
  
call sp_insert_log('0');    
  
    
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j, tgl_buku, thn_perolehan, year(tgl_buku), asal_usul, staset, id, jml_harga, jml_barang, harga_atribusi, idawal, uid
     into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,tgl_, thn_perolehan_, thn_buku_ , asal_usul_, staset_, idbi_ , jml_harga_, jml_barang_, harga_atribusi_, idawal_, uid_
     from buku_induk where id = id_;     


  
  set jns_trans2_=0;
    
  if thn_buku_ <> thn_perolehan_ then  
    set jns_trans2_ = 7;  
    set jns_trans_ = 8; 
  else  
    if staset_ = 3 or staset_=8 then 
      set jns_trans2_ = 1;                     
    elseif staset_ = 9 then 
      set jns_trans2_ = 28; 
    elseif staset_ = 10 then 
      set jns_trans2_ = 8;  
    end if;    

    if asal_usul_=1 then
      set jns_trans_ = 1;       
    elseif asal_usul_ =2 or asal_usul_ =3 then
      set jns_trans_ = 4 ;           
    elseif asal_usul_ = 4 then
      set jns_trans_ = 5 ;     
    elseif asal_usul_ = 5 then    
      set jns_trans_ = 9  ;    
    elseif asal_usul_ =6 then    
      set jns_trans_ = 3;
    end if;
  end if;


  if jns_trans2_ >0 then
    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;    
    elseif staset_ = 9 and thn_buku_ = thn_perolehan_ then  
      if f_ ='07' then 
         set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
      else  
         set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
      end if;           
    elseif staset_ = 9 and thn_buku_ <> thn_perolehan_ then  
       set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;        
    elseif staset_ = 10 and thn_buku_ = thn_perolehan_ and asal_usul_=1 then 
       set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 10 and thn_buku_ = thn_perolehan_ and asal_usul_<>1 then 
       set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    elseif staset_ = 10 and thn_buku_ <> thn_perolehan_ then 
       set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;  

call sp_insert_log('3');    
    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset,jns_trans,  debet,kredit, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, staset_, jns_trans_, jml_harga_, 0, now(), uid_ );      
    set idtrans_ = LAST_INSERT_ID();  
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  

call sp_insert_log('4');        
    
    
    if jns_trans2_ = 1 or jns_trans2_= 2 or jns_trans2_=3 or jns_trans2_=7 or jns_trans2_=8 or jns_trans2_=28 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_);     
    end if;

call sp_insert_log('5');      
    
    if staset_=9 and thn_buku_ = thn_perolehan_ then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ); 
    end if;      

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ); 
    end if;          

call sp_insert_log('6');    
    
    if staset_=9 and thn_buku_ = thn_perolehan_ then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, '01', '02', '05', jns_trans2_, idtrans_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         jml_barang_, 0, jml_harga_, 0, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );     
    end if;     

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans2_, idtrans_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         jml_barang_, 0, jml_harga_, 0, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ); 
    end if; 
        
call sp_insert_log('7'); 
  end if;  
  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_bi_bck20170918`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, id_lama_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, jns_trans3_, staset_, staset2_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_atribusi_, jml_harga_, harga_beli_ decimal(18,2);
  
  declare thn_buku_, thn_perolehan_, asal_usul_, jml_barang_, kondisi_ int(11);  
  declare tgl_create_ datetime;  
  declare cnt_ int;  
  declare  refid_terima_ int;  
  declare f1_, f2_ char(1); 
    

  
  select a1, a, b, c1, c, d, e, e1, f1,f2, f, g, h, i, j, tgl_buku, thn_perolehan, year(tgl_buku), asal_usul, staset, id, jml_harga, jml_barang, 
     harga_beli, harga_atribusi, idawal, uid, id_lama, kondisi, tgl_create, refid_terima
     into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_,tgl_, thn_perolehan_, thn_buku_ , asal_usul_, staset_, idbi_ , jml_harga_, jml_barang_, 
     harga_beli_, harga_atribusi_, idawal_, uid_, id_lama_, kondisi_, tgl_create_, refid_terima_
     from buku_induk where id = id_;     
      
  
  select sum(div_staset) into staset2_ from t_history_aset where idbi_awal = idawal_ and tgl<=tgl_ ;  
  if staset2_ is not null and  staset2_ <> 0 then    
    set staset_ = staset2_;
  end if;
       
  
  set jns_trans2_=0;  
  set jns_trans_ = 0;   
  set difstaset_ = 0;  
  set jns_trans3_ = 1 ; 
    
  
  set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ; 

  if thn_buku_ <> thn_perolehan_ then 
    set jns_trans2_ = 7;  
    set jns_trans_ = 8; 
  else  
    
    if asal_usul_ = 1 then 
      set jns_trans2_ = 1;  
      
    elseif asal_usul_ = 2 then 
      set jns_trans2_ = 2;              
    elseif asal_usul_ = 3 then 
      set jns_trans2_ = 3;      
    elseif asal_usul_ = 4 and id_lama_ is null then 
      set jns_trans2_ = 4;      
    elseif asal_usul_ = 5 and id_lama_ is null then 
      set jns_trans2_ = 5;     
    elseif asal_usul_ = 6 and id_lama_ is null then 
      set jns_trans2_ = 6;        
    elseif asal_usul_ = 7 and id_lama_ is null then 
      set jns_trans2_ = 7;        
    end if;

    if asal_usul_=1 then
      set jns_trans_ = 1;       
    elseif asal_usul_ =2 or asal_usul_ =3 then
      set jns_trans_ = 4 ;           
    elseif asal_usul_ = 4 then
      set jns_trans_ = 5 ;     
    elseif asal_usul_ = 5 then    
      set jns_trans_ = 9  ;    
    elseif asal_usul_ =6 then    
      set jns_trans_ = 3;      
    elseif asal_usul_ =7 then    
      set jns_trans_ = 8;      
      
    end if; 
  end if; 

  
  if jns_trans2_ >0 then  

    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;          

    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;                  
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;  
    elseif staset_ = 10 then
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;     
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;   
    end if;  


    
    select count(*) into cnt_ from t_transaksi where jns_trans2 in (1,2,3,4,5,6,7,8,28) and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        jns_trans3=jns_trans3_, jns_trans2=jns_trans2_, idbi=idbi_, 
        idawal = idbi_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=jml_harga_,kredit = 0,
        kondisi=kondisi_, asal_usul=asal_usul_, status_barang=status_barang_, refid_terima=refid_terima_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset,jns_trans,  debet,kredit, tgl_update,uid, 
        kondisi, asal_usul, status_barang, tgl_create,refid_terima)   
      values  
        (rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, staset_, jns_trans_, jml_harga_, 0, now(), uid_, 
        kondisi_, asal_usul_, 1 , tgl_create_,refid_terima_);                    
    end if;
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0),
      ifnull(m1,0), ifnull(m2,0), ifnull(m3,0), ifnull(m4,0), ifnull(m5,0), ifnull(m6,0)  
      into  ka_, kb_, kc_, kd_, ke_, kf_, m1_, m2_, m3_, m4_, m5_, m6_
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  

    
   if jns_trans2_ = 1 or jns_trans2_= 2 or jns_trans2_=3 or jns_trans2_=4 or jns_trans2_=5 or 
      jns_trans2_=6 or jns_trans2_=7 or jns_trans2_=8 or jns_trans2_=28 then  
      
      if jns_trans2_ = 1 then      
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, harga_beli_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);                     

        
        if harga_atribusi_ <> 0 then
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 0, 
            0, 0, harga_atribusi_, 0 , tgl_, 0, 2, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , 0, tgl_create_, 0);                           
        end if;
      else            
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, jml_harga_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);             

      end if;
    end if;    

    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;      

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;          
   
    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '01', '02', '05', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 9, 
        1, 5, 4, 1, 0, 0,  now(), uid_, tgl_create_ );     
    end if;     

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 3, 
        0, 0, 0, 0, 0, 0,  now(), uid_, tgl_create_ ); 
    end if; 
                

    
    if staset_=10 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );          

       
       insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans3, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans3_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         jml_barang_,0, jml_harga_, 0,  tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );                        
    end if;        




  end if;  
  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_bi_tes`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, id_lama_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, staset2_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_atribusi_, jml_harga_, harga_beli_ decimal(18,2);
  
  declare thn_buku_, thn_perolehan_, asal_usul_, jml_barang_, kondisi_ int(11);  
  declare tgl_create_ datetime;
    
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j, tgl_buku, thn_perolehan, year(tgl_buku), asal_usul, staset, id, jml_harga, jml_barang, 
     harga_beli, harga_atribusi, idawal, uid, id_lama, kondisi, tgl_create
     into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,tgl_, thn_perolehan_, thn_buku_ , asal_usul_, staset_, idbi_ , jml_harga_, jml_barang_, 
     harga_beli_, harga_atribusi_, idawal_, uid_, id_lama_, kondisi_, tgl_create_
     from buku_induk where id = id_;     
      
  
  select sum(div_staset) into staset2_ from t_history_aset where idbi_awal = idawal_ and tgl<=tgl_ ;  
  if staset2_ is not null and  staset2_ <> 0 then    
    set staset_ = staset2_;
  end if;



  
  set jns_trans2_=0;  
  set jns_trans_ = 0;   
  set difstaset_ = 0;
    
  
  set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ; 

  if thn_buku_ <> thn_perolehan_ then 
    set jns_trans2_ = 7;  
    set jns_trans_ = 8; 
  else  
    
    if asal_usul_ = 1 then 
      set jns_trans2_ = 1;  
      
    elseif asal_usul_ = 2 then 
      set jns_trans2_ = 2;              
    elseif asal_usul_ = 3 then 
      set jns_trans2_ = 3;      
    elseif asal_usul_ = 4 and id_lama_ is null then 
      set jns_trans2_ = 4;      
    elseif asal_usul_ = 5 and id_lama_ is null then 
      set jns_trans2_ = 5;     
    elseif asal_usul_ = 6 and id_lama_ is null then 
      set jns_trans2_ = 6;        
    elseif asal_usul_ = 7 and id_lama_ is null then 
      set jns_trans2_ = 7;        
    end if;

    if asal_usul_=1 then
      set jns_trans_ = 1;       
    elseif asal_usul_ =2 or asal_usul_ =3 then
      set jns_trans_ = 4 ;           
    elseif asal_usul_ = 4 then
      set jns_trans_ = 5 ;     
    elseif asal_usul_ = 5 then    
      set jns_trans_ = 9  ;    
    elseif asal_usul_ =6 then    
      set jns_trans_ = 3;      
    elseif asal_usul_ =7 then    
      set jns_trans_ = 8;      
      
    end if;
  end if;


  if jns_trans2_ >0 then
    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;          

    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;                  
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;      

        
    elseif staset_ = 10 then
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;     
      if thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then 
         if f_ ='07' then 
           set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;
         else  
           set rkint_ = '01' ; set rka_ = '01'; set rkb_ = f_ ;           
         end if;     
      end if;   
        
    
    end if;  


    
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset,jns_trans,  debet,kredit, tgl_update,uid, kondisi, asal_usul, status_barang, tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, staset_, jns_trans_, jml_harga_, 0, now(), uid_, kondisi_, asal_usul_, 1 , tgl_create_);            
    
    
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0),
      ifnull(m1,0), ifnull(m2,0), ifnull(m3,0), ifnull(m4,0), ifnull(m5,0), ifnull(m6,0)  
      into  ka_, kb_, kc_, kd_, ke_, kf_, m1_, m2_, m3_, m4_, m5_, m6_
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  


    
    
   
   if jns_trans2_ = 1 or jns_trans2_= 2 or jns_trans2_=3 or jns_trans2_=4 or jns_trans2_=5 or 
      jns_trans2_=6 or jns_trans2_=7 or jns_trans2_=8 or jns_trans2_=28 then  
      
      if jns_trans2_ = 1 then      
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, harga_beli_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);                     

        
        if harga_atribusi_ <> 0 then
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 0, 
            0, 0, harga_atribusi_, 0 , tgl_, 0, 2, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , 0, tgl_create_, 0);                           
        end if;
      else            
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, harga_atribusi, tgl_create, kondisi)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1, 
        jml_barang_, 0, jml_harga_, 0 , tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , harga_atribusi_, tgl_create_, kondisi_);             

      end if;
    end if;    


    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;      

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ); 
    end if;          


    
    if staset_=9 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then  
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '01', '02', '05', jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 9, 
        1, 5, 4, 1, 0, 0,  now(), uid_, tgl_create_ );     
    end if;     

    if jns_trans2_ = 8 and asal_usul_ =1 then  
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
        k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        jml_barang_, 0, jml_harga_, 0, tgl_, 0, 3, 
        0, 0, 0, 0, 0, 0,  now(), uid_, tgl_create_ ); 
    end if; 
                

    
    if staset_=10 and thn_buku_ = thn_perolehan_ and asal_usul_ = 1 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         0, jml_barang_, 0, jml_harga_, tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );          

       
       insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
      values 
        (jns_trans2_, '02', '00', '00', jns_trans2_, id_, idbi_, idbi_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
         jml_barang_,0, jml_harga_, 0,  tgl_, 0, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );                        
    end if;        




 end if;  
  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_gantirugi`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_,  hrg_ketetapan_ decimal(18,2);  
  declare akum_susut_  decimal(18,5); 
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);
  declare tgl_create_ datetime;    
  declare susut_mode_ int;  
  declare f1_, f2_ char(1);  
  declare cnt_ int;
  declare thn_login_ char(4);

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;  
  
   

  set q_= 18;
  set jns_trans2_ = 18;     
  
  select staset,tgl_gantirugi,id_bukuinduk,idbi_awal, ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid, no_sk, diganti_barang, harga,tgl_create
     into staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_, no_sk_, diganti_barang_, hrg_ketetapan_,tgl_create_ from gantirugi where id = id_; 

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
  
if (year(tgl_) >= thn_login_) then
     
if no_sk_<> '' and no_sk_ is not null then 
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    
  
  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);      
    
   
  if susut_mode_ = 3  then  
     delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
  else 
     delete from penyusutan where idbi=idbi_ and tgl>= tgl_;    
  end if;
  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);  
      
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
  
  set difstaset_ = 6-staset_;


   select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=9, tgl_update=now(), uid=uid_, debet=hrg_ketetapan_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
     insert into t_transaksi
     (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,
     f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, status_barang,
     debet, kredit, tgl_update,uid,tgl_create)   
     values  
     (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,
      f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, 9, 4,
      0, 0, now(), uid_ ,tgl_create_);  
   end if; 
   
      
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
  values 
  (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 5-status_barang_,
  0, 1, 0, nilai_buku_, tgl_, difstaset_, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
  
  if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;

    
  if diganti_barang_ = 0 then 
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 1, 
      1, 0, nilai_buku_ , 0, tgl_, 0, 9, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);             
        
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 1, 
      0, 0, hrg_ketetapan_ - nilai_buku_ , 0, tgl_, 0, 6, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);             
      
    if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0,  0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;
  end if;

 end if;
end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_gantirugi_20160514`(idgantirugi_ int(11) )
BEGIN



  declare qry varchar(300);
  declare idbi_, idawal_, idtrans_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);

  set q_= 18;
  set jns_trans2_ = 18;     
  
  select staset,tgl_gantirugi,id_bukuinduk,idbi_awal, ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid, no_sk, diganti_barang
     into staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_, no_sk_, diganti_barang_ from gantirugi where id = idgantirugi_; 
     
if no_sk_<> '' and no_sk_ is not null then 
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);    
      
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
  
  set difstaset_ = 6-staset_;
  insert into t_transaksi
  (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,
     f,g,h,i,j, tgl_buku, staset, jns_trans, 
     debet, kredit, tgl_update,uid)   
  values  
  (rkint_, rka_, rkb_, jns_trans2_, idgantirugi_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_,
      f_, g_, h_, i_, j_, tgl_, difstaset_, 9,
      0, 0, now(), uid_ );  
  set idtrans_ = LAST_INSERT_ID();
      
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
  values 
  (q_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
  0, 1, 0, nilai_buku_, tgl_, difstaset_, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
  

    
  if diganti_barang_ = 0 then 
    
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid)
    values 
      (q_, '01', '02', '03', jns_trans2_, idtrans_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      1, 0, nilai_buku_ , 0, tgl_, 0, 9, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ );       
  end if;

end if;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_gantirugi_20170918`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_, akum_susut_, hrg_ketetapan_ decimal(18,2);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);
  declare tgl_create_ datetime;    
  declare susut_mode_ int;  
  declare f1_, f2_ char(1);  
  declare cnt_ int;

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;  
  
   

  set q_= 18;
  set jns_trans2_ = 18;     
  
  select staset,tgl_gantirugi,id_bukuinduk,idbi_awal, ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid, no_sk, diganti_barang, harga,tgl_create
     into staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_, no_sk_, diganti_barang_, hrg_ketetapan_,tgl_create_ from gantirugi where id = id_; 
     
if no_sk_<> '' and no_sk_ is not null then 
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    
  
  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);      
    
   
  if susut_mode_ = 3  then  
     delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
  else 
     delete from penyusutan where idbi=idbi_ and tgl>= tgl_;    
  end if;
  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);  
      
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
  
  set difstaset_ = 6-staset_;


select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=9, tgl_update=now(), uid=uid_, debet=nilai_buku_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
     insert into t_transaksi
     (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,
     f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, status_barang,
     debet, kredit, tgl_update,uid,tgl_create)   
     values  
     (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,
      f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, 9, 4,
      0, 0, now(), uid_ ,tgl_create_);  
   end if; 
   
      
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
  values 
  (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 5-status_barang_,
  0, 1, 0, nilai_buku_, tgl_, difstaset_, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
  
  if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;

    
  if diganti_barang_ = 0 then 
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 1, 
      1, 0, nilai_buku_ , 0, tgl_, 0, 9, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);             
        
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 1, 
      0, 0, hrg_ketetapan_ - nilai_buku_ , 0, tgl_, 0, 6, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);             
      
    if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0,  0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;
  end if;

end if;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_gantirugi_20180130`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_,  hrg_ketetapan_ decimal(18,2);  
  declare akum_susut_  decimal(18,5); 
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);
  declare tgl_create_ datetime;    
  declare susut_mode_ int;  
  declare f1_, f2_ char(1);  
  declare cnt_ int;

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;  
  
   

  set q_= 18;
  set jns_trans2_ = 18;     
  
  select staset,tgl_gantirugi,id_bukuinduk,idbi_awal, ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid, no_sk, diganti_barang, harga,tgl_create
     into staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_, no_sk_, diganti_barang_, hrg_ketetapan_,tgl_create_ from gantirugi where id = id_; 
     
if no_sk_<> '' and no_sk_ is not null then 
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    
  
  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);      
    
   
  if susut_mode_ = 3  then  
     delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
  else 
     delete from penyusutan where idbi=idbi_ and tgl>= tgl_;    
  end if;
  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);  
      
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
  
  set difstaset_ = 6-staset_;


select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=9, tgl_update=now(), uid=uid_, debet=hrg_ketetapan_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
     insert into t_transaksi
     (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,
     f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, status_barang,
     debet, kredit, tgl_update,uid,tgl_create)   
     values  
     (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,
      f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, 9, 4,
      0, 0, now(), uid_ ,tgl_create_);  
   end if; 
   
      
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
  values 
  (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 5-status_barang_,
  0, 1, 0, nilai_buku_, tgl_, difstaset_, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
  
  if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;

    
  if diganti_barang_ = 0 then 
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 1, 
      1, 0, nilai_buku_ , 0, tgl_, 0, 9, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);             
        
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 1, 
      0, 0, hrg_ketetapan_ - nilai_buku_ , 0, tgl_, 0, 6, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);             
      
    if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0,  0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;
  end if;

end if;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_gantirugi_bayar`(id_ int(11) )
BEGIN

  declare idbi_, idawal_ ,ref_idgantirugi_ int(11);  
  declare jns_trans_,jns_trans2_,staset_ tinyint(3);
  declare uid_,uid_create_ varchar(20);  
  declare bayar_ decimal(18,2);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare tgl_create_ datetime;
  declare f1_, f2_ char(1); 
  declare cnt_ int;
  declare thn_login_ char(4);
  
  
  select id_bukuinduk,harga,tgl_pembukuan,uid,ref_idgantirugi,tgl_create,uid_create into idbi_,bayar_,tgl_,uid_,ref_idgantirugi_,tgl_create_,uid_create_ from gantirugi_bayar where id = id_;

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';   

if (year(tgl_) >= thn_login_) then              

  set jns_trans_ = 9;      
  set jns_trans2_ = 33;       
  set rkint_ = '01'; set rka_ = '02'; set rkb_ = '02' ;       
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    
  select staset , idbi_awal into staset_, idawal_ from gantirugi where id = ref_idgantirugi_;    
  
 
    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, kredit=bayar_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create,uid_create)   
      values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ ,tgl_create_,uid_create_);  
    end if;
           
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create,uid_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, 0, bayar_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_, uid_create_);  
end if; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_gantirugi_bayar_20180130`(id_ int(11) )
BEGIN

  declare idbi_, idawal_ ,ref_idgantirugi_ int(11);  
  declare jns_trans_,jns_trans2_,staset_ tinyint(3);
  declare uid_,uid_create_ varchar(20);  
  declare bayar_ decimal(18,2);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare tgl_create_ datetime;
  declare f1_, f2_ char(1); 
  declare cnt_ int;
  
  
  select id_bukuinduk,harga,tgl_pembukuan,uid,ref_idgantirugi,tgl_create,uid_create into idbi_,bayar_,tgl_,uid_,ref_idgantirugi_,tgl_create_,uid_create_ from gantirugi_bayar where id = id_;

  set jns_trans_ = 9;      
  set jns_trans2_ = 33;       
  set rkint_ = '01'; set rka_ = '02'; set rkb_ = '02' ;       
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    
  select staset , idbi_awal into staset_, idawal_ from gantirugi where id = ref_idgantirugi_;   
 
    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, kredit=bayar_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create,uid_create)   
      values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ ,tgl_create_,uid_create_);  
    end if;
           
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create,uid_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, 0, bayar_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_, uid_create_); 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_gantirugi_tes`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_,  hrg_ketetapan_ decimal(18,2);  
  declare akum_susut_  decimal(18,5); 
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);
  declare tgl_create_ datetime;    
  declare susut_mode_ int;  
  declare f1_, f2_ char(1);  
  declare cnt_ int;

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;  
  
   

  set q_= 18;
  set jns_trans2_ = 18;     
  
  select staset,tgl_gantirugi,id_bukuinduk,idbi_awal, ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid, no_sk, diganti_barang, harga,tgl_create
     into staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_, no_sk_, diganti_barang_, hrg_ketetapan_,tgl_create_ from gantirugi where id = id_; 
     
if no_sk_<> '' and no_sk_ is not null then 
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    
  
  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);      
    
   
  if susut_mode_ = 3  then  
     delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
  else 
     delete from penyusutan where idbi=idbi_ and tgl>= tgl_;    
  end if;
  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);  
      
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
  
  set difstaset_ = 6-staset_;


select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=9, tgl_update=now(), uid=uid_, debet=nilai_buku_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
     insert into t_transaksi
     (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,
     f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, status_barang,
     debet, kredit, tgl_update,uid,tgl_create)   
     values  
     (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,
      f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, 9, 4,
      0, 0, now(), uid_ ,tgl_create_);  
   end if; 
   
      
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
  values 
  (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 5-status_barang_,
  0, 1, 0, nilai_buku_, tgl_, difstaset_, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
  
  if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;

    
  if diganti_barang_ = 0 then 
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 1, 
      1, 0, nilai_buku_ , 0, tgl_, 0, 9, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);             
        
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 1, 
      0, 0, hrg_ketetapan_ - nilai_buku_ , 0, tgl_, 0, 6, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);             
      
    if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '02', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0,  0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;
  end if;

end if;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_hapussebagian`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_hapus_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
  declare tgl_create_ datetime;
  declare f1_, f2_ char(1);  
  declare cnt_ int;
  declare thn_login_ char(4);
        
  set jns_trans2_ = 11;  
  set jns_trans_ = 3;  

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal, 
    
    uid , harga_hapus,tgl_create
    into staset_, tgl_, idbi_, idawal_, 
    
    uid_, harga_hapus_,tgl_create_
    from penghapusan_sebagian where id = id_;             



    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';  
  
if (year(tgl_) >= thn_login_) then          

    
    

      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if; 
    
    
    set difstaset_ = 0;
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=harga_hapus_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
      values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ ,tgl_create_);  
    end if;  
           

   

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) 
      into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  
      a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
      k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, 
      a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, 0, harga_hapus_ , tgl_, 0, jns_trans_, 
      ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
 

end if;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_hapussebagian_20160514`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idtrans_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_hapus_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
        
  set jns_trans2_ = 11;  
  set jns_trans_ = 3;  

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal, 
    
    uid , harga_hapus
    into staset_, tgl_, idbi_, idawal_, 
    
    uid_, harga_hapus_
    from penghapusan_sebagian where id = id_;             



    
    select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ );  
        

    set idtrans_ = LAST_INSERT_ID();

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) 
      into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  
      a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
      k, l, m, n, o, p, tgl_update,uid)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idawal_, 
      a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, 0, harga_hapus_ , tgl_, 0, jns_trans_, 
      ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
 



END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_hapussebagian_20180130`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare harga_hapus_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
  declare tgl_create_ datetime;
  declare f1_, f2_ char(1);  
  declare cnt_ int;
        
  set jns_trans2_ = 11;  
  set jns_trans_ = 3;  

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal, 
    
    uid , harga_hapus,tgl_create
    into staset_, tgl_, idbi_, idawal_, 
    
    uid_, harga_hapus_,tgl_create_
    from penghapusan_sebagian where id = id_;             



    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=harga_hapus_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
      values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ ,tgl_create_);  
    end if;  
           

   

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) 
      into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  
      a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, 
      k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, 
      a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, 0, harga_hapus_ , tgl_, 0, jns_trans_, 
      ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
 



END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_kondisi`(`id_` int(11))
BEGIN




  declare idbi_, idawal_ int(11);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);     
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare e1_, j_ char(3); 
  declare uid_ varchar(20);    
  declare uid_create_ varchar(20);
  declare tgl_create_ datetime;    
  declare kond_awal_,kond_akhir_,dif_kondisi_ int(1);
  declare f1_, f2_ char(1);   
  declare cnt_ int;
  declare thn_login_ char(4);  
  declare nilai_buku_,  akum_susut_ decimal(18,2); 

set jns_trans2_ = 34;  

select tgl,idbi,idbi_awal,kond_awal,kond_akhir,uid ,uid_create,tgl_create,dif_kondisi into tgl_, idbi_, idawal_,kond_awal_,kond_akhir_,uid_,uid_create_,tgl_create_,dif_kondisi_ from t_kondisi where id = id_;             
select staset,a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into staset_,a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
    

    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;       

if (year(tgl_) >= thn_login_) then 


  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);   


  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);    

 
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;  
      
      select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;

    if kond_awal_ <>0 then    
       
       select count(*) into cnt_ from t_transaksi where jns_trans2 in (34) and refid=id_; 
       if cnt_ > 0 then     
        update t_transaksi set       
          kint=rkint_, ka=rka_, kb=rkb_,         
          jns_trans3=0, jns_trans2=jns_trans2_, idbi=idbi_, 
          idawal = idawal_,        
          a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
          tgl_buku = tgl_, staset=0, jns_trans=0, tgl_update=now(), uid=uid_, debet=0,kredit = 0,
          kondisi=dif_kondisi_, asal_usul=0, status_barang=0  
          where jns_trans2=jns_trans2_ and refid=id_;
          delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
      else
        insert into t_transaksi
          (q,kint, ka, kb, jns_trans2, jns_trans3, kondisi,refid, refid2,idbi, idawal, 
          jml_barang_d, jml_barang_k, debet, kredit, harga_atribusi, asal_usul, status_barang,a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          tgl_buku, staset, jns_trans, tgl_update,uid,uid_create,tgl_create)   
        values  
           (0,rkint_, rka_, rkb_, jns_trans2_, 0, dif_kondisi_,id_, 0,idbi_, idawal_,
           0,0,0,0,0,0,0, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
           tgl_, 0, 0, now(), uid_ ,uid_create_,tgl_create_);    
      end if;      

      if kond_akhir_ = 3 then 
          
          insert into t_jurnal_aset
                 (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, kondisi,
                 jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
          values 
                 (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, dif_kondisi_,
                 0, 1, 0, nilai_buku_ , tgl_, 0, 9,  ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
          
          insert into t_jurnal_aset
                 (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, kondisi,
                 jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
          values 
                 (jns_trans2_, '01', '02', '05', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, dif_kondisi_,
                 1, 0, nilai_buku_, 0 , tgl_, 0, 9, '1', '5', '4', '1', f_, g_,  now(), uid_ );                
         
         if akum_susut_ >0 then
          
          insert into t_jurnal_aset
                 (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, kondisi,
                 jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
          values 
                 (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, dif_kondisi_,
                 1, 0, akum_susut_, 0 , tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ); 
          
          insert into t_jurnal_aset
                 (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, kondisi,
                 jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
          values 
                 (jns_trans2_, '01', '02', '05', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, dif_kondisi_,
                 0, 1, 0, akum_susut_ , tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ );           
         end if;   
      else
          
          insert into t_jurnal_aset
                 (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, kondisi,
                 jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
          values 
                 (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, dif_kondisi_,
                 0, 0, 0, 0 , tgl_, 0, 0, 0, 0, 0, 0, 0, 0,  now(), uid_ );
      end if;        
end if;
end if;     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_kondisi_20180130`(`id_` int(11))
BEGIN


  declare idbi_, idawal_ int(11);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare uid_ varchar(20);    
  declare uid_create_ varchar(20);
  declare tgl_create_ datetime;    
  declare kond_awal_,dif_kondisi_ int(1);
  declare f1_, f2_ char(1);   
  declare cnt_ int;

set jns_trans2_ = 34;  

select tgl,idbi,idbi_awal,kond_awal,uid ,uid_create,tgl_create,dif_kondisi into tgl_, idbi_, idawal_,kond_awal_,uid_,uid_create_,tgl_create_,dif_kondisi_ from t_kondisi where id = id_;             
select staset,a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into staset_,a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;
 
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
    if kond_awal_ <>0 then    
       
       select count(*) into cnt_ from t_transaksi where jns_trans2 in (34) and refid=id_; 
       if cnt_ > 0 then     
        update t_transaksi set       
          kint=rkint_, ka=rka_, kb=rkb_,         
          jns_trans3=0, jns_trans2=jns_trans2_, idbi=idbi_, 
          idawal = idawal_,        
          a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
          tgl_buku = tgl_, staset=0, jns_trans=0, tgl_update=now(), uid=uid_, debet=0,kredit = 0,
          kondisi=dif_kondisi_, asal_usul=0, status_barang=0  
          where jns_trans2=jns_trans2_ and refid=id_;
          delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
      else
        insert into t_transaksi
          (q,kint, ka, kb, jns_trans2, jns_trans3, kondisi,refid, refid2,idbi, idawal, 
          jml_barang_d, jml_barang_k, debet, kredit, harga_atribusi, asal_usul, status_barang,a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          tgl_buku, staset, jns_trans, tgl_update,uid,uid_create,tgl_create)   
        values  
           (0,rkint_, rka_, rkb_, jns_trans2_, 0, dif_kondisi_,id_, 0,idbi_, idawal_,
           0,0,0,0,0,0,0, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
           tgl_, 0, 0, now(), uid_ ,uid_create_,tgl_create_);    
      end if;      


      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, kondisi,
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, dif_kondisi_,
      0, 0, 0, 0 , tgl_, 0, 0, 0, 0, 0, 0, 0, 0,  now(), uid_ );
    end if;     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_kondisi_20180210`(`id_` int(11))
BEGIN



  declare idbi_, idawal_ int(11);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare uid_ varchar(20);    
  declare uid_create_ varchar(20);
  declare tgl_create_ datetime;    
  declare kond_awal_,dif_kondisi_ int(1);
  declare f1_, f2_ char(1);   
  declare cnt_ int;
  declare thn_login_ char(4);

set jns_trans2_ = 34;  

select tgl,idbi,idbi_awal,kond_awal,uid ,uid_create,tgl_create,dif_kondisi into tgl_, idbi_, idawal_,kond_awal_,uid_,uid_create_,tgl_create_,dif_kondisi_ from t_kondisi where id = id_;             
select staset,a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into staset_,a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
  
if (year(tgl_) >= thn_login_) then 
 
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;

    if kond_awal_ <>0 then    
       
       select count(*) into cnt_ from t_transaksi where jns_trans2 in (34) and refid=id_; 
       if cnt_ > 0 then     
        update t_transaksi set       
          kint=rkint_, ka=rka_, kb=rkb_,         
          jns_trans3=0, jns_trans2=jns_trans2_, idbi=idbi_, 
          idawal = idawal_,        
          a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
          tgl_buku = tgl_, staset=0, jns_trans=0, tgl_update=now(), uid=uid_, debet=0,kredit = 0,
          kondisi=dif_kondisi_, asal_usul=0, status_barang=0  
          where jns_trans2=jns_trans2_ and refid=id_;
          delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
      else
        insert into t_transaksi
          (q,kint, ka, kb, jns_trans2, jns_trans3, kondisi,refid, refid2,idbi, idawal, 
          jml_barang_d, jml_barang_k, debet, kredit, harga_atribusi, asal_usul, status_barang,a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          tgl_buku, staset, jns_trans, tgl_update,uid,uid_create,tgl_create)   
        values  
           (0,rkint_, rka_, rkb_, jns_trans2_, 0, dif_kondisi_,id_, 0,idbi_, idawal_,
           0,0,0,0,0,0,0, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
           tgl_, 0, 0, now(), uid_ ,uid_create_,tgl_create_);    
      end if;      


      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, kondisi,
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, dif_kondisi_,
      0, 0, 0, 0 , tgl_, 0, 0, 0, 0, 0, 0, 0, 0,  now(), uid_ );
    end if;  
end if;     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_koreksi`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
  declare f1_,f2_ char(1); 
  declare cnt_ int;    
  declare c1_ char(1); 
  declare thn_login_ char(4);
    
  set jns_trans2_ = 12;  
  set jns_trans_ = 8;  

  
  select staset, tgl, idbi, idbi_awal, uid, harga_baru-harga
    into staset_, tgl_, idbi_, idawal_, uid_, biaya_ from t_koreksi where id = id_;             



    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_,f_, g_, h_, i_, j_  from buku_induk where id = idbi_; 

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
  
if (year(tgl_) >= thn_login_) then       

    
    

      
        
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;         
    
    
    set difstaset_ = 0;
    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=if(biaya_>0, biaya_, 0), kredit = if(biaya_<0, -1*biaya_, 0 )        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, debet, kredit,
      tgl_buku, staset, jns_trans, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1, f2, f_, g_, h_, i_, j_, if(biaya_>0, biaya_, 0), if(biaya_<0, -1*biaya_, 0 ) ,
      tgl_, 0, jns_trans_, now(), uid_ );  
    end if;         

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, if(biaya_>0, biaya_, 0), if(biaya_<0, -1*biaya_, 0 ) , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
 

end if; 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_koreksi_20170906`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
  declare f1_,f2_ char(1); 
  declare cnt_ int;    
  declare c1_ char(1); 
    
  set jns_trans2_ = 12;  
  set jns_trans_ = 8;  

  
  select staset, tgl, idbi, idbi_awal, uid, harga_baru-harga
    into staset_, tgl_, idbi_, idawal_, uid_, biaya_ from t_koreksi where id = id_;             



    
    select a1, a, b, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f1_, f2_,f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
        
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;
    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=biaya_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f1, f2, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ );  
    end if;         

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, if(biaya_>0, biaya_, 0), if(biaya_<0, -1*biaya_, 0 ) , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
 

 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_koreksi_20180130`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
  declare f1_,f2_ char(1); 
  declare cnt_ int;    
  declare c1_ char(1); 
    
  set jns_trans2_ = 12;  
  set jns_trans_ = 8;  

  
  select staset, tgl, idbi, idbi_awal, uid, harga_baru-harga
    into staset_, tgl_, idbi_, idawal_, uid_, biaya_ from t_koreksi where id = id_;             



    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_,f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
        
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;
    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=if(biaya_>0, biaya_, 0), kredit = if(biaya_<0, -1*biaya_, 0 )        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, debet, kredit,
      tgl_buku, staset, jns_trans, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1, f2, f_, g_, h_, i_, j_, if(biaya_>0, biaya_, 0), if(biaya_<0, -1*biaya_, 0 ) ,
      tgl_, 0, jns_trans_, now(), uid_ );  
    end if;         

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, if(biaya_>0, biaya_, 0), if(biaya_<0, -1*biaya_, 0 ) , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
 

 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_koreksi_bck20160514`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, idtrans_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
        
  set jns_trans2_ = 12;  
  set jns_trans_ = 8;  

  
  select staset, tgl, idbi, idbi_awal, uid, harga_baru-harga
    into staset_, tgl_, idbi_, idawal_, uid_, biaya_ from t_koreksi where id = id_;             



    
    select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
        
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ );  
        

    set idtrans_ = LAST_INSERT_ID();

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, if(biaya_>0, biaya_, 0), if(biaya_<0, -1*biaya_, 0 ) , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
 

 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_koreksi_bck20170929`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
  declare f1_,f2_ char(1); 
  declare cnt_ int;    
  declare c1_ char(1); 
    
  set jns_trans2_ = 12;  
  set jns_trans_ = 8;  

  
  select staset, tgl, idbi, idbi_awal, uid, harga_baru-harga
    into staset_, tgl_, idbi_, idawal_, uid_, biaya_ from t_koreksi where id = id_;             



    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_,f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
        
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;
    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=biaya_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1, f2, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ );  
    end if;         

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, if(biaya_>0, biaya_, 0), if(biaya_<0, -1*biaya_, 0 ) , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
 

 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_koreksi_bck20180129`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
  declare f1_,f2_ char(1); 
  declare cnt_ int;    
  declare c1_ char(1); 
    
  set jns_trans2_ = 12;  
  set jns_trans_ = 8;  

  
  select staset, tgl, idbi, idbi_awal, uid, harga_baru-harga
    into staset_, tgl_, idbi_, idawal_, uid_, biaya_ from t_koreksi where id = id_;             



    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_,f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
        
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;
    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=if(biaya_>0, biaya_, 0), kredit = if(biaya_<0, -1*biaya_, 0 )        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, debet, kredit,
      tgl_buku, staset, jns_trans, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1, f2, f_, g_, h_, i_, j_, if(biaya_>0, biaya_, 0), if(biaya_<0, -1*biaya_, 0 ) ,
      tgl_, 0, jns_trans_, now(), uid_ );  
    end if;         

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, if(biaya_>0, biaya_, 0), if(biaya_<0, -1*biaya_, 0 ) , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
 

 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_mutasi`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idbaru_, status_barang_ int(11);  


  declare nilai_buku_ decimal(18,2); 
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);  
  declare mutasi_, sudahmutasi_ tinyint(3);    
  declare tgl_create_ datetime;  
  declare susut_mode_, cnt_ int; 
  declare f1_, f2_ char(1); 
  declare thn_login_ char(4);  






  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, sudahmutasi, tgl_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_ from penghapusan where id = id_;  


  if mutasi_ = 1 then
     set jns_trans2_ = 15;            
     set jns_trans_  = 5;  
  elseif mutasi_ = 3 then  
     set jns_trans2_ = 35;    
     set jns_trans_  = 5;  
  end if;
  

  if mutasi_ = 1 or mutasi_ = 3 then 


    
    select a1, a, b, c1, c, d, e, e1, f1,f2, f, g, h, i, j, status_barang  into a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, status_barang_  from buku_induk where id = idbi_; 

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN'; 
  
if (year(tgl_) >= thn_login_) then    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
    

    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

      
    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if; 

 


    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        idbi=idbi_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=0, jns_trans=jns_trans_, tgl_update=now(), uid=uid_           
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1, f1, f2,f,g,h,i,j, 
        tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_,f_, g_, h_, i_, j_, 
        tgl_, 0, jns_trans_, now(), uid_, 3-status_barang_, tgl_create_);  
      
    end if;
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 3-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );  
 


    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    if akum_susut_ >0 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );         
    end if;    



    if sudahmutasi_=1 then        
       
        
        select a1, a, b, c1, c, d, e, e1, f, g, h, i, j, id into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, idbaru_  
        from buku_induk where id_lama = idbi_ limit 0,1;         
 
         


        
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1,
          1, 0, nilai_buku_, 0, tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );     
          
       
          
        delete from penyusutan where idbi = idbaru_;      
        update buku_induk aa join buku_induk bb on aa.id_lama = bb.id 
          set aa.nilai_sisa=bb.nilai_sisa, aa.thn_susut_aw=bb.thn_susut_aw, 
          aa.thn_susut_ak=bb.thn_susut_ak, aa.masa_manfaat=bb.masa_manfaat, aa.bln_susut_aw=bb.bln_susut_aw, aa.bln_susut_ak=bb.bln_susut_ak , aa.stop_susut=bb.stop_susut        
          where aa.id=idbaru_;          

        
        insert into penyusutan       
         (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c1,c,d,e,e1,f,g,h,i,j,ket,jns_trans2,id_koreksi,tgl_create,uid_create)
        select       
         tgl_,tahun,sem,bulan,idbaru_ ,idbi_awal, harga, uid_, now(),thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c1_,c_,d_,e_,e1_,f_,g_,h_,i_,j_,ket,jns_trans2_,id_koreksi, tgl_create_, uid_
        from penyusutan           
        where idbi = idbi_ and (id_koreksi is null or id_koreksi='' or id_koreksi=0);
       

        
        
        if akum_susut_ >0 then    
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
            0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );  
        end if;         

    end if;
     
  end if;  
end if;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_mutasi_20170110`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idbaru_, status_barang_ int(11);  


  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);  
  declare mutasi_, sudahmutasi_ tinyint(3);    
  declare tgl_create_ datetime;  
  declare susut_mode_ int; 


  set jns_trans2_ = 15;  
  set jns_trans_  = 5;  




  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, sudahmutasi, tgl_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_ from penghapusan where id = id_;  


  if mutasi_ = 1 then 


    
    select a1, a, b, c, d, e, e1, f, g, h, i, j, status_barang  into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, status_barang_  from buku_induk where id = idbi_;    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
    

    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

    
    if susut_mode_ = 3  then  
       delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
    else 
       delete from penyusutan where idbi=idbi_ and tgl>= tgl_;    
    end if;            

    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;


    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, 3-status_barang_, tgl_create_);  
    
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 3-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );  
 


   
    if akum_susut_ >0 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );         
    end if;    



    if sudahmutasi_=1 then        
       
        
        select a1, a, b, c, d, e, e1, f, g, h, i, j, id into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, idbaru_  
        from buku_induk where id_lama = idbi_ limit 0,1;         
 

        
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1,
          1, 0, nilai_buku_, 0, tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );        

        
        if akum_susut_ >0 then    
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
            0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );  
        end if;         

    end if;
     
  end if;  


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_mutasi_20170919`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idbaru_, status_barang_ int(11);  


  declare nilai_buku_ decimal(18,2); 
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);  
  declare mutasi_, sudahmutasi_ tinyint(3);    
  declare tgl_create_ datetime;  
  declare susut_mode_ int; 







  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, sudahmutasi, tgl_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_ from penghapusan where id = id_;  


  if mutasi_ = 1 then
     set jns_trans2_ = 15;            
     set jns_trans_  = 5;  
  elseif mutasi_ = 3 then    
     set jns_trans2_ = 35;    
     set jns_trans_  = 5;  
  end if;
  

  if mutasi_ = 1 or mutasi_ = 3 then 


    
    select a1, a, b, c1, c, d, e, e1, f, g, h, i, j, status_barang  into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, status_barang_  from buku_induk where id = idbi_;    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
    

    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

      
    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;

 delete from t_transaksi where jns_trans2 = jns_trans2_ and refid=id_; 


    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, 3-status_barang_, tgl_create_);  
    
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 3-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );  
 


    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    if akum_susut_ >0 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );         
    end if;    



    if sudahmutasi_=1 then        
       
        
        select a1, a, b, c1, c, d, e, e1, f, g, h, i, j, id into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, idbaru_  
        from buku_induk where id_lama = idbi_ limit 0,1;         
 

        
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1,
          1, 0, nilai_buku_, 0, tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );        

          
        delete from penyusutan where idbi = idbaru_;      
        update buku_induk aa join buku_induk bb on aa.id_lama = bb.id 
          set aa.nilai_sisa=bb.nilai_sisa, aa.thn_susut_aw=bb.thn_susut_aw, 
          aa.thn_susut_ak=bb.thn_susut_ak, aa.masa_manfaat=bb.masa_manfaat, aa.bln_susut_aw=bb.bln_susut_aw, aa.bln_susut_ak=bb.bln_susut_ak , aa.stop_susut=bb.stop_susut        
          where aa.id=idbaru_;          

        
        insert into penyusutan       
         (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c,d,e,e1,f,g,h,i,j,ket,jns_trans2,id_koreksi,tgl_create,uid_create)
        select       
         tgl_,tahun,sem,bulan,idbaru_ ,idbi_awal, harga, uid_, now(),thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c_,d_,e_,e1_,f_,g_,h_,i_,j_,ket,jns_trans2_,id_koreksi, tgl_create_, uid_
        from penyusutan           
        where idbi = idbi_ and (id_koreksi is null or id_koreksi='' or id_koreksi=0);
       

        
        
        if akum_susut_ >0 then    
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
            0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );  
        end if;         

    end if;
     
  end if;  


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_mutasi_20180130`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idbaru_, status_barang_ int(11);  


  declare nilai_buku_ decimal(18,2); 
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);  
  declare mutasi_, sudahmutasi_ tinyint(3);    
  declare tgl_create_ datetime;  
  declare susut_mode_, cnt_ int; 
  declare f1_, f2_ char(1); 






  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, sudahmutasi, tgl_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_ from penghapusan where id = id_;  


  if mutasi_ = 1 then
     set jns_trans2_ = 15;            
     set jns_trans_  = 5;  
  elseif mutasi_ = 3 then  
     set jns_trans2_ = 35;    
     set jns_trans_  = 5;  
  end if;
  

  if mutasi_ = 1 or mutasi_ = 3 then 


    
    select a1, a, b, c1, c, d, e, e1, f1,f2, f, g, h, i, j, status_barang  into a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, status_barang_  from buku_induk where id = idbi_;    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
    

    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

      
    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;

 


    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        idbi=idbi_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=0, jns_trans=jns_trans_, tgl_update=now(), uid=uid_           
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1, f1, f2,f,g,h,i,j, 
        tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_,f_, g_, h_, i_, j_, 
        tgl_, 0, jns_trans_, now(), uid_, 3-status_barang_, tgl_create_);  
      
    end if;
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 3-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );  
 


    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    if akum_susut_ >0 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );         
    end if;    



    if sudahmutasi_=1 then        
       
        
        select a1, a, b, c1, c, d, e, e1, f, g, h, i, j, id into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, idbaru_  
        from buku_induk where id_lama = idbi_ limit 0,1;         
 
         


        
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1,
          1, 0, nilai_buku_, 0, tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );     
          
       
          
        delete from penyusutan where idbi = idbaru_;      
        update buku_induk aa join buku_induk bb on aa.id_lama = bb.id 
          set aa.nilai_sisa=bb.nilai_sisa, aa.thn_susut_aw=bb.thn_susut_aw, 
          aa.thn_susut_ak=bb.thn_susut_ak, aa.masa_manfaat=bb.masa_manfaat, aa.bln_susut_aw=bb.bln_susut_aw, aa.bln_susut_ak=bb.bln_susut_ak , aa.stop_susut=bb.stop_susut        
          where aa.id=idbaru_;          

        
        insert into penyusutan       
         (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c,d,e,e1,f,g,h,i,j,ket,jns_trans2,id_koreksi,tgl_create,uid_create)
        select       
         tgl_,tahun,sem,bulan,idbaru_ ,idbi_awal, harga, uid_, now(),thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c_,d_,e_,e1_,f_,g_,h_,i_,j_,ket,jns_trans2_,id_koreksi, tgl_create_, uid_
        from penyusutan           
        where idbi = idbi_ and (id_koreksi is null or id_koreksi='' or id_koreksi=0);
       

        
        
        if akum_susut_ >0 then    
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
            0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );  
        end if;         

    end if;
     
  end if;  


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_mutasi_bck20170918`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idbaru_, status_barang_ int(11);  


  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);  
  declare mutasi_, sudahmutasi_ tinyint(3);    
  declare tgl_create_ datetime;  
  declare susut_mode_ int; 







  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, sudahmutasi, tgl_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_ from penghapusan where id = id_;  


  if mutasi_ = 1 then
     set jns_trans2_ = 15;            
     set jns_trans_  = 5;  
  elseif mutasi_ = 3 then    
     set jns_trans2_ = 35;    
     set jns_trans_  = 5;  
  end if;
  

  if mutasi_ = 1 or mutasi_ = 3 then 


    
    select a1, a, b, c1, c, d, e, e1, f, g, h, i, j, status_barang  into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, status_barang_  from buku_induk where id = idbi_;    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
    

    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

      
    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;

 delete from t_transaksi where jns_trans2 = jns_trans2_ and refid=id_; 


    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, 3-status_barang_, tgl_create_);  
    
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 3-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );  
 


    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    if akum_susut_ >0 then      
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );         
    end if;    



    if sudahmutasi_=1 then        
       
        
        select a1, a, b, c1, c, d, e, e1, f, g, h, i, j, id into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, idbaru_  
        from buku_induk where id_lama = idbi_ limit 0,1;         
 

        
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1,
          1, 0, nilai_buku_, 0, tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );        

          
        delete from penyusutan where idbi = idbaru_;      
        update buku_induk aa join buku_induk bb on aa.id_lama = bb.id 
          set aa.nilai_sisa=bb.nilai_sisa, aa.thn_susut_aw=bb.thn_susut_aw, 
          aa.thn_susut_ak=bb.thn_susut_ak, aa.masa_manfaat=bb.masa_manfaat, aa.bln_susut_aw=bb.bln_susut_aw, aa.bln_susut_ak=bb.bln_susut_ak , aa.stop_susut=bb.stop_susut        
          where aa.id=idbaru_;          

        
        insert into penyusutan       
         (tgl,tahun,sem,bulan,idbi,idbi_awal,harga,uid,tgl_update,thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c,d,e,e1,f,g,h,i,j,ket,jns_trans2,id_koreksi,tgl_create,uid_create)
        select       
         tgl_,tahun,sem,bulan,idbaru_ ,idbi_awal, harga, uid_, now(),thn_perolehan,hrg_perolehan,hrg_rehab,masa_manfaat,residu,
         akum_nilai_buku,nilai_buku_stlh_susut,akum_susut,akum_masa_manfaat,thn_ke,sisa_masa_manfaat,masa_manfaat_rehab,
         sisa_masa_manfaat_thn,stat,bulan_awl,staset,c_,d_,e_,e1_,f_,g_,h_,i_,j_,ket,jns_trans2_,id_koreksi, tgl_create_, uid_
        from penyusutan           
        where idbi = idbi_ and (id_koreksi is null or id_koreksi='' or id_koreksi=0);
       

        
        
        if akum_susut_ >0 then    
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
            0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );  
        end if;         

    end if;
     
  end if;  


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_mutasi_sotk`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idbaru_, status_barang_ int(11);  


  declare nilai_buku_ decimal(18,2); 
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_, nilai_susut_ decimal(18,2);  
  declare mutasi_, sudahmutasi_ tinyint(3);    
  declare tgl_create_ datetime;  
  declare susut_mode_, cnt_ int; 
  declare f1_, f2_ char(1); 
  declare thn_login_ char(4);  






  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, sudahmutasi, tgl_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_ from penghapusan where id = id_;  

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN'; 
  
if (year(tgl_) >= thn_login_) then    


  if mutasi_ = 1 then
     set jns_trans2_ = 15;            
     set jns_trans_  = 5;  
  elseif mutasi_ = 3 then  
     set jns_trans2_ = 35;    
     set jns_trans_  = 5;  
  end if;
  

  if mutasi_ = 1 or mutasi_ = 3 then 


    if sudahmutasi_=1 then        
       
        
        select a1, a, b, c1, c, d, e, e1, f, g, h, i, j, id, nilai_buku, nilai_susut  into 
        a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, idbaru_ ,  nilai_buku_, nilai_susut_
        from buku_induk where id_lama = idbi_ limit 0,1;         


    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;
         


        
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1,
          1, 0, nilai_buku_, 0, tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );     
          
  
        
        
        if akum_susut_ >0 then    
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
            0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );  
        end if;         

    end if;
     
  end if;  
end if;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_mutasi_sotk_20180130`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idbaru_, status_barang_ int(11);  


  declare nilai_buku_ decimal(18,2); 
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_, nilai_susut_ decimal(18,2);  
  declare mutasi_, sudahmutasi_ tinyint(3);    
  declare tgl_create_ datetime;  
  declare susut_mode_, cnt_ int; 
  declare f1_, f2_ char(1); 






  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, sudahmutasi, tgl_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_ from penghapusan where id = id_;  


  if mutasi_ = 1 then
     set jns_trans2_ = 15;            
     set jns_trans_  = 5;  
  elseif mutasi_ = 3 then  
     set jns_trans2_ = 35;    
     set jns_trans_  = 5;  
  end if;
  

  if mutasi_ = 1 or mutasi_ = 3 then 


    if sudahmutasi_=1 then        
       
        
        select a1, a, b, c1, c, d, e, e1, f, g, h, i, j, id, nilai_buku, nilai_susut  into 
        a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, idbaru_ ,  nilai_buku_, nilai_susut_
        from buku_induk where id_lama = idbi_ limit 0,1;         


    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;
         


        
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1,
          1, 0, nilai_buku_, 0, tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );     
          
  
        
        
        if akum_susut_ >0 then    
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
            0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );  
        end if;         

    end if;
     
  end if;  


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemanfaatan`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, jns_trans2_, jns_trans_,status_barang_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare tgl_create_ datetime;  
  declare susut_mode_ int;  
  declare f1_, f2_,bentuk_pemanfaatan_ char(1);
  declare cnt_ int;
  declare thn_login_ char(4);  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;  

    
    
  
  select bentuk_pemanfaatan,staset,tgl_pemanfaatan,id_bukuinduk,idbi_awal, ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid, tgl_create
     into bentuk_pemanfaatan_,staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,tgl_create_ from pemanfaatan where id = id_;    
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, status_barang into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, status_barang_  
  from buku_induk where id = idbi_;

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN'; 
  
if (year(tgl_) >= thn_login_) then    
  
  
  if susut_mode_ = 3  then  
       delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
  else 
       delete from penyusutan where idbi=idbi_ and tgl>= tgl_ and jns_trans2=30;    
  end if;    

  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);    

  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);        
  
    
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
    
set jns_trans2_ = 19; 
set jns_trans_= 9 ;

  
  set difstaset_ = 7-staset_;
  select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=nilai_buku_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, status_barang,tgl_create)   
      values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), uid_, 2-status_barang_ ,tgl_create_);  
    end if;  

   

    
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
    
if bentuk_pemanfaatan_ != 2 then 
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
  values 
  (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 2-status_barang_,
  0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);
else  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
  values 
  (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 2-status_barang_,
  0, 0, 0, 0, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);
end if; 
  
    
    
 
  if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19, rkint_, rka_, rkb_, 19, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;
  
  
  
    if bentuk_pemanfaatan_ != 2 then 
      insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
      values 
      (19, '01', '02', '03', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_ ,c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      
      1, 0, nilai_buku_ , 0, tgl_, 0, jns_trans_, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);   
    end if;  
    if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2_, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19,'01', '02', '03', 19, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
end if;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemanfaatan_20160514`(idpemanfaatan_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, idtrans_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);
    
  
  select staset,tgl_pemanfaatan,id_bukuinduk,idbi_awal, ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid 
     into staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_ from pemanfaatan where id = idpemanfaatan_;    
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);    
  
    
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
  
  set difstaset_ = 7-staset_;
  insert into t_transaksi
  (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid)   
  values  
  (rkint_, rka_, rkb_, 19, idpemanfaatan_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, difstaset_, 9, now(), uid_ );  
  set idtrans_ = LAST_INSERT_ID();
   
    
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
  values 
  (19, rkint_, rka_, rkb_, 19, idtrans_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
  0, 1, 0, nilai_buku_, tgl_, difstaset_, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
    
 
  
  select sum(ifnull(harga,0)) into akum_susut_ from penyusutan where idbi= idbi_ and tgl<=tgl_;      
  
    set akum_susut_ = ifnull(akum_susut_,0);    
  
  if akum_susut_ >0 then
    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid)
    values 
      (19, rkint_, rka_, rkb_, 19, idtrans_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ );         
   end if;

  
  
  insert into t_jurnal_aset   
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid)
  values 
  (19, '01', '02', '03', 19, idtrans_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
  1, 0, nilai_buku_ - akum_susut_, 0, tgl_, 0, 9, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ );   
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemanfaatan_20180130`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, jns_trans2_, jns_trans_,status_barang_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare tgl_create_ datetime;  
  declare susut_mode_ int;  
  declare f1_, f2_,bentuk_pemanfaatan_ char(1);
  declare cnt_ int;

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;  

    
    
  
  select bentuk_pemanfaatan,staset,tgl_pemanfaatan,id_bukuinduk,idbi_awal, ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid, tgl_create
     into bentuk_pemanfaatan_,staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,tgl_create_ from pemanfaatan where id = id_;    
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, status_barang into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, status_barang_  
  from buku_induk where id = idbi_;
  
  if susut_mode_ = 3  then  
       delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
  else 
       delete from penyusutan where idbi=idbi_ and tgl>= tgl_ and jns_trans2=30;    
  end if;    

  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);    

  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);        
  
    
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
    
set jns_trans2_ = 19; 
set jns_trans_= 9 ;

  
  set difstaset_ = 7-staset_;
  select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=nilai_buku_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, status_barang,tgl_create)   
      values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), uid_, 2-status_barang_ ,tgl_create_);  
    end if;  

   

    
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
    
if bentuk_pemanfaatan_ != 2 then 
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
  values 
  (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 2-status_barang_,
  0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);
else  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
  values 
  (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 2-status_barang_,
  0, 0, 0, 0, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);
end if; 
  
    
    
 
  if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19, rkint_, rka_, rkb_, 19, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;
  
  
  
    if bentuk_pemanfaatan_ != 2 then 
      insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
      values 
      (19, '01', '02', '03', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_ ,c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      
      1, 0, nilai_buku_ , 0, tgl_, 0, jns_trans_, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);   
    end if;  
    if akum_susut_ >0 then    
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2_, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19,'01', '02', '03', 19, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemeliharaan`(id_ int(11) )
BEGIN
  






  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, jns_trans3_ , staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);
  declare tambah_aset_ tinyint(3);  
  declare cara_perolehan_ int;  
  declare thn_buku_pelihara_ char(4); 
  declare thn_perolehan_,thn_login_ char(4); 
  declare tgl_create_ datetime;  
  declare cnt_ int;
  declare f1_, f2_ char(1); 
        

  
  select staset,tgl_pemeliharaan,id_bukuinduk,idbi_awal,year(tgl_pemeliharaan)as thn_pelihara,year(tgl_perolehan)as thn_perolehan, 
    ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid ,biaya_pemeliharaan,tambah_aset, cara_perolehan, tgl_create
    into staset_, tgl_, idbi_, idawal_,thn_buku_pelihara_,thn_perolehan_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,biaya_pemeliharaan_,tambah_aset_, cara_perolehan_ , tgl_create_
    from pemeliharaan where id = id_;  
    
  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';  
  
if (thn_buku_pelihara_ >= thn_login_) then              

  
  set jns_trans2_ = 9;        
  
  if(thn_buku_pelihara_ <> thn_perolehan_) then  
    set jns_trans_= 8;  
    set jns_trans3_ = 5;  
  else  
     
      if cara_perolehan_ = 1 then 
        set jns_trans_ = 1;     
        set jns_trans3_ = 1;   
      elseif cara_perolehan_ = 2 then 
        set jns_trans_ = 3;   
        set jns_trans3_ = 2;          
      elseif cara_perolehan_ = 3 then 
        set jns_trans_ = 4;          
        set jns_trans3_ = 3; 
       elseif cara_perolehan_ = 4 then  
        set jns_trans_ = 8; 
        set jns_trans3_ = 4;       
      else  
        set jns_trans_ = 3;        
      end if; 
  end if;

  

  

  if tambah_aset_ = 1 then
    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ;             
    elseif staset_ = 7 then 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;                
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then   
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;   
    
    
    set difstaset_ = 0;    

    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=biaya_pemeliharaan_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, jns_trans3, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, debet, kredit, tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, jns_trans3_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, biaya_pemeliharaan_, 0 , tgl_create_);  
    end if;    

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, jns_trans3, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, jns_trans3_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, if(biaya_pemeliharaan_>=0,biaya_pemeliharaan_,0), if(biaya_pemeliharaan_<0,-1*biaya_pemeliharaan_,0) , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , tgl_create_);  
 

  end if;  
end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemeliharaan_20160511`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, idtrans_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);
  declare tambah_aset_ tinyint(3);  
  declare cara_perolehan_ int;
        

  
  select staset,tgl_pemeliharaan,id_bukuinduk,idbi_awal, 
    ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid ,biaya_pemeliharaan,tambah_aset, cara_perolehan_
    into staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,biaya_pemeliharaan_,tambah_aset_, cara_perolehan_ from pemeliharaan where id = id_;             

  
  set jns_trans2_ = 9;      
  
  if cara_perolehan_ = 1 then
    set jns_trans_ = 1;        
  elseif cara_perolehan_ = 2 then
    set jns_trans_ = 3;            
  elseif cara_perolehan_ = 3 then
    set jns_trans_ = 4;        
  else  
    set jns_trans_ = 3;        
  end if;


  if tambah_aset_ = 1 then
    
    select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ );  
        

    set idtrans_ = LAST_INSERT_ID();

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, biaya_pemeliharaan_, 0 , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
 

  end if;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemeliharaan_20160725`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);
  declare tambah_aset_ tinyint(3);  
  declare cara_perolehan_ int;
        

  
  select staset,tgl_pemeliharaan,id_bukuinduk,idbi_awal, 
    ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid ,biaya_pemeliharaan,tambah_aset, cara_perolehan_
    into staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,biaya_pemeliharaan_,tambah_aset_, cara_perolehan_ from pemeliharaan where id = id_;             

  
  set jns_trans2_ = 9;      
  
  if cara_perolehan_ = 1 then
    set jns_trans_ = 1;        
  elseif cara_perolehan_ = 2 then
    set jns_trans_ = 3;            
  elseif cara_perolehan_ = 3 then
    set jns_trans_ = 4;        
  else  
    set jns_trans_ = 3;        
  end if;


  if tambah_aset_ = 1 then
    
    select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ );  
        

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, biaya_pemeliharaan_, 0 , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
 

  end if;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemeliharaan_20171109`(id_ int(11) )
BEGIN
  




  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, jns_trans3_ , staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);
  declare tambah_aset_ tinyint(3);  
  declare cara_perolehan_ int;  
  declare thn_buku_pelihara_ char(4);  
  declare thn_perolehan_ char(4);  
  declare tgl_create_ datetime;  
  declare cnt_ int;
  declare f1_, f2_ char(1); 
        

  
  select staset,tgl_pemeliharaan,id_bukuinduk,idbi_awal,year(tgl_pemeliharaan)as thn_pelihara,year(tgl_perolehan)as thn_perolehan, 
    ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid ,biaya_pemeliharaan,tambah_aset, cara_perolehan, tgl_create
    into staset_, tgl_, idbi_, idawal_,thn_buku_pelihara_,thn_perolehan_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,biaya_pemeliharaan_,tambah_aset_, cara_perolehan_ , tgl_create_
    from pemeliharaan where id = id_;             

  
  set jns_trans2_ = 9;        
  
  if(thn_buku_pelihara_ <> thn_perolehan_) then  
    set jns_trans_= 8;    
  else  
     
      if cara_perolehan_ = 1 then
        set jns_trans_ = 1;        
      elseif cara_perolehan_ = 2 then
        set jns_trans_ = 3;            
      elseif cara_perolehan_ = 3 then
        set jns_trans_ = 4;  
       elseif cara_perolehan_ = 4 then
        set jns_trans_ = 8;       
      else  
        set jns_trans_ = 3;        
      end if; 
  end if;

  

  

  if tambah_aset_ = 1 then
    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ;             
    elseif staset_ = 7 then 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;                
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then   
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;    

    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=biaya_pemeliharaan_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, debet, kredit, tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, biaya_pemeliharaan_, 0 , tgl_create_);  
    end if;    

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, if(biaya_pemeliharaan_>=0,biaya_pemeliharaan_,0), if(biaya_pemeliharaan_<0,-1*biaya_pemeliharaan_,0) , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , tgl_create_);  
 

  end if;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemeliharaan_20180130`(id_ int(11) )
BEGIN
  





  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, jns_trans3_ , staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);
  declare tambah_aset_ tinyint(3);  
  declare cara_perolehan_ int;  
  declare thn_buku_pelihara_ char(4);  
  declare thn_perolehan_ char(4);  
  declare tgl_create_ datetime;  
  declare cnt_ int;
  declare f1_, f2_ char(1); 
        

  
  select staset,tgl_pemeliharaan,id_bukuinduk,idbi_awal,year(tgl_pemeliharaan)as thn_pelihara,year(tgl_perolehan)as thn_perolehan, 
    ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid ,biaya_pemeliharaan,tambah_aset, cara_perolehan, tgl_create
    into staset_, tgl_, idbi_, idawal_,thn_buku_pelihara_,thn_perolehan_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,biaya_pemeliharaan_,tambah_aset_, cara_perolehan_ , tgl_create_
    from pemeliharaan where id = id_;             

  
  set jns_trans2_ = 9;        
  
  if(thn_buku_pelihara_ <> thn_perolehan_) then  
    set jns_trans_= 8;  
    set jns_trans3_ = 5;  
  else  
     
      if cara_perolehan_ = 1 then 
        set jns_trans_ = 1;     
        set jns_trans3_ = 1;   
      elseif cara_perolehan_ = 2 then 
        set jns_trans_ = 3;   
        set jns_trans3_ = 2;          
      elseif cara_perolehan_ = 3 then 
        set jns_trans_ = 4;          
        set jns_trans3_ = 3; 
       elseif cara_perolehan_ = 4 then  
        set jns_trans_ = 8; 
        set jns_trans3_ = 4;       
      else  
        set jns_trans_ = 3;        
      end if; 
  end if;

  

  

  if tambah_aset_ = 1 then
    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
    
    if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ;             
    elseif staset_ = 7 then 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;                
    elseif staset_ = 8 then  
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then   
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;    

    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=biaya_pemeliharaan_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, jns_trans3, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, debet, kredit, tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, jns_trans3_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, biaya_pemeliharaan_, 0 , tgl_create_);  
    end if;    

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, jns_trans3, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid, tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, jns_trans3_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, if(biaya_pemeliharaan_>=0,biaya_pemeliharaan_,0), if(biaya_pemeliharaan_<0,-1*biaya_pemeliharaan_,0) , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ , tgl_create_);  
 

  end if;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemindahtangan`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare bentuk_pemindahtanganan_ , jns_trans_, jns_trans2_ int;
  declare tgl_create_ datetime;
  declare susut_mode_ int;  
  declare f1_, f2_ char(1);
  declare cnt_ int;
  declare thn_login_ char(4);

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;
        
  
  
  
  select staset, tgl_pemindahtanganan, id_bukuinduk, idbi_awal, uid , bentuk_pemindahtanganan,tgl_create
     into staset_, tgl_, idbi_, idawal_, uid_ , bentuk_pemindahtanganan_,tgl_create_ from pemindahtanganan 
     where id = id_;    
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, status_barang into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_ , status_barang_ from buku_induk where id = idbi_;

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';    
  
if (year(tgl_) >= thn_login_) then   

  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
 
   
  if susut_mode_ = 3  then  
       delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
    else 
       delete from penyusutan where idbi=idbi_ and tgl>= tgl_;    
    end if;  
     
  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);         
  
    
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
  
  if bentuk_pemindahtanganan_ = 1 then 
     set difstaset_ = 5-staset_;          
     set jns_trans_ = 9;     
     set jns_trans2_ = 17;     
  elseif bentuk_pemindahtanganan_ = 2 then  
     set difstaset_ = 11-staset_;          
     set jns_trans_ = 9;   
     set jns_trans2_ = 27;     
  elseif bentuk_pemindahtanganan_ = 3 then    
     set difstaset_ = 12-staset_;    
     set jns_trans_ = 4;  
     set jns_trans2_ = 26;     
  else   
     set difstaset_ = 13-staset_;   
     set jns_trans_ = 9;  
     set jns_trans2_ = 32;      
  end if;  

    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=nilai_buku_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, status_barang,tgl_create)   
      values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), uid_, 4-status_barang_ ,tgl_create_);  
   end if; 
   
   
    
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
  values 
  (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 4-status_barang_,
  0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);    

 
  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;

    
  if bentuk_pemindahtanganan_ = 1 then 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ;
  else
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;
  end if;  
 
  
  
  insert into t_jurnal_aset   
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
  values 
  (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
  
  1, 0, nilai_buku_ , 0, tgl_, 0, jns_trans_, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);     


  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;
end if;
 END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemindahtangan_20160514`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, idtrans_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare bentuk_pemindahtanganan_ , jns_trans_, jns_trans2_ int;
    
  
  select staset, tgl_pemindahtanganan, id_bukuinduk, idbi_awal, uid , bentuk_pemindahtanganan
     into staset_, tgl_, idbi_, idawal_, uid_ , bentuk_pemindahtanganan_ from pemindahtanganan 
     where id = id_;    
  
  select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);    
  
    
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
  
  if bentuk_pemindahtanganan_ = 1 then 
     set difstaset_ = 5-staset_;          
     set jns_trans_ = 9;     
     set jns_trans2_ = 17;     
  elseif bentuk_pemindahtanganan_ = 2 then  
     set difstaset_ = 11-staset_;          
     set jns_trans_ = 7;     
     set jns_trans2_ = 27;     
  elseif bentuk_pemindahtanganan_ = 3 then    
     set difstaset_ = 12-staset_;    
     set jns_trans_ = 4;           
     set jns_trans2_ = 26;     
  else   
     set difstaset_ = 13-staset_;   
     set jns_trans_ = 7; 
     set jns_trans2_ = 32;      
  end if;  

  insert into t_transaksi
  (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid)   
  values  
  (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), uid_ );  
  set idtrans_ = LAST_INSERT_ID();
   
    
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
  values 
  (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
  0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );    

 
  


 END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemindahtangan_20180130`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare bentuk_pemindahtanganan_ , jns_trans_, jns_trans2_ int;
  declare tgl_create_ datetime;
  declare susut_mode_ int;  
  declare f1_, f2_ char(1);
  declare cnt_ int;

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;
        
  
  
  
  select staset, tgl_pemindahtanganan, id_bukuinduk, idbi_awal, uid , bentuk_pemindahtanganan,tgl_create
     into staset_, tgl_, idbi_, idawal_, uid_ , bentuk_pemindahtanganan_,tgl_create_ from pemindahtanganan 
     where id = id_;    
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, status_barang into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_ , status_barang_ from buku_induk where id = idbi_;    

  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
 
   
  if susut_mode_ = 3  then  
       delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
    else 
       delete from penyusutan where idbi=idbi_ and tgl>= tgl_;    
    end if;  
     
  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);         
  
    
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
  
  if bentuk_pemindahtanganan_ = 1 then 
     set difstaset_ = 5-staset_;          
     set jns_trans_ = 9;     
     set jns_trans2_ = 17;     
  elseif bentuk_pemindahtanganan_ = 2 then  
     set difstaset_ = 11-staset_;          
     set jns_trans_ = 9;   
     set jns_trans2_ = 27;     
  elseif bentuk_pemindahtanganan_ = 3 then    
     set difstaset_ = 12-staset_;    
     set jns_trans_ = 4;  
     set jns_trans2_ = 26;     
  else   
     set difstaset_ = 13-staset_;   
     set jns_trans_ = 9;  
     set jns_trans2_ = 32;      
  end if;  

    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=nilai_buku_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, status_barang,tgl_create)   
      values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), uid_, 4-status_barang_ ,tgl_create_);  
   end if; 
   
   
    
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
  values 
  (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 4-status_barang_,
  0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);    

 
  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (19, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;

    
  if bentuk_pemindahtanganan_ = 1 then 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ;
  else
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;
  end if;  
 
  
  
  insert into t_jurnal_aset   
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
  values 
  (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
  
  1, 0, nilai_buku_ , 0, tgl_, 0, jns_trans_, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);     


  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
   end if;

 END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemusnahan`(`id_` int(11))
BEGIN


  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare staset_, difstaset_,sttemp_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare jns_trans_, jns_trans2_ int;  
  declare uid_create_ char(20);  
  declare tgl_create_ datetime;
  declare susut_mode_ int; 
  declare f1_, f2_ char(1);
  declare cnt_ int;
  declare thn_login_ char(4);
   

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;  

  
  select staset, tgl_buku, id_bukuinduk, idbi_awal,sttemp,uid_create,tgl_create
     into staset_, tgl_, idbi_, idawal_,sttemp_,uid_create_,tgl_create_ from pemusnahan_det 
     where id = id_;
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, status_barang into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_ , status_barang_ from buku_induk where id = idbi_;

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
  
if (year(tgl_) >= thn_login_) then        

  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
  
  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);         
  
  set jns_trans2_ = 39;  
  set jns_trans_ = 9;
  set difstaset_ = 14-staset_;
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;  
  
 if (year(tgl_) >= thn_login_) then

  select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=nilai_buku_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update, status_barang,tgl_create,uid_create)   
      values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), 4-status_barang_ ,tgl_create_,uid_create_);  
    end if; 
   
   
    
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid_create,tgl_create)
  values 
  (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 4-status_barang_,
  0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_create_ ,tgl_create_);    

 
  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid_create,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_create_ ,tgl_create_);         
   end if;
  
 
  
  
  insert into t_jurnal_aset   
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid_create,tgl_create)
  values 
  (jns_trans2_, '01', '02', '07', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
  
  1, 0, nilai_buku_ , 0, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,   now(), uid_create_ ,tgl_create_);     


  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid_create,tgl_create)
    values 
      (jns_trans2_, '01', '02', '07', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_create_ ,tgl_create_);         
   end if;
 end if;
end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pemusnahan_20180130`(`id_` int(11))
BEGIN


  declare idbi_, idawal_, status_barang_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare staset_, difstaset_,sttemp_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_,  f_,g_, h_, i_,  rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare jns_trans_, jns_trans2_ int;  
  declare uid_create_ char(20);  
  declare tgl_create_ datetime;
  declare susut_mode_ int; 
  declare f1_, f2_ char(1);
  declare cnt_ int;
   

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;  

  
  select staset, tgl_buku, id_bukuinduk, idbi_awal,sttemp,uid_create,tgl_create
     into staset_, tgl_, idbi_, idawal_,sttemp_,uid_create_,tgl_create_ from pemusnahan_det 
     where id = id_;
  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, status_barang into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_ , status_barang_ from buku_induk where id = idbi_;    

  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
  
  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);         
  
  set jns_trans2_ = 39;  
  set jns_trans_ = 9;
  set difstaset_ = 14-staset_;
  
  if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;  

  select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=nilai_buku_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update, status_barang,tgl_create,uid_create)   
      values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), 4-status_barang_ ,tgl_create_,uid_create_);  
    end if; 
   
   
    
  
  select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
     from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
  
  
  insert into t_jurnal_aset
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid_create,tgl_create)
  values 
  (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 4-status_barang_,
  0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_create_ ,tgl_create_);    

 
  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid_create,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_create_ ,tgl_create_);         
   end if;
  
 
  
  
  insert into t_jurnal_aset   
  (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
  jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid_create,tgl_create)
  values 
  (jns_trans2_, '01', '02', '07', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
  
  1, 0, nilai_buku_ , 0, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,   now(), uid_create_ ,tgl_create_);     


  if akum_susut_ >0 then
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid_create,tgl_create)
    values 
      (jns_trans2_, '01', '02', '07', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_create_ ,tgl_create_);         
   end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pengaman`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_,  d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);   
  declare c1_ char(1);
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare biaya_pengamanan_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
  declare thn_perolehan_,thn_login_,thn_buku_pengaman_ char(4);
  declare tgl_create_ datetime;  
  declare cnt_ int;
  declare f1_,f2_ char(1);
          
  set jns_trans2_ = 10;  
  set jns_trans_ = 3;  

  
  select staset,tgl_pengamanan,id_bukuinduk,idbi_awal,year(tgl_pengamanan)as thn_pengamanan,year(tgl_perolehan)as thn_perolehan,  
    ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid ,biaya_pengamanan,tambah_aset,tgl_create
    into staset_, tgl_, idbi_, idawal_,thn_buku_pengaman_,thn_perolehan_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,biaya_pengamanan_,tambah_aset_,tgl_create_ from pengamanan where id = id_; 

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
  
if (thn_buku_pengaman_ >= thn_login_) then                             


  if tambah_aset_ = 1 then
    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    if(thn_buku_pengaman_ <> thn_perolehan_) then  
      set jns_trans_= 8;    
    else  
      set jns_trans_ = 3;
    end if;   
    
    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=biaya_pengamanan_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1, c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create,debet)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ ,tgl_create_, biaya_pengamanan_);  
    end if;    

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f2_ and f1=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, biaya_pengamanan_, 0 , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
 

  end if;  
end if;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pengaman_20160514`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, idtrans_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare biaya_pengamanan_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
        
  set jns_trans2_ = 10;  
  set jns_trans_ = 3;  

  
  select staset,tgl_pengamanan,id_bukuinduk,idbi_awal, 
    ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid ,biaya_pengamanan,tambah_aset
    into staset_, tgl_, idbi_, idawal_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,biaya_pengamanan_,tambah_aset_ from pengamanan where id = id_;             


  if tambah_aset_ = 1 then
    
    select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '01'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    
    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ );  
        

    set idtrans_ = LAST_INSERT_ID();

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 0, biaya_pengamanan_, 0 , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
 

  end if;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_pengaman_20180130`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_,  d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);   
  declare c1_ char(1);
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare biaya_pengamanan_ decimal(18,2);
  declare tambah_aset_ tinyint(3);
  declare thn_buku_pengaman_ char(4);  
  declare thn_perolehan_ char(4);
  declare tgl_create_ datetime;  
  declare cnt_ int;
  declare f1_,f2_ char(1);
          
  set jns_trans2_ = 10;  
  set jns_trans_ = 3;  

  
  select staset,tgl_pengamanan,id_bukuinduk,idbi_awal,year(tgl_pengamanan)as thn_pengamanan,year(tgl_perolehan)as thn_perolehan,  
    ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid ,biaya_pengamanan,tambah_aset,tgl_create
    into staset_, tgl_, idbi_, idawal_,thn_buku_pengaman_,thn_perolehan_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,biaya_pengamanan_,tambah_aset_,tgl_create_ from pengamanan where id = id_;             


  if tambah_aset_ = 1 then
    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    

      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    if(thn_buku_pengaman_ <> thn_perolehan_) then  
      set jns_trans_= 8;    
    else  
      set jns_trans_ = 3;
    end if;
    
    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=biaya_pengamanan_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1, c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create,debet)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ ,tgl_create_, biaya_pengamanan_);  
    end if;    

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f2_ and f1=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, biaya_pengamanan_, 0 , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
 

  end if;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_penghapusan`(id_ int(11) )
BEGIN
 

  declare qry varchar(300);
  declare idbi_, idawal_,status_barang_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_, hapus_dari_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare biaya_pemeliharaan_ decimal(18,2);
  declare mutasi_ tinyint(3);  
  declare tgl_create_ datetime;  
  declare susut_mode_ int;  
  declare f1_, f2_ char(1);
  declare cnt_ int;
  declare thn_login_ char(4);

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;
   
  
  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, tgl_create,hapus_dari
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, tgl_create_,hapus_dari_ from penghapusan where id = id_;  


  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
  
if (year(tgl_) >= thn_login_) then      


  if mutasi_ = 0 or mutasi_=4 or mutasi_=5 then 
    if mutasi_ = 0 then
       set jns_trans2_ = 14;   
       set jns_trans_  = 7;        
    elseif mutasi_ = 4 then    
       set jns_trans2_ = 37; 
       set jns_trans_  = 8;        
    elseif mutasi_ = 5 then        
       set jns_trans2_ = 38;  
       set jns_trans_  = 8;       
    end if;
    
    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, status_barang into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, status_barang_  from buku_induk where id = idbi_;    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;

 
   
    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        idbi=idbi_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=0, jns_trans=jns_trans_, tgl_update=now(), uid=uid_           
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
        tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create, jns_trans3)   
      values  
        (  rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
        tgl_, 0, jns_trans_, now(), uid_, 3-status_barang_, tgl_create_ ,hapus_dari_);  
      
    end if;
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        
  
    
    
    if hapus_dari_ = 4 then 
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create, jns_trans3)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_,  3-status_barang_,
      0, 0, 0, 0, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ,hapus_dari_);        
    else    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create, jns_trans3)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_,  3-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ,hapus_dari_);
    end if;

    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;             
        

    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0);        

    

    if akum_susut_ >0 then    
       
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create,jns_trans3)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ ,hapus_dari_);         
    end if;

  end if;  
end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_penghapusan_20160511`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_, idtrans_ int(11);
  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare biaya_pemeliharaan_ decimal(18,2);
  declare mutasi_ tinyint(3);
        
  set jns_trans2_ = 14;  
  set jns_trans_  = 7;  
  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_ from penghapusan where id = id_;  


  if mutasi_ = 0 then 
    
    select a1, a, b, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ );  
    set idtrans_ = LAST_INSERT_ID();
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ );  
 
        
    
    select sum(ifnull(harga,0)) into akum_susut_ from penyusutan where idbi= idbi_ and tgl<=tgl_;  
    set akum_susut_ = ifnull(akum_susut_,0);    
    if akum_susut_ >0 then
      
      select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
        into l1_, l2_, l3_, l4_, l5_, l6_ 
        from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;
      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, idtrans_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ );         
    end if;
     
  end if;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_penghapusan_20180130`(id_ int(11) )
BEGIN
 

  declare qry varchar(300);
  declare idbi_, idawal_,status_barang_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_, hapus_dari_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare biaya_pemeliharaan_ decimal(18,2);
  declare mutasi_ tinyint(3);  
  declare tgl_create_ datetime;  
  declare susut_mode_ int;  
  declare f1_, f2_ char(1);
  declare cnt_ int;  

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;
   
  
  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, tgl_create,hapus_dari
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, tgl_create_,hapus_dari_ from penghapusan where id = id_;  


  if mutasi_ = 0 or mutasi_=4 or mutasi_=5 then 
    if mutasi_ = 0 then
       set jns_trans2_ = 14;   
       set jns_trans_  = 7;        
    elseif mutasi_ = 4 then    
       set jns_trans2_ = 37; 
       set jns_trans_  = 8;        
    elseif mutasi_ = 5 then        
       set jns_trans2_ = 38;  
       set jns_trans_  = 8;       
    end if;
    
    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, status_barang into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, status_barang_  from buku_induk where id = idbi_;    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;

 
   
    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        idbi=idbi_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=0, jns_trans=jns_trans_, tgl_update=now(), uid=uid_           
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
        tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create, jns_trans3)   
      values  
        (  rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
        tgl_, 0, jns_trans_, now(), uid_, 3-status_barang_, tgl_create_ ,hapus_dari_);  
      
    end if;
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        
  
    
    if hapus_dari_ != 4 then 
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create, jns_trans3)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_,  3-status_barang_,
      0, 0, 0, 0, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ,hapus_dari_);        
    else    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create, jns_trans3)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_,  3-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ,hapus_dari_);
    end if;

    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;             
        

    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0);        

    

    if akum_susut_ >0 then    
       
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create,jns_trans3)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ ,hapus_dari_);         
    end if;

  end if;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_penghapusan_bck20180210`(id_ int(11) )
BEGIN
 

  declare qry varchar(300);
  declare idbi_, idawal_,status_barang_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_, hapus_dari_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare biaya_pemeliharaan_ decimal(18,2);
  declare mutasi_ tinyint(3);  
  declare tgl_create_ datetime;  
  declare susut_mode_ int;  
  declare f1_, f2_ char(1);
  declare cnt_ int;
  declare thn_login_ char(4);

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;
   
  
  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, tgl_create,hapus_dari
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, tgl_create_,hapus_dari_ from penghapusan where id = id_;  


  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
  
if (year(tgl_) >= thn_login_) then      


  if mutasi_ = 0 or mutasi_=4 or mutasi_=5 then 
    if mutasi_ = 0 then
       set jns_trans2_ = 14;   
       set jns_trans_  = 7;        
    elseif mutasi_ = 4 then    
       set jns_trans2_ = 37; 
       set jns_trans_  = 8;        
    elseif mutasi_ = 5 then        
       set jns_trans2_ = 38;  
       set jns_trans_  = 8;       
    end if;
    
    
    select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j, status_barang into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, status_barang_  from buku_induk where id = idbi_;    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;             
    elseif staset_ = 5 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '01' ; 
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '02' ; 
    elseif staset_ = 7 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ; 
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; 
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; 
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;            
    elseif staset_ = 11 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;       
    elseif staset_ = 12 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;                    
    elseif staset_ = 13 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '06' ;      
    elseif staset_ = 14 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '07' ;      
    end if;

 
   
    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        idbi=idbi_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=0, jns_trans=jns_trans_, tgl_update=now(), uid=uid_           
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
        tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create, jns_trans3)   
      values  
        (  rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
        tgl_, 0, jns_trans_, now(), uid_, 3-status_barang_, tgl_create_ ,hapus_dari_);  
      
    end if;
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        
  
    
    if hapus_dari_ != 4 then 
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create, jns_trans3)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_,  3-status_barang_,
      0, 0, 0, 0, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ,hapus_dari_);        
    else    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create, jns_trans3)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_,  3-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ ,hapus_dari_);
    end if;

    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;             
        

    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0);        

    

    if akum_susut_ >0 then    
       
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create,jns_trans3)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ ,hapus_dari_);         
    end if;

  end if;  
end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_penilaian`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare nilai_barang_ decimal(18,2);
  declare thn_buku_penilaian_,thn_perolehan_,thn_login_ char(4);
  declare tgl_create_ datetime;
  declare f1_,f2_ char(1); 
  declare cnt_ int; 
         
  set jns_trans2_ = 13;  
  set jns_trans_ = 6;  

  
  select staset,tgl_penilaian,id_bukuinduk,idbi_awal,year(tgl_penilaian)as thn_penilaian,year(tgl_perolehan)as thn_perolehan,  
    ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid ,nilai_barang - nilai_barang_asal,tgl_create
    into staset_, tgl_, idbi_, idawal_,thn_buku_penilaian_,thn_perolehan_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,nilai_barang_,tgl_create_ from penilaian where id = id_;

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';   
  
if (thn_buku_penilaian_ >= thn_login_) then                         

    
    


    select a1, a, b, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    if(thn_buku_penilaian_ <> thn_perolehan_) then  
      set jns_trans_= 8;    
    else  
      set jns_trans_ = 6;
    end if;
    
    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=nilai_barang_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
     insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ ,tgl_create_);  
    end if;  
            

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, nilai_barang_, 0 , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
 

end if;  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_penilaian_20170911`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare nilai_barang_ decimal(18,2);
  declare thn_buku_penilaian_ char(4);  
  declare thn_perolehan_ char(4);
  declare tgl_create_ datetime;
  declare f1_,f2_ char(1); 
  declare cnt_ int; 
         
  set jns_trans2_ = 13;  
  set jns_trans_ = 6;  

  
  select staset,tgl_penilaian,id_bukuinduk,idbi_awal,year(tgl_penilaian)as thn_penilaian,year(tgl_perolehan)as thn_perolehan,  
    ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid ,nilai_barang - nilai_barang_asal,tgl_create
    into staset_, tgl_, idbi_, idawal_,thn_buku_penilaian_,thn_perolehan_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,nilai_barang_,tgl_create_ from penilaian where id = id_;             

    
    


    select a1, a, b, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    if(thn_buku_penilaian_ <> thn_perolehan_) then  
      set jns_trans_= 8;    
    else  
      set jns_trans_ = 6;
    end if;
    
    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=nilai_barang_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
     insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ ,tgl_create_);  
    end if;  
            

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, nilai_barang_, 0 , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
 

  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_penilaian_20180130`(id_ int(11) )
BEGIN

  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3); 
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare nilai_barang_ decimal(18,2);
  declare thn_buku_penilaian_ char(4);  
  declare thn_perolehan_ char(4);
  declare tgl_create_ datetime;
  declare f1_,f2_ char(1); 
  declare cnt_ int; 
         
  set jns_trans2_ = 13;  
  set jns_trans_ = 6;  

  
  select staset,tgl_penilaian,id_bukuinduk,idbi_awal,year(tgl_penilaian)as thn_penilaian,year(tgl_perolehan)as thn_perolehan,  
    ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0), uid ,nilai_barang - nilai_barang_asal,tgl_create
    into staset_, tgl_, idbi_, idawal_,thn_buku_penilaian_,thn_perolehan_, m1_, m2_, m3_, m4_, m5_, m6_,uid_,nilai_barang_,tgl_create_ from penilaian where id = id_;             

    
    


    select a1, a, b, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    
    
    elseif staset_ = 6 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '03' ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                
    elseif staset_ = 9 then       
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;           
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;
  
    if(thn_buku_penilaian_ <> thn_perolehan_) then  
      set jns_trans_= 8;    
    else  
      set jns_trans_ = 6;
    end if;
    
    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2=jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=nilai_barang_        
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
     insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_ ,tgl_create_);  
    end if;  
            

    

    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f1=f1_ and f2=f2_ and f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    
  
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 0, nilai_barang_, 0 , tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
 

  

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_reklass`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idbaru_, status_barang_ int(11);  


  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ , tgl_susut_baru_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);  
  declare mutasi_, sudahmutasi_ tinyint(3);    
  declare tgl_create_ datetime;  
  declare susut_mode_ int;   
  declare cek_ text; 
  declare cnt_ int;   
  declare f1_, f2_ char(1); 
  declare thn_login_ char(4);

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;


  set jns_trans2_ = 16;  
  set jns_trans_  = 9;  




  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, sudahmutasi, tgl_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_ from penghapusan where id = id_;  

  if mutasi_ = 2 then 


    
    select a1, a, b, c1, c, d, e, e1, f1,f2,f, g, h, i, j, status_barang  into a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_ , status_barang_ from buku_induk where id = idbi_;    

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
  
if (year(tgl_) >= thn_login_) then       

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 

    
    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  
      
    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;   


    
    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        idbi=idbi_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=0, jns_trans=jns_trans_, tgl_update=now(), uid=uid_           
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, 5-status_barang_, tgl_create_ );  
      
    end if;
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 5-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );  
 

     

    if akum_susut_ >0 then          
             

      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );         
    end if;    



    if sudahmutasi_=1 then        
       
        
        select a1, a, b, c1, c, d, e, e1, f1,f2,f, g, h, i, j, id into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, idbaru_  from buku_induk where id_lama = idbi_ limit 0,1;         


          
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  
            
     

    
         

    
      
      
      
      select max(tgl) into tgl_susut_baru_ from penyusutan where idbi = idbi_;      
if tgl_susut_baru_ is not null then
      
      delete from penyusutan where idbi = idbaru_;    
      
      update buku_induk set 
      masa_manfaat=0,nilai_sisa=0,thn_susut_aw=0,thn_susut_ak=0,bln_susut_aw=0,bln_susut_ak=0,masa_manfaat_tot=0,stop_susut=0
      where id =  idbaru_;      
      
      select sf_susut(idbaru_, tgl_susut_baru_, uid_ , jns_trans2_,  susut_mode_) into cek_; 
      update penyusutan set tgl = tgl_ where idbi=idbaru_; 
      
      
      
      select sf_getAkumSusut(idbaru_, tgl_) into akum_susut_;   
      set akum_susut_ = ifnull(akum_susut_,0);
end if;
            

        
    if staset_ = 3 then 
      
      if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
       else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
       end if;     
    elseif staset_ = 8 then    
      
      if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
       else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
       end if;                  
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    
          
        
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 1,
          1, 0, nilai_buku_, 0, tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );        
        
        
        if akum_susut_ >0 then    
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 
            0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );  
        end if;         
        
    end if;
     
  end if;  
end if;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_reklass_20170139`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idbaru_, status_barang_ int(11);  


  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);  
  declare mutasi_, sudahmutasi_ tinyint(3);    
  declare tgl_create_ datetime;  
  declare susut_mode_ int;    

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;


  set jns_trans2_ = 16;  
  set jns_trans_  = 9;  




  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, sudahmutasi, tgl_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_ from penghapusan where id = id_;  


            
    

  if mutasi_ = 2 then 


    
    select a1, a, b, c, d, e, e1, f, g, h, i, j, status_barang  into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_ , status_barang_ from buku_induk where id = idbi_;    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 


    
    if susut_mode_ = 3  then  
       delete from penyusutan where idbi=idbi_ and year(tgl)>= year(tgl_);
    else 
       delete from penyusutan where idbi=idbi_ and tgl>= tgl_;    
    end if;    
    
    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  
      
    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    


    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, 5-status_barang_, tgl_create_ );  
    
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 5-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );  
 

     delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10; 
    if akum_susut_ >0 then          
             

      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );         
    end if;    



    if sudahmutasi_=1 then        
       
        
        select a1, a, b, c, d, e, e1, f, g, h, i, j, id into a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, idbaru_  from buku_induk where id_lama = idbi_ limit 0,1;         


          
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  
            
     

    
    select sf_getAkumSusut(idbaru_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0); 
              

        
    if staset_ = 3 then 
      
      if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
       else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
       end if;     
    elseif staset_ = 8 then    
      
      if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
       else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
       end if;                  
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    
          
        
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1,
          1, 0, nilai_buku_, 0, tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );        
        
        
        if akum_susut_ >0 then    
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c,d,e,e1,f,g,h,i,j, 
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
            0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );  
        end if;         
        
    end if;
     
  end if;  


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_reklass_20170918`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idbaru_, status_barang_ int(11);  


  declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ , tgl_susut_baru_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);  
  declare mutasi_, sudahmutasi_ tinyint(3);    
  declare tgl_create_ datetime;  
  declare susut_mode_ int;   
  declare cek_ text; 

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;


  set jns_trans2_ = 16;  
  set jns_trans_  = 9;  




  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, sudahmutasi, tgl_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_ from penghapusan where id = id_;  

    
  
        
    

  if mutasi_ = 2 then 


    
    select a1, a, b, c1, c, d, e, e1, f, g, h, i, j, status_barang  into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_ , status_barang_ from buku_induk where id = idbi_;    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 

    
    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  
      
    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    


    delete from t_transaksi where jns_trans2 = jns_trans2_ and refid =  id_;   
    
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, 5-status_barang_, tgl_create_ );  
    
    
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 5-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );  
 

     

    if akum_susut_ >0 then          
             

      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );         
    end if;    



    if sudahmutasi_=1 then        
       
        
        select a1, a, b, c1, c, d, e, e1, f, g, h, i, j, id into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, idbaru_  from buku_induk where id_lama = idbi_ limit 0,1;         


          
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  
            
     

    
         

    
      
      
      
      select max(tgl) into tgl_susut_baru_ from penyusutan where idbi = idbi_;      
if tgl_susut_baru_ is not null then
      
      delete from penyusutan where idbi = idbaru_;    
      
      update buku_induk set 
      masa_manfaat=0,nilai_sisa=0,thn_susut_aw=0,thn_susut_ak=0,bln_susut_aw=0,bln_susut_ak=0,masa_manfaat_tot=0,stop_susut=0
      where id =  idbaru_;      
      
      select sf_susut(idbaru_, tgl_susut_baru_, uid_ , jns_trans2_,  susut_mode_) into cek_; 
      update penyusutan set tgl = tgl_ where idbi=idbaru_; 
      
      
      
      select sf_getAkumSusut(idbaru_, tgl_) into akum_susut_;   
      set akum_susut_ = ifnull(akum_susut_,0);
end if;
              

        
    if staset_ = 3 then 
      
      if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
       else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
       end if;     
    elseif staset_ = 8 then    
      
      if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
       else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
       end if;                  
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    
          
        
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 1,
          1, 0, nilai_buku_, 0, tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );        
        
        
        if akum_susut_ >0 then    
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
            0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );  
        end if;         
        
    end if;
     
  end if;  


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_reklass_20180130`(id_ int(11) )
BEGIN


  declare qry varchar(300);
  declare idbi_, idawal_, idbaru_, status_barang_ int(11);  


  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare jns_trans_,jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ , tgl_susut_baru_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(20);  
  declare biaya_pemeliharaan_ decimal(18,2);  
  declare mutasi_, sudahmutasi_ tinyint(3);    
  declare tgl_create_ datetime;  
  declare susut_mode_ int;   
  declare cek_ text; 
  declare cnt_ int;   
  declare f1_, f2_ char(1);

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;


  set jns_trans2_ = 16;  
  set jns_trans_  = 9;  




  
  select staset,tgl_penghapusan,id_bukuinduk,idbi_awal,  uid ,mutasi, sudahmutasi, tgl_create
    into staset_, tgl_, idbi_, idawal_,uid_, mutasi_, sudahmutasi_, tgl_create_ from penghapusan where id = id_;  

    
  
        
    

  if mutasi_ = 2 then 


    
    select a1, a, b, c1, c, d, e, e1, f1,f2,f, g, h, i, j, status_barang  into a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_ , status_barang_ from buku_induk where id = idbi_;    

    
    set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0); 

    
    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  
      
    
    select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;   
    set akum_susut_ = ifnull(akum_susut_,0); 
      
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    


    
    
    set difstaset_ = 0;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        idbi=idbi_, idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=0, jns_trans=jns_trans_, tgl_update=now(), uid=uid_           
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, status_barang, tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, 5-status_barang_, tgl_create_ );  
      
    end if;
    
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;        

    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 5-status_barang_,
      0, 1, 0, nilai_buku_, tgl_, 0, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );  
 

     

    if akum_susut_ >0 then          
             

      
      insert into t_jurnal_aset
        (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
        jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
      values 
        (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 
        0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );         
    end if;    



    if sudahmutasi_=1 then        
       
        
        select a1, a, b, c1, c, d, e, e1, f1,f2,f, g, h, i, j, id into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, idbaru_  from buku_induk where id_lama = idbi_ limit 0,1;         


          
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;  
            
     

    
         

    
      
      
      
      select max(tgl) into tgl_susut_baru_ from penyusutan where idbi = idbi_;      
if tgl_susut_baru_ is not null then
      
      delete from penyusutan where idbi = idbaru_;    
      
      update buku_induk set 
      masa_manfaat=0,nilai_sisa=0,thn_susut_aw=0,thn_susut_ak=0,bln_susut_aw=0,bln_susut_ak=0,masa_manfaat_tot=0,stop_susut=0
      where id =  idbaru_;      
      
      select sf_susut(idbaru_, tgl_susut_baru_, uid_ , jns_trans2_,  susut_mode_) into cek_; 
      update penyusutan set tgl = tgl_ where idbi=idbaru_; 
      
      
      
      select sf_getAkumSusut(idbaru_, tgl_) into akum_susut_;   
      set akum_susut_ = ifnull(akum_susut_,0);
end if;
              

        
    if staset_ = 3 then 
      
      if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
       else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
       end if;     
    elseif staset_ = 8 then    
      
      if f_ <> '07' then    
          set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;                 
          set staset_ = 3;
       else
          set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;                       
          set staset_ = 8; 
       end if;                  
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    
          
        
        
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, status_barang,
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
        values 
          (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 1,
          1, 0, nilai_buku_, 0, tgl_, staset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_, tgl_create_ );        
        
        
        if akum_susut_ >0 then    
          insert into t_jurnal_aset
            (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
            jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
          values 
            (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, id_, idbaru_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 
            0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_, tgl_create_ );  
        end if;         
        
    end if;
     
  end if;  


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_staset`(id_ int(11) )
BEGIN

























  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare staset_, staset_baru_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ , jns_trans_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);
  declare jns_, refid_ int(11);  
  declare tgl_create_ datetime;
  declare susut_mode_ int;   
  declare f1_, f2_ char(1);   
  declare cnt_ int;
  declare thn_login_ char(4);

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  
  select tgl,idbi,uid, staset, staset_baru, idbi_awal, jns,refid,tgl_create      
     into tgl_,idbi_, uid_, staset_, staset_baru_ , idawal_, jns_, refid_ ,tgl_create_ from t_history_aset where Id = id_;      

  
 

if staset_ <> '0' then 

  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;    

  select nilai into thn_login_ from setting where id = 'THN_ANGGARAN';
        
if (year(tgl_) >= thn_login_) then
    
  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);     

  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);      


  if staset_baru_ = 9 then 
    
    set q_= 21; set jns_trans2_ = 21;      
        
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;  
      
      select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;            

    
    
    set difstaset_ = staset_baru_-staset_;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        jns_trans2=jns_trans2_,                
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_               
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2, f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, 9, now(), uid_ ,tgl_create_);          
    end if;
                
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1, f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 1, 0, nilai_buku_, tgl_, difstaset_, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
        
    
    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1, f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_, f2_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    
    
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1, f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '05', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_,f_, g_, h_, i_, j_, 
      
      1, 0, nilai_buku_, 0, tgl_, 0, 9, '1', '5', '4', '1', f_, g_,   now(), uid_ ,tgl_create_);            
    
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1, f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_,  '01', '02', '05', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_,f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;      
                    

  elseif staset_baru_ = 10 then 
  
    set q_= 22; set jns_trans2_ = 22; 
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;     
      
      select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
        from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;   
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;     

    
    set difstaset_ = staset_baru_-staset_;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
         jns_trans2=jns_trans2_,                
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_               
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, 3, now(), uid_ ,tgl_create_);          
    end if;
                
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_,       
      0, 1, 0, nilai_buku_, tgl_, difstaset_, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);    

    
    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    

    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '02', '00', '00', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 
      
      1, 0, nilai_buku_, 0, tgl_, 0, 3, '', '', '', '', '', '',   now(), uid_ ,tgl_create_);    
      
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, '02', '00', '00', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    
 
  elseif staset_baru_ = 3 then 
  
    if staset_ = 9 then    
       set q_= 21; set jns_trans2_ = 21;         
    elseif staset_ = 10 then    
       set q_= 22; set jns_trans2_ = 22; 
    end if;    

    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;  set jns_trans_=9;         
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; set jns_trans_=9;         
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; set jns_trans_=9;    
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ; set jns_trans_ = 3;
    end if;     

    
    set difstaset_ = staset_baru_-staset_;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
         jns_trans2=jns_trans2_,                
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_               
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), uid_ ,tgl_create_);          
    end if;
    
        
    
    
    
        
    
    if staset_ = 9 then        
       set ka_ = '1' ; set kb_ = '5'; set kc_ = '4'; set kd_='1' ; set ke_= f_ ; set kf_=g_;        
    elseif staset_=10 then    
       set ka_ = '' ; set kb_ = ''; set kc_ = ''; set kd_='' ; set ke_= ''; set kf_='';  
    end if;
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_, 
      
      0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);        

    
    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;   
    if akum_susut_ >0 then                
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0,  tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
          
    
    if f_<> '07' then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    else 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    end if;    

    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 
      1, 0, nilai_buku_, 0, tgl_, 0, jns_trans_, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);      

    
    if akum_susut_ >0 then                
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
  
  elseif staset_baru_ = 8 then 
  
    if staset_ = 9 then    
       set q_= 21; set jns_trans2_ = 21;         
    elseif staset_ = 10 then    
       set q_= 22; set jns_trans2_ = 22; 
    end if;    

    
    if staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; set jns_trans_=9;    
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ; set jns_trans_ = 3;
    end if;     

    
    set difstaset_ = staset_baru_-staset_;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
         jns_trans2=jns_trans2_,                
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_               
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), uid_ ,tgl_create_); 
    end if; 
    
        
    
    if staset_ = 9 then        
       set ka_ = '1' ; set kb_ = '5'; set kc_ = '4'; set kd_='1' ; set ke_= f_ ; set kf_=g_;        
    elseif staset_=10 then    
       set ka_ = '' ; set kb_ = ''; set kc_ = ''; set kd_='' ; set ke_= ''; set kf_='';  
    end if;
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 
      
      0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);        

    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;     
          
    
    if f_<> '07' then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    else
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    end if;    

    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 
      1, 0, nilai_buku_, 0, tgl_, 0, jns_trans_, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);      

     
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;         
  end if;    
 end if;  
end if; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_staset_20180130`(id_ int(11) )
BEGIN
























  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare staset_, staset_baru_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ , jns_trans_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);
  declare jns_, refid_ int(11);  
  declare tgl_create_ datetime;
  declare susut_mode_ int;   
  declare f1_, f2_ char(1);   
  declare cnt_ int;

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  
  select tgl,idbi,uid, staset, staset_baru, idbi_awal, jns,refid,tgl_create      
     into tgl_,idbi_, uid_, staset_, staset_baru_ , idawal_, jns_, refid_ ,tgl_create_ from t_history_aset where Id = id_;      

  
 

if staset_ <> '0' then 

  
  select a1, a, b, c1, c, d, e, e1, f1, f2, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;      
  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);     

  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);      


  if staset_baru_ = 9 then 
    
    set q_= 21; set jns_trans2_ = 21;      
        
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;  
      
      select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    
      
    

    
    
    set difstaset_ = staset_baru_-staset_;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        jns_trans2=jns_trans2_,                
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_               
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2, f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_, f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, 9, now(), uid_ ,tgl_create_);          
    end if;
                
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1, f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_, f_, g_, h_, i_, j_, 
      0, 1, 0, nilai_buku_, tgl_, difstaset_, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
        
    
    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1, f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_, f2_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    
    
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1, f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '05', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_,f_, g_, h_, i_, j_, 
      
      1, 0, nilai_buku_, 0, tgl_, 0, 9, '1', '5', '4', '1', f_, g_,   now(), uid_ ,tgl_create_);            
    
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1, f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_,  '01', '02', '05', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_, f2_,f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;      
                    

  elseif staset_baru_ = 10 then 
  
    set q_= 22; set jns_trans2_ = 22; 
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;     
      
      select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
        from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;   
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;     

    
    set difstaset_ = staset_baru_-staset_;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
         jns_trans2=jns_trans2_,                
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_               
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, 3, now(), uid_ ,tgl_create_);          
    end if;
                
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_,       
      0, 1, 0, nilai_buku_, tgl_, difstaset_, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);    

    
    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    

    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '02', '00', '00', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 
      
      1, 0, nilai_buku_, 0, tgl_, 0, 3, '', '', '', '', '', '',   now(), uid_ ,tgl_create_);    
      
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, '02', '00', '00', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    
 
  elseif staset_baru_ = 3 then 
  
    if staset_ = 9 then    
       set q_= 21; set jns_trans2_ = 21;         
    elseif staset_ = 10 then    
       set q_= 22; set jns_trans2_ = 22; 
    end if;    

    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;  set jns_trans_=9;         
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; set jns_trans_=9;         
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; set jns_trans_=9;    
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ; set jns_trans_ = 3;
    end if;     

    
    set difstaset_ = staset_baru_-staset_;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
         jns_trans2=jns_trans2_,                
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_               
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), uid_ ,tgl_create_);          
    end if;
    
        
    
    
    
        
    
    if staset_ = 9 then        
       set ka_ = '1' ; set kb_ = '5'; set kc_ = '4'; set kd_='1' ; set ke_= f_ ; set kf_=g_;        
    elseif staset_=10 then    
       set ka_ = '' ; set kb_ = ''; set kc_ = ''; set kd_='' ; set ke_= ''; set kf_='';  
    end if;
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_, 
      
      0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);        

    
    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;   
    if akum_susut_ >0 then                
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0,  tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
          
    
    if f_<> '07' then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    else 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    end if;    

    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 
      1, 0, nilai_buku_, 0, tgl_, 0, jns_trans_, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);      

    
    if akum_susut_ >0 then                
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
  
  elseif staset_baru_ = 8 then 
  
    if staset_ = 9 then    
       set q_= 21; set jns_trans2_ = 21;         
    elseif staset_ = 10 then    
       set q_= 22; set jns_trans2_ = 22; 
    end if;    

    
    if staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; set jns_trans_=9;    
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ; set jns_trans_ = 3;
    end if;     

    
    set difstaset_ = staset_baru_-staset_;    
    select count(*) into cnt_ from t_transaksi where jns_trans2 =jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
         jns_trans2=jns_trans2_,                
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_, staset=staset_, jns_trans=jns_trans_, tgl_update=now(), uid=uid_               
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), uid_ ,tgl_create_); 
    end if; 
    
        
    
    if staset_ = 9 then        
       set ka_ = '1' ; set kb_ = '5'; set kc_ = '4'; set kd_='1' ; set ke_= f_ ; set kf_=g_;        
    elseif staset_=10 then    
       set ka_ = '' ; set kb_ = ''; set kc_ = ''; set kd_='' ; set ke_= ''; set kf_='';  
    end if;
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 
      
      0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);        

    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;     
          
    
    if f_<> '07' then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    else
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    end if;    

    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_, 
      1, 0, nilai_buku_, 0, tgl_, 0, jns_trans_, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);      

     
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_,f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;  
        
  end if;     


end if;  



END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_staset_bck20170929`(id_ int(11) )
BEGIN























  declare qry varchar(300);
  declare idbi_, idawal_ int(11);
  declare nilai_buku_ decimal(18,2);
  declare akum_susut_ decimal(18,5);
  declare staset_, staset_baru_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_, g_, h_, i_, rkint_, rka_, rkb_ char(2);    
  declare e1_, j_ char(3);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_ varchar(8);  
  declare q_, jns_trans2_ , jns_trans_ int(11);  
  declare no_sk_ varchar(50);  
  declare diganti_barang_ tinyint(3);
  declare jns_, refid_ int(11);  
  declare tgl_create_ datetime;
  declare susut_mode_ int; 

  select nilai into susut_mode_ from setting where Id = 'SUSUT_MODE' ;

  
  
  select tgl,idbi,uid, staset, staset_baru, idbi_awal, jns,refid,tgl_create      
     into tgl_,idbi_, uid_, staset_, staset_baru_ , idawal_, jns_, refid_ ,tgl_create_ from t_history_aset where Id = id_;      

  
 

if staset_ <> '0' then 

  
  select a1, a, b, c1, c, d, e, e1, f, g, h, i, j into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_  from buku_induk where id = idbi_;      
  
  set nilai_buku_ = ifnull(get_nilai_buku(idbi_, tgl_ , 0 ), 0);     

  
  select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
     into l1_, l2_, l3_, l4_, l5_, l6_ 
     from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;      
  
  select sf_getAkumSusut(idbi_, tgl_) into akum_susut_;     
  set akum_susut_ = ifnull(akum_susut_,0);      


  if staset_baru_ = 9 then 
    
    set q_= 21; set jns_trans2_ = 21;      
        
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;  
      
      select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;       
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;    
      
    

    
    
    set difstaset_ = staset_baru_-staset_;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, difstaset_, 9, now(), uid_ ,tgl_create_);  
                
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      0, 1, 0, nilai_buku_, tgl_, difstaset_, 9, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);  
        
    
    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    
    
    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '01', '02', '05', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      
      1, 0, nilai_buku_, 0, tgl_, 0, 9, '1', '5', '4', '1', f_, g_,   now(), uid_ ,tgl_create_);            
    
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_,  '01', '02', '05', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;      
                    

  elseif staset_baru_ = 10 then 
  
    set q_= 22; set jns_trans2_ = 22; 
    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;     
      
      select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
        from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;   
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ;
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ;
    end if;     

    
    set difstaset_ = staset_baru_-staset_;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, difstaset_, 3, now(), uid_ ,tgl_create_);  
                
    
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,       
      0, 1, 0, nilai_buku_, tgl_, difstaset_, 3, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);    

    
    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    

    
    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, '02', '00', '00', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      
      1, 0, nilai_buku_, 0, tgl_, 0, 3, '', '', '', '', '', '',   now(), uid_ ,tgl_create_);    
      
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, '02', '00', '00', jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;    
 
  elseif staset_baru_ = 3 then 
  
    if staset_ = 9 then    
       set q_= 21; set jns_trans2_ = 21;         
    elseif staset_ = 10 then    
       set q_= 22; set jns_trans2_ = 22; 
    end if;    

    
    if staset_ = 3 then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;  set jns_trans_=9;         
    elseif staset_ = 8 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ; set jns_trans_=9;         
    elseif staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; set jns_trans_=9;    
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ; set jns_trans_ = 3;
    end if;     

    
    set difstaset_ = staset_baru_-staset_;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), uid_ ,tgl_create_);  
    
        
    
    
    
        
    
    if staset_ = 9 then        
       set ka_ = '1' ; set kb_ = '5'; set kc_ = '4'; set kd_='1' ; set ke_= f_ ; set kf_=g_;        
    elseif staset_=10 then    
       set ka_ = '' ; set kb_ = ''; set kc_ = ''; set kd_='' ; set ke_= ''; set kf_='';  
    end if;
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      
      0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);        

    
    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;   
    if akum_susut_ >0 then                
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0,  tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
          
    
    if f_<> '07' then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    else 
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    end if;    

    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      1, 0, nilai_buku_, 0, tgl_, 0, jns_trans_, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);      

    
    if akum_susut_ >0 then                
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;   
  
  elseif staset_baru_ = 8 then 
  
    if staset_ = 9 then    
       set q_= 21; set jns_trans2_ = 21;         
    elseif staset_ = 10 then    
       set q_= 22; set jns_trans2_ = 22; 
    end if;    

    
    if staset_ = 9 then    
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '05' ; set jns_trans_=9;    
    elseif staset_ = 10 then    
      set rkint_ = '02' ; set rka_ = '00'; set rkb_ = '00' ; set jns_trans_ = 3;
    end if;     

    
    set difstaset_ = staset_baru_-staset_;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid,tgl_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, difstaset_, jns_trans_, now(), uid_ ,tgl_create_);  
    
        
    
    if staset_ = 9 then        
       set ka_ = '1' ; set kb_ = '5'; set kc_ = '4'; set kd_='1' ; set ke_= f_ ; set kf_=g_;        
    elseif staset_=10 then    
       set ka_ = '' ; set kb_ = ''; set kc_ = ''; set kd_='' ; set ke_= ''; set kf_='';  
    end if;
    insert into t_jurnal_aset
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku,   staset, jns_trans, k, l, m, n, o, p, tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      
      0, 1, 0, nilai_buku_, tgl_, difstaset_, jns_trans_, ka_, kb_, kc_, kd_, ke_, kf_,  now(), uid_ ,tgl_create_);        

    delete from t_jurnal_aset where jns_trans2 = jns_trans2_ and refid=id_ and jns_trans=10;
    
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, akum_susut_, 0, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;     
          
    
    if f_<> '07' then    
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
    else
      set rkint_ = '01' ; set rka_ = '02'; set rkb_ = '04' ;      
    end if;    

    insert into t_jurnal_aset   
      (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
      jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
    values 
      (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
      1, 0, nilai_buku_, 0, tgl_, 0, jns_trans_, m1_, m2_, m3_, m4_, m5_, m6_,   now(), uid_ ,tgl_create_);      

     
    if akum_susut_ >0 then
        insert into t_jurnal_aset
          (q, kint, ka, kb, jns_trans2, refid, idbi, idawal,  a1,a,b,c1,c,d,e,e1,f,g,h,i,j, 
          jml_barang_d, jml_barang_k, debet, kredit, tgl_buku, staset, jns_trans, k, l, m, n, o, p,  tgl_update,uid,tgl_create)
        values 
          (q_, rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, 
          0, 0, 0, akum_susut_, tgl_, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_,  now(), uid_ ,tgl_create_);         
    end if;  
        
  end if;     


end if;  



END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_susut`(id_ int(11))
BEGIN




  declare qry varchar(300);
  declare idbi_, idawal_, refid_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;  

  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,5);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_, uid_create varchar(20);    
  declare tgl_create_ datetime; 
  declare uid_create_ datetime;
  
  
  
  
  declare thn_perolehan_, thn_tgl_buku_, thn_anggaran_ char(4); 
  declare tahun_, jns_trans3_ int; 
  declare cnt_ int;
  declare f1_,f2_ char(1);  

  
  select tgl, idbi, idbi_awal, harga, thn_perolehan, staset, uid, jns_trans2, tgl_create,uid_create, tahun
     into tgl_, idbi_,idawal_, harga_susut_, thn_perolehan_, staset_, uid_, jns_trans2_, tgl_create_, uid_create_ , tahun_
     from penyusutan where Id = id_;

 
  select nilai into thn_anggaran_ from setting where Id = 'THN_ANGGARAN';    

  
  
  set thn_tgl_buku_ = year(tgl_);
  set jns_trans_ = 10;         


if jns_trans2_=30 AND thn_tgl_buku_>=thn_anggaran_ then

  
  select a1, a, b, c1, c, d, e, e1, f1,f2,f, g, h, i, j
     into a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_
     from buku_induk where id = idbi_;  

  
  if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
  elseif staset_ = 9 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '05' ;   
  elseif staset_ = 10 then    
      set rkint_ = '02'; set rka_ = '00'; set rkb_ = '00' ;   
  elseif staset_ = 8 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '04' ;
  elseif staset_ = 7 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '03' ;
        
  end if; 
    set jns_trans3_ = 30;
  if year(tgl_) <>  tahun_ then    
    set jns_trans3_ = 41; 
  end if;              
  

   
   select count(*) into cnt_ from t_transaksi where jns_trans2 = jns_trans2_ and refid=id_; 
    if cnt_ > 0 then     
      update t_transaksi set       
        kint=rkint_, ka=rka_, kb=rkb_,         
        jns_trans2=jns_trans2_, idbi=idbi_, 
        idawal = idawal_,        
        a1=a1_, a=a_, b=b_, c1=c1_, c=c_, d=d_, e=e_, e1=e1_, 
        f1=f1_, f2=f2_, f=f_, g=g_, h=h_, i=i_, j=j_,        
        tgl_buku = tgl_,  jns_trans=jns_trans_, tgl_update=now(), uid=uid_, debet=0,kredit = harga_susut_             
      where jns_trans2=jns_trans2_ and refid=id_;
      delete from t_jurnal_aset where jns_trans2=jns_trans2_ and refid=id_;  
    else 
      set difstaset_ = 0;
      insert into t_transaksi
        (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j, 
        tgl_buku, staset, jns_trans, tgl_update,uid, debet, kredit, tgl_create, uid_create)   
      values  
        (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c1_, c_, d_, e_, e1_, f1_,f2_, f_, g_, h_, i_, j_, 
        tgl_, 0, jns_trans_, now(), uid_, 0, harga_susut_, tgl_create_, uid_create_ );          
    end if;
   

     

    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_; 
    
    
 
 insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c1,c,d,e,e1,f1,f2,f,g,h,i,j,jml_barang_d,jml_barang_k,debet,kredit,
       tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
    value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, jns_trans3_, id_, 0, idbi_, idawal_,a1_, a_, b_, c1_, c_, d_, e_, e1_,f1_,f2_, f_, g_, h_, i_, j_,
       0, 0, 0, harga_susut_, tgl_, 0, 0, 0, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_, uid_, now(), tgl_create_, uid_create_);
 
end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_susut_bck20171101`(id_ int(11))
BEGIN




  declare qry varchar(300);
  declare idbi_, idawal_, refid_ int(11);
  
  declare jns_trans_, jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_ decimal(18,5);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); 
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); 
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); 
  declare uid_, uid_create varchar(20);    
  declare tgl_create_ datetime; 
  declare uid_create_ datetime;
  
  
  
  
  declare thn_perolehan_ char(4); 
  declare tahun_, jns_trans3_ int; 

  
  select tgl, idbi, idbi_awal, harga, thn_perolehan, staset, uid, jns_trans2, tgl_create,uid_create, tahun
     into tgl_, idbi_,idawal_, harga_susut_, thn_perolehan_, staset_, uid_, jns_trans2_, tgl_create_, uid_create_ , tahun_
     from penyusutan where Id = id_;
  
  
  
  set jns_trans_ = 10;         


if jns_trans2_=30 then

  
  select a1, a, b, c1, c, d, e, e1, f, g, h, i, j
     into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
     from buku_induk where id = idbi_;  

  
  if staset_ = 3 then  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
  elseif staset_ = 9 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '05' ;   
  elseif staset_ = 10 then    
      set rkint_ = '02'; set rka_ = '00'; set rkb_ = '00' ;   
  elseif staset_ = 8 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '04' ;
  elseif staset_ = 7 then    
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '03' ;
        
  end if; 
    set jns_trans3_ = 30;
  if year(tgl_) <>  tahun_ then    
    set jns_trans3_ = 41; 
  end if;              
  

   
    set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, debet, kredit, tgl_create, uid_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, 0, harga_susut_, tgl_create_, uid_create_ );  
   

     

    
    select ifnull(l1,0), ifnull(l2,0), ifnull(l3,0), ifnull(l4,0), ifnull(l5,0), ifnull(l6,0) 
      into l1_, l2_, l3_, l4_, l5_, l6_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_; 
    
    
 
 insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c1,c,d,e,e1,f,g,h,i,j,jml_barang_d,jml_barang_k,debet,kredit,
       tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update,tgl_create,uid_create)
    value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, jns_trans3_, id_, 0, idbi_, idawal_,a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
       0, 0, 0, harga_susut_, tgl_, 0, 0, 0, 0, 10, l1_, l2_, l3_, l4_, l5_, l6_, uid_, now(), tgl_create_, uid_create_);
 
end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_jurnal_susut_koreksi`(idbi_ int(11), id_koreksi_ int(11))
BEGIN
/* -----------------------------------------------
#20160825 
 - terbalik, harusnya kredit
#20170920 saeful : ubah  harga_susut_, akum_susut_ decimal(18,5); 
#20180131 add kondisi year(tgl_buku_penyusutan) > thn_anggaran  
# 20180222 rusyad 
     - fix kompatible pindah saldo, tahun transaksi < dari tahun anggaran/login , tidak di jurnal     
     - delete jika ada jurnal ertambah sebelumnya
*/
  declare qry varchar(300);
  declare idawal_, refid_ int(11);
  #declare nilai_buku_, akum_susut_ decimal(18,2);
  declare jns_trans_, jns_trans2_, staset_, difstaset_ tinyint(3);
  declare tgl_ date;
  declare a1_, a_, b_, c1_, c_, d_, e_, f_,g_, h_, i_, rkint_, rka_, rkb_ char(2); 
  declare e1_, j_ char(3);   
  declare harga_susut_, akum_susut_ decimal(18,5);
  declare ka_, kb_, kc_, kd_, ke_, kf_ tinyint(3); # kd akun aset tetap
  declare l1_, l2_, l3_, l4_, l5_, l6_ tinyint(3); # kd akun penyusutan  
  declare m1_, m2_, m3_, m4_, m5_, m6_ tinyint(3); # kd akun pemanfaatan/kemitraaan    
  declare uid_ varchar(20);    
  declare tgl_create_ datetime; 
  declare uid_create_ datetime;
  #declare biaya_pemeliharaan_ decimal(18,2);
  #declare tambah_aset_ tinyint(3);  
  #declare cara_perolehan_ int;  
  #declare thn_buku_pelihara_ char(4);  
  declare thn_perolehan_, thn_tgl_buku_, thn_anggaran_ char(4);    
  
  #ambil data bertambah  dari koreksi penyusutan   
  select  sum(harga), tgl, idbi_awal, harga, thn_perolehan, staset, uid, jns_trans2, tgl_create,uid_create
     into akum_susut_, tgl_, idawal_, harga_susut_, thn_perolehan_, staset_, uid_, jns_trans2_, tgl_create_, uid_create_      
    # from penyusutan where idbi = idbi_ and id_koreksi=0  ;
     from penyusutan where idbi = idbi_ and id_koreksi=0 and id_koreksi_tambah =id_koreksi_ ;
  
  #set jns_trans3   
  #set jns_trans2_ = 31;         
  #set thn_tgl_buku_ = year(tgl_);
  set jns_trans_ = 10;  

 #ambil tahun mulai susut dari tabel setting  
  select nilai into thn_anggaran_ from setting where Id = 'THN_ANGGARAN';  

  # ambil tahun transaksi 
  select year(tgl) into thn_tgl_buku_ from t_koreksi_penyusutan where id = id_koreksi_;

 #kondisi jika tahun tgl buku transaksi >= thn anggaran maka dibuat jurnal    
 if thn_tgl_buku_>=thn_anggaran_ then 
#if jns_trans2_=31 then
  #ambil data dari buku_induk
  select a1, a, b, c1, c, d, e, e1, f, g, h, i, j
     into a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_
     from buku_induk where id = idbi_;  
     
  #get kode rekap  ----------------------------------------------------------
  SET rkint_ = '01'; SET rka_ = '01'; SET rkb_ = f_ ;       
  /*if staset_ = 3 then  #aset tetap  
      set rkint_ = '01'; set rka_ = '01'; set rkb_ = f_ ;       
  elseif staset_ = 9 then    #aset lain-lain
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '05' ;   
  elseif staset_ = 10 then    #aset ekstra
      set rkint_ = '02'; set rka_ = '00'; set rkb_ = '00' ;   
  elseif staset_ = 8 then    #aset tak berwujud
      set rkint_ = '01'; set rka_ = '02'; set rkb_ = '04' ;   
  end if;*/             
  #---------------------------------------------------------------------------  
   
   #simpan ke trans ----------------------------------------------------------   
    /*set difstaset_ = 0;
    insert into t_transaksi
      (kint, ka, kb, jns_trans2, refid, idbi, idawal, a1,a,b,c,d,e,e1,f,g,h,i,j, tgl_buku, staset, jns_trans, tgl_update,uid, debet, kredit, tgl_create, uid_create)   
    values  
      (rkint_, rka_, rkb_, jns_trans2_, id_koreksi_, idbi_, idawal_, a1_, a_, b_, c_, d_, e_, e1_, f_, g_, h_, i_, j_, tgl_, 0, jns_trans_, now(), uid_, 0, 0, tgl_create_, uid_create_  ); */ 
   #--------------------------------------------------------------------------     
   
    # ambil akun aset tetap -------------------------------------------------- 
    select ifnull(ka,0), ifnull(kb,0), ifnull(kc,0), ifnull(kd,0), ifnull(ke,0), ifnull(kf,0) into  ka_, kb_, kc_, kd_, ke_, kf_ 
      from  ref_barang where f=f_ and g=g_ and h=h_ and i=i_ and j=j_;     
    #set ka_=0; set kb_=0; set kc_=0; set kd_=0; set ke_=0; set kf_ = 0;
    
    
 # delete jika ada jurnal bertambah sebelumnya -------------------------------------------------------------------------
 delete from t_jurnal_aset where jns_trans=10 and jns_trans2 = 31 and refid = id_koreksi_ and kredit<>0 ; 

 #insert jurnal bertambah koreksi  -------------------------------------------------------------   
 insert into t_jurnal_aset
       (q,kint,ka,kb,jns_trans2,jns_trans3,refid,refid2,idbi,idawal,a1,a,b,c1,c,d,e,e1,f,g,h,i,j,jml_barang_d,jml_barang_k,debet,kredit,
       tgl_buku,harga_atribusi,asal_usul,status_barang,staset,jns_trans,k,l,m,n,o,p,uid, tgl_update, tgl_create, uid_create)
    value
       (jns_trans2_, rkint_, rka_, rkb_, jns_trans2_, 31, id_koreksi_, 0, idbi_, idawal_,a1_, a_, b_, c1_, c_, d_, e_, e1_, f_, g_, h_, i_, j_,
       0, 0, 0, akum_susut_, tgl_, 0, 0, 0, 0, 10, ka_, kb_, kc_, kd_, ke_, kf_, uid_, now(), tgl_create_, uid_create_ );
 #----------------------------------------------------------------------------
end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rekap2`(IN `tgl_awal_` DATE, IN `tgl_akhir_` DATE, IN `kondisi_` VARCHAR(250))
BEGIN






if kondisi_ != '' then 
  set kondisi_ = concat(" where ",kondisi_);
end if;

SET @s = CONCAT(
	"select aa.kint,aa.ka,aa.kb, aa.f,aa.g,aa.nm_barang , ",
				"(bb.debet_saldoawal_brg - bb.kredit_saldoawal_brg) as jmlbrgawal, ",
				"(bb.debet_saldoawal - bb.kredit_saldoawal) as jmlhargaawal,",
				"(bb.debet_hp-bb.debet_atribusi) as debet_bmd, ",
				"bb.debet_atribusi,bb.debet_kapitalisasi,bb.kredit_kapitalisasi,bb.debet_hibah,bb.kredit_hibah,bb.debet_mutasi,bb.kredit_mutasi, ",
				"bb.debet_penilaian, ",
				"(bb.kredit_penghapusan-bb.debet_penghapusan) as kredit_penghapusan, ",
				"bb.debet_koreksi,bb.kredit_koreksi,bb.debet_reklass,bb.kredit_reklass, ",
				"(bb.debet_saldoakhir_brg - bb.kredit_saldoakhir_brg) as jmlbrgakhir, ",
				"(bb.debet_saldoakhir - bb.kredit_saldoakhir) as jmlhargaakhir, ",
				
				"(bb.debet_saldoawal - bb.kredit_saldoawal+	bb.debet_hp+bb.debet_kapitalisasi-bb.kredit_kapitalisasi+bb.debet_hibah-bb.kredit_hibah+bb.debet_mutasi-bb.kredit_mutasi+ ",
				"bb.debet_penilaian-bb.kredit_penghapusan+bb.debet_koreksi-bb.kredit_koreksi+bb.debet_reklass-bb.kredit_reklass) as jmlhitakhir, ",
				
				"(bb.kredit_susutawal - bb.debet_susutawal) as susutawal, ",
				"bb.debet_susut, bb.kredit_susut, ",
				"(bb.kredit_susutawal - bb.debet_susutawal + bb.kredit_susut - bb.debet_susut)as susutakhir, ",
				
				"( (bb.debet_saldoawal-bb.kredit_saldoawal+bb.debet_hp+bb.debet_kapitalisasi-bb.kredit_kapitalisasi+bb.debet_hibah-bb.kredit_hibah+bb.debet_mutasi-bb.kredit_mutasi+bb.debet_penilaian-bb.kredit_penghapusan+bb.debet_koreksi-bb.kredit_koreksi+bb.debet_reklass-bb.kredit_reklass) ",
				"- (bb.kredit_susutawal-bb.debet_susutawal+bb.kredit_susut-bb.debet_susut) ) as nilai_buku ",
					
				
				" from v_ref_kib_keu  aa ",
				" left join ",
				"( select  IFNULL(f,'00') as f, IFNULL(g,'00') as g, ",
				"sum(if(tgl_buku<", tgl_awal_ ,"&& jns_trans<>10,jml_barang_d,0)) as debet_saldoawal_brg, ",
				"sum(if(tgl_buku<", tgl_awal_ ," && jns_trans<>10,jml_barang_k,0)) as kredit_saldoawal_brg, ",
				"sum(if(tgl_buku<", tgl_awal_ ," && jns_trans<>10,debet,0)) as debet_saldoawal, ",
				"sum(if(tgl_buku<", tgl_awal_ ," && jns_trans<>10,kredit,0)) as kredit_saldoawal, ",
				
				"sum(if(tgl_buku<", tgl_awal_ ," && jns_trans=10,debet,0)) as debet_susutawal, ",
				"sum(if(tgl_buku<", tgl_awal_ ," && jns_trans=10,kredit,0)) as kredit_susutawal, ",
				
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=1 ,debet,0)) as debet_hp, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=1 ,harga_atribusi,0)) as debet_atribusi, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=3 ,debet,0)) as debet_kapitalisasi, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=3 ,kredit,0)) as kredit_kapitalisasi, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=4 ,debet,0)) as debet_hibah, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=4 ,kredit,0)) as kredit_hibah, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=5 ,debet,0)) as debet_mutasi, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=5 ,kredit,0)) as kredit_mutasi, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=6 ,debet,0)) as debet_penilaian, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=7 ,debet,0)) as debet_penghapusan,  ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=7 ,kredit,0)) as kredit_penghapusan, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=8 ,debet,0)) as debet_koreksi, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=8 ,kredit,0)) as kredit_koreksi, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=9 ,debet,0)) as debet_reklass, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=9 ,kredit,0)) as kredit_reklass, ",
				
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=10 ,debet,0)) as debet_susut, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && tgl_buku>=", tgl_awal_ ," && jns_trans=10 ,kredit,0)) as kredit_susut, ",
				
				"sum(if(tgl_buku<=", tgl_akhir_ ," && jns_trans<>10,jml_barang_d,0)) as debet_saldoakhir_brg, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && jns_trans<>10,jml_barang_k,0)) as kredit_saldoakhir_brg, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && jns_trans<>10,debet,0)) as debet_saldoakhir, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && jns_trans<>10,kredit,0)) as kredit_saldoakhir, ",
				
				"sum(if(tgl_buku<=", tgl_akhir_ ," && jns_trans=10,debet,0)) as debet_susutakhir, ",
				"sum(if(tgl_buku<=", tgl_akhir_ ," && jns_trans=10,kredit,0)) as kredit_susutakhir ",
				
				"from v_jurnal_aset_tetap ",
				kondisi_ ,
				"group by f,g with rollup ",
				") bb on aa.f = bb.f and aa.g=bb.g ",
				 "where aa.ka='01' and aa.kb<>'00' ");
	
				 
	PREPARE stmt FROM @s;
	EXECUTE stmt;
   DEALLOCATE PREPARE stmt;			 

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sensus_scan`(`Param` int(11))
BEGIN

  declare c_, d_, e_ char(2);
  declare e1_ char(3);
  declare cnt_, tahun_sensus_ int;
  declare maxtgl_ date;  
  declare idsensus_, idsensusscan_ int;

  DECLARE done INT DEFAULT FALSE;  
  DECLARE cur CURSOR FOR 
         
         
         
         select c,d,e,e1 tahun_sensus, count(*) as cnt, DATE(max(tgl)) as maxtgl from view2_sensus 
                where (error ='' or error is  null)
                and (idbi is not null)                 
                and (tahun_sensus is not null and tahun_sensus !='')
                and c is not null and d is not null and e is not null       
         group by c,d,e,e1,tahun_sensus;      

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;  
  
    
    OPEN cur;  
    read_loop: LOOP
      
      FETCH cur INTO c_, d_, e_,e1_, tahun_sensus_, cnt_, maxtgl_;  
       
      
      IF done THEN
        LEAVE read_loop;
      END IF;                              
 
      
      insert into sensus_scan
             (tgl,tahun_sensus,a1,a,b,c,d,e,e1 )             
             values                           
             ( maxtgl_, tahun_sensus_,'12', '28', '01', c_,d_,e_,e1_ );             
      
      SELECT LAST_INSERT_ID() into idsensusscan_;      
            
      update sensus aa 
        inner join buku_induk bb 
        on aa.idbi = bb.id and 
        bb.c = c_ and bb.d=d_ and bb.e=e_ and bb.e1=e1_        
        set aa.ref_idsensusscan = idsensusscan_
      where (aa.error ='' or aa.error is  null)
        and (aa.idbi is not null)                 
        and (aa.tahun_sensus is not null and aa.tahun_sensus !='');
        

   END LOOP;    

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sensus_upd_bi`(`Param` int(11))
BEGIN
 declare tgl_ datetime; 
 declare ref_idpemegang_ varchar(30); 
 declare ref_idpenanggung_ varchar(30);  
 declare ref_idpemegang2_ varchar(30);  
 declare ref_idruang_ int; 
 declare tahun_sensus_ int;  
 declare kondisi_ int; 

 declare ref_idpemegang_lama_ varchar(30); 
 declare ref_idpenanggung_lama_ varchar(30);  
 declare ref_idpemegang2_lama_ varchar(30);  
 declare ref_idruang_lama_ int; 
 declare kondisi_lama_ int; 
  
 declare idsensus_ int;
 declare idbi_ int; 
 DECLARE done INT DEFAULT FALSE;  
 declare status_penguasaan_ int;


 DECLARE cur CURSOR FOR 
         select id, idbi, tgl, kondisi, tahun_sensus, 
         ifnull(ref_idpemegang,''), 
         ifnull(ref_idpenanggung,''), 
         ifnull(ref_idruang,0), 
         ifnull(ref_idpemegang2,''),         
         status_penguasaan
         from sensus
         where (sesi is null or sesi ='' ) and (error = '' or error is null) ;         

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;  
  
    
    OPEN cur;  
    read_loop: LOOP
      FETCH cur INTO idsensus_, idbi_, tgl_, kondisi_, tahun_sensus_, ref_idpemegang_, 
      ref_idpenanggung_, ref_idruang_, ref_idpemegang2_, status_penguasaan_ ;  
          
      IF done THEN
        LEAVE read_loop;
      END IF;                        




       
      update buku_induk set       
         kondisi = kondisi_,
         tgl_sensus = tgl_,         
         tahun_sensus = tahun_sensus_,         
         ref_idpemegang = ref_idpemegang_,         
         ref_idpemegang2 = ref_idpemegang2_,         
         ref_idpenanggung = ref_idpenanggung_,         
         ref_idruang = ref_idruang_,         
         status_penguasaan = status_penguasaan_
      where id = idbi_ ; 

   END LOOP;    

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2018-02-28 20:09:27
